# 温度选项字段使用指南 📚

**添加时间**: 2025-10-27  
**文件**: `backend/models/Actuator.js`  
**字段**: `temperature_options`  
**状态**: ✅ 已完成

---

## 📋 字段概述

在 Actuator 模型中新增了 `temperature_options` 字段，用于存储每个执行器型号支持的所有温度选项及其详细信息。

---

## 🎯 字段结构

### Schema 定义

```javascript
temperature_options: [{
  // 温度代码
  code: {
    type: String,
    trim: true,
    uppercase: true
    // 例如: 'NO CODE', 'T1', 'T2', 'T3', 'M'
  },
  // 温度描述
  description: {
    type: String,
    trim: true
    // 例如: '常温 Normal atmospheric temperature'
    // '低温 Low T1', '低温 Low T2', '低温 Low T3'
    // '高温 High Temp'
  },
  // 温度范围
  range: {
    type: String,
    trim: true
    // 例如: '-20~80°C', '-40~80°C', '-50~80°C', '-60~80°C', '-20~120°C'
  }
}]
```

### 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `temperature_options` | Array | ❌ | 温度选项数组 |
| `temperature_options[].code` | String | ❌ | 温度代码（自动转大写） |
| `temperature_options[].description` | String | ❌ | 温度等级描述 |
| `temperature_options[].range` | String | ❌ | 温度范围 |

---

## 💡 标准温度代码

### 代码定义

| Code | Description | Range | 适用场景 |
|------|-------------|-------|----------|
| `NO CODE` | 常温 Normal atmospheric temperature | -20~80°C | 标准环境 |
| `T1` | 低温 Low T1 | -40~80°C | 轻度低温 |
| `T2` | 低温 Low T2 | -50~80°C | 中度低温 |
| `T3` | 低温 Low T3 | -60~80°C | 极端低温 |
| `M` | 高温 High Temp | -20~120°C | 高温环境 |

---

## 📊 数据示例

### 示例 1: AT-DA63 型号（支持所有温度等级）

```javascript
{
  model_base: "AT-DA63",
  series: "AT",
  mechanism: "Rack & Pinion",
  body_size: "63",
  action_type: "DA",
  
  temperature_options: [
    {
      code: "NO CODE",
      description: "常温 Normal atmospheric temperature",
      range: "-20~80°C"
    },
    {
      code: "T1",
      description: "低温 Low T1",
      range: "-40~80°C"
    },
    {
      code: "T2",
      description: "低温 Low T2",
      range: "-50~80°C"
    },
    {
      code: "T3",
      description: "低温 Low T3",
      range: "-60~80°C"
    },
    {
      code: "M",
      description: "高温 High Temp",
      range: "-20~120°C"
    }
  ],
  
  pricing: {
    base_price_normal: 90,
    base_price_low: 93,
    base_price_high: 110,
    manual_override_model: "SD-1",
    manual_override_price: 127
  }
}
```

### 示例 2: SF10-DA-SY 型号（仅支持常温）

```javascript
{
  model_base: "SF10-DA-SY",
  series: "SF",
  mechanism: "Scotch Yoke",
  body_size: "10",
  action_type: "DA",
  
  temperature_options: [
    {
      code: "NO CODE",
      description: "常温 Normal atmospheric temperature",
      range: "-20~80°C"
    }
  ],
  
  base_price: 8500
}
```

### 示例 3: GY-75 型号（支持部分温度等级）

```javascript
{
  model_base: "GY-75",
  series: "GY",
  mechanism: "Rack & Pinion",
  body_size: "75",
  action_type: "DA",
  
  temperature_options: [
    {
      code: "NO CODE",
      description: "常温 Normal atmospheric temperature",
      range: "-20~80°C"
    },
    {
      code: "T1",
      description: "低温 Low T1",
      range: "-40~80°C"
    },
    {
      code: "M",
      description: "高温 High Temp",
      range: "-20~120°C"
    }
  ],
  
  pricing: {
    base_price_normal: 1340,
    base_price_low: 1340,
    base_price_high: 1340
  }
}
```

---

## 🔧 使用方法

### 1. 创建新执行器时添加温度选项

```javascript
const Actuator = require('./models/Actuator');

const newActuator = await Actuator.create({
  model_base: "AT-DA63",
  series: "AT",
  mechanism: "Rack & Pinion",
  body_size: "63",
  action_type: "DA",
  base_price: 90,
  
  // 添加温度选项
  temperature_options: [
    {
      code: "No code",  // 会自动转为 "NO CODE"
      description: "常温 Normal atmospheric temperature",
      range: "-20~80°C"
    },
    {
      code: "t1",  // 会自动转为 "T1"
      description: "低温 Low T1",
      range: "-40~80°C"
    },
    {
      code: "m",  // 会自动转为 "M"
      description: "高温 High Temp",
      range: "-20~120°C"
    }
  ]
});

console.log(newActuator.temperature_options);
// [
//   { code: 'NO CODE', description: '常温...', range: '-20~80°C' },
//   { code: 'T1', description: '低温 Low T1', range: '-40~80°C' },
//   { code: 'M', description: '高温 High Temp', range: '-20~120°C' }
// ]
```

### 2. 查询支持特定温度代码的执行器

```javascript
// 查找支持 T1 温度等级的执行器
const t1Actuators = await Actuator.find({
  'temperature_options.code': 'T1',
  is_active: true
});

console.log(`找到 ${t1Actuators.length} 个支持 T1 温度的执行器`);
```

### 3. 更新现有执行器的温度选项

```javascript
// 为现有执行器添加温度选项
const actuator = await Actuator.findOne({ model_base: 'AT-DA63' });

actuator.temperature_options = [
  {
    code: 'NO CODE',
    description: '常温 Normal atmospheric temperature',
    range: '-20~80°C'
  },
  {
    code: 'T1',
    description: '低温 Low T1',
    range: '-40~80°C'
  },
  {
    code: 'T2',
    description: '低温 Low T2',
    range: '-50~80°C'
  },
  {
    code: 'T3',
    description: '低温 Low T3',
    range: '-60~80°C'
  },
  {
    code: 'M',
    description: '高温 High Temp',
    range: '-20~120°C'
  }
];

await actuator.save();
console.log('温度选项已更新');
```

### 4. 添加单个温度选项

```javascript
const actuator = await Actuator.findOne({ model_base: 'AT-DA63' });

// 添加新的温度选项
actuator.temperature_options.push({
  code: 'T3',
  description: '低温 Low T3',
  range: '-60~80°C'
});

await actuator.save();
```

### 5. 检查是否支持特定温度代码

```javascript
const actuator = await Actuator.findOne({ model_base: 'AT-DA63' });

// 检查是否支持 T2
const supportsT2 = actuator.temperature_options.some(
  option => option.code === 'T2'
);

if (supportsT2) {
  console.log('此型号支持 T2 温度等级');
} else {
  console.log('此型号不支持 T2 温度等级');
}
```

---

## 🔄 批量导入数据

### 更新导入脚本 (seed_at_gy_final.js)

```javascript
// 在导入脚本中添加温度选项数据

// 定义标准温度选项
const STANDARD_TEMP_OPTIONS = [
  {
    code: 'NO CODE',
    description: '常温 Normal atmospheric temperature',
    range: '-20~80°C'
  },
  {
    code: 'T1',
    description: '低温 Low T1',
    range: '-40~80°C'
  },
  {
    code: 'T2',
    description: '低温 Low T2',
    range: '-50~80°C'
  },
  {
    code: 'T3',
    description: '低温 Low T3',
    range: '-60~80°C'
  },
  {
    code: 'M',
    description: '高温 High Temp',
    range: '-20~120°C'
  }
];

// AT 系列支持所有温度等级
const AT_TEMP_OPTIONS = [...STANDARD_TEMP_OPTIONS];

// GY 系列支持常温和部分温度等级
const GY_TEMP_OPTIONS = [
  STANDARD_TEMP_OPTIONS[0],  // NO CODE
  STANDARD_TEMP_OPTIONS[1],  // T1
  STANDARD_TEMP_OPTIONS[4]   // M
];

// SF 系列仅支持常温
const SF_TEMP_OPTIONS = [
  STANDARD_TEMP_OPTIONS[0]   // NO CODE
];

// 在导入时根据系列添加温度选项
const actuatorData = {
  model_base: row['model_base'],
  series: row['series'],
  mechanism: row['mechanism'],
  action_type: row['action_type'],
  
  // 根据系列添加温度选项
  temperature_options: 
    row['series'] === 'AT' ? AT_TEMP_OPTIONS :
    row['series'] === 'GY' ? GY_TEMP_OPTIONS :
    row['series'] === 'SF' ? SF_TEMP_OPTIONS :
    [STANDARD_TEMP_OPTIONS[0]],  // 默认仅常温
  
  pricing: {
    base_price_normal: Number(row['base_price_normal']),
    base_price_low: Number(row['base_price_low']),
    base_price_high: Number(row['base_price_high']),
    // ...
  }
};

await Actuator.create(actuatorData);
```

---

## 🎨 前端集成

### 1. 获取可用温度选项

```javascript
// selectionAPI.js 或在组件中

// 获取特定型号支持的温度选项
const getTemperatureOptions = async (modelBase) => {
  const response = await axios.get(`/api/actuators/${modelBase}`);
  return response.data.temperature_options || [];
};

// 使用示例
const options = await getTemperatureOptions('AT-DA63');
console.log(options);
// [
//   { code: 'NO CODE', description: '常温...', range: '-20~80°C' },
//   { code: 'T1', description: '低温 Low T1', range: '-40~80°C' },
//   ...
// ]
```

### 2. 动态渲染温度选择器

```jsx
import { Select } from 'antd';
import { useState, useEffect } from 'react';

const TemperatureSelector = ({ actuatorId }) => {
  const [tempOptions, setTempOptions] = useState([]);
  
  useEffect(() => {
    // 获取该执行器支持的温度选项
    const fetchOptions = async () => {
      const response = await axios.get(`/api/actuators/${actuatorId}`);
      setTempOptions(response.data.temperature_options || []);
    };
    
    if (actuatorId) {
      fetchOptions();
    }
  }, [actuatorId]);
  
  return (
    <Form.Item
      label="使用温度 (Temperature)"
      name="temperature_code"
    >
      <Select placeholder="选择温度等级">
        {tempOptions.map(option => (
          <Select.Option 
            key={option.code} 
            value={option.code}
          >
            {option.description} ({option.range})
          </Select.Option>
        ))}
      </Select>
    </Form.Item>
  );
};
```

### 3. 验证用户选择的温度代码

```javascript
// 后端验证
const validateTemperatureCode = async (actuatorId, temperatureCode) => {
  const actuator = await Actuator.findById(actuatorId);
  
  if (!actuator) {
    return { valid: false, message: '执行器不存在' };
  }
  
  const isSupported = actuator.temperature_options.some(
    option => option.code === temperatureCode.toUpperCase()
  );
  
  if (!isSupported) {
    return { 
      valid: false, 
      message: `该型号不支持温度代码 ${temperatureCode}` 
    };
  }
  
  return { valid: true };
};

// 在选型 API 中使用
const { valid, message } = await validateTemperatureCode(
  selectedActuator._id,
  req.body.temperature_code
);

if (!valid) {
  return res.status(400).json({ success: false, message });
}
```

---

## 📄 API 端点建议

### 1. 获取执行器的温度选项

```javascript
// GET /api/actuators/:id/temperature-options

router.get('/actuators/:id/temperature-options', async (req, res) => {
  try {
    const actuator = await Actuator.findById(req.params.id);
    
    if (!actuator) {
      return res.status(404).json({
        success: false,
        message: '执行器不存在'
      });
    }
    
    res.json({
      success: true,
      data: actuator.temperature_options || []
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: '获取温度选项失败',
      error: error.message
    });
  }
});
```

### 2. 查询支持特定温度代码的所有执行器

```javascript
// GET /api/actuators/by-temperature/:code

router.get('/actuators/by-temperature/:code', async (req, res) => {
  try {
    const { code } = req.params;
    
    const actuators = await Actuator.find({
      'temperature_options.code': code.toUpperCase(),
      is_active: true
    });
    
    res.json({
      success: true,
      count: actuators.length,
      data: actuators
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: '查询失败',
      error: error.message
    });
  }
});
```

---

## 📊 在规格书和报价单中显示

### 技术规格书 (PDF)

```javascript
// pdfGenerator.js

const generateSelectionSpecPDF = (selection) => {
  // ...
  
  // 显示温度信息
  const tempOption = selection.selected_actuator.temperature_options?.find(
    opt => opt.code === selection.temperature_code
  );
  
  if (tempOption) {
    doc.text(`温度等级: ${tempOption.description}`, 20, yPosition);
    yPosition += 10;
    doc.text(`温度范围: ${tempOption.range}`, 20, yPosition);
    yPosition += 15;
  } else if (selection.temperature_code) {
    doc.text(`温度代码: ${selection.temperature_code}`, 20, yPosition);
    yPosition += 15;
  }
  
  // ...
};
```

### 报价单描述

```javascript
// 在产品描述中包含温度代码
const getProductDescription = (actuator, temperatureCode) => {
  const tempOption = actuator.temperature_options?.find(
    opt => opt.code === temperatureCode
  );
  
  if (tempOption && temperatureCode !== 'NO CODE') {
    return `${actuator.model_base} (${tempOption.description})`;
  }
  
  return actuator.model_base;
};

// 使用示例
const description = getProductDescription(actuator, 'T1');
// 结果: "AT-DA63 (低温 Low T1)"
```

---

## 🧪 测试用例

### 测试 1: 创建带温度选项的执行器

```javascript
describe('Temperature Options', () => {
  it('should create actuator with temperature options', async () => {
    const actuator = await Actuator.create({
      model_base: 'TEST-DA-100',
      series: 'AT',
      mechanism: 'Rack & Pinion',
      body_size: '100',
      action_type: 'DA',
      temperature_options: [
        { code: 'no code', description: '常温', range: '-20~80°C' },
        { code: 't1', description: '低温 T1', range: '-40~80°C' }
      ]
    });
    
    expect(actuator.temperature_options).toHaveLength(2);
    expect(actuator.temperature_options[0].code).toBe('NO CODE');
    expect(actuator.temperature_options[1].code).toBe('T1');
  });
});
```

### 测试 2: 查询支持特定温度的执行器

```javascript
it('should find actuators supporting T1', async () => {
  const actuators = await Actuator.find({
    'temperature_options.code': 'T1'
  });
  
  expect(actuators.length).toBeGreaterThan(0);
  actuators.forEach(act => {
    const supportsT1 = act.temperature_options.some(
      opt => opt.code === 'T1'
    );
    expect(supportsT1).toBe(true);
  });
});
```

---

## ✅ 最佳实践

### 1. 代码一致性

- ✅ 始终使用大写代码（Schema 会自动转换）
- ✅ 使用标准代码：`NO CODE`, `T1`, `T2`, `T3`, `M`
- ✅ 保持描述格式一致

### 2. 数据完整性

- ✅ 至少包含 `NO CODE` (常温) 选项
- ✅ 按温度等级顺序排列
- ✅ 确保 range 格式统一 (`-XX~YY°C`)

### 3. 查询优化

```javascript
// 推荐：使用索引字段查询
await Actuator.find({ 
  'temperature_options.code': 'T1',
  series: 'AT',
  is_active: true 
});

// 避免：在应用层过滤
const all = await Actuator.find();
const filtered = all.filter(act => 
  act.temperature_options.some(opt => opt.code === 'T1')
);
```

### 4. 错误处理

```javascript
// 检查温度选项是否存在
const actuator = await Actuator.findOne({ model_base: 'AT-DA63' });

if (!actuator.temperature_options || actuator.temperature_options.length === 0) {
  // 使用默认温度选项
  actuator.temperature_options = [
    {
      code: 'NO CODE',
      description: '常温 Normal atmospheric temperature',
      range: '-20~80°C'
    }
  ];
  await actuator.save();
}
```

---

## 📝 待办事项

### 短期
- [ ] 更新数据导入脚本，为现有数据添加温度选项
- [ ] 创建 API 端点获取温度选项
- [ ] 前端动态渲染支持的温度选项

### 中期
- [ ] 在 PDF 生成中显示温度信息
- [ ] 添加温度代码验证
- [ ] 创建温度选项管理界面

### 长期
- [ ] 温度选项与价格关联分析
- [ ] 温度选项使用统计
- [ ] 智能推荐合适的温度等级

---

## 🎉 总结

`temperature_options` 字段已成功添加到 Actuator 模型中！

**关键优势**:
- 📊 **结构化数据**: 每个温度等级都有详细信息
- 🔍 **易于查询**: 可快速查找支持特定温度的型号
- 📄 **完整文档**: 代码、描述、范围一应俱全
- 🎯 **灵活扩展**: 可轻松添加新的温度等级

**下一步**: 更新数据导入脚本，为现有执行器添加温度选项数据。

---

**完成时间**: 2025-10-27  
**状态**: ✅ Production Ready

