# AI优化建议功能说明

## 📋 功能概述

在BOM清单页面新增了"AI优化建议"功能，可以调用OpenAI API对当前的BOM清单进行智能分析，并提供优化建议。

## 🎯 功能特性

- **智能分析**: 基于OpenAI GPT模型分析BOM清单
- **多维度建议**: 从成本、型号整合、技术风险、供应链、维护等方面提供建议
- **美观界面**: 使用Modal展示AI建议，支持滚动查看长文本
- **错误处理**: 完善的错误提示和异常处理机制
- **加载状态**: 清晰的加载动画和状态提示

## 📁 文件结构

### 后端文件

```
backend/
├── controllers/
│   └── aiController.js          # AI控制器（新建）
├── routes/
│   └── aiRoutes.js              # AI路由（新建）
└── server.js                     # 注册AI路由（已更新）
```

### 前端文件

```
frontend/
└── src/
    ├── services/
    │   └── api.js               # 添加aiAPI（已更新）
    └── pages/
        └── ProjectDetails.jsx   # 添加AI按钮和Modal（已更新）
```

## 🔧 配置步骤

### 1. 安装依赖（已包含）

后端已包含 `axios` 依赖，无需额外安装。

### 2. 配置OpenAI API密钥

在后端根目录的 `.env` 文件中添加以下配置：

```bash
# OpenAI API配置
OPENAI_API_KEY=sk-your-api-key-here
OPENAI_MODEL=gpt-4o-mini
```

**获取API密钥步骤：**

1. 访问 [OpenAI Platform](https://platform.openai.com/)
2. 注册/登录账号
3. 进入 API Keys 页面创建新密钥
4. 复制密钥并粘贴到 `.env` 文件中

**模型选择建议：**

- `gpt-4o-mini`: 推荐使用，成本低，速度快，质量高
- `gpt-4o`: 最新旗舰模型，质量最高但成本较高
- `gpt-4-turbo`: GPT-4系列的高性价比版本
- `gpt-3.5-turbo`: 成本最低，速度最快，适合高频调用

### 3. 重启后端服务

```bash
cd backend
npm run dev
# 或
npm start
```

## 🚀 使用方法

### 前端操作流程

1. 登录系统并进入项目详情页
2. 切换到"BOM清单"标签页
3. 确保BOM清单中有数据（可以通过"从选型自动生成"或"手动添加行"添加）
4. 点击"AI优化建议"按钮（紫色渐变按钮，带灯泡图标）
5. 等待AI分析（通常5-15秒）
6. 在弹出的Modal中查看AI建议
7. 根据建议对BOM清单进行调整

### 按钮位置

在BOM清单页面的功能按钮区，位于"历史版本与对比"按钮之后：

```
[从选型自动生成] [手动添加行] [保存BOM] [导出BOM ▼] 
[生成报价单PDF] [历史版本与对比] [AI优化建议] [清空BOM]
```

## 📊 API接口说明

### POST /api/ai/optimize-bom

**请求体：**

```json
{
  "bomData": [
    {
      "actuator_model": "SF050-DA",
      "total_quantity": 5,
      "unit_price": 2500,
      "total_price": 12500,
      "covered_tags": ["V001", "V002"],
      "notes": "标准配置"
    }
  ],
  "projectInfo": {
    "projectNumber": "PRJ-2024-001",
    "projectName": "石化项目",
    "client": {
      "name": "某某公司"
    },
    "industry": "石油化工",
    "application": "阀门控制"
  }
}
```

**响应：**

```json
{
  "success": true,
  "data": {
    "suggestion": "AI生成的优化建议内容...",
    "usage": {
      "prompt_tokens": 500,
      "completion_tokens": 800,
      "total_tokens": 1300
    },
    "model": "gpt-4o-mini",
    "timestamp": "2024-01-01T12:00:00.000Z"
  }
}
```

### GET /api/ai/status

检查AI服务配置状态。

**响应：**

```json
{
  "configured": true,
  "model": "gpt-4o-mini",
  "ready": true
}
```

## ⚠️ 错误处理

### 常见错误及解决方案

| 错误类型 | 原因 | 解决方案 |
|---------|------|---------|
| API密钥未配置 | `.env`中未设置`OPENAI_API_KEY` | 添加有效的API密钥 |
| API密钥无效 | 密钥格式错误或已失效 | 检查密钥是否正确，重新生成 |
| 配额不足 | OpenAI账户余额不足 | 充值或更换账户 |
| 请求超时 | 网络问题或API响应慢 | 检查网络，稍后重试 |
| 速率限制 | 请求过于频繁 | 等待片刻后重试 |

### 错误提示示例

前端会根据不同的错误类型显示相应的提示信息：

- **401错误**: "OpenAI API密钥无效，请联系管理员配置"
- **429错误**: "API请求过于频繁或配额不足"
- **504错误**: "AI服务响应超时，请稍后重试"

## 💰 成本估算

使用 `gpt-4o-mini` 模型的成本估算：

- 输入: $0.15 / 1M tokens
- 输出: $0.60 / 1M tokens

每次BOM分析约消耗：
- 输入tokens: 500-1000
- 输出tokens: 800-1500
- 单次成本: 约 $0.001-0.002 (约0.007-0.014元人民币)

**月度成本估算：**
- 每天分析10次 × 30天 = 300次/月
- 月度成本: 约 $0.30-0.60 (约2-4元人民币)

## 🎨 UI界面

### AI优化建议按钮

- **样式**: 紫色渐变背景 (#667eea → #764ba2)
- **图标**: 灯泡图标 (BulbOutlined)
- **文字**: "AI优化建议"
- **禁用条件**: BOM清单为空时禁用

### AI建议Modal

- **标题**: 机器人图标 + "AI 优化建议"
- **宽度**: 900px
- **最大高度**: 70vh，超出自动滚动
- **加载状态**: 显示Spin动画和提示文字
- **内容区**: 灰色背景卡片，保留换行和格式
- **提示信息**: 蓝色提示框说明建议仅供参考
- **使用指南**: 绿色提示框提供具体使用步骤

## 🔐 安全考虑

1. **API密钥保护**: 密钥存储在后端`.env`文件中，不暴露给前端
2. **权限控制**: 所有AI接口都需要用户认证（通过auth中间件）
3. **数据隐私**: 发送给OpenAI的数据仅包含BOM清单和项目基本信息
4. **超时设置**: API调用设置60秒超时，避免长时间等待
5. **错误日志**: 后端记录详细的错误日志，便于排查问题

## 📝 提示词优化

AI分析基于以下提示词结构：

**系统提示词:**
```
你是一位专业的工业自动化设备采购顾问，擅长执行器选型和BOM优化。
你需要分析客户的BOM清单，并提供专业的优化建议。
```

**用户提示词包含:**
1. 项目基本信息（项目编号、名称、客户、行业、应用场景）
2. BOM清单详细数据（型号、数量、价格、备注）
3. 分析维度要求（成本、型号整合、技术风险、供应链、维护）

## 🚀 扩展建议

### 未来可优化方向

1. **建议历史记录**: 保存AI建议到数据库，方便回顾
2. **批量分析**: 支持对多个项目进行批量分析
3. **建议采纳跟踪**: 记录哪些建议被采纳，分析效果
4. **自定义提示词**: 允许管理员自定义分析维度和提示词
5. **对比分析**: 将AI建议与实际优化结果进行对比
6. **导出报告**: 将AI建议导出为PDF或Word文档

## 📞 技术支持

如遇到问题，请检查：

1. ✅ OpenAI API密钥是否正确配置
2. ✅ 后端服务是否正常运行
3. ✅ 网络连接是否正常
4. ✅ OpenAI账户是否有足够余额
5. ✅ BOM清单数据是否完整

## 📚 相关文档

- [OpenAI API文档](https://platform.openai.com/docs/api-reference)
- [GPT模型定价](https://openai.com/pricing)
- [Ant Design Modal组件](https://ant.design/components/modal-cn/)

---

**更新日期**: 2024-10-27
**版本**: v1.0.0
