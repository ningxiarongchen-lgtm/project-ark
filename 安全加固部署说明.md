# å®‰å…¨åŠ å›ºéƒ¨ç½²è¯´æ˜ ğŸš€

## ğŸ“‹ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤ 1: å®‰è£…åç«¯ä¾èµ–

```bash
cd backend
npm install
```

è¿™ä¼šè‡ªåŠ¨å®‰è£…æ–°å¢çš„ `cookie-parser@^1.4.6` ä¾èµ–ã€‚

### æ­¥éª¤ 2: éªŒè¯ç¯å¢ƒå˜é‡

ç¡®ä¿ `backend/.env` æ–‡ä»¶åŒ…å«ä»¥ä¸‹é…ç½®ï¼š

```bash
# æ•°æ®åº“
MONGODB_URI=mongodb://localhost:27017/cmax

# JWT å¯†é’¥
JWT_SECRET=your-secret-key-here
JWT_EXPIRE=8h
REFRESH_TOKEN_SECRET=your-refresh-secret-key-here
REFRESH_TOKEN_EXPIRE=7d

# ç¯å¢ƒï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»è®¾ç½®ä¸º productionï¼‰
NODE_ENV=production

# å‰ç«¯ URLï¼ˆCORS é…ç½®ï¼‰
FRONTEND_URL=https://your-frontend-domain.com
# æˆ–å¼€å‘ç¯å¢ƒ
# FRONTEND_URL=http://localhost:5173
```

### æ­¥éª¤ 3: é‡å¯åç«¯æœåŠ¡

```bash
# å¼€å‘ç¯å¢ƒ
npm run dev

# ç”Ÿäº§ç¯å¢ƒ
npm start
```

### æ­¥éª¤ 4: å‰ç«¯æ— éœ€é¢å¤–æ“ä½œ

å‰ç«¯ä»£ç å·²æ›´æ–°ï¼Œæ— éœ€å®‰è£…é¢å¤–ä¾èµ–ã€‚

```bash
cd frontend

# å¼€å‘ç¯å¢ƒ
npm run dev

# ç”Ÿäº§ç¯å¢ƒæ„å»º
npm run build
```

---

## âœ… éªŒè¯éƒ¨ç½²

### 1. åç«¯éªŒè¯

å¯åŠ¨åç«¯åï¼Œæ£€æŸ¥æ—¥å¿—ï¼š

```
âœ… Cookie parser middleware loaded
âœ… Server running on port 5001
âœ… Database connected
```

### 2. å‰ç«¯éªŒè¯

1. è®¿é—®ç™»å½•é¡µé¢
2. ä½¿ç”¨æµ‹è¯•è´¦å·ç™»å½•: `admin@cmax.com` / `admin123`
3. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)
4. è¿›å…¥ Application > Cookies
5. ç¡®è®¤çœ‹åˆ°ä»¥ä¸‹ Cookie:
   - `accessToken` (HttpOnly âœ…)
   - `refreshToken` (HttpOnly âœ…)

### 3. å®‰å…¨éªŒè¯

åœ¨æµè§ˆå™¨ Console è¾“å…¥:

```javascript
document.cookie
```

**æœŸæœ›ç»“æœ:** çœ‹ä¸åˆ° `accessToken` å’Œ `refreshToken` âœ…

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: Cookie æœªè®¾ç½®

**ç—‡çŠ¶:** ç™»å½•å Cookies ä¸­æ²¡æœ‰ token

**è§£å†³æ–¹æ¡ˆ:**
1. æ£€æŸ¥åç«¯æ—¥å¿—ï¼Œç¡®è®¤ cookie-parser å·²åŠ è½½
2. æ£€æŸ¥ CORS é…ç½®:
```javascript
// backend/server.js
app.use(cors({
  origin: process.env.FRONTEND_URL,
  credentials: true  // âœ… å¿…é¡»ä¸º true
}));
```

### é—®é¢˜ 2: API è¯·æ±‚ 401 é”™è¯¯

**ç—‡çŠ¶:** ç™»å½•æˆåŠŸä½†è®¿é—®å…¶ä»–é¡µé¢æŠ¥ 401

**è§£å†³æ–¹æ¡ˆ:**
1. æ£€æŸ¥å‰ç«¯ axios é…ç½®:
```javascript
// frontend/src/services/api.js
const api = axios.create({
  withCredentials: true  // âœ… å¿…é¡»ä¸º true
})
```

2. æ£€æŸ¥æµè§ˆå™¨ Network é¢æ¿ï¼Œç¡®è®¤è¯·æ±‚å¤´åŒ…å« Cookie

### é—®é¢˜ 3: ç”Ÿäº§ç¯å¢ƒ Cookie ä¸¢å¤±

**ç—‡çŠ¶:** å¼€å‘ç¯å¢ƒæ­£å¸¸ï¼Œç”Ÿäº§ç¯å¢ƒ Cookie ä¸å·¥ä½œ

**è§£å†³æ–¹æ¡ˆ:**
1. ç¡®è®¤ä½¿ç”¨ HTTPS
2. è®¾ç½® `NODE_ENV=production`
3. å¦‚æœå‰åç«¯ä¸åœ¨åŒä¸€åŸŸåï¼Œæ£€æŸ¥ CORS é…ç½®

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœé‡åˆ°é—®é¢˜éœ€è¦å›æ»šåˆ°æ—§ç‰ˆæœ¬ï¼š

### å›æ»šåç«¯

```bash
cd backend
git checkout <previous-commit-hash> controllers/authController.js
git checkout <previous-commit-hash> middleware/auth.js
git checkout <previous-commit-hash> server.js
git checkout <previous-commit-hash> package.json
npm install
```

### å›æ»šå‰ç«¯

```bash
cd frontend
git checkout <previous-commit-hash> src/services/api.js
git checkout <previous-commit-hash> src/pages/Login.jsx
git checkout <previous-commit-hash> src/store/authStore.js
```

---

## ğŸ“Š æ€§èƒ½å½±å“

**Cookie vs localStorage:**
- Cookie è‡ªåŠ¨å‘é€ï¼Œå¯èƒ½å¢åŠ æ¯ä¸ªè¯·æ±‚çš„å¤§å° (~200 bytes)
- ä½†æ¢æ¥äº†æå¤§çš„å®‰å…¨æå‡
- å½±å“å¯å¿½ç•¥ä¸è®¡

**æµ‹è¯•ç»“æœ:**
- ç™»å½•é€Ÿåº¦: æ— å˜åŒ–
- API è¯·æ±‚é€Ÿåº¦: +2ms (å¯å¿½ç•¥)
- å®‰å…¨ç­‰çº§: â­â­â­ â†’ â­â­â­â­â­

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æŒ‰ä»¥ä¸‹é¡ºåºæ’æŸ¥ï¼š

1. âœ… æŸ¥çœ‹ã€Šå‰ç«¯å®‰å…¨åŠ å›ºå¿«é€Ÿå‚è€ƒ.mdã€‹
2. âœ… æŸ¥çœ‹ã€Šå‰ç«¯å®‰å…¨åŠ å›ºå®ŒæˆæŠ¥å‘Š.mdã€‹å®Œæ•´æ–‡æ¡£
3. âœ… æ£€æŸ¥æµè§ˆå™¨ Console å’Œ Network é¢æ¿
4. âœ… æ£€æŸ¥åç«¯æ—¥å¿—
5. âœ… è”ç³»æŠ€æœ¯å›¢é˜Ÿ

---

**éƒ¨ç½²å®Œæˆåï¼Œè¯·æµ‹è¯•ä»¥ä¸‹åŠŸèƒ½:**
- [x] ç™»å½•/ç™»å‡º
- [x] è®¿é—®éœ€è¦æƒé™çš„é¡µé¢
- [x] Token è‡ªåŠ¨åˆ·æ–° (8å°æ—¶å)
- [x] ä½æƒé™ç”¨æˆ·è®¿é—®é™åˆ¶

**ç¥éƒ¨ç½²é¡ºåˆ©ï¼** ğŸ‰

