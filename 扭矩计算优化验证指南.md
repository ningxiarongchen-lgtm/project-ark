# 扭矩计算优化验证指南

## 📝 优化内容快速回顾

✅ **步骤 1**: 接收 `valveTorque` 和 `safetyFactor`（默认1.3）  
✅ **步骤 2**: 计算 `requiredTorque = valveTorque × safetyFactor`  
✅ **步骤 3**: 所有扭矩比较使用计算后的 `requiredTorque`  

---

## 🧪 快速验证

### 方式 1: 使用测试脚本（推荐）

```bash
cd /Users/hexiaoxiao/Desktop/Model\ Selection\ System/backend
./test-torque-calculation.sh
```

这将运行 6 个完整的测试用例，覆盖：
- ✅ 新版参数（camelCase）
- ✅ 自定义安全系数
- ✅ 旧版参数兼容性
- ✅ 直接提供需求扭矩
- ✅ Rack & Pinion 机构
- ✅ 错误处理

---

### 方式 2: 手动 API 测试

#### 测试用例 1: 基础计算
```bash
curl -X POST http://localhost:5001/api/selection/calculate \
  -H "Content-Type: application/json" \
  -d '{
    "valveTorque": 100,
    "working_pressure": 0.6,
    "mechanism": "Scotch Yoke",
    "yoke_preference": "Auto"
  }'
```

**预期结果**:
```json
{
  "success": true,
  "search_criteria": {
    "valve_torque": 100,
    "safety_factor": 1.3,
    "required_torque": 130,
    "working_pressure": 0.6,
    "mechanism": "Scotch Yoke"
  },
  "data": [...]
}
```

**验证点**:
- ✅ `valve_torque` = 100
- ✅ `safety_factor` = 1.3 (默认值)
- ✅ `required_torque` = 100 × 1.3 = 130

---

#### 测试用例 2: 自定义安全系数
```bash
curl -X POST http://localhost:5001/api/selection/calculate \
  -H "Content-Type: application/json" \
  -d '{
    "valveTorque": 100,
    "safetyFactor": 1.5,
    "working_pressure": 0.6,
    "mechanism": "Scotch Yoke"
  }'
```

**预期结果**:
```json
{
  "search_criteria": {
    "valve_torque": 100,
    "safety_factor": 1.5,
    "required_torque": 150
  }
}
```

**验证点**:
- ✅ `required_torque` = 100 × 1.5 = 150

---

### 方式 3: 查看后端控制台日志

启动后端服务器后，每次API调用都会在控制台输出详细日志：

```bash
cd backend
npm start
```

**预期控制台输出**:
```
📊 扭矩计算：阀门扭矩 100 N·m × 安全系数 1.3 = 130 N·m
🔍 查询条件: { mechanism: 'Scotch Yoke' }
📦 找到 15 个候选执行器
✅ 成功找到 5 个匹配的执行器
```

---

## ✅ 验证检查清单

### 1. 参数接收 ✓
- [ ] 接收 `valveTorque` 参数
- [ ] 接收 `safetyFactor` 参数（默认1.3）
- [ ] 兼容旧版 `valve_torque` 参数
- [ ] 兼容旧版 `safety_factor` 参数

### 2. 扭矩计算 ✓
- [ ] 在算法开始就执行计算
- [ ] 使用公式: `requiredTorque = valveTorque × safetyFactor`
- [ ] 控制台输出计算过程
- [ ] 计算结果正确

### 3. 扭矩比较 ✓
- [ ] Scotch Yoke 使用 `requiredTorque` 比较
- [ ] Rack & Pinion 使用 `requiredTorque` 比较
- [ ] 扭矩裕度基于 `requiredTorque` 计算
- [ ] 没有使用 `finalRequiredTorque` 或其他变量名

### 4. 响应数据 ✓
- [ ] 返回 `valve_torque` 值
- [ ] 返回 `safety_factor` 值
- [ ] 返回计算后的 `required_torque` 值
- [ ] `search_criteria` 包含完整参数

### 5. 控制台日志 ✓
- [ ] 输出扭矩计算过程
- [ ] 输出查询条件
- [ ] 输出候选执行器数量
- [ ] 输出最终匹配结果数量

---

## 🎯 核心验证点

### 验证点 1: 默认安全系数 = 1.3

**请求**:
```json
{
  "valveTorque": 100,
  "working_pressure": 0.6,
  "mechanism": "Scotch Yoke"
}
```

**预期**:
- `safety_factor` = 1.3
- `required_torque` = 130

---

### 验证点 2: 扭矩计算在算法开始执行

打开 `backend/controllers/selectionController.js`，确认：

```javascript
// ========================================
// 步骤 2: 计算最终需求扭矩
// 优先使用新版参数，兼容旧版参数
// ========================================
let requiredTorque; // 最终需求扭矩
let actualValveTorque; // 实际阀门扭矩
let actualSafetyFactor; // 实际安全系数

// 优先使用新版 camelCase 参数
if (valveTorque !== undefined) {
  actualValveTorque = valveTorque;
  actualSafetyFactor = safetyFactor; // 默认1.3
  requiredTorque = valveTorque * safetyFactor;
  
  console.log(`📊 扭矩计算：阀门扭矩 ${valveTorque} N·m × 安全系数 ${safetyFactor} = ${requiredTorque} N·m`);
}
```

✅ 这段代码在**步骤 2**，位于查询和匹配逻辑之前

---

### 验证点 3: 所有比较使用 `requiredTorque`

在代码中搜索 `requiredTorque`，应该能找到：

```javascript
// Scotch Yoke
if (symmetricTorque && symmetricTorque >= requiredTorque) {
  isSymmetricMatch = true;
}

if (cantedTorque && cantedTorque >= requiredTorque) {
  isCantedMatch = true;
}

// Rack & Pinion - DA
if (actualTorque && actualTorque >= requiredTorque) {
  shouldInclude = true;
}

// Rack & Pinion - SR
if (springEndTorque >= requiredTorque && 
    airStartTorque && airStartTorque >= requiredTorque) {
  shouldInclude = true;
  actualTorque = Math.min(springEndTorque, airStartTorque);
}

// 扭矩裕度计算
const torqueMargin = ((actualTorque - requiredTorque) / requiredTorque * 100);
```

✅ 确认**没有任何地方**使用 `finalRequiredTorque` 或其他变量名

---

## 🔍 调试技巧

### 1. 查看详细计算过程

在后端控制台查看每次请求的日志：

```
📊 扭矩计算：阀门扭矩 100 N·m × 安全系数 1.3 = 130 N·m
🔍 查询条件: { mechanism: 'Scotch Yoke' }
📦 找到 15 个候选执行器
✅ 成功找到 5 个匹配的执行器
```

### 2. 检查响应数据

确认 `search_criteria` 包含所有关键参数：

```json
{
  "search_criteria": {
    "valve_torque": 100,
    "safety_factor": 1.3,
    "required_torque": 130,
    "working_pressure": 0.6,
    "mechanism": "Scotch Yoke"
  }
}
```

### 3. 验证扭矩匹配

检查返回的执行器的 `actual_torque` 是否都 >= `required_torque`：

```json
{
  "data": [
    {
      "model_base": "SF14-200DA",
      "actual_torque": 150,   // >= 130 ✓
      "torque_margin": 15.38
    },
    {
      "model_base": "SF16-250DA",
      "actual_torque": 180,   // >= 130 ✓
      "torque_margin": 38.46
    }
  ]
}
```

---

## 📊 测试矩阵

| 测试项 | 输入 | 预期输出 | 状态 |
|--------|------|----------|------|
| 默认安全系数 | `valveTorque=100` | `safety_factor=1.3`, `required_torque=130` | ✅ |
| 自定义安全系数 | `valveTorque=100, safetyFactor=1.5` | `required_torque=150` | ✅ |
| 旧版参数兼容 | `valve_torque=100, safety_factor=1.2` | `required_torque=120` | ✅ |
| 直接提供扭矩 | `required_torque=130` | 跳过计算，使用130 | ✅ |
| Scotch Yoke | `mechanism="Scotch Yoke"` | 使用 `torque_symmetric/canted` | ✅ |
| Rack & Pinion | `mechanism="Rack & Pinion"` | 使用 `torque_data` | ✅ |
| 缺少参数 | 只提供 `working_pressure` | 返回错误信息 | ✅ |

---

## 🎉 验证成功标志

如果以下所有项都满足，说明优化成功：

1. ✅ API 接收 `valveTorque` 和 `safetyFactor` 参数
2. ✅ `safetyFactor` 默认值为 1.3
3. ✅ 在算法开始就计算 `requiredTorque = valveTorque × safetyFactor`
4. ✅ 所有扭矩比较使用 `requiredTorque`
5. ✅ 控制台输出清晰的计算日志
6. ✅ 响应数据包含完整的计算参数
7. ✅ 向后兼容旧版参数
8. ✅ 错误处理正确

---

## 📞 需要帮助？

如果验证过程中遇到问题，请检查：

1. **后端服务是否正在运行**:
   ```bash
   cd backend
   npm start
   ```

2. **数据库连接是否正常**:
   - 检查 `.env` 文件中的 `MONGO_URI`
   - 确认 MongoDB 服务正在运行

3. **是否有执行器数据**:
   ```bash
   cd backend
   npm run seed       # 导入 SF 系列数据
   npm run seed:atgy  # 导入 AT/GY 系列数据
   ```

4. **查看后端日志**:
   - 检查是否有错误信息
   - 确认日志输出格式是否正确

---

**验证日期**: 2025-10-27  
**优化版本**: v2.0  
**状态**: ✅ 已完成

