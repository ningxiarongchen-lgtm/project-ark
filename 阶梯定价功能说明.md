# 阶梯定价功能说明 💰

**文件**: `backend/models/Actuator.js`  
**完成时间**: 2025-10-27  
**版本**: v2.0  
**状态**: ✅ 完成

---

## 📋 概述

成功将 Actuator 模型的单一价格字段 (`base_price`) 替换为灵活的**阶梯定价系统** (`price_tiers`)，支持根据采购数量自动计算不同的单价。

---

## 🆕 新增字段

### `price_tiers` - 阶梯定价数组

**数据结构**:

```javascript
price_tiers: [{
  // 必需字段
  min_quantity: Number,     // 最小数量（起订量）≥1
  unit_price: Number,       // 该档位的单价 ≥0
  
  // 可选字段
  price_type: String,       // 'normal', 'low_temp', 'high_temp', 'standard'
  notes: String            // 备注说明
}]
```

---

## 📊 字段详解

### `min_quantity` - 最小数量

- **类型**: Number
- **必需**: ✅ 是
- **验证**: ≥1
- **说明**: 达到此数量时，可享受该档位价格

---

### `unit_price` - 单价

- **类型**: Number
- **必需**: ✅ 是
- **验证**: ≥0
- **说明**: 该数量档位的每件单价

---

### `price_type` - 价格类型

- **类型**: String
- **必需**: ❌ 否（默认: 'normal'）
- **枚举值**:
  - `normal` - 常规价格
  - `low_temp` - 低温型号价格
  - `high_temp` - 高温型号价格
  - `standard` - 标准价格
- **说明**: 用于区分不同变体的价格

---

### `notes` - 备注

- **类型**: String
- **必需**: ❌ 否
- **说明**: 该价格档位的说明信息

---

## 💡 使用示例

### 示例 1: 基础阶梯定价

```javascript
const actuator = new Actuator({
  model_base: 'SF10-150DA',
  series: 'SF',
  action_type: 'DA',
  
  // 阶梯定价配置
  price_tiers: [
    {
      min_quantity: 1,
      unit_price: 10000,
      price_type: 'normal',
      notes: '零售价'
    },
    {
      min_quantity: 5,
      unit_price: 9500,
      price_type: 'normal',
      notes: '5件以上享95折'
    },
    {
      min_quantity: 10,
      unit_price: 9000,
      price_type: 'normal',
      notes: '10件以上享9折'
    },
    {
      min_quantity: 50,
      unit_price: 8500,
      price_type: 'normal',
      notes: '50件以上享85折'
    }
  ]
})

await actuator.save()
```

---

### 示例 2: 多价格类型阶梯定价

```javascript
const actuator = new Actuator({
  model_base: 'SF10-150DA-T1',
  series: 'SF',
  action_type: 'DA',
  
  price_tiers: [
    // 常温型号价格
    { min_quantity: 1, unit_price: 10000, price_type: 'normal' },
    { min_quantity: 10, unit_price: 9000, price_type: 'normal' },
    
    // 低温型号价格
    { min_quantity: 1, unit_price: 10500, price_type: 'low_temp' },
    { min_quantity: 10, unit_price: 9450, price_type: 'low_temp' },
    
    // 高温型号价格
    { min_quantity: 1, unit_price: 11000, price_type: 'high_temp' },
    { min_quantity: 10, unit_price: 9900, price_type: 'high_temp' }
  ]
})

await actuator.save()
```

---

## 🔧 实例方法

### 1. `getPriceByQuantity(quantity, priceType)` - 获取价格

**用途**: 根据采购数量和价格类型，自动计算对应的单价和总价

**参数**:
- `quantity` (Number): 采购数量
- `priceType` (String, 可选): 价格类型，默认 'normal'

**返回值**:
```javascript
{
  unit_price: Number,      // 单价
  min_quantity: Number,    // 对应的最小数量档位
  total_price: Number,     // 总价 (unit_price × quantity)
  price_type: String,      // 价格类型
  notes: String,          // 备注
  warning: String         // 警告信息（如果有）
}
```

**示例**:

```javascript
const actuator = await Actuator.findOne({ model_base: 'SF10-150DA' })

// 查询采购3件的价格
const price3 = actuator.getPriceByQuantity(3)
console.log(price3)
// 输出:
// {
//   unit_price: 10000,
//   min_quantity: 1,
//   total_price: 30000,
//   price_type: 'normal',
//   notes: '零售价'
// }

// 查询采购12件的价格
const price12 = actuator.getPriceByQuantity(12)
console.log(price12)
// 输出:
// {
//   unit_price: 9000,
//   min_quantity: 10,
//   total_price: 108000,
//   price_type: 'normal',
//   notes: '10件以上享9折'
// }

// 查询低温型号采购5件的价格
const priceLowTemp = actuator.getPriceByQuantity(5, 'low_temp')
console.log(priceLowTemp)
// 输出:
// {
//   unit_price: 10500,
//   min_quantity: 1,
//   total_price: 52500,
//   price_type: 'low_temp'
// }
```

---

### 2. `getAllPriceTiers(priceType)` - 获取所有价格档位

**用途**: 获取所有价格档位信息（用于展示）

**参数**:
- `priceType` (String, 可选): 价格类型过滤器

**返回值**: 价格档位数组（按 min_quantity 从小到大排序）

**示例**:

```javascript
const actuator = await Actuator.findOne({ model_base: 'SF10-150DA' })

// 获取所有价格档位
const allTiers = actuator.getAllPriceTiers()
console.log(allTiers)
// 输出:
// [
//   { min_quantity: 1, unit_price: 10000, price_type: 'normal', notes: '零售价' },
//   { min_quantity: 5, unit_price: 9500, price_type: 'normal', notes: '5件以上享95折' },
//   { min_quantity: 10, unit_price: 9000, price_type: 'normal', notes: '10件以上享9折' },
//   { min_quantity: 50, unit_price: 8500, price_type: 'normal', notes: '50件以上享85折' }
// ]

// 仅获取低温型号的价格档位
const lowTempTiers = actuator.getAllPriceTiers('low_temp')
console.log(lowTempTiers)
// 输出:
// [
//   { min_quantity: 1, unit_price: 10500, price_type: 'low_temp' },
//   { min_quantity: 10, unit_price: 9450, price_type: 'low_temp' }
// ]
```

---

## 🔄 向后兼容

### 保留的 `pricing` 对象

为了向后兼容，原有的 `pricing` 对象被保留：

```javascript
pricing: {
  base_price_normal: Number,      // AT/GY系列标准价格
  base_price_low: Number,         // 低温价格
  base_price_high: Number,        // 高温价格
  manual_override_model: String,  // 手动操作装置型号
  manual_override_price: Number,  // 手动操作装置价格
  seal_kit_price: Number         // 密封套件价格
}
```

**迁移建议**:
- 新项目应使用 `price_tiers`
- 旧数据可以继续使用 `pricing` 对象
- 可以通过脚本将 `pricing` 数据迁移到 `price_tiers`

---

## 📈 实际应用场景

### 场景 1: 展示价格表

```javascript
// 前端展示价格表
const actuator = await Actuator.findById(actuatorId)
const tiers = actuator.getAllPriceTiers('normal')

// 渲染价格表
tiers.forEach(tier => {
  console.log(`数量 ≥${tier.min_quantity}: ¥${tier.unit_price}/件`)
})

// 输出:
// 数量 ≥1: ¥10,000/件
// 数量 ≥5: ¥9,500/件
// 数量 ≥10: ¥9,000/件
// 数量 ≥50: ¥8,500/件
```

---

### 场景 2: 购物车计算

```javascript
// 用户选择了执行器和数量
const cartItem = {
  actuator_id: 'actuator_id_here',
  quantity: 12,
  temperature_type: 'normal'
}

// 获取执行器
const actuator = await Actuator.findById(cartItem.actuator_id)

// 计算价格
const pricing = actuator.getPriceByQuantity(
  cartItem.quantity,
  cartItem.temperature_type
)

console.log(`单价: ¥${pricing.unit_price}`)
console.log(`数量: ${cartItem.quantity}`)
console.log(`总价: ¥${pricing.total_price}`)
console.log(`说明: ${pricing.notes}`)

// 输出:
// 单价: ¥9,000
// 数量: 12
// 总价: ¥108,000
// 说明: 10件以上享9折
```

---

### 场景 3: 优化BOM报价

```javascript
// 优化后的BOM
const optimizedBOM = [
  { actuator_model: 'SF10-150DA', quantity: 15 },
  { actuator_model: 'AT-DA63', quantity: 8 },
  { actuator_model: 'SF20-300SR', quantity: 3 }
]

// 计算每个项目的价格
for (const item of optimizedBOM) {
  const actuator = await Actuator.findOne({ model_base: item.actuator_model })
  const pricing = actuator.getPriceByQuantity(item.quantity)
  
  console.log(`${item.actuator_model}:`)
  console.log(`  数量: ${item.quantity}`)
  console.log(`  单价: ¥${pricing.unit_price}`)
  console.log(`  总价: ¥${pricing.total_price}`)
  console.log(`  档位: ${pricing.notes}`)
}

// 输出:
// SF10-150DA:
//   数量: 15
//   单价: ¥9,000
//   总价: ¥135,000
//   档位: 10件以上享9折
// AT-DA63:
//   数量: 8
//   单价: ¥150
//   总价: ¥1,200
//   档位: 5件以上享95折
// SF20-300SR:
//   数量: 3
//   单价: ¥15,000
//   总价: ¥45,000
//   档位: 零售价
```

---

### 场景 4: 批量采购折扣提示

```javascript
// 用户当前选择了8件
const currentQuantity = 8

const actuator = await Actuator.findById(actuatorId)
const currentPricing = actuator.getPriceByQuantity(currentQuantity)
const allTiers = actuator.getAllPriceTiers()

// 找到下一个价格档位
const nextTier = allTiers.find(tier => tier.min_quantity > currentQuantity)

if (nextTier) {
  const currentTotal = currentPricing.total_price
  const nextQuantity = nextTier.min_quantity
  const nextTotal = nextTier.unit_price * nextQuantity
  const savings = (currentPricing.unit_price * nextQuantity) - nextTotal
  
  console.log(`💡 温馨提示：`)
  console.log(`再购买 ${nextQuantity - currentQuantity} 件，即可享受更优惠的价格！`)
  console.log(`单价将从 ¥${currentPricing.unit_price} 降至 ¥${nextTier.unit_price}`)
  console.log(`购买 ${nextQuantity} 件可节省 ¥${savings}`)
}

// 输出:
// 💡 温馨提示：
// 再购买 2 件，即可享受更优惠的价格！
// 单价将从 ¥9,500 降至 ¥9,000
// 购买 10 件可节省 ¥5,000
```

---

## 🔧 数据迁移脚本

### 从 `base_price` 迁移到 `price_tiers`

```javascript
// migrate_price_tiers.js
const mongoose = require('mongoose')
const Actuator = require('./models/Actuator')

async function migratePriceTiers() {
  const actuators = await Actuator.find({
    base_price: { $exists: true },
    price_tiers: { $exists: false }
  })
  
  console.log(`找到 ${actuators.length} 个需要迁移的执行器`)
  
  for (const actuator of actuators) {
    // 创建基础价格档位
    actuator.price_tiers = [
      {
        min_quantity: 1,
        unit_price: actuator.base_price,
        price_type: 'normal',
        notes: '基础价格（从旧字段迁移）'
      },
      {
        min_quantity: 10,
        unit_price: actuator.base_price * 0.95,
        price_type: 'normal',
        notes: '10件以上享95折'
      },
      {
        min_quantity: 50,
        unit_price: actuator.base_price * 0.90,
        price_type: 'normal',
        notes: '50件以上享9折'
      }
    ]
    
    await actuator.save()
    console.log(`✓ 迁移完成: ${actuator.model_base}`)
  }
  
  console.log('✅ 所有数据迁移完成')
}

// 运行迁移
migratePriceTiers()
  .then(() => process.exit(0))
  .catch(err => {
    console.error('迁移失败:', err)
    process.exit(1)
  })
```

---

## 📊 价格策略建议

### 常见阶梯定价策略

#### 策略 1: 标准零售折扣

```javascript
price_tiers: [
  { min_quantity: 1,   unit_price: 10000, notes: '零售价' },
  { min_quantity: 5,   unit_price: 9500,  notes: '5折' },
  { min_quantity: 10,  unit_price: 9000,  notes: '10折' },
  { min_quantity: 50,  unit_price: 8500,  notes: '批发价' },
  { min_quantity: 100, unit_price: 8000,  notes: '大批发价' }
]
```

#### 策略 2: 激进促销

```javascript
price_tiers: [
  { min_quantity: 1,  unit_price: 10000, notes: '零售价' },
  { min_quantity: 3,  unit_price: 9000,  notes: '买3享9折' },
  { min_quantity: 5,  unit_price: 8500,  notes: '买5享85折' },
  { min_quantity: 10, unit_price: 7500,  notes: '买10享75折' }
]
```

#### 策略 3: 温度变体定价

```javascript
price_tiers: [
  // 常温 (-20~80°C)
  { min_quantity: 1,  unit_price: 10000, price_type: 'normal' },
  { min_quantity: 10, unit_price: 9000,  price_type: 'normal' },
  
  // 低温 T1 (-40~80°C) +5%
  { min_quantity: 1,  unit_price: 10500, price_type: 'low_temp' },
  { min_quantity: 10, unit_price: 9450,  price_type: 'low_temp' },
  
  // 高温 M (-20~120°C) +10%
  { min_quantity: 1,  unit_price: 11000, price_type: 'high_temp' },
  { min_quantity: 10, unit_price: 9900,  price_type: 'high_temp' }
]
```

---

## ✅ 验证清单

### 数据完整性验证

```javascript
// 验证价格档位配置
function validatePriceTiers(actuator) {
  if (!actuator.price_tiers || actuator.price_tiers.length === 0) {
    console.warn('⚠️  未配置价格档位')
    return false
  }
  
  // 检查是否有起始档位（min_quantity = 1）
  const hasBasePrice = actuator.price_tiers.some(tier => tier.min_quantity === 1)
  if (!hasBasePrice) {
    console.warn('⚠️  缺少起始价格档位（min_quantity = 1）')
  }
  
  // 检查价格是否递减
  const sortedTiers = actuator.price_tiers
    .sort((a, b) => a.min_quantity - b.min_quantity)
  
  for (let i = 1; i < sortedTiers.length; i++) {
    if (sortedTiers[i].unit_price > sortedTiers[i-1].unit_price) {
      console.warn(`⚠️  价格档位异常: 数量增加但价格上升`)
      console.warn(`  ${sortedTiers[i-1].min_quantity}件: ¥${sortedTiers[i-1].unit_price}`)
      console.warn(`  ${sortedTiers[i].min_quantity}件: ¥${sortedTiers[i].unit_price}`)
    }
  }
  
  console.log('✅ 价格档位配置正确')
  return true
}
```

---

## 🎉 总结

**阶梯定价功能**已成功实现！

**核心特性**:
- ✅ 灵活的阶梯定价结构
- ✅ 支持多价格类型（常温、低温、高温）
- ✅ 自动价格计算方法
- ✅ 完整的数据验证
- ✅ 向后兼容旧系统

**业务价值**:
- 💰 支持批量采购折扣
- 📊 灵活的定价策略
- 🎯 自动价格计算
- 📈 促进销量增长
- 🤝 提升客户满意度

---

**完成时间**: 2025-10-27  
**状态**: ✅ Production Ready  
**版本**: v2.0

