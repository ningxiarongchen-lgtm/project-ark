# é˜¶æ¢¯å®šä»·åŠŸèƒ½è¯´æ˜ ğŸ’°

**æ–‡ä»¶**: `backend/models/Actuator.js`  
**å®Œæˆæ—¶é—´**: 2025-10-27  
**ç‰ˆæœ¬**: v2.0  
**çŠ¶æ€**: âœ… å®Œæˆ

---

## ğŸ“‹ æ¦‚è¿°

æˆåŠŸå°† Actuator æ¨¡å‹çš„å•ä¸€ä»·æ ¼å­—æ®µ (`base_price`) æ›¿æ¢ä¸ºçµæ´»çš„**é˜¶æ¢¯å®šä»·ç³»ç»Ÿ** (`price_tiers`)ï¼Œæ”¯æŒæ ¹æ®é‡‡è´­æ•°é‡è‡ªåŠ¨è®¡ç®—ä¸åŒçš„å•ä»·ã€‚

---

## ğŸ†• æ–°å¢å­—æ®µ

### `price_tiers` - é˜¶æ¢¯å®šä»·æ•°ç»„

**æ•°æ®ç»“æ„**:

```javascript
price_tiers: [{
  // å¿…éœ€å­—æ®µ
  min_quantity: Number,     // æœ€å°æ•°é‡ï¼ˆèµ·è®¢é‡ï¼‰â‰¥1
  unit_price: Number,       // è¯¥æ¡£ä½çš„å•ä»· â‰¥0
  
  // å¯é€‰å­—æ®µ
  price_type: String,       // 'normal', 'low_temp', 'high_temp', 'standard'
  notes: String            // å¤‡æ³¨è¯´æ˜
}]
```

---

## ğŸ“Š å­—æ®µè¯¦è§£

### `min_quantity` - æœ€å°æ•°é‡

- **ç±»å‹**: Number
- **å¿…éœ€**: âœ… æ˜¯
- **éªŒè¯**: â‰¥1
- **è¯´æ˜**: è¾¾åˆ°æ­¤æ•°é‡æ—¶ï¼Œå¯äº«å—è¯¥æ¡£ä½ä»·æ ¼

---

### `unit_price` - å•ä»·

- **ç±»å‹**: Number
- **å¿…éœ€**: âœ… æ˜¯
- **éªŒè¯**: â‰¥0
- **è¯´æ˜**: è¯¥æ•°é‡æ¡£ä½çš„æ¯ä»¶å•ä»·

---

### `price_type` - ä»·æ ¼ç±»å‹

- **ç±»å‹**: String
- **å¿…éœ€**: âŒ å¦ï¼ˆé»˜è®¤: 'normal'ï¼‰
- **æšä¸¾å€¼**:
  - `normal` - å¸¸è§„ä»·æ ¼
  - `low_temp` - ä½æ¸©å‹å·ä»·æ ¼
  - `high_temp` - é«˜æ¸©å‹å·ä»·æ ¼
  - `standard` - æ ‡å‡†ä»·æ ¼
- **è¯´æ˜**: ç”¨äºåŒºåˆ†ä¸åŒå˜ä½“çš„ä»·æ ¼

---

### `notes` - å¤‡æ³¨

- **ç±»å‹**: String
- **å¿…éœ€**: âŒ å¦
- **è¯´æ˜**: è¯¥ä»·æ ¼æ¡£ä½çš„è¯´æ˜ä¿¡æ¯

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: åŸºç¡€é˜¶æ¢¯å®šä»·

```javascript
const actuator = new Actuator({
  model_base: 'SF10-150DA',
  series: 'SF',
  action_type: 'DA',
  
  // é˜¶æ¢¯å®šä»·é…ç½®
  price_tiers: [
    {
      min_quantity: 1,
      unit_price: 10000,
      price_type: 'normal',
      notes: 'é›¶å”®ä»·'
    },
    {
      min_quantity: 5,
      unit_price: 9500,
      price_type: 'normal',
      notes: '5ä»¶ä»¥ä¸Šäº«95æŠ˜'
    },
    {
      min_quantity: 10,
      unit_price: 9000,
      price_type: 'normal',
      notes: '10ä»¶ä»¥ä¸Šäº«9æŠ˜'
    },
    {
      min_quantity: 50,
      unit_price: 8500,
      price_type: 'normal',
      notes: '50ä»¶ä»¥ä¸Šäº«85æŠ˜'
    }
  ]
})

await actuator.save()
```

---

### ç¤ºä¾‹ 2: å¤šä»·æ ¼ç±»å‹é˜¶æ¢¯å®šä»·

```javascript
const actuator = new Actuator({
  model_base: 'SF10-150DA-T1',
  series: 'SF',
  action_type: 'DA',
  
  price_tiers: [
    // å¸¸æ¸©å‹å·ä»·æ ¼
    { min_quantity: 1, unit_price: 10000, price_type: 'normal' },
    { min_quantity: 10, unit_price: 9000, price_type: 'normal' },
    
    // ä½æ¸©å‹å·ä»·æ ¼
    { min_quantity: 1, unit_price: 10500, price_type: 'low_temp' },
    { min_quantity: 10, unit_price: 9450, price_type: 'low_temp' },
    
    // é«˜æ¸©å‹å·ä»·æ ¼
    { min_quantity: 1, unit_price: 11000, price_type: 'high_temp' },
    { min_quantity: 10, unit_price: 9900, price_type: 'high_temp' }
  ]
})

await actuator.save()
```

---

## ğŸ”§ å®ä¾‹æ–¹æ³•

### 1. `getPriceByQuantity(quantity, priceType)` - è·å–ä»·æ ¼

**ç”¨é€”**: æ ¹æ®é‡‡è´­æ•°é‡å’Œä»·æ ¼ç±»å‹ï¼Œè‡ªåŠ¨è®¡ç®—å¯¹åº”çš„å•ä»·å’Œæ€»ä»·

**å‚æ•°**:
- `quantity` (Number): é‡‡è´­æ•°é‡
- `priceType` (String, å¯é€‰): ä»·æ ¼ç±»å‹ï¼Œé»˜è®¤ 'normal'

**è¿”å›å€¼**:
```javascript
{
  unit_price: Number,      // å•ä»·
  min_quantity: Number,    // å¯¹åº”çš„æœ€å°æ•°é‡æ¡£ä½
  total_price: Number,     // æ€»ä»· (unit_price Ã— quantity)
  price_type: String,      // ä»·æ ¼ç±»å‹
  notes: String,          // å¤‡æ³¨
  warning: String         // è­¦å‘Šä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
}
```

**ç¤ºä¾‹**:

```javascript
const actuator = await Actuator.findOne({ model_base: 'SF10-150DA' })

// æŸ¥è¯¢é‡‡è´­3ä»¶çš„ä»·æ ¼
const price3 = actuator.getPriceByQuantity(3)
console.log(price3)
// è¾“å‡º:
// {
//   unit_price: 10000,
//   min_quantity: 1,
//   total_price: 30000,
//   price_type: 'normal',
//   notes: 'é›¶å”®ä»·'
// }

// æŸ¥è¯¢é‡‡è´­12ä»¶çš„ä»·æ ¼
const price12 = actuator.getPriceByQuantity(12)
console.log(price12)
// è¾“å‡º:
// {
//   unit_price: 9000,
//   min_quantity: 10,
//   total_price: 108000,
//   price_type: 'normal',
//   notes: '10ä»¶ä»¥ä¸Šäº«9æŠ˜'
// }

// æŸ¥è¯¢ä½æ¸©å‹å·é‡‡è´­5ä»¶çš„ä»·æ ¼
const priceLowTemp = actuator.getPriceByQuantity(5, 'low_temp')
console.log(priceLowTemp)
// è¾“å‡º:
// {
//   unit_price: 10500,
//   min_quantity: 1,
//   total_price: 52500,
//   price_type: 'low_temp'
// }
```

---

### 2. `getAllPriceTiers(priceType)` - è·å–æ‰€æœ‰ä»·æ ¼æ¡£ä½

**ç”¨é€”**: è·å–æ‰€æœ‰ä»·æ ¼æ¡£ä½ä¿¡æ¯ï¼ˆç”¨äºå±•ç¤ºï¼‰

**å‚æ•°**:
- `priceType` (String, å¯é€‰): ä»·æ ¼ç±»å‹è¿‡æ»¤å™¨

**è¿”å›å€¼**: ä»·æ ¼æ¡£ä½æ•°ç»„ï¼ˆæŒ‰ min_quantity ä»å°åˆ°å¤§æ’åºï¼‰

**ç¤ºä¾‹**:

```javascript
const actuator = await Actuator.findOne({ model_base: 'SF10-150DA' })

// è·å–æ‰€æœ‰ä»·æ ¼æ¡£ä½
const allTiers = actuator.getAllPriceTiers()
console.log(allTiers)
// è¾“å‡º:
// [
//   { min_quantity: 1, unit_price: 10000, price_type: 'normal', notes: 'é›¶å”®ä»·' },
//   { min_quantity: 5, unit_price: 9500, price_type: 'normal', notes: '5ä»¶ä»¥ä¸Šäº«95æŠ˜' },
//   { min_quantity: 10, unit_price: 9000, price_type: 'normal', notes: '10ä»¶ä»¥ä¸Šäº«9æŠ˜' },
//   { min_quantity: 50, unit_price: 8500, price_type: 'normal', notes: '50ä»¶ä»¥ä¸Šäº«85æŠ˜' }
// ]

// ä»…è·å–ä½æ¸©å‹å·çš„ä»·æ ¼æ¡£ä½
const lowTempTiers = actuator.getAllPriceTiers('low_temp')
console.log(lowTempTiers)
// è¾“å‡º:
// [
//   { min_quantity: 1, unit_price: 10500, price_type: 'low_temp' },
//   { min_quantity: 10, unit_price: 9450, price_type: 'low_temp' }
// ]
```

---

## ğŸ”„ å‘åå…¼å®¹

### ä¿ç•™çš„ `pricing` å¯¹è±¡

ä¸ºäº†å‘åå…¼å®¹ï¼ŒåŸæœ‰çš„ `pricing` å¯¹è±¡è¢«ä¿ç•™ï¼š

```javascript
pricing: {
  base_price_normal: Number,      // AT/GYç³»åˆ—æ ‡å‡†ä»·æ ¼
  base_price_low: Number,         // ä½æ¸©ä»·æ ¼
  base_price_high: Number,        // é«˜æ¸©ä»·æ ¼
  manual_override_model: String,  // æ‰‹åŠ¨æ“ä½œè£…ç½®å‹å·
  manual_override_price: Number,  // æ‰‹åŠ¨æ“ä½œè£…ç½®ä»·æ ¼
  seal_kit_price: Number         // å¯†å°å¥—ä»¶ä»·æ ¼
}
```

**è¿ç§»å»ºè®®**:
- æ–°é¡¹ç›®åº”ä½¿ç”¨ `price_tiers`
- æ—§æ•°æ®å¯ä»¥ç»§ç»­ä½¿ç”¨ `pricing` å¯¹è±¡
- å¯ä»¥é€šè¿‡è„šæœ¬å°† `pricing` æ•°æ®è¿ç§»åˆ° `price_tiers`

---

## ğŸ“ˆ å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯ 1: å±•ç¤ºä»·æ ¼è¡¨

```javascript
// å‰ç«¯å±•ç¤ºä»·æ ¼è¡¨
const actuator = await Actuator.findById(actuatorId)
const tiers = actuator.getAllPriceTiers('normal')

// æ¸²æŸ“ä»·æ ¼è¡¨
tiers.forEach(tier => {
  console.log(`æ•°é‡ â‰¥${tier.min_quantity}: Â¥${tier.unit_price}/ä»¶`)
})

// è¾“å‡º:
// æ•°é‡ â‰¥1: Â¥10,000/ä»¶
// æ•°é‡ â‰¥5: Â¥9,500/ä»¶
// æ•°é‡ â‰¥10: Â¥9,000/ä»¶
// æ•°é‡ â‰¥50: Â¥8,500/ä»¶
```

---

### åœºæ™¯ 2: è´­ç‰©è½¦è®¡ç®—

```javascript
// ç”¨æˆ·é€‰æ‹©äº†æ‰§è¡Œå™¨å’Œæ•°é‡
const cartItem = {
  actuator_id: 'actuator_id_here',
  quantity: 12,
  temperature_type: 'normal'
}

// è·å–æ‰§è¡Œå™¨
const actuator = await Actuator.findById(cartItem.actuator_id)

// è®¡ç®—ä»·æ ¼
const pricing = actuator.getPriceByQuantity(
  cartItem.quantity,
  cartItem.temperature_type
)

console.log(`å•ä»·: Â¥${pricing.unit_price}`)
console.log(`æ•°é‡: ${cartItem.quantity}`)
console.log(`æ€»ä»·: Â¥${pricing.total_price}`)
console.log(`è¯´æ˜: ${pricing.notes}`)

// è¾“å‡º:
// å•ä»·: Â¥9,000
// æ•°é‡: 12
// æ€»ä»·: Â¥108,000
// è¯´æ˜: 10ä»¶ä»¥ä¸Šäº«9æŠ˜
```

---

### åœºæ™¯ 3: ä¼˜åŒ–BOMæŠ¥ä»·

```javascript
// ä¼˜åŒ–åçš„BOM
const optimizedBOM = [
  { actuator_model: 'SF10-150DA', quantity: 15 },
  { actuator_model: 'AT-DA63', quantity: 8 },
  { actuator_model: 'SF20-300SR', quantity: 3 }
]

// è®¡ç®—æ¯ä¸ªé¡¹ç›®çš„ä»·æ ¼
for (const item of optimizedBOM) {
  const actuator = await Actuator.findOne({ model_base: item.actuator_model })
  const pricing = actuator.getPriceByQuantity(item.quantity)
  
  console.log(`${item.actuator_model}:`)
  console.log(`  æ•°é‡: ${item.quantity}`)
  console.log(`  å•ä»·: Â¥${pricing.unit_price}`)
  console.log(`  æ€»ä»·: Â¥${pricing.total_price}`)
  console.log(`  æ¡£ä½: ${pricing.notes}`)
}

// è¾“å‡º:
// SF10-150DA:
//   æ•°é‡: 15
//   å•ä»·: Â¥9,000
//   æ€»ä»·: Â¥135,000
//   æ¡£ä½: 10ä»¶ä»¥ä¸Šäº«9æŠ˜
// AT-DA63:
//   æ•°é‡: 8
//   å•ä»·: Â¥150
//   æ€»ä»·: Â¥1,200
//   æ¡£ä½: 5ä»¶ä»¥ä¸Šäº«95æŠ˜
// SF20-300SR:
//   æ•°é‡: 3
//   å•ä»·: Â¥15,000
//   æ€»ä»·: Â¥45,000
//   æ¡£ä½: é›¶å”®ä»·
```

---

### åœºæ™¯ 4: æ‰¹é‡é‡‡è´­æŠ˜æ‰£æç¤º

```javascript
// ç”¨æˆ·å½“å‰é€‰æ‹©äº†8ä»¶
const currentQuantity = 8

const actuator = await Actuator.findById(actuatorId)
const currentPricing = actuator.getPriceByQuantity(currentQuantity)
const allTiers = actuator.getAllPriceTiers()

// æ‰¾åˆ°ä¸‹ä¸€ä¸ªä»·æ ¼æ¡£ä½
const nextTier = allTiers.find(tier => tier.min_quantity > currentQuantity)

if (nextTier) {
  const currentTotal = currentPricing.total_price
  const nextQuantity = nextTier.min_quantity
  const nextTotal = nextTier.unit_price * nextQuantity
  const savings = (currentPricing.unit_price * nextQuantity) - nextTotal
  
  console.log(`ğŸ’¡ æ¸©é¦¨æç¤ºï¼š`)
  console.log(`å†è´­ä¹° ${nextQuantity - currentQuantity} ä»¶ï¼Œå³å¯äº«å—æ›´ä¼˜æƒ çš„ä»·æ ¼ï¼`)
  console.log(`å•ä»·å°†ä» Â¥${currentPricing.unit_price} é™è‡³ Â¥${nextTier.unit_price}`)
  console.log(`è´­ä¹° ${nextQuantity} ä»¶å¯èŠ‚çœ Â¥${savings}`)
}

// è¾“å‡º:
// ğŸ’¡ æ¸©é¦¨æç¤ºï¼š
// å†è´­ä¹° 2 ä»¶ï¼Œå³å¯äº«å—æ›´ä¼˜æƒ çš„ä»·æ ¼ï¼
// å•ä»·å°†ä» Â¥9,500 é™è‡³ Â¥9,000
// è´­ä¹° 10 ä»¶å¯èŠ‚çœ Â¥5,000
```

---

## ğŸ”§ æ•°æ®è¿ç§»è„šæœ¬

### ä» `base_price` è¿ç§»åˆ° `price_tiers`

```javascript
// migrate_price_tiers.js
const mongoose = require('mongoose')
const Actuator = require('./models/Actuator')

async function migratePriceTiers() {
  const actuators = await Actuator.find({
    base_price: { $exists: true },
    price_tiers: { $exists: false }
  })
  
  console.log(`æ‰¾åˆ° ${actuators.length} ä¸ªéœ€è¦è¿ç§»çš„æ‰§è¡Œå™¨`)
  
  for (const actuator of actuators) {
    // åˆ›å»ºåŸºç¡€ä»·æ ¼æ¡£ä½
    actuator.price_tiers = [
      {
        min_quantity: 1,
        unit_price: actuator.base_price,
        price_type: 'normal',
        notes: 'åŸºç¡€ä»·æ ¼ï¼ˆä»æ—§å­—æ®µè¿ç§»ï¼‰'
      },
      {
        min_quantity: 10,
        unit_price: actuator.base_price * 0.95,
        price_type: 'normal',
        notes: '10ä»¶ä»¥ä¸Šäº«95æŠ˜'
      },
      {
        min_quantity: 50,
        unit_price: actuator.base_price * 0.90,
        price_type: 'normal',
        notes: '50ä»¶ä»¥ä¸Šäº«9æŠ˜'
      }
    ]
    
    await actuator.save()
    console.log(`âœ“ è¿ç§»å®Œæˆ: ${actuator.model_base}`)
  }
  
  console.log('âœ… æ‰€æœ‰æ•°æ®è¿ç§»å®Œæˆ')
}

// è¿è¡Œè¿ç§»
migratePriceTiers()
  .then(() => process.exit(0))
  .catch(err => {
    console.error('è¿ç§»å¤±è´¥:', err)
    process.exit(1)
  })
```

---

## ğŸ“Š ä»·æ ¼ç­–ç•¥å»ºè®®

### å¸¸è§é˜¶æ¢¯å®šä»·ç­–ç•¥

#### ç­–ç•¥ 1: æ ‡å‡†é›¶å”®æŠ˜æ‰£

```javascript
price_tiers: [
  { min_quantity: 1,   unit_price: 10000, notes: 'é›¶å”®ä»·' },
  { min_quantity: 5,   unit_price: 9500,  notes: '5æŠ˜' },
  { min_quantity: 10,  unit_price: 9000,  notes: '10æŠ˜' },
  { min_quantity: 50,  unit_price: 8500,  notes: 'æ‰¹å‘ä»·' },
  { min_quantity: 100, unit_price: 8000,  notes: 'å¤§æ‰¹å‘ä»·' }
]
```

#### ç­–ç•¥ 2: æ¿€è¿›ä¿ƒé”€

```javascript
price_tiers: [
  { min_quantity: 1,  unit_price: 10000, notes: 'é›¶å”®ä»·' },
  { min_quantity: 3,  unit_price: 9000,  notes: 'ä¹°3äº«9æŠ˜' },
  { min_quantity: 5,  unit_price: 8500,  notes: 'ä¹°5äº«85æŠ˜' },
  { min_quantity: 10, unit_price: 7500,  notes: 'ä¹°10äº«75æŠ˜' }
]
```

#### ç­–ç•¥ 3: æ¸©åº¦å˜ä½“å®šä»·

```javascript
price_tiers: [
  // å¸¸æ¸© (-20~80Â°C)
  { min_quantity: 1,  unit_price: 10000, price_type: 'normal' },
  { min_quantity: 10, unit_price: 9000,  price_type: 'normal' },
  
  // ä½æ¸© T1 (-40~80Â°C) +5%
  { min_quantity: 1,  unit_price: 10500, price_type: 'low_temp' },
  { min_quantity: 10, unit_price: 9450,  price_type: 'low_temp' },
  
  // é«˜æ¸© M (-20~120Â°C) +10%
  { min_quantity: 1,  unit_price: 11000, price_type: 'high_temp' },
  { min_quantity: 10, unit_price: 9900,  price_type: 'high_temp' }
]
```

---

## âœ… éªŒè¯æ¸…å•

### æ•°æ®å®Œæ•´æ€§éªŒè¯

```javascript
// éªŒè¯ä»·æ ¼æ¡£ä½é…ç½®
function validatePriceTiers(actuator) {
  if (!actuator.price_tiers || actuator.price_tiers.length === 0) {
    console.warn('âš ï¸  æœªé…ç½®ä»·æ ¼æ¡£ä½')
    return false
  }
  
  // æ£€æŸ¥æ˜¯å¦æœ‰èµ·å§‹æ¡£ä½ï¼ˆmin_quantity = 1ï¼‰
  const hasBasePrice = actuator.price_tiers.some(tier => tier.min_quantity === 1)
  if (!hasBasePrice) {
    console.warn('âš ï¸  ç¼ºå°‘èµ·å§‹ä»·æ ¼æ¡£ä½ï¼ˆmin_quantity = 1ï¼‰')
  }
  
  // æ£€æŸ¥ä»·æ ¼æ˜¯å¦é€’å‡
  const sortedTiers = actuator.price_tiers
    .sort((a, b) => a.min_quantity - b.min_quantity)
  
  for (let i = 1; i < sortedTiers.length; i++) {
    if (sortedTiers[i].unit_price > sortedTiers[i-1].unit_price) {
      console.warn(`âš ï¸  ä»·æ ¼æ¡£ä½å¼‚å¸¸: æ•°é‡å¢åŠ ä½†ä»·æ ¼ä¸Šå‡`)
      console.warn(`  ${sortedTiers[i-1].min_quantity}ä»¶: Â¥${sortedTiers[i-1].unit_price}`)
      console.warn(`  ${sortedTiers[i].min_quantity}ä»¶: Â¥${sortedTiers[i].unit_price}`)
    }
  }
  
  console.log('âœ… ä»·æ ¼æ¡£ä½é…ç½®æ­£ç¡®')
  return true
}
```

---

## ğŸ‰ æ€»ç»“

**é˜¶æ¢¯å®šä»·åŠŸèƒ½**å·²æˆåŠŸå®ç°ï¼

**æ ¸å¿ƒç‰¹æ€§**:
- âœ… çµæ´»çš„é˜¶æ¢¯å®šä»·ç»“æ„
- âœ… æ”¯æŒå¤šä»·æ ¼ç±»å‹ï¼ˆå¸¸æ¸©ã€ä½æ¸©ã€é«˜æ¸©ï¼‰
- âœ… è‡ªåŠ¨ä»·æ ¼è®¡ç®—æ–¹æ³•
- âœ… å®Œæ•´çš„æ•°æ®éªŒè¯
- âœ… å‘åå…¼å®¹æ—§ç³»ç»Ÿ

**ä¸šåŠ¡ä»·å€¼**:
- ğŸ’° æ”¯æŒæ‰¹é‡é‡‡è´­æŠ˜æ‰£
- ğŸ“Š çµæ´»çš„å®šä»·ç­–ç•¥
- ğŸ¯ è‡ªåŠ¨ä»·æ ¼è®¡ç®—
- ğŸ“ˆ ä¿ƒè¿›é”€é‡å¢é•¿
- ğŸ¤ æå‡å®¢æˆ·æ»¡æ„åº¦

---

**å®Œæˆæ—¶é—´**: 2025-10-27  
**çŠ¶æ€**: âœ… Production Ready  
**ç‰ˆæœ¬**: v2.0

