# é€‰å‹ç®—æ³•å‡çº§æŠ¥å‘Š

## ğŸ¯ å‡çº§ç›®æ ‡

å°†é€‰å‹ç®—æ³•ä»ä»…æ”¯æŒ SF ç³»åˆ—ï¼ˆScotch Yoke æ°”åŠ¨å¶ç‰‡å¼ï¼‰æ‰©å±•ä¸ºæ”¯æŒä¸‰ç§ç³»åˆ—çš„æ‰§è¡Œå™¨ï¼š
- **SF ç³»åˆ—** - Scotch Yokeï¼ˆæ°”åŠ¨å¶ç‰‡å¼ï¼‰
- **AT ç³»åˆ—** - Rack & Pinionï¼ˆé½¿è½®é½¿æ¡å¼ï¼‰
- **GY ç³»åˆ—** - Rack & Pinionï¼ˆé½¿è½®é½¿æ¡å¼ï¼‰

## âœ… å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®æ¨¡å‹å‡çº§

**æ–‡ä»¶**: `backend/models/Actuator.js`

**æ–°å¢å­—æ®µ**:
```javascript
{
  series: String,              // "SF", "AT", "GY"
  mechanism: String,           // "Scotch Yoke", "Rack & Pinion"
  spring_range: String,        // "K8", "K10" (ç”¨äº SR å‹å·)
  torque_data: Mixed,          // AT/GY ç³»åˆ—æ‰­çŸ©æ•°æ®
  dimensions: Mixed            // AT/GY ç³»åˆ—å°ºå¯¸æ•°æ®
}
```

### 2. é€‰å‹æ§åˆ¶å™¨é‡æ„

**æ–‡ä»¶**: `backend/controllers/selectionController.js`

**æ ¸å¿ƒæ”¹åŠ¨**:

#### 2.1 æ–°å¢ `mechanism` å‚æ•°

```javascript
const {
  mechanism, // æ–°å¢ï¼š'Scotch Yoke' æˆ– 'Rack & Pinion'
  valve_torque,
  required_torque,
  working_pressure,
  // ... å…¶ä»–å‚æ•°
} = req.body;
```

#### 2.2 åŠ¨æ€æŸ¥è¯¢æ¡ä»¶

```javascript
let query = {
  mechanism: mechanism  // æ ¹æ®æœºæ„ç±»å‹ç­›é€‰
};

if (action_type_preference) {
  query.action_type = action_type_preference.toUpperCase();
}

const candidateActuators = await Actuator.find(query);
```

#### 2.3 åˆ†æ”¯æ‰­çŸ©åŒ¹é…é€»è¾‘

**Scotch Yoke é€»è¾‘ï¼ˆSF ç³»åˆ—ï¼‰**:
```javascript
if (mechanism === 'Scotch Yoke') {
  // ä½¿ç”¨ torque_symmetric å’Œ torque_canted
  const pressureKey = String(working_pressure).replace('.', '_');
  const torqueKey = `${pressureKey}_${working_angle}`;
  
  symmetricTorque = actuator.torque_symmetric.get(torqueKey);
  cantedTorque = actuator.torque_canted.get(torqueKey);
  
  // æ ¹æ® yoke_preference é€‰æ‹©è½­æ¶ç±»å‹
  // ...
}
```

**Rack & Pinion é€»è¾‘ï¼ˆAT/GY ç³»åˆ—ï¼‰**:
```javascript
else if (mechanism === 'Rack & Pinion') {
  const torqueData = actuator.torque_data || {};
  
  if (actuator.action_type === 'DA') {
    // DA: æ ¹æ®å·¥ä½œå‹åŠ›åŒ¹é…æ‰­çŸ©å€¼
    // æŸ¥æ‰¾ "0.5MPa", "0.55MPa" ç­‰é”®
    const possibleKeys = [
      `${working_pressure}MPa`,
      `${working_pressure.toFixed(1)}MPa`,
      `${working_pressure.toFixed(2)}MPa`
    ];
    
    for (const key of possibleKeys) {
      if (torqueData[key]) {
        actualTorque = torqueData[key];
        break;
      }
    }
    
    // æ£€æŸ¥æ˜¯å¦æ»¡è¶³æ‰­çŸ©è¦æ±‚
    if (actualTorque >= finalRequiredTorque) {
      shouldInclude = true;
    }
  }
  else if (actuator.action_type === 'SR') {
    // SR: éœ€è¦åŒæ—¶æ»¡è¶³ spring_end å’Œ air_start
    const springEndTorque = torqueData.spring_end;
    const airStartTorque = torqueData.air_start_XXMPa;
    
    if (springEndTorque >= finalRequiredTorque && 
        airStartTorque >= finalRequiredTorque) {
      shouldInclude = true;
      actualTorque = Math.min(springEndTorque, airStartTorque);
    }
  }
}
```

## ğŸ“Š API æ¥å£å˜æ›´

### POST /api/selection/calculate

**æ–°å¢è¯·æ±‚å‚æ•°**:

| å‚æ•° | ç±»å‹ | å¿…éœ€ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|------|
| `mechanism` | String | âœ… | æœºæ„ç±»å‹ | "Scotch Yoke" æˆ– "Rack & Pinion" |

**å®Œæ•´è¯·æ±‚ç¤ºä¾‹**:

#### Scotch Yoke (SFç³»åˆ—) è¯·æ±‚
```json
{
  "mechanism": "Scotch Yoke",
  "required_torque": 500,
  "working_pressure": 0.5,
  "working_angle": 0,
  "yoke_preference": "Auto",
  "action_type_preference": "DA"
}
```

#### Rack & Pinion (AT/GYç³»åˆ—) è¯·æ±‚
```json
{
  "mechanism": "Rack & Pinion",
  "required_torque": 10,
  "working_pressure": 0.5,
  "action_type_preference": "DA"
}
```

**å“åº”ç»“æ„**:

```json
{
  "success": true,
  "message": "æ‰¾åˆ° 5 ä¸ªæ»¡è¶³è¦æ±‚çš„æ‰§è¡Œå™¨",
  "count": 5,
  "search_criteria": {
    "valve_torque": null,
    "safety_factor": 1.0,
    "required_torque": 10,
    "working_pressure": 0.5,
    "working_angle": "N/A",
    "mechanism": "Rack & Pinion",
    "yoke_preference": "N/A",
    "action_type_preference": "DA",
    "needs_manual_override": false,
    "max_budget": "ä¸é™"
  },
  "data": [
    {
      "_id": "...",
      "model_base": "AT-DA52",
      "series": "AT",
      "mechanism": "Rack & Pinion",
      "body_size": "AT52",
      "action_type": "DA",
      "spring_range": null,
      "price": 64,
      "actual_torque": 10,
      "torque_margin": 0.00,
      "recommend_level": "å‹‰å¼ºå¯ç”¨",
      "torque_data": {
        "0.3MPa": 6,
        "0.4MPa": 8,
        "0.5MPa": 10,
        "0.55MPa": 11
      },
      "dimensions": {
        "A": 147,
        "B": 65,
        "H": 92
      },
      "total_price": 64
    }
  ],
  "best_choice": { /* ç¬¬ä¸€æ¡æ•°æ® */ },
  "timestamp": "2025-10-27T..."
}
```

## ğŸ”§ æ‰­çŸ©åŒ¹é…ç®—æ³•è¯¦è§£

### Scotch Yokeï¼ˆSF ç³»åˆ—ï¼‰

**æ•°æ®ç»“æ„**:
```javascript
{
  torque_symmetric: Map {
    "0_3_0": 309,
    "0_4_0": 412,
    "0_5_0": 515,
    // ...
  },
  torque_canted: Map {
    "0_3_0": 417,
    "0_4_0": 556,
    // ...
  }
}
```

**åŒ¹é…é€»è¾‘**:
1. æ„å»ºé”®ï¼š`pressure_angle` (å¦‚ `0_5_0`)
2. ä» `torque_symmetric` å’Œ `torque_canted` ä¸­æŸ¥æ‰¾
3. æ ¹æ® `yoke_preference` é€‰æ‹©åˆé€‚çš„è½­æ¶ç±»å‹
4. æ¯”è¾ƒæ‰­çŸ©å€¼æ˜¯å¦ â‰¥ éœ€æ±‚æ‰­çŸ©

### Rack & Pinionï¼ˆAT/GY ç³»åˆ—ï¼‰

#### DAï¼ˆåŒä½œç”¨ï¼‰å‹

**æ•°æ®ç»“æ„**:
```javascript
{
  torque_data: {
    "0.3MPa": 6,
    "0.4MPa": 8,
    "0.5MPa": 10,
    "0.55MPa": 11,
    "0.6MPa": 12
  }
}
```

**åŒ¹é…é€»è¾‘**:
1. æŸ¥æ‰¾ä¸å·¥ä½œå‹åŠ›åŒ¹é…çš„é”®ï¼ˆå¦‚ `"0.5MPa"`ï¼‰
2. å¦‚æœæ‰¾ä¸åˆ°ç²¾ç¡®åŒ¹é…ï¼Œæ‰¾æœ€æ¥è¿‘ä¸”ä¸å¤§äºå·¥ä½œå‹åŠ›çš„å€¼
3. æ£€æŸ¥æ‰­çŸ©å€¼æ˜¯å¦ â‰¥ éœ€æ±‚æ‰­çŸ©

#### SRï¼ˆå¼¹ç°§å¤ä½ï¼‰å‹

**æ•°æ®ç»“æ„**:
```javascript
{
  torque_data: {
    "spring_end": 7.7,
    "air_start_0.55MPa": 9.9,
    "air_end_0.55MPa": 6.7
  }
}
```

**åŒ¹é…é€»è¾‘**:
1. æ£€æŸ¥ `spring_end` â‰¥ éœ€æ±‚æ‰­çŸ©
2. æ£€æŸ¥ `air_start_XXMPa` â‰¥ éœ€æ±‚æ‰­çŸ©
3. ä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³æ‰ç®—åŒ¹é…
4. å®é™…æ‰­çŸ©å–ä¸¤è€…è¾ƒå°å€¼

## ğŸ“ è¿”å›ç»“æœå·®å¼‚

### Scotch Yoke ç»“æœå­—æ®µ

```javascript
{
  recommended_yoke: "Symmetric" | "Canted" | "Both",
  symmetric_torque: 515,
  canted_torque: 695,
  // ...
}
```

### Rack & Pinion ç»“æœå­—æ®µ

```javascript
{
  series: "AT" | "GY",
  spring_range: "K8" | "K10" | null,
  torque_data: { /* åŸå§‹æ‰­çŸ©æ•°æ® */ },
  dimensions: { /* å°ºå¯¸æ•°æ® */ },
  // ...
}
```

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯• 1: SF ç³»åˆ—é€‰å‹

```bash
curl -X POST http://localhost:5001/api/selection/calculate \
  -H "Content-Type: application/json" \
  -d '{
    "mechanism": "Scotch Yoke",
    "required_torque": 500,
    "working_pressure": 0.5,
    "working_angle": 0,
    "yoke_preference": "Auto"
  }'
```

**é¢„æœŸç»“æœ**: è¿”å› SF ç³»åˆ—æ‰§è¡Œå™¨

### æµ‹è¯• 2: AT ç³»åˆ— DA é€‰å‹

```bash
curl -X POST http://localhost:5001/api/selection/calculate \
  -H "Content-Type: application/json" \
  -d '{
    "mechanism": "Rack & Pinion",
    "required_torque": 10,
    "working_pressure": 0.5,
    "action_type_preference": "DA"
  }'
```

**é¢„æœŸç»“æœ**: è¿”å› AT/GY ç³»åˆ— DA å‹æ‰§è¡Œå™¨

### æµ‹è¯• 3: AT ç³»åˆ— SR é€‰å‹

```bash
curl -X POST http://localhost:5001/api/selection/calculate \
  -H "Content-Type: application/json" \
  -d '{
    "mechanism": "Rack & Pinion",
    "required_torque": 8,
    "working_pressure": 0.55,
    "action_type_preference": "SR"
  }'
```

**é¢„æœŸç»“æœ**: è¿”å› AT ç³»åˆ— SR å‹æ‰§è¡Œå™¨

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å‘åå…¼å®¹æ€§

- æ—§çš„ SF ç³»åˆ—æ•°æ®æ²¡æœ‰ `mechanism` å­—æ®µ
- éœ€è¦è¿è¡Œæ•°æ®è¿ç§»ä¸º SF ç³»åˆ—æ·»åŠ  `mechanism: "Scotch Yoke"`

### 2. å¿…éœ€å‚æ•°

- `mechanism` å‚æ•°ç°åœ¨æ˜¯**å¿…éœ€**çš„
- å‰ç«¯è°ƒç”¨æ—¶å¿…é¡»æ˜ç¡®æŒ‡å®šæœºæ„ç±»å‹

### 3. å‹åŠ›é”®æ ¼å¼

- **Scotch Yoke**: `"0_5_0"` (ä¸‹åˆ’çº¿æ ¼å¼)
- **Rack & Pinion**: `"0.5MPa"` (MPa åç¼€)

### 4. è½­æ¶åå¥½

- `yoke_preference` ä»…å¯¹ Scotch Yoke æœ‰æ•ˆ
- Rack & Pinion å¿½ç•¥æ­¤å‚æ•°

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ç´¢å¼•ä¼˜åŒ–

å·²åœ¨æ¨¡å‹ä¸­æ·»åŠ  `mechanism` ç´¢å¼•ï¼š
```javascript
actuatorSchema.index({ mechanism: 1 });
```

### 2. æŸ¥è¯¢ä¼˜åŒ–

ä½¿ç”¨å¤åˆæŸ¥è¯¢å‡å°‘æ•°æ®åº“è´Ÿè½½ï¼š
```javascript
const query = {
  mechanism: mechanism,
  action_type: action_type_preference
};
```

### 3. ç¼“å­˜ç­–ç•¥

è€ƒè™‘ä¸ºå¸¸è§æŸ¥è¯¢æ·»åŠ ç¼“å­˜ï¼š
- å›ºå®šå‹åŠ›å€¼çš„æŸ¥è¯¢ç»“æœ
- çƒ­é—¨æœºæ„ç±»å‹ç»„åˆ

## ğŸš€ åç»­æ”¹è¿›è®¡åˆ’

### çŸ­æœŸ
- [ ] æ·»åŠ æ•°æ®è¿ç§»è„šæœ¬ä¸º SF ç³»åˆ—è¡¥å…… `mechanism` å­—æ®µ
- [ ] æ›´æ–°å‰ç«¯é€‰å‹è¡¨å•æ·»åŠ æœºæ„ç±»å‹é€‰æ‹©
- [ ] å®Œå–„é”™è¯¯æç¤ºä¿¡æ¯

### ä¸­æœŸ
- [ ] ä¼˜åŒ–æ‰­çŸ©æ•°æ®å­˜å‚¨æ ¼å¼ç»Ÿä¸€åŒ–
- [ ] æ·»åŠ æ›´å¤šç­›é€‰æ¡ä»¶ï¼ˆå°ºå¯¸ã€é‡é‡ç­‰ï¼‰
- [ ] å®ç°æ™ºèƒ½æ¨èæœºæ„ç±»å‹

### é•¿æœŸ
- [ ] æœºå™¨å­¦ä¹ ä¼˜åŒ–é€‰å‹å»ºè®®
- [ ] å†å²é€‰å‹æ•°æ®åˆ†æ
- [ ] è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–

## âœ¨ æ€»ç»“

æœ¬æ¬¡å‡çº§æˆåŠŸå®ç°äº†ï¼š

1. **æ¨¡å‹æ‰©å±•** âœ…
   - æ”¯æŒä¸‰ç§ç³»åˆ—çš„æ‰§è¡Œå™¨
   - ç»Ÿä¸€çš„æ•°æ®ç»“æ„

2. **ç®—æ³•å‡çº§** âœ…
   - æ™ºèƒ½åˆ†æ”¯é€»è¾‘
   - ä¸åŒæœºæ„ç±»å‹çš„ä¸“é—¨å¤„ç†

3. **API å¢å¼º** âœ…
   - æ–°å¢ `mechanism` å‚æ•°
   - å‘åå…¼å®¹è®¾è®¡

4. **ä»£ç è´¨é‡** âœ…
   - æ¸…æ™°çš„æ³¨é‡Š
   - æ¨¡å—åŒ–è®¾è®¡
   - å®Œå–„çš„é”™è¯¯å¤„ç†

ç³»ç»Ÿç°åœ¨å¯ä»¥ä¸ºå®¢æˆ·æä¾›**æ›´å…¨é¢çš„æ‰§è¡Œå™¨é€‰å‹æ–¹æ¡ˆ**ï¼Œæ¶µç›–æ°”åŠ¨å¶ç‰‡å¼å’Œé½¿è½®é½¿æ¡å¼ä¸¤å¤§ç±»äº§å“ï¼

---

**å®Œæˆæ—¶é—´**: 2025-10-27  
**ç‰ˆæœ¬**: v3.0  
**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**å¼€å‘å›¢é˜Ÿ**: C-MAX å¼€å‘å›¢é˜Ÿ

