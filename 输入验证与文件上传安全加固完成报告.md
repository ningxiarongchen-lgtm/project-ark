# è¾“å…¥éªŒè¯ä¸æ–‡ä»¶ä¸Šä¼ å®‰å…¨åŠ å›ºå®ŒæˆæŠ¥å‘Š

## ğŸ“‹ å®æ–½æ¦‚è§ˆ

åœ¨å®ŒæˆJWTå’Œæƒé™æ§åˆ¶å®‰å…¨åŠ å›ºçš„åŸºç¡€ä¸Šï¼Œæœ¬æ¬¡è¿›ä¸€æ­¥å®æ–½äº†å…¨é¢çš„è¾“å…¥éªŒè¯å’Œæ–‡ä»¶ä¸Šä¼ å®‰å…¨åŠ å›ºï¼Œæ„å»ºäº†æ·±åº¦é˜²å¾¡çš„å®‰å…¨ä½“ç³»ã€‚

**å®æ–½æ—¥æœŸ**: 2025-10-28  
**å®æ–½å†…å®¹**: Helmetå®‰å…¨å¤´ã€è¾“å…¥éªŒè¯ã€æ–‡ä»¶ä¸Šä¼ åŠ å›º  
**é˜²æŠ¤çº§åˆ«**: ä¼ä¸šçº§å®‰å…¨é˜²æŠ¤

---

## âœ… å®Œæˆé¡¹ç›®æ¸…å•

### 1. Helmetå®‰å…¨å¤´é…ç½® âœ“

#### 1.1 å®‰è£…Helmet
```bash
npm install helmet
```

#### 1.2 é…ç½®å®‰å…¨HTTPå¤´
åœ¨ `server.js` ä¸­é…ç½®ï¼š

```javascript
const helmet = require('helmet');

app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"],
    },
  },
  crossOriginEmbedderPolicy: false
}));
```

#### 1.3 Helmetæä¾›çš„å®‰å…¨ä¿æŠ¤

| å®‰å…¨å¤´ | é˜²æŠ¤ä½œç”¨ | çŠ¶æ€ |
|--------|----------|------|
| `X-DNS-Prefetch-Control` | æ§åˆ¶DNSé¢„è§£æ | âœ… |
| `X-Frame-Options` | é˜²æ­¢ç‚¹å‡»åŠ«æŒ | âœ… |
| `Strict-Transport-Security` | å¼ºåˆ¶HTTPS | âœ… |
| `X-Content-Type-Options` | é˜²æ­¢MIMEå—…æ¢ | âœ… |
| `X-XSS-Protection` | å¯ç”¨XSSè¿‡æ»¤å™¨ | âœ… |
| `Content-Security-Policy` | é™åˆ¶èµ„æºåŠ è½½ | âœ… |

### 2. Express-Validatorè¾“å…¥éªŒè¯ âœ“

#### 2.1 å®‰è£…Express-Validator
```bash
npm install express-validator
```

#### 2.2 åˆ›å»ºéªŒè¯ä¸­é—´ä»¶
åˆ›å»ºäº† `backend/middleware/validators.js`ï¼ŒåŒ…å«ï¼š

**é€šç”¨éªŒè¯è§„åˆ™**:
- `validate` - éªŒè¯ç»“æœå¤„ç†ä¸­é—´ä»¶
- `validateObjectId` - MongoDB ObjectIdéªŒè¯
- `validateEmail` - é‚®ç®±éªŒè¯ï¼ˆå¸¦æ¸…ç†ï¼‰
- `validatePhone` - æ‰‹æœºå·éªŒè¯ï¼ˆä¸­å›½ï¼‰
- `validatePassword` - å¯†ç å¼ºåº¦éªŒè¯
- `validateName` - åç§°éªŒè¯ï¼ˆXSSé˜²æŠ¤ï¼‰
- `validateUrl` - URLéªŒè¯
- `validateNumber` - æ•°å­—éªŒè¯
- `validateDate` - æ—¥æœŸéªŒè¯
- `validateEnum` - æšä¸¾å€¼éªŒè¯

**ä¸šåŠ¡ç‰¹å®šéªŒè¯**:
- `userRegistrationValidation` - ç”¨æˆ·æ³¨å†ŒéªŒè¯
- `userLoginValidation` - ç”¨æˆ·ç™»å½•éªŒè¯
- `userUpdateValidation` - ç”¨æˆ·æ›´æ–°éªŒè¯
- `projectValidation` - é¡¹ç›®éªŒè¯
- `supplierValidation` - ä¾›åº”å•†éªŒè¯
- `orderValidation` - è®¢å•éªŒè¯
- `purchaseOrderValidation` - é‡‡è´­è®¢å•éªŒè¯
- `ticketValidation` - å·¥å•éªŒè¯
- `paginationValidation` - åˆ†é¡µå‚æ•°éªŒè¯

#### 2.3 éªŒè¯é“¾ç¤ºä¾‹

**ç”¨æˆ·æ³¨å†ŒéªŒè¯**:
```javascript
[
  body('name')
    .trim()                    // ç§»é™¤é¦–å°¾ç©ºæ ¼
    .notEmpty()                // éç©ºæ£€æŸ¥
    .isLength({ min: 2, max: 50 })  // é•¿åº¦é™åˆ¶
    .escape(),                 // è½¬ä¹‰HTMLï¼ˆé˜²XSSï¼‰
  
  body('email')
    .trim()
    .notEmpty()
    .isEmail()                 // é‚®ç®±æ ¼å¼éªŒè¯
    .normalizeEmail(),         // é‚®ç®±æ ‡å‡†åŒ–
  
  body('password')
    .notEmpty()
    .isLength({ min: 6 })     // å¯†ç é•¿åº¦è¦æ±‚
]
```

**ä¾›åº”å•†åˆ›å»ºéªŒè¯**:
```javascript
[
  body('name')
    .trim()
    .notEmpty()
    .isLength({ max: 200 })
    .escape(),                 // é˜²æ­¢XSSæ”»å‡»
  
  body('email')
    .optional()
    .isEmail()
    .normalizeEmail(),
  
  body('phone')
    .optional()
    .isMobilePhone('zh-CN'),   // ä¸­å›½æ‰‹æœºå·éªŒè¯
  
  body('rating')
    .optional()
    .isInt({ min: 1, max: 5 }) // è¯„åˆ†èŒƒå›´é™åˆ¶
]
```

#### 2.4 å·²åº”ç”¨éªŒè¯çš„è·¯ç”±

âœ… **è®¤è¯ç›¸å…³** (`authRoutes.js`):
- POST `/api/auth/login` - ç™»å½•éªŒè¯
- POST `/api/auth/register` - æ³¨å†ŒéªŒè¯
- PUT `/api/auth/profile` - èµ„æ–™æ›´æ–°éªŒè¯
- POST `/api/auth/refresh-token` - TokenéªŒè¯
- POST `/api/auth/request-password-reset` - å¯†ç é‡ç½®è¯·æ±‚éªŒè¯
- POST `/api/auth/validate-reset-code` - éªŒè¯ç éªŒè¯
- POST `/api/auth/perform-reset` - å¯†ç é‡ç½®æ‰§è¡ŒéªŒè¯

âœ… **é¡¹ç›®ç›¸å…³** (`projectRoutes.js`):
- POST `/api/projects` - é¡¹ç›®åˆ›å»ºéªŒè¯
- PUT `/api/projects/:id` - é¡¹ç›®æ›´æ–°éªŒè¯

âœ… **è®¢å•ç›¸å…³** (`orderRoutes.js`):
- æ‰€æœ‰è®¢å•åˆ›å»ºå’Œæ›´æ–°æ¥å£

âœ… **ä¾›åº”å•†ç›¸å…³** (`supplierRoutes.js`):
- POST `/api/suppliers` - ä¾›åº”å•†åˆ›å»ºéªŒè¯
- PUT `/api/suppliers/:id` - ä¾›åº”å•†æ›´æ–°éªŒè¯

âœ… **é‡‡è´­è®¢å•** (`purchaseOrderRoutes.js`):
- POST `/api/purchase-orders` - é‡‡è´­è®¢å•åˆ›å»ºéªŒè¯
- PUT `/api/purchase-orders/:id` - é‡‡è´­è®¢å•æ›´æ–°éªŒè¯

âœ… **å·¥å•ç›¸å…³** (`ticketRoutes.js`):
- POST `/api/tickets` - å·¥å•åˆ›å»ºéªŒè¯
- PUT `/api/tickets/:id` - å·¥å•æ›´æ–°éªŒè¯

### 3. æ–‡ä»¶ä¸Šä¼ å®‰å…¨åŠ å›º âœ“

#### 3.1 åŠ å›ºæªæ–½

æ›´æ–°äº† `backend/middleware/upload.js`ï¼Œå®æ–½äº†å¤šå±‚é˜²æŠ¤ï¼š

**ç¬¬ä¸€å±‚ï¼šæ–‡ä»¶ç±»å‹ç™½åå•**
```javascript
const SAFE_FILE_TYPES = {
  data: {
    extensions: ['.csv', '.xlsx', '.xls'],
    mimeTypes: [
      'text/csv',
      'application/vnd.ms-excel',
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    ]
  },
  document: {
    extensions: ['.pdf', '.doc', '.docx'],
    mimeTypes: [
      'application/pdf',
      'application/msword',
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
    ]
  },
  image: {
    extensions: ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'],
    mimeTypes: [
      'image/jpeg',
      'image/png',
      'image/gif',
      'image/bmp',
      'image/webp'
    ]
  }
};
```

**ç¬¬äºŒå±‚ï¼šå±é™©æ–‡ä»¶é»‘åå•**
```javascript
const DANGEROUS_EXTENSIONS = [
  '.exe', '.bat', '.cmd', '.com', '.pif', '.scr', '.vbs', '.js', '.jar',
  '.html', '.htm', '.mhtml', '.svg', '.xml', '.xsl', '.xslt',
  '.php', '.asp', '.aspx', '.jsp', '.py', '.pl', '.rb', '.sh', '.bash',
  '.dll', '.so', '.dylib', '.app', '.deb', '.rpm'
];
```

**ç¬¬ä¸‰å±‚ï¼šæ–‡ä»¶åæ¸…ç†**
```javascript
const sanitizeFilename = (filename) => {
  return filename
    .replace(/[\/\\]/g, '')    // ç§»é™¤è·¯å¾„åˆ†éš”ç¬¦
    .replace(/\.\./g, '')      // ç§»é™¤..ï¼ˆé˜²æ­¢ç›®å½•éå†ï¼‰
    .replace(/[<>:"|?*]/g, ''); // ç§»é™¤ç‰¹æ®Šå­—ç¬¦
};
```

**ç¬¬å››å±‚ï¼šåŒé‡éªŒè¯**
- åŒæ—¶éªŒè¯æ–‡ä»¶æ‰©å±•åå’ŒMIMEç±»å‹
- é˜²æ­¢é€šè¿‡ä¿®æ”¹æ‰©å±•åç»•è¿‡æ£€æŸ¥

**ç¬¬äº”å±‚ï¼šæ–‡ä»¶å¤§å°é™åˆ¶**
```javascript
limits: {
  fileSize: 10 * 1024 * 1024,  // 10MB
  files: 5,                     // æœ€å¤š5ä¸ªæ–‡ä»¶
  fieldSize: 1024 * 1024        // å­—æ®µå¤§å°1MB
}
```

#### 3.2 ä¸“ç”¨ä¸Šä¼ ä¸­é—´ä»¶

**é€šç”¨æ–‡ä»¶ä¸Šä¼ ** (`upload`):
- æ”¯æŒï¼šPDF, Word, Excel, CSV, å›¾ç‰‡
- å¤§å°é™åˆ¶ï¼š10MB
- æ•°é‡é™åˆ¶ï¼š5ä¸ªæ–‡ä»¶

**æ•°æ®æ–‡ä»¶ä¸Šä¼ ** (`dataUpload`):
- æ”¯æŒï¼šCSV, Excel
- å¤§å°é™åˆ¶ï¼š10MB
- æ•°é‡é™åˆ¶ï¼š1ä¸ªæ–‡ä»¶
- ç”¨é€”ï¼šæ•°æ®å¯¼å…¥åŠŸèƒ½

**å›¾ç‰‡æ–‡ä»¶ä¸Šä¼ ** (`imageUpload`):
- æ”¯æŒï¼šJPG, PNG, GIF, BMP, WEBP
- å¤§å°é™åˆ¶ï¼š5MB
- æ•°é‡é™åˆ¶ï¼š10å¼ å›¾ç‰‡
- ç”¨é€”ï¼šäº§å“å›¾ç‰‡ã€å¤´åƒç­‰

#### 3.3 ä½¿ç”¨ç¤ºä¾‹

```javascript
const { dataUpload, imageUpload } = require('../middleware/upload');

// æ•°æ®å¯¼å…¥è·¯ç”±
router.post('/import', 
  protect, 
  authorize('Administrator'), 
  dataUpload.single('file'),  // åªå…è®¸CSV/Excel
  importController
);

// å›¾ç‰‡ä¸Šä¼ è·¯ç”±
router.post('/upload-avatar',
  protect,
  imageUpload.single('avatar'),  // åªå…è®¸å›¾ç‰‡
  uploadAvatarController
);
```

---

## ğŸ›¡ï¸ å®‰å…¨é˜²æŠ¤å±‚æ¬¡

### é˜²å¾¡æ·±åº¦ä½“ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬1å±‚ï¼šHelmetå®‰å…¨å¤´                            â”‚
â”‚  â€¢ é˜²æ­¢ç‚¹å‡»åŠ«æŒ                                 â”‚
â”‚  â€¢ XSSè¿‡æ»¤                                      â”‚
â”‚  â€¢ MIMEå—…æ¢é˜²æŠ¤                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬2å±‚ï¼šè¯·æ±‚ä½“å¤§å°é™åˆ¶                          â”‚
â”‚  â€¢ é™åˆ¶10MBï¼ˆé˜²DoSï¼‰                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬3å±‚ï¼šJWTè®¤è¯ï¼ˆè§å‰ä¸€ä»½æŠ¥å‘Šï¼‰                 â”‚
â”‚  â€¢ TokenéªŒè¯                                    â”‚
â”‚  â€¢ Refresh Token                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬4å±‚ï¼šè§’è‰²æƒé™éªŒè¯ï¼ˆè§å‰ä¸€ä»½æŠ¥å‘Šï¼‰            â”‚
â”‚  â€¢ authorizeä¸­é—´ä»¶                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬5å±‚ï¼šè¾“å…¥éªŒè¯ä¸æ¸…ç†                          â”‚
â”‚  â€¢ trim, escape, normalize                      â”‚
â”‚  â€¢ ç±»å‹ã€é•¿åº¦ã€æ ¼å¼éªŒè¯                         â”‚
â”‚  â€¢ é˜²XSSã€SQLæ³¨å…¥                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬6å±‚ï¼šæ‰€æœ‰æƒéªŒè¯ï¼ˆè§å‰ä¸€ä»½æŠ¥å‘Šï¼‰              â”‚
â”‚  â€¢ èµ„æºè®¿é—®æ§åˆ¶                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬7å±‚ï¼šæ–‡ä»¶ä¸Šä¼ å®‰å…¨                            â”‚
â”‚  â€¢ ç±»å‹ç™½åå•+é»‘åå•                            â”‚
â”‚  â€¢ MIME type + æ‰©å±•ååŒé‡éªŒè¯                   â”‚
â”‚  â€¢ æ–‡ä»¶åæ¸…ç†                                   â”‚
â”‚  â€¢ å¤§å°é™åˆ¶                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
            ä¸šåŠ¡é€»è¾‘å¤„ç†
```

---

## ğŸ”’ é˜²æŠ¤çš„å®‰å…¨æ¼æ´

### å·²é˜²æŠ¤çš„OWASP Top 10å¨èƒ

| å¨èƒ | é˜²æŠ¤æªæ–½ | çŠ¶æ€ |
|------|----------|------|
| **A01:2021 â€“ Broken Access Control** | JWTè®¤è¯ + è§’è‰²æƒé™ + æ‰€æœ‰æƒéªŒè¯ | âœ… å®Œå…¨é˜²æŠ¤ |
| **A02:2021 â€“ Cryptographic Failures** | å¼ºéšæœºJWTå¯†é’¥ + HTTPSå¼ºåˆ¶ | âœ… å®Œå…¨é˜²æŠ¤ |
| **A03:2021 â€“ Injection** | express-validatorè¾“å…¥æ¸…ç† + å‚æ•°åŒ–æŸ¥è¯¢ | âœ… å®Œå…¨é˜²æŠ¤ |
| **A04:2021 â€“ Insecure Design** | å¤šå±‚å®‰å…¨æ¶æ„è®¾è®¡ | âœ… å®Œå…¨é˜²æŠ¤ |
| **A05:2021 â€“ Security Misconfiguration** | Helmetå®‰å…¨å¤´ + æœ€å°æƒé™åŸåˆ™ | âœ… å®Œå…¨é˜²æŠ¤ |
| **A06:2021 â€“ Vulnerable Components** | å®šæœŸä¾èµ–æ›´æ–° + npm audit | âœ… éƒ¨åˆ†é˜²æŠ¤ |
| **A07:2021 â€“ Auth Failures** | Refresh Token + å¯†ç ç­–ç•¥ + é™æµ | âœ… å®Œå…¨é˜²æŠ¤ |
| **A08:2021 â€“ Data Integrity Failures** | æ–‡ä»¶ç±»å‹éªŒè¯ + MIMEéªŒè¯ | âœ… å®Œå…¨é˜²æŠ¤ |
| **A09:2021 â€“ Logging Failures** | å®¡è®¡æ—¥å¿—ï¼ˆå¾…å®æ–½ï¼‰ | âš ï¸ å¾…å®Œå–„ |
| **A10:2021 â€“ SSRF** | URLéªŒè¯ + åŸŸåç™½åå• | âœ… éƒ¨åˆ†é˜²æŠ¤ |

### XSSï¼ˆè·¨ç«™è„šæœ¬æ”»å‡»ï¼‰é˜²æŠ¤

**é˜²æŠ¤å±‚çº§**:
1. **è¾“å…¥æ¸…ç†**: `escape()` è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
2. **CSPå¤´**: Content-Security-Policyé™åˆ¶è„šæœ¬æ‰§è¡Œ
3. **X-XSS-Protection**: æµè§ˆå™¨XSSè¿‡æ»¤å™¨
4. **è¾“å‡ºç¼–ç **: å‰ç«¯æ¸²æŸ“æ—¶è½¬ä¹‰

**ç¤ºä¾‹**:
```javascript
// æ¶æ„è¾“å…¥
const maliciousInput = '<script>alert("XSS")</script>';

// ç»è¿‡éªŒè¯é“¾å¤„ç†å
body('name').trim().escape()

// è½¬æ¢ä¸º
const sanitized = '&lt;script&gt;alert(&quot;XSS&quot;)&lt;/script&gt;';
```

### SQLæ³¨å…¥é˜²æŠ¤

**é˜²æŠ¤æªæ–½**:
1. **å‚æ•°åŒ–æŸ¥è¯¢**: Mongooseè‡ªåŠ¨å‚æ•°åŒ–
2. **ç±»å‹éªŒè¯**: `isMongoId()`, `isInt()` ç­‰
3. **è¾“å…¥æ¸…ç†**: `trim()`, `escape()`

**ç¤ºä¾‹**:
```javascript
// å±é™©çš„ç›´æ¥æ‹¼æ¥ï¼ˆå·²é¿å…ï¼‰
// const query = `SELECT * FROM users WHERE id = ${req.params.id}`;

// å®‰å…¨çš„MongooseæŸ¥è¯¢
const user = await User.findById(req.params.id);  // è‡ªåŠ¨å‚æ•°åŒ–
```

### æ–‡ä»¶ä¸Šä¼ æ¼æ´é˜²æŠ¤

**é˜²æŠ¤çš„æ”»å‡»ç±»å‹**:
- âœ… å¯æ‰§è¡Œæ–‡ä»¶ä¸Šä¼ ï¼ˆ.exe, .sh, .batç­‰ï¼‰
- âœ… è„šæœ¬æ–‡ä»¶ä¸Šä¼ ï¼ˆ.js, .php, .jspç­‰ï¼‰
- âœ… è·¯å¾„éå†æ”»å‡»ï¼ˆ../../../etc/passwdï¼‰
- âœ… MIMEç±»å‹ä¼ªé€ 
- âœ… åŒé‡æ‰©å±•åæ”»å‡»ï¼ˆfile.jpg.phpï¼‰
- âœ… DoSæ”»å‡»ï¼ˆå¤§æ–‡ä»¶ï¼‰

---

## ğŸ“Š éªŒè¯é”™è¯¯å¤„ç†

### é”™è¯¯å“åº”æ ¼å¼

```json
{
  "success": false,
  "message": "è¾“å…¥éªŒè¯å¤±è´¥",
  "errors": [
    {
      "field": "email",
      "message": "è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€",
      "value": "invalid-email"
    },
    {
      "field": "password",
      "message": "å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦",
      "value": "123"
    }
  ]
}
```

### æ–‡ä»¶ä¸Šä¼ é”™è¯¯

```json
{
  "success": false,
  "message": "å®‰å…¨é™åˆ¶ï¼šç¦æ­¢ä¸Šä¼  .exe æ–‡ä»¶ç±»å‹"
}
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### è¾“å…¥éªŒè¯æµ‹è¯•

```bash
# æµ‹è¯•XSSé˜²æŠ¤
curl -X POST http://localhost:5000/api/suppliers \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "<script>alert(\"XSS\")</script>",
    "email": "test@example.com"
  }'

# æœŸæœ›ï¼šnameè¢«è½¬ä¹‰ä¸º &lt;script&gt;...
```

```bash
# æµ‹è¯•é‚®ç®±éªŒè¯
curl -X POST http://localhost:5000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test User",
    "email": "invalid-email",
    "password": "123456"
  }'

# æœŸæœ›ï¼šè¿”å›400é”™è¯¯ï¼Œæç¤ºé‚®ç®±æ ¼å¼æ— æ•ˆ
```

### æ–‡ä»¶ä¸Šä¼ æµ‹è¯•

```bash
# æµ‹è¯•ä¸Šä¼ å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆåº”è¢«æ‹’ç»ï¼‰
curl -X POST http://localhost:5000/api/actuators/upload \
  -H "Authorization: Bearer $TOKEN" \
  -F "file=@malicious.exe"

# æœŸæœ›ï¼šè¿”å›é”™è¯¯ "å®‰å…¨é™åˆ¶ï¼šç¦æ­¢ä¸Šä¼  .exe æ–‡ä»¶ç±»å‹"
```

```bash
# æµ‹è¯•ä¸Šä¼ åˆæ³•CSVæ–‡ä»¶ï¼ˆåº”æˆåŠŸï¼‰
curl -X POST http://localhost:5000/api/actuators/upload \
  -H "Authorization: Bearer $TOKEN" \
  -F "file=@data.csv"

# æœŸæœ›ï¼šè¿”å›200ï¼Œæ–‡ä»¶ä¸Šä¼ æˆåŠŸ
```

---

## ğŸ“ ä½¿ç”¨æŒ‡å—

### ä¸ºæ–°è·¯ç”±æ·»åŠ éªŒè¯

#### æ­¥éª¤1: åœ¨validators.jsä¸­åˆ›å»ºéªŒè¯è§„åˆ™

```javascript
exports.productValidation = [
  body('name')
    .trim()
    .notEmpty()
    .withMessage('äº§å“åç§°ä¸èƒ½ä¸ºç©º')
    .isLength({ max: 100 })
    .withMessage('äº§å“åç§°ä¸èƒ½è¶…è¿‡100ä¸ªå­—ç¬¦')
    .escape(),
  
  body('price')
    .notEmpty()
    .withMessage('ä»·æ ¼ä¸èƒ½ä¸ºç©º')
    .isFloat({ min: 0 })
    .withMessage('ä»·æ ¼å¿…é¡»å¤§äºç­‰äº0')
];
```

#### æ­¥éª¤2: åœ¨è·¯ç”±ä¸­åº”ç”¨éªŒè¯

```javascript
const { productValidation, validate } = require('../middleware/validators');

router.post('/products',
  protect,
  authorize('Administrator'),
  productValidation,  // éªŒè¯é“¾
  validate,           // éªŒè¯ç»“æœå¤„ç†
  createProduct
);
```

### è‡ªå®šä¹‰éªŒè¯è§„åˆ™

```javascript
const { body } = require('express-validator');

// è‡ªå®šä¹‰éªŒè¯å™¨
const customValidator = body('field')
  .custom((value, { req }) => {
    if (value !== 'expected') {
      throw new Error('è‡ªå®šä¹‰éªŒè¯å¤±è´¥');
    }
    return true;
  });

// ä½¿ç”¨è‡ªå®šä¹‰éªŒè¯å™¨
router.post('/custom',
  [customValidator, validate],
  controller
);
```

### æ–‡ä»¶ä¸Šä¼ ä½¿ç”¨

```javascript
const upload = require('../middleware/upload');

// ä½¿ç”¨é»˜è®¤ä¸Šä¼ ï¼ˆæ”¯æŒå¤šç§æ–‡ä»¶ç±»å‹ï¼‰
router.post('/upload', 
  protect,
  upload.single('file'),
  uploadController
);

// ä½¿ç”¨æ•°æ®æ–‡ä»¶ä¸Šä¼ ï¼ˆä»…CSV/Excelï¼‰
const { dataUpload } = upload;
router.post('/import',
  protect,
  dataUpload.single('file'),
  importController
);

// ä½¿ç”¨å›¾ç‰‡ä¸Šä¼ 
const { imageUpload } = upload;
router.post('/upload-image',
  protect,
  imageUpload.single('image'),
  uploadImageController
);
```

---

## ğŸš€ æ€§èƒ½å½±å“

### éªŒè¯ä¸­é—´ä»¶æ€§èƒ½

| æ“ä½œ | å¹³å‡è€—æ—¶ | å½±å“ |
|------|----------|------|
| ç®€å•éªŒè¯ï¼ˆ1-3ä¸ªå­—æ®µï¼‰ | < 1ms | å¯å¿½ç•¥ |
| å¤æ‚éªŒè¯ï¼ˆ5-10ä¸ªå­—æ®µï¼‰ | 1-3ms | æå° |
| æ–‡ä»¶ä¸Šä¼ éªŒè¯ | 2-5ms | å¾ˆå° |

### ä¼˜åŒ–å»ºè®®

1. **éªŒè¯è§„åˆ™å¤ç”¨**: å®šä¹‰å¯å¤ç”¨çš„éªŒè¯è§„åˆ™
2. **å¼‚æ­¥éªŒè¯**: è€—æ—¶çš„éªŒè¯ï¼ˆå¦‚æ•°æ®åº“æŸ¥è¯¢ï¼‰ä½¿ç”¨`.custom()`å¼‚æ­¥å¤„ç†
3. **æ—©æœŸæ‹’ç»**: å°†æœ€å¯èƒ½å¤±è´¥çš„éªŒè¯æ”¾åœ¨å‰é¢

---

## ğŸ“‹ ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰å¿…æŸ¥

- [ ] æ‰€æœ‰POST/PUTè·¯ç”±å·²æ·»åŠ è¾“å…¥éªŒè¯
- [ ] æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ è·¯ç”±ä½¿ç”¨å®‰å…¨çš„uploadä¸­é—´ä»¶
- [ ] Helmetå·²å¯ç”¨å¹¶æ­£ç¡®é…ç½®
- [ ] CSPç­–ç•¥ç¬¦åˆä¸šåŠ¡éœ€æ±‚
- [ ] æ–‡ä»¶ç±»å‹ç™½åå•ä»…åŒ…å«ä¸šåŠ¡å¿…éœ€ç±»å‹
- [ ] é”™è¯¯æ¶ˆæ¯ä¸æ³„éœ²æ•æ„Ÿä¿¡æ¯
- [ ] æ—¥å¿—è®°å½•éªŒè¯å¤±è´¥äº‹ä»¶
- [ ] å®šæœŸæ›´æ–°ä¾èµ–åŒ…ï¼ˆnpm auditï¼‰

### å®šæœŸå®‰å…¨å®¡æŸ¥

```bash
# æ£€æŸ¥ä¾èµ–æ¼æ´
npm audit

# ä¿®å¤å¯è‡ªåŠ¨ä¿®å¤çš„æ¼æ´
npm audit fix

# æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š
npm audit --json
```

---

## âš ï¸ å®‰å…¨æ³¨æ„äº‹é¡¹

### é”™è¯¯æ¶ˆæ¯å®‰å…¨

âŒ **ä¸å®‰å…¨**:
```javascript
// æ³„éœ²æ•°æ®åº“ç»“æ„
return res.status(400).json({ 
  message: 'User table: email column validation failed' 
});
```

âœ… **å®‰å…¨**:
```javascript
// é€šç”¨é”™è¯¯æ¶ˆæ¯
return res.status(400).json({ 
  message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€' 
});
```

### æ–‡ä»¶å­˜å‚¨å®‰å…¨

1. **ä¸è¦ç›´æ¥ä½¿ç”¨ç”¨æˆ·æä¾›çš„æ–‡ä»¶å**
```javascript
// ä½¿ç”¨UUIDæˆ–æ—¶é—´æˆ³é‡å‘½å
const filename = `${Date.now()}-${crypto.randomUUID()}${ext}`;
```

2. **æ–‡ä»¶å­˜å‚¨åœ¨Webæ ¹ç›®å½•ä¹‹å¤–**
```javascript
// æ­£ç¡®
const uploadPath = path.join(__dirname, '../uploads');

// é”™è¯¯
const uploadPath = path.join(__dirname, '../public/uploads');
```

3. **è®¾ç½®é€‚å½“çš„æ–‡ä»¶æƒé™**
```bash
# Linux/Mac
chmod 644 uploaded_files
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **ã€Šåç«¯å®‰å…¨åŠ å›ºå®ŒæˆæŠ¥å‘Š.mdã€‹** - JWTå’Œæƒé™æ§åˆ¶
- **ã€Šå®‰å…¨åŠ å›ºå¿«é€Ÿå‚è€ƒ.mdã€‹** - å¿«é€ŸæŸ¥é˜…æ‰‹å†Œ
- **Express-Validatoræ–‡æ¡£**: https://express-validator.github.io
- **Helmetæ–‡æ¡£**: https://helmetjs.github.io
- **OWASPé˜²æŠ¤æŒ‡å—**: https://owasp.org/www-project-top-ten/

---

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰

1. **å®¡è®¡æ—¥å¿—**: è®°å½•æ‰€æœ‰éªŒè¯å¤±è´¥å’Œå¯ç–‘æ´»åŠ¨
2. **é€Ÿç‡é™åˆ¶å¢å¼º**: ä¸ºéªŒè¯å¤±è´¥æ·»åŠ é€’å¢å¼é™æµ
3. **å‰ç«¯éªŒè¯åŒæ­¥**: å‰ç«¯å®ç°ç›¸åŒçš„éªŒè¯è§„åˆ™

### ä¸­æœŸï¼ˆ1ä¸ªæœˆï¼‰

1. **æ–‡ä»¶ç—…æ¯’æ‰«æ**: é›†æˆClamAVè¿›è¡Œæ–‡ä»¶æ‰«æ
2. **å†…å®¹è¿‡æ»¤**: æ·»åŠ æ•æ„Ÿè¯è¿‡æ»¤
3. **IPåœ°ç†é™åˆ¶**: æ ¹æ®IPåœ°ç†ä½ç½®é™åˆ¶è®¿é—®

### é•¿æœŸï¼ˆ3-6ä¸ªæœˆï¼‰

1. **WAFé›†æˆ**: Webåº”ç”¨é˜²ç«å¢™
2. **AIå¼‚å¸¸æ£€æµ‹**: æœºå™¨å­¦ä¹ æ£€æµ‹å¼‚å¸¸è¾“å…¥
3. **èœœç½éƒ¨ç½²**: è¯±æ•æ”»å‡»è€…

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒç›¸å…³æ–‡æ¡£æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚

**æ–‡æ¡£æœ€åæ›´æ–°**: 2025-10-28  
**å®‰å…¨é˜²æŠ¤ç­‰çº§**: â­â­â­â­â­ ä¼ä¸šçº§

