# 文件上传服务快速参考

**⏱️ 2分钟快速开始**

---

## 🚀 快速使用

### 方法1：使用通用API（推荐）

#### 前端上传代码
```javascript
async function uploadFile(file, folder = 'uploads') {
  const formData = new FormData();
  formData.append('file', file);
  
  const response = await fetch(
    `http://localhost:5001/api/uploads/single?folder=${folder}`,
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: formData
    }
  );
  
  const result = await response.json();
  return result.file.url;  // 返回文件URL
}

// 使用
const fileUrl = await uploadFile(file, 'contracts');
```

#### React组件
```jsx
import { Upload, Button } from 'antd';
import axios from 'axios';

const FileUploader = ({ onSuccess }) => {
  const handleUpload = async ({ file }) => {
    const formData = new FormData();
    formData.append('file', file);
    
    const res = await axios.post(
      'http://localhost:5001/api/uploads/single?folder=contracts',
      formData,
      {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'multipart/form-data'
        }
      }
    );
    
    onSuccess(res.data.file);
  };
  
  return (
    <Upload customRequest={handleUpload}>
      <Button>上传文件</Button>
    </Upload>
  );
};
```

---

### 方法2：在后端路由中使用

```javascript
// 在任意路由文件中
const { createUploadMiddleware, getFileInfo } = require('../services/upload.service');

router.post('/create-order', protect, (req, res) => {
  // 创建上传中间件
  const uploadMiddleware = createUploadMiddleware({
    folderName: 'orders',
    storageType: 'local'  // 或 'cloudinary'
  });
  
  // 使用中间件
  uploadMiddleware(req, res, async (err) => {
    if (err) {
      return res.status(400).json({ message: err.message });
    }
    
    // 获取文件信息
    const fileInfo = getFileInfo(req.file);
    
    // 创建订单并保存文件信息
    const order = await Order.create({
      ...req.body,
      contractFile: fileInfo.url
    });
    
    res.json({ success: true, data: order });
  });
});
```

---

## 📋 API端点速查

| 端点 | 用途 | 文件夹 |
|------|------|--------|
| `POST /api/uploads/single` | 通用单文件上传 | 自定义 |
| `POST /api/uploads/multiple` | 通用多文件上传 | 自定义 |
| `POST /api/uploads/contract` | 合同文件 | contracts |
| `POST /api/uploads/project` | 项目文件 | projects |
| `POST /api/uploads/purchase-order` | 采购订单 | purchase_orders |
| `DELETE /api/uploads/:id` | 删除文件 | - |
| `GET /api/uploads/info` | 配置信息 | - |

---

## 🔧 环境配置

### 本地存储（默认）
```env
USE_CLOUDINARY=false
```

### Cloudinary云存储
```env
USE_CLOUDINARY=true
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_api_key
CLOUDINARY_API_SECRET=your_api_secret
```

**安装Cloudinary依赖**:
```bash
npm install cloudinary multer-storage-cloudinary
```

---

## 📦 支持的文件类型

✅ **图片**: jpg, jpeg, png, gif, webp  
✅ **文档**: pdf, doc, docx, xls, xlsx, csv  
✅ **压缩**: zip  
📏 **大小**: 最大10MB

---

## 💡 常用场景

### 场景1：上传合同
```javascript
// 前端
const url = await uploadFile(contractFile, 'contracts');

// 或使用专用接口
const formData = new FormData();
formData.append('file', contractFile);
await axios.post('/api/uploads/contract', formData);
```

### 场景2：上传多个文件
```javascript
const formData = new FormData();
files.forEach(file => {
  formData.append('files', file);
});

const res = await axios.post(
  '/api/uploads/multiple?folder=projects',
  formData
);

console.log('上传的文件:', res.data.files);
```

### 场景3：上传后保存到数据库
```javascript
// 上传文件
const fileInfo = await uploadFile(file, 'projects');

// 保存到数据库
await projectsAPI.update(projectId, {
  documents: [{
    name: file.name,
    url: fileInfo.url,
    uploadedAt: new Date()
  }]
});
```

---

## 🔍 查看上传的文件

### 本地存储
```
http://localhost:5001/uploads/{folder}/{filename}
```

例如:
```
http://localhost:5001/uploads/contracts/contract-1698765432123.pdf
```

### Cloudinary
直接使用返回的URL（已包含CDN）:
```
https://res.cloudinary.com/your-cloud/image/upload/v1234567890/contracts/file.pdf
```

---

## ⚠️ 注意事项

1. **认证**: 所有上传接口需要JWT token
2. **文件名**: 表单字段名必须是 `file` 或 `files`
3. **大小**: 默认限制10MB
4. **类型**: 只允许列表中的文件类型

---

## 🆘 常见错误

### 错误1: "请选择要上传的文件"
**原因**: 表单字段名不正确  
**解决**: 使用 `file` 或 `files` 作为字段名

### 错误2: "不支持的文件类型"
**原因**: 文件类型不在允许列表  
**解决**: 检查文件扩展名是否支持

### 错误3: 403错误
**原因**: 未提供token或token过期  
**解决**: 检查Authorization头

---

## 📚 完整文档

详细文档请参考: `通用文件上传服务完整文档.md`

---

## ✅ 检查清单

使用前确认:
- [ ] 后端服务已启动
- [ ] 环境变量已配置（如使用Cloudinary）
- [ ] 有有效的JWT token
- [ ] 文件类型在支持列表中

开始上传！🚀

