# æ–‡ä»¶ä¸Šä¼ æœåŠ¡å¿«é€Ÿå‚è€ƒ

**â±ï¸ 2åˆ†é’Ÿå¿«é€Ÿå¼€å§‹**

---

## ğŸš€ å¿«é€Ÿä½¿ç”¨

### æ–¹æ³•1ï¼šä½¿ç”¨é€šç”¨APIï¼ˆæ¨èï¼‰

#### å‰ç«¯ä¸Šä¼ ä»£ç 
```javascript
async function uploadFile(file, folder = 'uploads') {
  const formData = new FormData();
  formData.append('file', file);
  
  const response = await fetch(
    `http://localhost:5001/api/uploads/single?folder=${folder}`,
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: formData
    }
  );
  
  const result = await response.json();
  return result.file.url;  // è¿”å›æ–‡ä»¶URL
}

// ä½¿ç”¨
const fileUrl = await uploadFile(file, 'contracts');
```

#### Reactç»„ä»¶
```jsx
import { Upload, Button } from 'antd';
import axios from 'axios';

const FileUploader = ({ onSuccess }) => {
  const handleUpload = async ({ file }) => {
    const formData = new FormData();
    formData.append('file', file);
    
    const res = await axios.post(
      'http://localhost:5001/api/uploads/single?folder=contracts',
      formData,
      {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'multipart/form-data'
        }
      }
    );
    
    onSuccess(res.data.file);
  };
  
  return (
    <Upload customRequest={handleUpload}>
      <Button>ä¸Šä¼ æ–‡ä»¶</Button>
    </Upload>
  );
};
```

---

### æ–¹æ³•2ï¼šåœ¨åç«¯è·¯ç”±ä¸­ä½¿ç”¨

```javascript
// åœ¨ä»»æ„è·¯ç”±æ–‡ä»¶ä¸­
const { createUploadMiddleware, getFileInfo } = require('../services/upload.service');

router.post('/create-order', protect, (req, res) => {
  // åˆ›å»ºä¸Šä¼ ä¸­é—´ä»¶
  const uploadMiddleware = createUploadMiddleware({
    folderName: 'orders',
    storageType: 'local'  // æˆ– 'cloudinary'
  });
  
  // ä½¿ç”¨ä¸­é—´ä»¶
  uploadMiddleware(req, res, async (err) => {
    if (err) {
      return res.status(400).json({ message: err.message });
    }
    
    // è·å–æ–‡ä»¶ä¿¡æ¯
    const fileInfo = getFileInfo(req.file);
    
    // åˆ›å»ºè®¢å•å¹¶ä¿å­˜æ–‡ä»¶ä¿¡æ¯
    const order = await Order.create({
      ...req.body,
      contractFile: fileInfo.url
    });
    
    res.json({ success: true, data: order });
  });
});
```

---

## ğŸ“‹ APIç«¯ç‚¹é€ŸæŸ¥

| ç«¯ç‚¹ | ç”¨é€” | æ–‡ä»¶å¤¹ |
|------|------|--------|
| `POST /api/uploads/single` | é€šç”¨å•æ–‡ä»¶ä¸Šä¼  | è‡ªå®šä¹‰ |
| `POST /api/uploads/multiple` | é€šç”¨å¤šæ–‡ä»¶ä¸Šä¼  | è‡ªå®šä¹‰ |
| `POST /api/uploads/contract` | åˆåŒæ–‡ä»¶ | contracts |
| `POST /api/uploads/project` | é¡¹ç›®æ–‡ä»¶ | projects |
| `POST /api/uploads/purchase-order` | é‡‡è´­è®¢å• | purchase_orders |
| `DELETE /api/uploads/:id` | åˆ é™¤æ–‡ä»¶ | - |
| `GET /api/uploads/info` | é…ç½®ä¿¡æ¯ | - |

---

## ğŸ”§ ç¯å¢ƒé…ç½®

### æœ¬åœ°å­˜å‚¨ï¼ˆé»˜è®¤ï¼‰
```env
USE_CLOUDINARY=false
```

### Cloudinaryäº‘å­˜å‚¨
```env
USE_CLOUDINARY=true
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_api_key
CLOUDINARY_API_SECRET=your_api_secret
```

**å®‰è£…Cloudinaryä¾èµ–**:
```bash
npm install cloudinary multer-storage-cloudinary
```

---

## ğŸ“¦ æ”¯æŒçš„æ–‡ä»¶ç±»å‹

âœ… **å›¾ç‰‡**: jpg, jpeg, png, gif, webp  
âœ… **æ–‡æ¡£**: pdf, doc, docx, xls, xlsx, csv  
âœ… **å‹ç¼©**: zip  
ğŸ“ **å¤§å°**: æœ€å¤§10MB

---

## ğŸ’¡ å¸¸ç”¨åœºæ™¯

### åœºæ™¯1ï¼šä¸Šä¼ åˆåŒ
```javascript
// å‰ç«¯
const url = await uploadFile(contractFile, 'contracts');

// æˆ–ä½¿ç”¨ä¸“ç”¨æ¥å£
const formData = new FormData();
formData.append('file', contractFile);
await axios.post('/api/uploads/contract', formData);
```

### åœºæ™¯2ï¼šä¸Šä¼ å¤šä¸ªæ–‡ä»¶
```javascript
const formData = new FormData();
files.forEach(file => {
  formData.append('files', file);
});

const res = await axios.post(
  '/api/uploads/multiple?folder=projects',
  formData
);

console.log('ä¸Šä¼ çš„æ–‡ä»¶:', res.data.files);
```

### åœºæ™¯3ï¼šä¸Šä¼ åä¿å­˜åˆ°æ•°æ®åº“
```javascript
// ä¸Šä¼ æ–‡ä»¶
const fileInfo = await uploadFile(file, 'projects');

// ä¿å­˜åˆ°æ•°æ®åº“
await projectsAPI.update(projectId, {
  documents: [{
    name: file.name,
    url: fileInfo.url,
    uploadedAt: new Date()
  }]
});
```

---

## ğŸ” æŸ¥çœ‹ä¸Šä¼ çš„æ–‡ä»¶

### æœ¬åœ°å­˜å‚¨
```
http://localhost:5001/uploads/{folder}/{filename}
```

ä¾‹å¦‚:
```
http://localhost:5001/uploads/contracts/contract-1698765432123.pdf
```

### Cloudinary
ç›´æ¥ä½¿ç”¨è¿”å›çš„URLï¼ˆå·²åŒ…å«CDNï¼‰:
```
https://res.cloudinary.com/your-cloud/image/upload/v1234567890/contracts/file.pdf
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **è®¤è¯**: æ‰€æœ‰ä¸Šä¼ æ¥å£éœ€è¦JWT token
2. **æ–‡ä»¶å**: è¡¨å•å­—æ®µåå¿…é¡»æ˜¯ `file` æˆ– `files`
3. **å¤§å°**: é»˜è®¤é™åˆ¶10MB
4. **ç±»å‹**: åªå…è®¸åˆ—è¡¨ä¸­çš„æ–‡ä»¶ç±»å‹

---

## ğŸ†˜ å¸¸è§é”™è¯¯

### é”™è¯¯1: "è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶"
**åŸå› **: è¡¨å•å­—æ®µåä¸æ­£ç¡®  
**è§£å†³**: ä½¿ç”¨ `file` æˆ– `files` ä½œä¸ºå­—æ®µå

### é”™è¯¯2: "ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹"
**åŸå› **: æ–‡ä»¶ç±»å‹ä¸åœ¨å…è®¸åˆ—è¡¨  
**è§£å†³**: æ£€æŸ¥æ–‡ä»¶æ‰©å±•åæ˜¯å¦æ”¯æŒ

### é”™è¯¯3: 403é”™è¯¯
**åŸå› **: æœªæä¾›tokenæˆ–tokenè¿‡æœŸ  
**è§£å†³**: æ£€æŸ¥Authorizationå¤´

---

## ğŸ“š å®Œæ•´æ–‡æ¡£

è¯¦ç»†æ–‡æ¡£è¯·å‚è€ƒ: `é€šç”¨æ–‡ä»¶ä¸Šä¼ æœåŠ¡å®Œæ•´æ–‡æ¡£.md`

---

## âœ… æ£€æŸ¥æ¸…å•

ä½¿ç”¨å‰ç¡®è®¤:
- [ ] åç«¯æœåŠ¡å·²å¯åŠ¨
- [ ] ç¯å¢ƒå˜é‡å·²é…ç½®ï¼ˆå¦‚ä½¿ç”¨Cloudinaryï¼‰
- [ ] æœ‰æœ‰æ•ˆçš„JWT token
- [ ] æ–‡ä»¶ç±»å‹åœ¨æ”¯æŒåˆ—è¡¨ä¸­

å¼€å§‹ä¸Šä¼ ï¼ğŸš€

