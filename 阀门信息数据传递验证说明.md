# é˜€é—¨ä¿¡æ¯æ•°æ®ä¼ é€’éªŒè¯è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

å·²éªŒè¯å¹¶ä¼˜åŒ–äº†å‰ç«¯ä¿å­˜é€‰å‹è®°å½•æ—¶é˜€é—¨ä¿¡æ¯ï¼ˆ`valve_size` å’Œ `flange_size`ï¼‰çš„æ•°æ®ä¼ é€’æµç¨‹ã€‚æ•°æ®ä¼šè‡ªåŠ¨åŒ…å«åœ¨ `input_params` ä¸­å‘é€åˆ°åç«¯ã€‚

---

## âœ… å½“å‰å®ç°éªŒè¯

### æ–‡ä»¶
`frontend/src/pages/SelectionEngine.jsx`

### å‡½æ•°
`handleSaveToProject` (ç¬¬ 116-161 è¡Œ)

---

## ğŸ”„ å®Œæ•´æ•°æ®æµç¨‹

### æ­¥éª¤ 1: ç”¨æˆ·å¡«å†™è¡¨å•
```
ç”¨æˆ·åœ¨é€‰å‹ç•Œé¢è¾“å…¥ï¼š
â”œâ”€ æ‰§è¡Œæœºæ„ç±»å‹: "Scotch Yoke"
â”œâ”€ é˜€é—¨ç±»å‹: "Ball Valve"
â”œâ”€ é˜€é—¨å£å¾„: "DN100"          â† æ–°å¢å­—æ®µ
â”œâ”€ æ³•å…°è¿æ¥å°ºå¯¸: "F07/F10"    â† æ–°å¢å­—æ®µ
â”œâ”€ ä½å·æ ‡è¯†: "FV-101"
â”œâ”€ éœ€æ±‚æ‰­çŸ©: 100
â””â”€ å·¥ä½œå‹åŠ›: 0.6
```

---

### æ­¥éª¤ 2: å‰ç«¯è·å–è¡¨å•æ•°æ®
```javascript
// åœ¨ handleSaveToProject å‡½æ•°ä¸­
const formValues = form.getFieldsValue()

// formValues å¯¹è±¡åŒ…å«æ‰€æœ‰è¡¨å•å­—æ®µï¼š
{
  mechanism: "Scotch Yoke",
  valve_type: "Ball Valve",
  valve_size: "DN100",           // âœ… è‡ªåŠ¨åŒ…å«
  flange_size: "F07/F10",        // âœ… è‡ªåŠ¨åŒ…å«
  tag_number: "FV-101",
  required_torque: 100,
  working_pressure: 0.6,
  working_angle: 90,
  needs_manual_override: false,
  max_budget: undefined,
  // ... æ‰€æœ‰å…¶ä»–è¡¨å•å­—æ®µ
}
```

---

### æ­¥éª¤ 3: æ„å»ºé€‰å‹æ•°æ®
```javascript
const selectionData = {
  tag_number: formValues.tag_number || `TAG-${Date.now()}`,
  
  // âœ… å…³é”®ï¼šinput_params åŒ…å«æ‰€æœ‰è¡¨å•å­—æ®µ
  input_params: formValues,  // è¿™é‡ŒåŒ…å« valve_size å’Œ flange_size
  
  selected_actuator: selectedActuator,
  selected_override: selectedOverride
}

// è°ƒè¯•æ—¥å¿—è¾“å‡º
console.log('ä¿å­˜é€‰å‹è®°å½•:', {
  tag_number: selectionData.tag_number,
  valve_size: formValues.valve_size,      // âœ… æ˜¾ç¤ºé˜€é—¨å£å¾„
  flange_size: formValues.flange_size,    // âœ… æ˜¾ç¤ºæ³•å…°å°ºå¯¸
  mechanism: formValues.mechanism,
  valve_type: formValues.valve_type
})
```

---

### æ­¥éª¤ 4: å‘é€åˆ°åç«¯
```javascript
// è°ƒç”¨ API
await projectsAPI.autoSelect(currentProject._id, selectionData)

// å®é™…å‘é€çš„æ•°æ®ç»“æ„ï¼š
{
  tag_number: "FV-101",
  input_params: {
    mechanism: "Scotch Yoke",
    valve_type: "Ball Valve",
    valve_size: "DN100",           // âœ… åŒ…å«
    flange_size: "F07/F10",        // âœ… åŒ…å«
    required_torque: 100,
    working_pressure: 0.6,
    working_angle: 90,
    needs_manual_override: false
  },
  selected_actuator: {
    model_base: "SF14-200DA",
    recommended_model: "SF14-200DA",
    actual_torque: 150,
    price: 2850
  },
  selected_override: null
}
```

---

### æ­¥éª¤ 5: åç«¯æ¥æ”¶å¹¶å­˜å‚¨
```javascript
// backend/controllers/newProjectController.js
exports.addSelection = async (req, res) => {
  const { tag_number, input_params, selected_actuator, selected_override } = req.body;
  
  // input_params åŒ…å«æ‰€æœ‰è¡¨å•å­—æ®µ
  // åŒ…æ‹¬ valve_size å’Œ flange_size âœ…
  
  const newSelection = {
    tag_number,
    input_params,  // âœ… è‡ªåŠ¨å­˜å‚¨æ‰€æœ‰å­—æ®µï¼ˆMixed ç±»å‹ï¼‰
    selected_actuator,
    selected_override,
    status: 'å·²é€‰å‹'
  };
  
  project.selections.push(newSelection);
  await project.save();
}
```

---

### æ­¥éª¤ 6: æ•°æ®åº“å­˜å‚¨
```javascript
// MongoDB ä¸­çš„æ•°æ®
{
  "_id": "...",
  "project_name": "æŸæŸé¡¹ç›®",
  "selections": [
    {
      "tag_number": "FV-101",
      "input_params": {
        "mechanism": "Scotch Yoke",
        "valve_type": "Ball Valve",
        "valve_size": "DN100",        // âœ… å·²å­˜å‚¨
        "flange_size": "F07/F10",     // âœ… å·²å­˜å‚¨
        "required_torque": 100,
        "working_pressure": 0.6,
        "working_angle": 90
      },
      "selected_actuator": {
        "model_base": "SF14-200DA",
        "actual_torque": 150,
        "price": 2850
      },
      "status": "å·²é€‰å‹",
      "total_price": 2850
    }
  ]
}
```

---

## ğŸ¯ å…³é”®ç‚¹è¯´æ˜

### 1. è‡ªåŠ¨åŒ…å«æœºåˆ¶ âœ…

`form.getFieldsValue()` æ–¹æ³•ä¼šè‡ªåŠ¨è·å–è¡¨å•ä¸­**æ‰€æœ‰å·²æ³¨å†Œçš„å­—æ®µ**ï¼ŒåŒ…æ‹¬ï¼š
- å¿…å¡«å­—æ®µ
- å¯é€‰å­—æ®µ
- æ–°æ·»åŠ çš„å­—æ®µ

å› æ­¤ï¼Œ`valve_size` å’Œ `flange_size` ä¼šè‡ªåŠ¨åŒ…å«åœ¨ `formValues` å¯¹è±¡ä¸­ã€‚

---

### 2. API æ¥å£åŒºåˆ† âš ï¸

#### `/api/selection/calculate` (é€‰å‹è®¡ç®—)
- **ä¸éœ€è¦** `valve_size` å’Œ `flange_size`
- åªéœ€è¦æ‰­çŸ©è®¡ç®—ç›¸å…³çš„å‚æ•°
- ä¸ä¼šä¿å­˜æ•°æ®

```javascript
// handleSearch å‡½æ•° - åªç”¨äºè®¡ç®—
const requestPayload = {
  mechanism: values.mechanism,
  valve_type: values.valve_type,
  required_torque: values.required_torque,
  working_pressure: values.working_pressure,
  // âŒ ä¸éœ€è¦ valve_size å’Œ flange_size
}
await selectionAPI.calculate(requestPayload)
```

#### `/api/projects/:id/selections` (ä¿å­˜é€‰å‹è®°å½•)
- **éœ€è¦** `valve_size` å’Œ `flange_size`
- ä¿å­˜å®Œæ•´çš„é€‰å‹è®°å½•
- æ‰€æœ‰è¡¨å•å­—æ®µéƒ½ä¼šè¢«ä¿å­˜

```javascript
// handleSaveToProject å‡½æ•° - ä¿å­˜å®Œæ•´è®°å½•
const selectionData = {
  input_params: formValues,  // âœ… åŒ…å«æ‰€æœ‰å­—æ®µ
  // ...
}
await projectsAPI.autoSelect(currentProject._id, selectionData)
```

---

## ğŸ“Š ä»£ç ä¼˜åŒ–å¯¹æ¯”

### ä¼˜åŒ–å‰
```javascript
const handleSaveToProject = async () => {
  try {
    const formValues = form.getFieldsValue()
    const selectionData = {
      tag_number: formValues.tag_number || `TAG-${Date.now()}`,
      input_params: formValues,
      selected_actuator: selectedActuator,
      selected_override: selectedOverride
    }
    await projectsAPI.autoSelect(currentProject._id, selectionData)
    message.success('å·²ä¿å­˜åˆ°é¡¹ç›®')
  } catch (error) {
    message.error('ä¿å­˜å¤±è´¥')
  }
}
```

### ä¼˜åŒ–å
```javascript
const handleSaveToProject = async () => {
  try {
    // è·å–æ‰€æœ‰è¡¨å•å€¼ï¼ˆåŒ…æ‹¬é˜€é—¨ä¿¡æ¯ï¼‰
    const formValues = form.getFieldsValue()
    
    // æ„å»ºé€‰å‹æ•°æ®
    // input_params å°†åŒ…å«æ‰€æœ‰è¡¨å•å­—æ®µï¼ŒåŒ…æ‹¬ï¼š
    // - mechanism, valve_type
    // - valve_size, flange_size (é˜€é—¨ç‰©ç†ä¿¡æ¯) âœ…
    // - required_torque, working_pressure, working_angle
    // - needs_manual_override, max_budget ç­‰
    const selectionData = {
      tag_number: formValues.tag_number || `TAG-${Date.now()}`,
      input_params: formValues, // åŒ…å«æ‰€æœ‰è¡¨å•å­—æ®µ
      selected_actuator: selectedActuator,
      selected_override: selectedOverride
    }

    // è°ƒè¯•æ—¥å¿—ï¼šæ˜¾ç¤ºå°†è¦ä¿å­˜çš„æ•°æ® âœ…
    console.log('ä¿å­˜é€‰å‹è®°å½•:', {
      tag_number: selectionData.tag_number,
      valve_size: formValues.valve_size,
      flange_size: formValues.flange_size,
      mechanism: formValues.mechanism,
      valve_type: formValues.valve_type
    })

    await projectsAPI.autoSelect(currentProject._id, selectionData)
    message.success('å·²ä¿å­˜åˆ°é¡¹ç›®')
  } catch (error) {
    console.error('ä¿å­˜é€‰å‹è®°å½•å¤±è´¥:', error)  // âœ… æ›´è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
    message.error('ä¿å­˜å¤±è´¥')
  }
}
```

**æ”¹è¿›ç‚¹**:
1. âœ… æ·»åŠ äº†æ¸…æ™°çš„æ³¨é‡Šè¯´æ˜
2. âœ… æ·»åŠ äº†è°ƒè¯•æ—¥å¿—ï¼Œä¾¿äºéªŒè¯æ•°æ®
3. âœ… æ·»åŠ äº†é”™è¯¯æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•
4. âœ… æ˜ç¡®è¯´æ˜äº† `valve_size` å’Œ `flange_size` çš„ä¼ é€’

---

## ğŸ§ª æµ‹è¯•éªŒè¯æ­¥éª¤

### 1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·
```
F12 æˆ– å³é”® â†’ æ£€æŸ¥ â†’ Console
```

### 2. å¡«å†™é€‰å‹è¡¨å•
```
1. é€‰æ‹©æ‰§è¡Œæœºæ„ç±»å‹: "Scotch Yoke"
2. é€‰æ‹©é˜€é—¨ç±»å‹: "Ball Valve"
3. è¾“å…¥é˜€é—¨å£å¾„: "DN100"
4. è¾“å…¥æ³•å…°è¿æ¥å°ºå¯¸: "F07/F10"
5. å¡«å†™å…¶ä»–å¿…å¡«å­—æ®µ
```

### 3. æ‰§è¡Œé€‰å‹
```
ç‚¹å‡»"æŸ¥æ‰¾åŒ¹é…æ‰§è¡Œå™¨"
é€‰æ‹©ä¸€ä¸ªæ‰§è¡Œå™¨
ç‚¹å‡»"é€‰æ‹©æ­¤å‹å·"
```

### 4. ä¿å­˜åˆ°é¡¹ç›®
```
ç‚¹å‡»"ä¿å­˜"æŒ‰é’®
```

### 5. æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º
```javascript
// åº”è¯¥èƒ½çœ‹åˆ°ç±»ä¼¼çš„æ—¥å¿—ï¼š
ä¿å­˜é€‰å‹è®°å½•: {
  tag_number: "FV-101",
  valve_size: "DN100",        // âœ… ç¡®è®¤åŒ…å«
  flange_size: "F07/F10",     // âœ… ç¡®è®¤åŒ…å«
  mechanism: "Scotch Yoke",
  valve_type: "Ball Valve"
}
```

### 6. æ£€æŸ¥ç½‘ç»œè¯·æ±‚
```
Network æ ‡ç­¾ â†’ æ‰¾åˆ° POST è¯·æ±‚
æŸ¥çœ‹ Payload:
{
  "tag_number": "FV-101",
  "input_params": {
    "valve_size": "DN100",      // âœ… ç¡®è®¤å‘é€
    "flange_size": "F07/F10",   // âœ… ç¡®è®¤å‘é€
    ...
  }
}
```

### 7. éªŒè¯æ•°æ®åº“
```javascript
// åœ¨ MongoDB ä¸­æŸ¥è¯¢
db.newprojects.findOne({ "selections.tag_number": "FV-101" })

// æ£€æŸ¥ç»“æœ
{
  selections: [{
    input_params: {
      valve_size: "DN100",      // âœ… ç¡®è®¤å­˜å‚¨
      flange_size: "F07/F10",   // âœ… ç¡®è®¤å­˜å‚¨
      ...
    }
  }]
}
```

---

## âœ… éªŒè¯æ£€æŸ¥æ¸…å•

### å‰ç«¯
- âœ… è¡¨å•åŒ…å« `valve_size` å’Œ `flange_size` å­—æ®µ
- âœ… `form.getFieldsValue()` è‡ªåŠ¨è·å–æ‰€æœ‰å­—æ®µ
- âœ… `input_params` åŒ…å«å®Œæ•´çš„è¡¨å•æ•°æ®
- âœ… æ·»åŠ äº†è°ƒè¯•æ—¥å¿—
- âœ… æ·»åŠ äº†æ¸…æ™°çš„æ³¨é‡Š

### æ•°æ®ä¼ é€’
- âœ… `valve_size` åŒ…å«åœ¨ `input_params` ä¸­
- âœ… `flange_size` åŒ…å«åœ¨ `input_params` ä¸­
- âœ… æ•°æ®æ­£ç¡®å‘é€åˆ°åç«¯
- âœ… æ§åˆ¶å°æ—¥å¿—æ˜¾ç¤ºæ­£ç¡®

### åç«¯æ¥æ”¶
- âœ… `input_params` æ˜¯ `Mixed` ç±»å‹
- âœ… å¯ä»¥æ¥æ”¶ä»»æ„å­—æ®µ
- âœ… æ•°æ®æ­£ç¡®å­˜å‚¨åˆ°æ•°æ®åº“

---

## ğŸ“‹ å®Œæ•´ç¤ºä¾‹

### å‰ç«¯å‘é€çš„æ•°æ®
```javascript
{
  tag_number: "FV-101",
  input_params: {
    // æœºæ„å’Œé˜€é—¨ä¿¡æ¯
    mechanism: "Scotch Yoke",
    valve_type: "Ball Valve",
    valve_size: "DN100",           // âœ…
    flange_size: "F07/F10",        // âœ…
    
    // æ‰­çŸ©å‚æ•°
    required_torque: 100,
    working_pressure: 0.6,
    working_angle: 90,
    
    // å…¶ä»–å‚æ•°
    needs_manual_override: false,
    max_budget: undefined,
    tag_number: "FV-101"
  },
  selected_actuator: {
    _id: "...",
    model_base: "SF14-200DA",
    recommended_model: "SF14-200DA",
    yoke_type: "Symmetric",
    actual_torque: 150,
    torque_margin: 15.38,
    price: 2850
  },
  selected_override: null
}
```

### åç«¯å­˜å‚¨çš„æ•°æ®
```javascript
{
  _id: ObjectId("..."),
  tag_number: "FV-101",
  input_params: {
    mechanism: "Scotch Yoke",
    valve_type: "Ball Valve",
    valve_size: "DN100",           // âœ… å·²å­˜å‚¨
    flange_size: "F07/F10",        // âœ… å·²å­˜å‚¨
    required_torque: 100,
    working_pressure: 0.6,
    working_angle: 90,
    needs_manual_override: false
  },
  selected_actuator: {
    actuator_id: ObjectId("..."),
    model_base: "SF14-200DA",
    actual_torque: 150,
    price: 2850
  },
  selected_override: null,
  total_price: 2850,
  status: "å·²é€‰å‹",
  createdAt: ISODate("2025-10-27T..."),
  updatedAt: ISODate("2025-10-27T...")
}
```

---

## ğŸ‰ æ€»ç»“

### âœ… æ•°æ®ä¼ é€’æµç¨‹å·²éªŒè¯
1. **å‰ç«¯è¡¨å•** â†’ åŒ…å« `valve_size` å’Œ `flange_size` å­—æ®µ
2. **è·å–è¡¨å•æ•°æ®** â†’ `form.getFieldsValue()` è‡ªåŠ¨è·å–æ‰€æœ‰å­—æ®µ
3. **æ„å»ºè¯·æ±‚æ•°æ®** â†’ `input_params` åŒ…å«å®Œæ•´è¡¨å•æ•°æ®
4. **å‘é€åˆ°åç«¯** â†’ é€šè¿‡ `projectsAPI.autoSelect()` å‘é€
5. **åç«¯æ¥æ”¶** â†’ `input_params` (Mixed ç±»å‹) æ¥æ”¶æ‰€æœ‰å­—æ®µ
6. **æ•°æ®åº“å­˜å‚¨** â†’ å®Œæ•´ä¿å­˜åˆ° MongoDB

### âœ… ä¼˜åŒ–å®Œæˆ
- æ·»åŠ äº†æ¸…æ™°çš„ä»£ç æ³¨é‡Š
- æ·»åŠ äº†è°ƒè¯•æ—¥å¿—
- æ·»åŠ äº†é”™è¯¯å¤„ç†æ—¥å¿—
- ä¾¿äºå¼€å‘å’Œè°ƒè¯•

### âœ… éªŒè¯æ–¹æ³•
- æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹æ—¥å¿—
- Network æ ‡ç­¾æŸ¥çœ‹è¯·æ±‚
- MongoDB æŸ¥è¯¢éªŒè¯å­˜å‚¨

---

**éªŒè¯æ—¥æœŸ**: 2025-10-27  
**éªŒè¯çŠ¶æ€**: âœ… å·²éªŒè¯é€šè¿‡  
**æ–‡ä»¶**: `frontend/src/pages/SelectionEngine.jsx`  
**è´Ÿè´£äºº**: Cursor AI Assistant

