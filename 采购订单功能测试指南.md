# 采购订单功能测试指南

## 快速测试步骤

### 前置条件

1. ✅ 后端服务已启动
2. ✅ MongoDB 数据库已连接
3. ✅ 已有测试账号（管理员或采购专员）
4. ✅ 已有至少一个供应商数据

---

## 测试流程

### 1. 启动后端服务

```bash
cd backend
npm start
```

验证启动成功：
```bash
curl http://localhost:5000/api/health
```

### 2. 获取认证Token

```bash
# 登录获取token
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@example.com",
    "password": "your_password"
  }'
```

保存响应中的 `token` 字段，后续请求都需要使用。

### 3. 查看供应商列表

```bash
# 替换 YOUR_TOKEN 为实际token
curl http://localhost:5000/api/suppliers \
  -H "Authorization: Bearer YOUR_TOKEN"
```

记录一个供应商的 `_id`，用于创建采购订单。

### 4. 创建采购订单

```bash
curl -X POST http://localhost:5000/api/purchase-orders \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "supplier_id": "SUPPLIER_ID_HERE",
    "items": [
      {
        "product_name": "AT执行器",
        "product_code": "AT-10",
        "specification": "10NM",
        "quantity": 5,
        "unit": "件",
        "unit_price": 2000,
        "notes": "优质产品"
      },
      {
        "product_name": "GY执行器",
        "product_code": "GY-20",
        "specification": "20NM",
        "quantity": 3,
        "unit": "件",
        "unit_price": 3000
      }
    ],
    "expected_delivery_date": "2025-11-30",
    "payment_terms": "货到付款",
    "shipping_address": "上海市浦东新区张江路123号",
    "contact_person": "李工",
    "contact_phone": "13800138000",
    "notes": "请按时交货",
    "status": "draft"
  }'
```

记录响应中的订单 `_id` 和 `order_number`。

### 5. 查看所有采购订单

```bash
curl http://localhost:5000/api/purchase-orders \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 6. 查看单个采购订单详情

```bash
curl http://localhost:5000/api/purchase-orders/ORDER_ID_HERE \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 7. 更新采购订单状态

#### 提交审核（draft → pending）

```bash
curl -X PATCH http://localhost:5000/api/purchase-orders/ORDER_ID_HERE/status \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"status": "pending"}'
```

#### 确认订单（pending → confirmed）

```bash
curl -X PATCH http://localhost:5000/api/purchase-orders/ORDER_ID_HERE/status \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"status": "confirmed"}'
```

#### 发货（confirmed → shipped）

```bash
curl -X PATCH http://localhost:5000/api/purchase-orders/ORDER_ID_HERE/status \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"status": "shipped"}'
```

#### 收货（shipped → received）

```bash
curl -X PATCH http://localhost:5000/api/purchase-orders/ORDER_ID_HERE/status \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"status": "received"}'
```

### 8. 更新采购订单信息

```bash
curl -X PUT http://localhost:5000/api/purchase-orders/ORDER_ID_HERE \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "expected_delivery_date": "2025-12-15",
    "notes": "延期交货"
  }'
```

### 9. 查看统计信息

```bash
curl http://localhost:5000/api/purchase-orders/stats/summary \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 10. 按供应商查询订单

```bash
curl http://localhost:5000/api/purchase-orders/supplier/SUPPLIER_ID_HERE \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 11. 高级查询（带筛选条件）

#### 按状态筛选

```bash
curl "http://localhost:5000/api/purchase-orders?status=confirmed" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 按日期范围筛选

```bash
curl "http://localhost:5000/api/purchase-orders?start_date=2025-10-01&end_date=2025-10-31" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 搜索订单

```bash
curl "http://localhost:5000/api/purchase-orders?search=PO2025" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 12. 删除采购订单（仅草稿状态）

```bash
curl -X DELETE http://localhost:5000/api/purchase-orders/ORDER_ID_HERE \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## 使用 Postman 测试

### 1. 导入环境变量

创建环境，添加以下变量：

```
base_url = http://localhost:5000
token = YOUR_TOKEN_HERE
supplier_id = YOUR_SUPPLIER_ID
order_id = YOUR_ORDER_ID
```

### 2. 创建请求集合

#### 获取所有订单
- Method: GET
- URL: `{{base_url}}/api/purchase-orders`
- Headers: `Authorization: Bearer {{token}}`

#### 创建订单
- Method: POST
- URL: `{{base_url}}/api/purchase-orders`
- Headers: 
  - `Authorization: Bearer {{token}}`
  - `Content-Type: application/json`
- Body (raw JSON):
```json
{
  "supplier_id": "{{supplier_id}}",
  "items": [
    {
      "product_name": "测试产品",
      "quantity": 10,
      "unit_price": 100
    }
  ],
  "notes": "测试订单"
}
```

---

## JavaScript/前端集成示例

### 使用 Axios

```javascript
import axios from 'axios';

// 配置基础URL和拦截器
const api = axios.create({
  baseURL: 'http://localhost:5000/api',
});

// 添加token到所有请求
api.interceptors.request.use(config => {
  const token = localStorage.getItem('token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// 采购订单API方法
const purchaseOrdersAPI = {
  // 获取所有订单
  getAll: (params) => api.get('/purchase-orders', { params }),
  
  // 获取单个订单
  getById: (id) => api.get(`/purchase-orders/${id}`),
  
  // 创建订单
  create: (data) => api.post('/purchase-orders', data),
  
  // 更新订单
  update: (id, data) => api.put(`/purchase-orders/${id}`, data),
  
  // 删除订单
  delete: (id) => api.delete(`/purchase-orders/${id}`),
  
  // 更新状态
  updateStatus: (id, status) => 
    api.patch(`/purchase-orders/${id}/status`, { status }),
  
  // 获取统计
  getStats: () => api.get('/purchase-orders/stats/summary'),
  
  // 按供应商查询
  getBySupplier: (supplierId) => 
    api.get(`/purchase-orders/supplier/${supplierId}`)
};

// 使用示例
async function testPurchaseOrders() {
  try {
    // 创建订单
    const newOrder = await purchaseOrdersAPI.create({
      supplier_id: '507f1f77bcf86cd799439012',
      items: [{
        product_name: 'AT执行器',
        quantity: 5,
        unit_price: 2000
      }]
    });
    console.log('订单创建成功:', newOrder.data);
    
    // 获取所有订单
    const orders = await purchaseOrdersAPI.getAll();
    console.log('所有订单:', orders.data);
    
    // 更新状态
    await purchaseOrdersAPI.updateStatus(
      newOrder.data.data._id, 
      'confirmed'
    );
    console.log('状态更新成功');
    
    // 获取统计
    const stats = await purchaseOrdersAPI.getStats();
    console.log('统计信息:', stats.data);
    
  } catch (error) {
    console.error('错误:', error.response?.data || error.message);
  }
}
```

---

## 测试检查清单

### 基础功能测试

- [ ] ✅ 获取所有采购订单
- [ ] ✅ 获取单个采购订单详情
- [ ] ✅ 创建新采购订单
- [ ] ✅ 更新采购订单信息
- [ ] ✅ 删除草稿订单
- [ ] ✅ 更新订单状态

### 状态流转测试

- [ ] ✅ draft → pending
- [ ] ✅ pending → confirmed（记录审批信息）
- [ ] ✅ confirmed → shipped
- [ ] ✅ shipped → received（记录交货日期）
- [ ] ✅ 任意状态 → cancelled

### 业务逻辑测试

- [ ] ✅ 订单号自动生成且唯一
- [ ] ✅ 金额自动计算正确
- [ ] ✅ 无法为黑名单供应商创建订单
- [ ] ✅ 已完成/已取消的订单无法修改
- [ ] ✅ 只能删除草稿状态订单
- [ ] ✅ 确认时记录审批人和时间
- [ ] ✅ 收货时更新供应商交易总额

### 查询功能测试

- [ ] ✅ 按状态筛选
- [ ] ✅ 按供应商筛选
- [ ] ✅ 按日期范围筛选
- [ ] ✅ 搜索订单号
- [ ] ✅ 排序功能

### 权限测试

- [ ] ✅ 管理员可以执行所有操作
- [ ] ✅ 采购专员可以创建、查看、更新订单
- [ ] ✅ 采购专员不能删除订单
- [ ] ✅ 其他角色无法访问

### 统计功能测试

- [ ] ✅ 订单总数统计
- [ ] ✅ 各状态订单数量统计
- [ ] ✅ 总金额统计
- [ ] ✅ 按月统计
- [ ] ✅ TOP供应商统计

### 错误处理测试

- [ ] ✅ 未提供必需字段
- [ ] ✅ 供应商不存在
- [ ] ✅ 订单不存在
- [ ] ✅ 无效的状态值
- [ ] ✅ 权限不足
- [ ] ✅ 未认证访问

---

## 常见问题排查

### 1. 401 未认证错误

**原因**: Token无效或过期

**解决**:
```bash
# 重新登录获取新token
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@example.com", "password": "password"}'
```

### 2. 403 权限不足错误

**原因**: 用户角色不正确

**解决**: 确保使用管理员或采购专员账号

### 3. 404 资源不存在

**原因**: 订单ID或供应商ID不正确

**解决**: 检查ID是否正确，确保资源存在

### 4. 400 黑名单供应商错误

**原因**: 尝试为黑名单供应商创建订单

**解决**: 先更新供应商状态为active

```bash
curl -X PATCH http://localhost:5000/api/suppliers/SUPPLIER_ID/status \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"status": "active"}'
```

### 5. 400 订单状态错误

**原因**: 尝试修改已完成或已取消的订单

**解决**: 检查订单当前状态，确认是否允许该操作

---

## MongoDB 数据验证

### 查看采购订单数据

```javascript
// 连接MongoDB
use model_selection_system

// 查看所有采购订单
db.purchaseorders.find().pretty()

// 查看最新订单
db.purchaseorders.find().sort({createdAt: -1}).limit(1).pretty()

// 查看特定状态的订单
db.purchaseorders.find({status: "confirmed"}).pretty()

// 统计各状态订单数量
db.purchaseorders.aggregate([
  { $group: { _id: "$status", count: { $sum: 1 } } }
])

// 查看供应商的交易总额
db.suppliers.find({}, {name: 1, total_transaction_value: 1}).pretty()
```

---

## 性能测试

### 批量创建测试数据

```bash
# 使用循环创建多个订单
for i in {1..10}; do
  curl -X POST http://localhost:5000/api/purchase-orders \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer YOUR_TOKEN" \
    -d '{
      "supplier_id": "SUPPLIER_ID_HERE",
      "items": [{
        "product_name": "测试产品'$i'",
        "quantity": '$i',
        "unit_price": 100
      }]
    }'
  echo "\n订单 $i 创建完成"
done
```

### 并发测试（使用 Apache Bench）

```bash
# 安装 ab
# macOS: 自带
# Ubuntu: sudo apt-get install apache2-utils

# 测试获取订单列表（100请求，10并发）
ab -n 100 -c 10 \
  -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:5000/api/purchase-orders
```

---

## 总结

完成以上测试后，你应该验证了：

1. ✅ 所有CRUD操作正常工作
2. ✅ 订单状态流转正确
3. ✅ 业务逻辑按预期执行
4. ✅ 权限控制有效
5. ✅ 统计功能准确
6. ✅ 错误处理完善
7. ✅ 数据完整性保持

如有任何问题，请查看：
- 后端日志输出
- MongoDB数据
- API响应错误信息

祝测试顺利！🎉

