# 📖 实时通知系统 - 快速参考

## 🚀 快速开始

### 后端 - 发送通知

```javascript
const notificationService = require('../services/notificationService');

// 1. 向指定角色发送通知
await notificationService.notifyRole('Production Planner', {
  title: '标题',
  message: '消息内容',
  link: '/target-page',
  type: 'notification_type',
  priority: 'high' // low, medium, high, urgent
});

// 2. 向单个用户发送
await notificationService.notifySingleUser(userId, {
  title: '标题',
  message: '消息',
  link: '/page'
});

// 3. 预定义方法
await notificationService.notifyProjectWon(project);
await notificationService.notifyProductionCompleted(production);
await notificationService.notifyQualityCheckPassed(qc, production);
await notificationService.notifyTicketAssigned(ticket, engineerId);
```

### 前端 - 使用通知

```javascript
import { useNotificationStore } from '../store/notificationStore';

const {
  notifications,      // 通知列表
  unreadCount,       // 未读数量
  fetchNotifications,// 获取通知
  markAsRead,        // 标记已读
  markAllAsRead,     // 全部已读
} = useNotificationStore();
```

## 📋 API 端点

| 方法 | 端点 | 说明 |
|------|------|------|
| GET | `/api/notifications` | 获取通知列表 |
| GET | `/api/notifications/unread-count` | 获取未读数量 |
| GET | `/api/notifications/:id` | 获取单个通知 |
| POST | `/api/notifications/:id/mark-read` | 标记已读 |
| POST | `/api/notifications/mark-all-read` | 全部已读 |
| DELETE | `/api/notifications/:id` | 删除通知 |
| DELETE | `/api/notifications/clear-read` | 清除已读 |

## 🎯 已集成的业务流程

| 业务场景 | 触发事件 | 接收角色 | 优先级 |
|---------|---------|---------|-------|
| 项目赢单 | 合同签署完成 | Production Planner | high |
| 合同审批 | 合同提交审批 | Commercial Engineer | high |
| 生产完成 | 所有物料生产完成 | Quality Inspector | high |
| 质检通过 | 质量检验合格 | Logistics Coordinator | high |
| 质检失败 | 质量检验不合格 | Production Planner | urgent |
| 工单分配 | 服务工单分配 | 指定工程师 | high/urgent |

## 🎨 通知类型和优先级

### 通知类型 (type)

```javascript
'project_assigned'      // 项目分配
'project_won'           // 项目赢单
'selection_submitted'   // 选型提交
'quote_needed'          // 需要报价
'contract_submitted'    // 合同提交
'contract_approved'     // 合同批准
'production_needed'     // 需要生产
'bom_shortage'          // 物料短缺
'purchase_needed'       // 需要采购
'production_started'    // 生产开始
'production_completed'  // 生产完成
'quality_check_needed'  // 需要质检
'quality_check_passed'  // 质检通过
'quality_check_failed'  // 质检失败
'delivery_scheduled'    // 发货安排
'ticket_assigned'       // 工单分配
'ticket_updated'        // 工单更新
'urgent'                // 紧急
'info'                  // 信息
```

### 优先级 (priority)

| 优先级 | 颜色 | 使用场景 |
|-------|------|---------|
| `low` | 灰色 | 一般信息 |
| `medium` | 蓝色 | 常规任务 |
| `high` | 黄色 | 重要任务 |
| `urgent` | 红色 | 紧急任务 |

## 🔧 常用代码片段

### 在控制器中添加通知

```javascript
// 1. 引入服务
const notificationService = require('../services/notificationService');

// 2. 在业务逻辑中发送通知
try {
  await notificationService.notifyRole('Role Name', {
    title: '通知标题',
    message: '详细说明',
    link: `/path/${id}`,
    type: 'notification_type',
    priority: 'high',
    relatedEntity: {
      entityType: 'ModelName',
      entityId: document._id
    }
  });
} catch (notifyError) {
  console.error('⚠️ 发送通知失败:', notifyError);
  // 不中断主流程
}
```

### 创建自定义通知方法

```javascript
// 在 notificationService.js 中添加
async notifyCustomEvent(data) {
  return await this.notifyRole('Target Role', {
    title: '自定义标题',
    message: `自定义消息: ${data.info}`,
    link: `/custom/${data.id}`,
    type: 'custom_type',
    priority: 'medium',
    relatedEntity: {
      entityType: 'CustomEntity',
      entityId: data._id
    }
  });
}
```

## 🎯 用户界面功能

### 铃铛组件功能

- ✅ 显示未读数量红点
- ✅ 点击查看通知列表
- ✅ 实时接收新通知
- ✅ 自动弹窗提醒

### 通知列表操作

- ✅ 点击通知跳转到目标页面
- ✅ 单个通知标记已读
- ✅ 全部标记已读
- ✅ 删除单个通知
- ✅ 清除所有已读通知
- ✅ 刷新通知列表

### 实时弹窗

- ✅ 右下角自动弹出
- ✅ 根据优先级显示不同颜色
- ✅ 点击跳转到目标页面
- ✅ 10秒后自动关闭

## 🔍 调试技巧

### 检查 WebSocket 连接

```javascript
// 浏览器控制台
import { isConnected } from './services/socketService';
console.log('WebSocket 连接状态:', isConnected());
```

### 查看通知数据

```javascript
// 浏览器控制台
import { useNotificationStore } from './store/notificationStore';
const store = useNotificationStore.getState();
console.log('通知列表:', store.notifications);
console.log('未读数量:', store.unreadCount);
```

### 后端日志

```javascript
// 查看通知发送日志
console.log('✅ 已向 X 位用户发送了通知: 标题');
console.log('📬 Received notification:', notification);
```

## ⚠️ 注意事项

1. **不要在循环中发送大量通知** - 会影响性能
2. **优先级要合理** - 避免滥用 `urgent`
3. **链接要正确** - 确保 link 指向有效页面
4. **消息要简洁** - title 简明扼要，message 补充说明
5. **异常处理** - 通知发送失败不应中断主业务流程

## 📞 常见问题

**Q: 通知没有实时显示？**  
A: 检查 WebSocket 连接状态，确保铃铛图标是蓝色的。

**Q: 未读数量不准确？**  
A: 点击刷新按钮或调用 `fetchUnreadCount()`。

**Q: 通知发送后找不到？**  
A: 检查后端日志，确认通知是否创建成功。

**Q: 如何测试通知功能？**  
A: 使用两个浏览器窗口，分别登录不同角色，触发业务流程观察通知。

---

**更新时间**: 2025-10-31  
**版本**: v1.0

