# CSV 数据导入指南

## 📋 概述

本文档介绍如何使用 `seed.js` 脚本从 CSV 文件导入执行器和手动操作装置数据到 MongoDB 数据库。

---

## 📂 数据文件位置

CSV 文件应放置在以下目录：
```
backend/data_imports/
  ├── sf_actuators_data.csv          # 执行器数据
  └── manual_overrides_data.csv      # 手动操作装置数据
```

---

## 🚀 快速开始

### 1. 运行导入脚本

```bash
cd backend
npm run seed-csv
```

或者直接运行：
```bash
node seed.js
```

### 2. 查看导入结果

脚本会实时显示导入进度和结果：
```
╔════════════════════════════════════════════════╗
║     C-MAX 数据导入工具                        ║
╚════════════════════════════════════════════════╝
✅ 数据库连接成功

📦 开始导入执行器数据...
📄 读取到 142 条执行器记录
  ✅ 创建: SF10-150DA
  ✅ 创建: SF10-170DA
  ...

📊 执行器导入统计:
  ✅ 成功: 142
  ❌ 失败: 0

🔧 开始导入手动操作装置数据...
📄 读取到 19 条手动操作装置记录
  ✅ 创建: SF10-150
  ✅ 创建: SF14-200
  ...

📊 手动操作装置导入统计:
  ✅ 成功: 19
  ❌ 失败: 0

╔════════════════════════════════════════════════╗
║     数据导入完成！ 🎉                        ║
╚════════════════════════════════════════════════╝
```

---

## 📝 CSV 文件格式说明

### 1. 执行器数据格式 (`sf_actuators_data.csv`)

#### 必需字段：
| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| model_base | String | 型号 | SF10-150DA |
| body_size | String | 机身尺寸 | SF10 |
| action_type | String | 作用类型 (DA/SR) | DA |
| base_price | Number | 基础价格 | 1339 |
| torque_symmetric | JSON String | 对称扭矩数据 | {"0.3_0":309,...} |
| torque_canted | JSON String | 倾斜扭矩数据 | {"0.3_0":417,...} |

#### 可选字段：
| 字段名 | 类型 | 说明 |
|--------|------|------|
| cylinder_size | Number | 缸径 |
| spring_range | String | 弹簧范围 |
| connect_flange | String | 连接法兰 |
| L1, L2, m1, m2, A, H1, H2, D, G | Number/String | 尺寸参数 |

#### 扭矩数据格式示例：
```json
{
  "0.3_0": 309,
  "0.3_45": 185,
  "0.3_90": 309,
  "0.4_0": 412,
  ...
}
```
**注意**: 键名格式为 `<压力>_<角度>`，如 `0.3_0` 表示 0.3MPa，0度角

### 2. 手动操作装置数据格式 (`manual_overrides_data.csv`)

#### 字段说明：
| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| model_base | String | 型号 | SF10-150 |
| price | Number | 价格 | 380 |
| compatible_body_sizes | String | 兼容机身尺寸（逗号分隔） | SF10 |

---

## 🔧 脚本功能特点

### 1. 智能数据解析
- ✅ 自动解析 CSV 文件
- ✅ 处理复杂的 JSON 格式字段
- ✅ 正确处理引号和特殊字符
- ✅ 智能识别嵌套的大括号

### 2. 数据验证
- ✅ 检查必需字段
- ✅ 数据类型转换
- ✅ 错误捕获和报告

### 3. 更新策略
- ✅ 如果记录已存在（根据 `model_base`），则更新
- ✅ 如果记录不存在，则创建新记录
- ✅ 保持数据一致性

### 4. 详细日志
- ✅ 实时显示导入进度
- ✅ 统计成功/失败数量
- ✅ 显示详细错误信息

---

## 🐛 常见问题排查

### 问题1: 文件找不到
```
❌ 文件不存在: /path/to/sf_actuators_data.csv
```
**解决方案**: 
- 确认 CSV 文件在 `backend/data_imports/` 目录下
- 检查文件名是否正确

### 问题2: 数据库连接失败
```
❌ 数据库连接失败
```
**解决方案**:
- 确认 MongoDB 服务正在运行
- 检查 `.env` 文件中的 `MONGODB_URI` 配置
- 确认数据库名称正确

### 问题3: 扭矩数据解析失败
```
解析扭矩数据失败: Unexpected token
```
**解决方案**:
- 检查 CSV 中的 JSON 格式是否正确
- 确保使用双引号 `"` 而不是单引号 `'`
- 确保 JSON 字符串被正确引用

### 问题4: 字段验证失败
```
Actuator validation failed: action_type: Path `action_type` is required
```
**解决方案**:
- 检查 CSV 文件中的必需字段是否存在
- 确认字段名称拼写正确
- 查看字段值是否符合枚举要求（如 action_type 必须是 DA 或 SR）

---

## 📊 CSV 文件示例

### 执行器数据示例行：
```csv
model_base,body_size,cylinder_size,action_type,spring_range,base_price,torque_symmetric,torque_canted,connect_flange,L1,L2,m1,m2,A,H1,H2,D,G
SF10-150DA,SF10,150,DA,,1339,"{""0.3_0"":309,""0.3_45"":185}","{""0.3_0"":417,""0.3_45"":200}","ISO 5211 F10",350,127,76,143.5,40,82,100,207,"NPT1/4"""
```

### 手动操作装置数据示例行：
```csv
model_base,price,compatible_body_sizes
SF10-150,380,"SF10"
SF14-200,450,"SF14,SF16"
```

---

## 🔄 重新导入数据

如果需要重新导入数据：

1. **清除现有数据**（可选）:
   ```bash
   # 进入 MongoDB shell
   mongosh
   
   # 选择数据库
   use cmax-actuators
   
   # 删除集合
   db.actuators.deleteMany({})
   db.manualoverrides.deleteMany({})
   ```

2. **运行导入脚本**:
   ```bash
   npm run seed-csv
   ```

---

## 🎯 最佳实践

1. **备份数据**: 在导入新数据前，先备份现有数据
2. **测试环境**: 先在测试环境中验证 CSV 文件格式
3. **分批导入**: 如果数据量大，考虑分批导入
4. **验证结果**: 导入后检查数据库中的记录数和数据完整性

---

## 📚 技术细节

### CSV 解析逻辑
脚本使用自定义的 CSV 解析器，支持：
- 引号内的逗号
- 嵌套的 JSON 对象
- 转义字符
- 多行字段

### 数据转换
- **数字字段**: 自动转换为 Number 类型
- **JSON 字段**: 解析为 Map 对象
- **数组字段**: 分割逗号分隔的字符串

### 错误处理
- 每条记录独立处理
- 单条记录失败不影响其他记录
- 详细记录所有错误信息

---

## 🆘 获取帮助

如果遇到问题，请：

1. 查看控制台输出的错误信息
2. 检查 CSV 文件格式
3. 验证数据库连接
4. 查看 MongoDB 日志

---

## 📝 脚本命令总结

| 命令 | 功能 |
|------|------|
| `npm run seed-csv` | 从 CSV 导入数据 |
| `npm run seed` | 运行基础种子数据 |
| `npm run seed-new` | 运行新种子数据 |

---

**创建时间**: 2025-10-27  
**版本**: v1.0  
**维护**: C-MAX 开发团队

