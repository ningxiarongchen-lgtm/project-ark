# è®¤è¯å•å…ƒæµ‹è¯•è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬æµ‹è¯•å¥—ä»¶è¦†ç›–äº†åç«¯è®¤è¯ç³»ç»Ÿçš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

- âœ… æ‰‹æœºå·ç™»å½•
- âœ… ç”¨æˆ·æ³¨å†Œ
- âœ… å¼ºåˆ¶ä¿®æ”¹å¯†ç æµç¨‹
- âœ… Token éªŒè¯
- âœ… ç”¨æˆ·ç™»å‡º
- âœ… è¾¹ç•Œæƒ…å†µå’Œå®‰å…¨æµ‹è¯•

## ğŸ”§ å®‰è£…ä¾èµ–

åœ¨è¿è¡Œæµ‹è¯•ä¹‹å‰ï¼Œè¯·ç¡®ä¿å·²å®‰è£…å¿…è¦çš„æµ‹è¯•ä¾èµ–ï¼š

```bash
cd backend
npm install --save-dev supertest
```

### å½“å‰ä¾èµ–åˆ—è¡¨

- **jest** - æµ‹è¯•æ¡†æ¶
- **supertest** - HTTP æ–­è¨€åº“
- **mongodb-memory-server** (å¯é€‰) - å†…å­˜æ•°æ®åº“ï¼Œç”¨äºç‹¬ç«‹æµ‹è¯•

## ğŸš€ è¿è¡Œæµ‹è¯•

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
npm test
```

### åªè¿è¡Œè®¤è¯æµ‹è¯•

```bash
npm test -- auth.test.js
```

### ç›‘å¬æ¨¡å¼ï¼ˆå¼€å‘æ—¶ä½¿ç”¨ï¼‰

```bash
npm run test:watch
```

### ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

```bash
npm run test:coverage
```

## ğŸ“ ç¯å¢ƒé…ç½®

### 1. åˆ›å»ºæµ‹è¯•ç¯å¢ƒå˜é‡æ–‡ä»¶

åœ¨ `backend/` ç›®å½•ä¸‹åˆ›å»º `.env.test` æ–‡ä»¶ï¼ˆå¦‚æœå°šæœªå­˜åœ¨ï¼‰ï¼š

```env
NODE_ENV=test
MONGODB_URI_TEST=mongodb://localhost:27017/cmax-test
JWT_SECRET=your-test-jwt-secret-key-here
REFRESH_TOKEN_SECRET=your-test-refresh-token-secret
JWT_EXPIRE=8h
REFRESH_TOKEN_EXPIRE=7d
```

### 2. ç¡®ä¿æµ‹è¯•æ•°æ®åº“ç‹¬ç«‹

âš ï¸ **é‡è¦**: æµ‹è¯•ä¼šè‡ªåŠ¨æ¸…ç†æ•°æ®åº“ï¼Œè¯·ç¡®ä¿ä½¿ç”¨ç‹¬ç«‹çš„æµ‹è¯•æ•°æ®åº“ï¼Œé¿å…å½±å“å¼€å‘æˆ–ç”Ÿäº§æ•°æ®ã€‚

## ğŸ“Š æµ‹è¯•è¦†ç›–èŒƒå›´

### 1. ç”¨æˆ·æ³¨å†Œ (`POST /api/auth/register`)

- âœ… æˆåŠŸæ³¨å†Œæ–°ç”¨æˆ·ï¼ˆä½¿ç”¨æ‰‹æœºå·ï¼‰
- âœ… æ‹’ç»æ— æ•ˆçš„æ‰‹æœºå·æ ¼å¼
- âœ… æ‹’ç»é‡å¤çš„æ‰‹æœºå·
- âœ… è¦æ±‚æä¾›å¿…å¡«å­—æ®µ
- âœ… éªŒè¯ Cookie ä¸­çš„ Token

### 2. ç”¨æˆ·ç™»å½• (`POST /api/auth/login`)

- âœ… ä½¿ç”¨æ­£ç¡®çš„æ‰‹æœºå·å’Œå¯†ç æˆåŠŸç™»å½•
- âœ… æ‹’ç»é”™è¯¯çš„å¯†ç 
- âœ… æ‹’ç»ä¸å­˜åœ¨çš„æ‰‹æœºå·
- âœ… æ‹’ç»æ— æ•ˆçš„æ‰‹æœºå·æ ¼å¼
- âœ… æ‹’ç»æœªæ¿€æ´»çš„ç”¨æˆ·
- âœ… è¦æ±‚æä¾›æ‰‹æœºå·å’Œå¯†ç 
- âœ… æ›´æ–° lastLogin å­—æ®µ
- âœ… è¿”å› `passwordChangeRequired` æ ‡å¿—

### 3. å¼ºåˆ¶ä¿®æ”¹å¯†ç æµç¨‹

#### æµ‹è¯•åœºæ™¯

**åœºæ™¯ 1**: æ–°ç”¨æˆ·ç™»å½•æ£€æµ‹
- âœ… ç™»å½•åæ£€æµ‹åˆ° `passwordChangeRequired` ä¸º `true`

**åœºæ™¯ 2**: ä¿®æ”¹å¯†ç 
- âœ… æˆåŠŸä¿®æ”¹å¯†ç 
- âœ… ä¿®æ”¹å `passwordChangeRequired` å˜ä¸º `false`

**åœºæ™¯ 3**: éªŒè¯æ–°å¯†ç 
- âœ… ä½¿ç”¨æ–°å¯†ç æˆåŠŸç™»å½•
- âœ… æ—§å¯†ç ä¸å†æœ‰æ•ˆ

**åœºæ™¯ 4**: é”™è¯¯å¤„ç†
- âœ… æ‹’ç»é”™è¯¯çš„å½“å‰å¯†ç 
- âœ… æ‹’ç»è¿‡çŸ­çš„æ–°å¯†ç ï¼ˆ< 6 ä¸ªå­—ç¬¦ï¼‰
- âœ… æœªç™»å½•ç”¨æˆ·æ— æ³•ä¿®æ”¹å¯†ç 
- âœ… è¦æ±‚æä¾›å½“å‰å¯†ç å’Œæ–°å¯†ç 

**åœºæ™¯ 5**: å®Œæ•´æµç¨‹æµ‹è¯•
- âœ… ç«¯åˆ°ç«¯æµ‹è¯•ä»ç™»å½•åˆ°ä¿®æ”¹å¯†ç çš„å®Œæ•´æµç¨‹

### 4. Token éªŒè¯ (`GET /api/auth/me`)

- âœ… è¿”å›å½“å‰ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯
- âœ… æœªç™»å½•ç”¨æˆ·è¿”å› 401
- âœ… æ— æ•ˆ Token è¿”å› 401

### 5. ç”¨æˆ·ç™»å‡º (`POST /api/auth/logout`)

- âœ… æˆåŠŸç™»å‡ºå¹¶æ¸…é™¤ Cookies
- âœ… ç™»å‡ºå Token æ— æ³•ä½¿ç”¨

### 6. è¾¹ç•Œæƒ…å†µå’Œå®‰å…¨æµ‹è¯•

- âœ… å¯†ç ä¸åº”åœ¨ä»»ä½•å“åº”ä¸­è¿”å›
- âœ… æ­£ç¡®å¤„ç†ç‰¹æ®Šå­—ç¬¦çš„å¯†ç 
- âœ… æ­£ç¡®å¤„ç†ä¸­æ–‡å§“å

## ğŸ” æµ‹è¯•ç”¨ä¾‹è¯¦è§£

### ç¤ºä¾‹ï¼šå¼ºåˆ¶ä¿®æ”¹å¯†ç å®Œæ•´æµç¨‹

```javascript
test('å®Œæ•´çš„å¼ºåˆ¶ä¿®æ”¹å¯†ç æµç¨‹', async () => {
  // æ­¥éª¤1: æ–°ç”¨æˆ·ç™»å½•
  const loginResponse = await request(app)
    .post('/api/auth/login')
    .send({
      phone: '13800138030',
      password: 'temp123456'
    })
    .expect(200);
  
  expect(loginResponse.body.passwordChangeRequired).toBe(true);
  
  // æ­¥éª¤2: ä¿®æ”¹å¯†ç 
  const changeResponse = await request(app)
    .post('/api/auth/change-password')
    .set('Cookie', [`accessToken=${accessToken}`])
    .send({
      currentPassword: 'temp123456',
      newPassword: 'mynewpassword123'
    })
    .expect(200);
  
  expect(changeResponse.body.passwordChangeRequired).toBe(false);
  
  // æ­¥éª¤3: ä½¿ç”¨æ–°å¯†ç ç™»å½•
  const reLoginResponse = await request(app)
    .post('/api/auth/login')
    .send({
      phone: '13800138030',
      password: 'mynewpassword123'
    })
    .expect(200);
  
  expect(reLoginResponse.body.passwordChangeRequired).toBe(false);
  
  // æ­¥éª¤4: éªŒè¯æ—§å¯†ç æ— æ•ˆ
  await request(app)
    .post('/api/auth/login')
    .send({
      phone: '13800138030',
      password: 'temp123456'
    })
    .expect(401);
});
```

## ğŸ“ˆ æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Š

### æ§åˆ¶å°è¾“å‡º

è¿è¡Œæµ‹è¯•åï¼Œæ§åˆ¶å°ä¼šæ˜¾ç¤ºè¯¦ç»†çš„æµ‹è¯•ç»“æœï¼š

```
PASS  tests/auth.test.js
  è®¤è¯ API æµ‹è¯•
    POST /api/auth/register - ç”¨æˆ·æ³¨å†Œ
      âœ“ åº”è¯¥æˆåŠŸæ³¨å†Œæ–°ç”¨æˆ·ï¼ˆä½¿ç”¨æ‰‹æœºå·ï¼‰ (150ms)
      âœ“ åº”è¯¥æ‹’ç»æ— æ•ˆçš„æ‰‹æœºå·æ ¼å¼ (250ms)
      âœ“ åº”è¯¥æ‹’ç»é‡å¤çš„æ‰‹æœºå· (120ms)
      âœ“ åº”è¯¥è¦æ±‚æä¾›å¿…å¡«å­—æ®µ (80ms)
    POST /api/auth/login - ç”¨æˆ·ç™»å½•
      âœ“ åº”è¯¥ä½¿ç”¨æ­£ç¡®çš„æ‰‹æœºå·å’Œå¯†ç æˆåŠŸç™»å½• (200ms)
      ...
    å¼ºåˆ¶ä¿®æ”¹å¯†ç æµç¨‹
      âœ“ ç™»å½•ååº”è¯¥æ£€æµ‹åˆ° passwordChangeRequired ä¸º true (100ms)
      âœ“ åº”è¯¥æˆåŠŸä¿®æ”¹å¯†ç  (150ms)
      âœ“ å®Œæ•´çš„å¼ºåˆ¶ä¿®æ”¹å¯†ç æµç¨‹ (400ms)
      ...

Test Suites: 1 passed, 1 total
Tests:       35 passed, 35 total
Snapshots:   0 total
Time:        5.234s
```

### HTML è¦†ç›–ç‡æŠ¥å‘Š

è¿è¡Œ `npm run test:coverage` åï¼Œåœ¨ `backend/coverage/index.html` æŸ¥çœ‹è¯¦ç»†çš„è¦†ç›–ç‡æŠ¥å‘Šã€‚

## ğŸ› å¸¸è§é—®é¢˜

### 1. MongoDB è¿æ¥é”™è¯¯

**é—®é¢˜**: `MongoNetworkError: connect ECONNREFUSED`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# å¯åŠ¨ MongoDB æœåŠ¡
sudo systemctl start mongod

# æˆ–ä½¿ç”¨ Docker
docker run -d -p 27017:27017 --name mongodb-test mongo
```

### 2. æµ‹è¯•è¶…æ—¶

**é—®é¢˜**: `Test timeout exceeded`

**è§£å†³æ–¹æ¡ˆ**: åœ¨ `jest.config.js` ä¸­å¢åŠ è¶…æ—¶æ—¶é—´
```javascript
testTimeout: 30000 // 30ç§’
```

### 3. ç«¯å£å ç”¨

**é—®é¢˜**: æµ‹è¯•æ—¶ç«¯å£å·²è¢«å ç”¨

**è§£å†³æ–¹æ¡ˆ**: æµ‹è¯•ä¸ä¼šå¯åŠ¨å®é™…çš„æœåŠ¡å™¨ï¼ˆé€šè¿‡ `supertest`ï¼‰ï¼Œæ— éœ€æ‹…å¿ƒç«¯å£å†²çªã€‚

## ğŸ“š æ›´å¤šèµ„æº

- [Jest å®˜æ–¹æ–‡æ¡£](https://jestjs.io/)
- [Supertest æ–‡æ¡£](https://github.com/visionmedia/supertest)
- [MongoDB Memory Server](https://github.com/nodkz/mongodb-memory-server)

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **æ‰©å±•æµ‹è¯•è¦†ç›–**:
   - æ·»åŠ æ›´å¤šè¾¹ç•Œæƒ…å†µæµ‹è¯•
   - æµ‹è¯•å¹¶å‘ç™»å½•åœºæ™¯
   - æµ‹è¯• Token åˆ·æ–°æœºåˆ¶

2. **é›†æˆ CI/CD**:
   - åœ¨ GitHub Actions ä¸­è‡ªåŠ¨è¿è¡Œæµ‹è¯•
   - è®¾ç½®è¦†ç›–ç‡é—¨æ§›

3. **æ€§èƒ½æµ‹è¯•**:
   - æ·»åŠ è´Ÿè½½æµ‹è¯•
   - æµ‹è¯• API å“åº”æ—¶é—´

## âœ… æµ‹è¯•æ¸…å•

è¿è¡Œæµ‹è¯•å‰ï¼Œè¯·ç¡®ä¿ï¼š

- [ ] MongoDB æœåŠ¡æ­£åœ¨è¿è¡Œ
- [ ] å·²å®‰è£…æ‰€æœ‰ä¾èµ– (`npm install`)
- [ ] å·²å®‰è£… `supertest` (`npm install --save-dev supertest`)
- [ ] å·²é…ç½® `.env.test` æ–‡ä»¶
- [ ] æµ‹è¯•æ•°æ®åº“ä¸å¼€å‘/ç”Ÿäº§æ•°æ®åº“éš”ç¦»

---

**ä½œè€…**: Project Ark Team  
**æœ€åæ›´æ–°**: 2025-10-28  
**ç‰ˆæœ¬**: 1.0.0

