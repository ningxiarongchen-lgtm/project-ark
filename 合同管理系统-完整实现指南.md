# 🏭 完整合同管理系统实现指南

## 📋 系统概述

本系统实现了一个统一的合同管理流程，将**销售合同**和**采购合同**汇集到商务工程师的**合同管理中心**进行集中处理。

## ✅ 已完成的核心功能

### 1. 后端实现 ✅

#### 数据模型（Contract.js）
- ✅ 合同基本信息（编号、名称、金额、币种等）
- ✅ 合同类型（销售合同、采购合同）
- ✅ 关联项目/采购订单
- ✅ 合同状态流转（待盖章 → 已盖章/已驳回）
- ✅ 合同文件管理（草稿、盖章版）
- ✅ 对方信息（客户/供应商）
- ✅ 付款信息
- ✅ 跟进记录和操作历史

#### 路由接口（contractRoutes.js）
- ✅ GET /api/contracts - 获取合同列表（支持筛选）
- ✅ GET /api/contracts/stats - 获取统计信息
- ✅ GET /api/contracts/:id - 获取合同详情
- ✅ POST /api/contracts/sales - 创建销售合同
- ✅ POST /api/contracts/purchase - 创建采购合同
- ✅ PUT /api/contracts/:id/accept - 商务工程师接单
- ✅ PUT /api/contracts/:id/seal - 上传盖章版并标记为已盖章
- ✅ PUT /api/contracts/:id/reject - 驳回合同
- ✅ PUT /api/contracts/:id - 更新合同信息
- ✅ POST /api/contracts/:id/follow-up - 添加跟进记录
- ✅ DELETE /api/contracts/:id - 删除合同
- ✅ GET /api/contracts/project/:project_id - 获取项目的所有合同
- ✅ GET /api/contracts/purchase-order/:purchase_order_id - 获取采购订单的所有合同

### 2. 前端实现 ✅

#### 合同管理中心页面（ContractCenter.jsx）
- ✅ 统计卡片（待盖章、已盖章、未分配等）
- ✅ Tab切换（全部/销售/采购/待盖章/已盖章）
- ✅ 合同列表展示
- ✅ 合同详情对话框
- ✅ 接单功能
- ✅ 上传盖章版功能
- ✅ 驳回功能
- ✅ 合同文件下载

#### 商务工程师Dashboard更新
- ✅ 添加"待盖章合同"统计卡片
- ✅ 快捷操作区添加"合同管理中心"入口
- ✅ 任务提醒中心添加合同待办提醒

#### API服务（api.js）
- ✅ 完整的contractsAPI接口定义
- ✅ 集成到Dashboard的数据加载

#### 路由配置（App.jsx）
- ✅ 注册/contracts路由
- ✅ Business Engineer权限配置

## 🚧 待完成功能

### 3. 销售经理项目详情页集成

需要在 `ProjectDetails.jsx` 中添加：

#### 3.1 销售合同Tab
```jsx
// 在项目详情页添加一个新的Tab："销售合同"
<Tabs>
  <TabPane tab="项目信息" key="info">...</TabPane>
  <TabPane tab="技术清单" key="tech">...</TabPane>
  <TabPane tab="报价单" key="quote">...</TabPane>
  <TabPane tab="销售合同" key="contract">
    {/* 销售合同管理区域 */}
  </TabPane>
</Tabs>
```

#### 3.2 创建销售合同对话框
```jsx
const CreateContractDialog = ({ open, onClose, project }) => {
  return (
    <Dialog open={open} onClose={onClose}>
      <DialogTitle>准备销售合同</DialogTitle>
      <DialogContent>
        <TextField label="合同名称" />
        <TextField label="合同金额" type="number" />
        <TextField label="客户名称" />
        <TextField label="客户公司" />
        <Button variant="outlined" component="label">
          上传合同草稿
          <input type="file" hidden />
        </Button>
      </DialogContent>
      <DialogActions>
        <Button onClick={onClose}>取消</Button>
        <Button onClick={handleSubmit}>提交至合同中心</Button>
      </DialogActions>
    </Dialog>
  );
};
```

#### 3.3 API调用示例
```javascript
// 创建销售合同
const handleCreateSalesContract = async (contractData) => {
  try {
    const response = await contractsAPI.createSalesContract({
      project_id: project._id,
      contract_name: contractData.name,
      contract_amount: contractData.amount,
      counterparty: {
        name: contractData.customer_name,
        company: contractData.customer_company,
        // ... 其他客户信息
      },
      draft_file: uploadedFile, // 上传的文件信息
      priority: 'Normal'
    });
    
    message.success('销售合同已提交至合同管理中心');
  } catch (error) {
    message.error('提交失败：' + error.message);
  }
};
```

### 4. 采购订单详情页集成

需要在 `PurchaseOrderDetails.jsx` 中添加：

#### 4.1 采购合同Section
```jsx
<Card title="采购合同" extra={
  <Button 
    type="primary" 
    icon={<PlusOutlined />}
    onClick={() => setCreateContractDialogOpen(true)}
  >
    创建采购合同
  </Button>
}>
  {/* 显示已创建的采购合同列表 */}
  <List
    dataSource={contracts}
    renderItem={contract => (
      <List.Item>
        <List.Item.Meta
          title={contract.contract_name}
          description={`金额：${contract.contract_amount} | 状态：${contract.status}`}
        />
        <Button onClick={() => viewContract(contract)}>查看详情</Button>
      </List.Item>
    )}
  />
</Card>
```

#### 4.2 创建采购合同对话框
```jsx
const CreatePurchaseContractDialog = ({ open, onClose, purchaseOrder }) => {
  return (
    <Dialog open={open} onClose={onClose}>
      <DialogTitle>准备采购合同</DialogTitle>
      <DialogContent>
        <TextField label="合同名称" />
        <TextField label="合同金额" type="number" />
        <TextField label="供应商名称" />
        <TextField label="供应商公司" />
        <Button variant="outlined" component="label">
          上传合同草稿
          <input type="file" hidden />
        </Button>
      </DialogContent>
      <DialogActions>
        <Button onClick={onClose}>取消</Button>
        <Button onClick={handleSubmit}>提交至合同中心</Button>
      </DialogActions>
    </Dialog>
  );
};
```

#### 4.3 API调用示例
```javascript
// 创建采购合同
const handleCreatePurchaseContract = async (contractData) => {
  try {
    const response = await contractsAPI.createPurchaseContract({
      purchase_order_id: purchaseOrder._id,
      contract_name: contractData.name,
      contract_amount: contractData.amount,
      counterparty: {
        name: contractData.supplier_name,
        company: contractData.supplier_company,
        // ... 其他供应商信息
      },
      draft_file: uploadedFile, // 上传的文件信息
      priority: 'Normal'
    });
    
    message.success('采购合同已提交至合同管理中心');
  } catch (error) {
    message.error('提交失败：' + error.message);
  }
};
```

## 📝 集成步骤

### 步骤1：修改ProjectDetails.jsx

1. 导入必要的组件和API
```javascript
import { contractsAPI } from '../services/api';
import { Dialog, DialogTitle, DialogContent, DialogActions } from '@mui/material';
```

2. 添加状态管理
```javascript
const [contracts, setContracts] = useState([]);
const [createContractOpen, setCreateContractOpen] = useState(false);
```

3. 加载项目合同
```javascript
const loadContracts = async () => {
  try {
    const response = await contractsAPI.getByProject(project._id);
    setContracts(response.data.data);
  } catch (error) {
    console.error('加载合同失败:', error);
  }
};

useEffect(() => {
  if (project?._id) {
    loadContracts();
  }
}, [project]);
```

4. 在项目详情页添加合同Tab（参考3.1）

### 步骤2：修改PurchaseOrderDetails.jsx

1. 类似的导入和状态管理

2. 加载采购订单合同
```javascript
const loadContracts = async () => {
  try {
    const response = await contractsAPI.getByPurchaseOrder(purchaseOrder._id);
    setContracts(response.data.data);
  } catch (error) {
    console.error('加载合同失败:', error);
  }
};
```

3. 在采购订单详情页添加合同Section（参考4.1）

## 🔄 完整工作流程

### 销售合同流程

1. **销售经理赢单** → 项目状态变为"Won"
2. **销售经理准备合同** → 在项目详情页填写合同信息，上传草稿
3. **销售经理提交** → 点击"提交至合同中心"
4. **系统创建合同记录** → 状态：待盖章
5. **商务工程师收到通知** → Dashboard显示待办
6. **商务工程师处理** → 在合同管理中心接单
7. **商务工程师盖章** → 下载草稿→线下盖章→上传盖章版
8. **完成** → 合同状态变为"已盖章"

### 采购合同流程

1. **采购员创建采购订单** → 完成订单信息填写
2. **采购员准备合同** → 在采购订单详情页填写合同信息，上传草稿
3. **采购员提交** → 点击"提交至合同中心"
4. **系统创建合同记录** → 状态：待盖章
5. **商务工程师收到通知** → Dashboard显示待办
6. **商务工程师处理** → 在合同管理中心接单
7. **商务工程师盖章** → 下载草稿→线下盖章→上传盖章版
8. **完成** → 合同状态变为"已盖章"

## 🎯 关键特性

### 1. 统一的合同管理中心
- 商务工程师拥有唯一的合同处理入口
- 可以按项目维度查看所有合同（销售+采购）
- 统一的盖章处理流程

### 2. 完整的状态流转
- 待盖章 → 已盖章（正常流程）
- 待盖章 → 已驳回（问题退回）
- 完整的操作历史记录

### 3. 文件版本管理
- 草稿文件（发起人上传）
- 盖章版文件（商务工程师上传）
- 文件历史记录

### 4. 通知和提醒
- 商务工程师Dashboard实时显示待盖章合同数量
- 任务提醒中心突出显示
- 一键跳转到合同管理中心

## 📦 数据库Schema

```javascript
// Contract模型主要字段
{
  contract_number: String,        // 合同编号（自动生成：SC-202410-0001）
  contract_type: String,          // 销售合同/采购合同
  contract_name: String,          // 合同名称
  contract_amount: Number,        // 合同金额
  
  // 关联
  project: ObjectId,              // 关联项目（销售合同）
  purchase_order: ObjectId,       // 关联采购订单（采购合同）
  
  // 状态
  status: String,                 // 待盖章/已盖章/已驳回
  
  // 对方信息
  counterparty: {
    name: String,
    company: String,
    contact_person: String,
    contact_phone: String
  },
  
  // 文件
  draft_file: { ... },           // 草稿文件
  sealed_file: { ... },          // 盖章版文件
  
  // 人员
  created_by: ObjectId,          // 发起人
  business_engineer: ObjectId,   // 商务工程师
  
  // 跟进记录
  follow_ups: [{ ... }],
  
  // 操作历史
  operation_history: [{ ... }]
}
```

## 🚀 下一步工作

1. ✅ 后端模型和路由 - 已完成
2. ✅ 合同管理中心页面 - 已完成
3. ✅ 商务工程师Dashboard - 已完成
4. ⏳ 销售经理项目详情页 - 待实现（参考步骤1）
5. ⏳ 采购订单详情页 - 待实现（参考步骤2）
6. ⏳ 文件上传到云存储（LeanCloud）- 需要集成
7. ⏳ 通知系统 - 可选增强

## 📞 技术支持

如有问题，请参考：
- 后端路由：`backend/routes/contractRoutes.js`
- 前端页面：`frontend/src/pages/ContractCenter.jsx`
- API定义：`frontend/src/services/api.js` (contractsAPI)
- 数据模型：`backend/models/Contract.js`

## 🎉 测试商务工程师功能

1. 启动系统
2. 使用商务工程师账号登录
3. 查看Dashboard，应该能看到：
   - "待盖章合同"统计卡片
   - "合同管理中心"快捷按钮
   - 任务提醒中心的合同待办
4. 点击进入合同管理中心 `/contracts`
5. 查看合同列表、统计信息
6. 测试接单、盖章、驳回等功能

---

**实现日期：** 2025-10-31  
**版本：** v1.0  
**状态：** 核心功能已完成，集成待实现

