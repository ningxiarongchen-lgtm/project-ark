# é€šç”¨æ–‡ä»¶ä¸Šä¼ æœåŠ¡å®Œæ•´æ–‡æ¡£

**å®Œæˆæ—¶é—´**: 2025å¹´10æœˆ28æ—¥  
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶å¯ç”¨  
**æ”¯æŒ**: Cloudinaryäº‘å­˜å‚¨ + æœ¬åœ°å­˜å‚¨

---

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æˆ‘ä»¬å·²ç»åˆ›å»ºäº†ä¸€ä¸ªå®Œå…¨å¯å¤ç”¨çš„æ–‡ä»¶ä¸Šä¼ æœåŠ¡ï¼Œæ”¯æŒï¼š
- âœ… **Cloudinaryäº‘å­˜å‚¨** - è‡ªåŠ¨CDNåŠ é€Ÿ
- âœ… **æœ¬åœ°å­˜å‚¨** - æ— éœ€å¤–éƒ¨æœåŠ¡
- âœ… **å¤šç§æ–‡ä»¶ç±»å‹** - å›¾ç‰‡ã€æ–‡æ¡£ã€å‹ç¼©åŒ…ç­‰
- âœ… **æ–‡ä»¶å¤¹ç®¡ç†** - æŒ‰æ¨¡å—åˆ†ç±»å­˜å‚¨
- âœ… **å•æ–‡ä»¶/å¤šæ–‡ä»¶ä¸Šä¼ **
- âœ… **æ–‡ä»¶åˆ é™¤åŠŸèƒ½**
- âœ… **å®Œæ•´çš„APIæ¥å£**

---

## ğŸ—ï¸ æ–‡ä»¶ç»“æ„

```
backend/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ upload.service.js       # æ ¸å¿ƒä¸Šä¼ æœåŠ¡ï¼ˆæ–°å»ºï¼‰
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ uploadRoutes.js          # é€šç”¨ä¸Šä¼ è·¯ç”±ï¼ˆæ–°å»ºï¼‰
â”œâ”€â”€ uploads/                     # æœ¬åœ°æ–‡ä»¶å­˜å‚¨ç›®å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â”‚   â”œâ”€â”€ contracts/
â”‚   â”œâ”€â”€ projects/
â”‚   â”œâ”€â”€ purchase_orders/
â”‚   â””â”€â”€ uploads/
â””â”€â”€ server.js                    # å·²æ›´æ–°ï¼Œæ³¨å†Œæ–°è·¯ç”±
```

---

## ğŸ”§ å®‰è£…ä¾èµ–

### å¿…éœ€ä¾èµ–ï¼ˆå·²æœ‰ï¼‰
```bash
npm install multer
```

### å¯é€‰ä¾èµ–ï¼ˆCloudinaryäº‘å­˜å‚¨ï¼‰
```bash
# å¦‚æœéœ€è¦ä½¿ç”¨Cloudinaryäº‘å­˜å‚¨
npm install cloudinary multer-storage-cloudinary
```

---

## âš™ï¸ ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```env
# å­˜å‚¨ç±»å‹é€‰æ‹©
# è®¾ç½®ä¸º 'true' ä½¿ç”¨Cloudinaryäº‘å­˜å‚¨ï¼Œå¦åˆ™ä½¿ç”¨æœ¬åœ°å­˜å‚¨
USE_CLOUDINARY=false

# Cloudinaryé…ç½®ï¼ˆå¦‚æœ USE_CLOUDINARY=trueï¼‰
# è®¿é—® https://cloudinary.com/ æ³¨å†Œè´¦å·è·å–ä»¥ä¸‹ä¿¡æ¯
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_api_key
CLOUDINARY_API_SECRET=your_api_secret
```

### é…ç½®è¯´æ˜

**æœ¬åœ°å­˜å‚¨æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰**:
- ä¸éœ€è¦é¢å¤–é…ç½®
- æ–‡ä»¶ä¿å­˜åœ¨ `backend/uploads/` ç›®å½•
- é€šè¿‡ `/uploads/...` URLè®¿é—®

**Cloudinaryæ¨¡å¼**:
- éœ€è¦æ³¨å†ŒCloudinaryè´¦å·
- å¡«å†™ç›¸åº”çš„é…ç½®ä¿¡æ¯
- æ–‡ä»¶è‡ªåŠ¨ä¸Šä¼ åˆ°äº‘ç«¯
- è·å¾—CDNåŠ é€Ÿçš„URL

---

## ğŸ“š APIæ–‡æ¡£

### åŸºç¡€URL
```
http://localhost:5001/api/uploads
```

### 1. ä¸Šä¼ å•ä¸ªæ–‡ä»¶

#### é€šç”¨æ¥å£
```http
POST /api/uploads/single
Authorization: Bearer {token}
Content-Type: multipart/form-data
Query Parameters:
  - folder: æ–‡ä»¶å¤¹åç§°ï¼ˆå¯é€‰ï¼Œé»˜è®¤ï¼š'uploads'ï¼‰
  - storage: å­˜å‚¨ç±»å‹ï¼ˆå¯é€‰ï¼Œ'cloudinary' æˆ– 'local'ï¼‰
Body:
  - file: è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆè¡¨å•å­—æ®µåå¿…é¡»æ˜¯ 'file'ï¼‰
```

**è¯·æ±‚ç¤ºä¾‹ï¼ˆä½¿ç”¨curlï¼‰**:
```bash
curl -X POST "http://localhost:5001/api/uploads/single?folder=contracts" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@/path/to/your/file.pdf"
```

**å“åº”ç¤ºä¾‹ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰**:
```json
{
  "success": true,
  "message": "æ–‡ä»¶ä¸Šä¼ æˆåŠŸ",
  "file": {
    "url": "/uploads/contracts/contract-1698765432123-123456789.pdf",
    "path": "/Users/.../backend/uploads/contracts/contract-1698765432123-123456789.pdf",
    "filename": "contract-1698765432123-123456789.pdf",
    "originalName": "contract.pdf",
    "mimeType": "application/pdf",
    "size": 245678,
    "storageType": "local"
  }
}
```

**å“åº”ç¤ºä¾‹ï¼ˆCloudinaryï¼‰**:
```json
{
  "success": true,
  "message": "æ–‡ä»¶ä¸Šä¼ æˆåŠŸ",
  "file": {
    "url": "https://res.cloudinary.com/your-cloud/image/upload/v1234567890/contracts/file.pdf",
    "publicId": "contracts/file",
    "originalName": "contract.pdf",
    "mimeType": "application/pdf",
    "size": 245678,
    "storageType": "cloudinary"
  }
}
```

---

### 2. ä¸Šä¼ å¤šä¸ªæ–‡ä»¶

```http
POST /api/uploads/multiple
Authorization: Bearer {token}
Content-Type: multipart/form-data
Query Parameters:
  - folder: æ–‡ä»¶å¤¹åç§°ï¼ˆå¯é€‰ï¼‰
  - storage: å­˜å‚¨ç±»å‹ï¼ˆå¯é€‰ï¼‰
Body:
  - files: è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆè¡¨å•å­—æ®µåå¿…é¡»æ˜¯ 'files'ï¼Œå¯å¤šä¸ªï¼‰
```

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X POST "http://localhost:5001/api/uploads/multiple?folder=projects" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "files=@file1.jpg" \
  -F "files=@file2.pdf" \
  -F "files=@file3.docx"
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "æˆåŠŸä¸Šä¼  3 ä¸ªæ–‡ä»¶",
  "files": [
    {
      "url": "/uploads/projects/file1-123456789.jpg",
      "filename": "file1-123456789.jpg",
      "originalName": "file1.jpg",
      "mimeType": "image/jpeg",
      "size": 123456,
      "storageType": "local"
    },
    // ... å…¶ä»–æ–‡ä»¶
  ]
}
```

---

### 3. ä¸“ç”¨ä¸Šä¼ æ¥å£

ç³»ç»Ÿé¢„è®¾äº†å‡ ä¸ªå¸¸ç”¨æ¨¡å—çš„ä¸“ç”¨æ¥å£ï¼š

#### ä¸Šä¼ åˆåŒæ–‡ä»¶
```http
POST /api/uploads/contract
Authorization: Bearer {token}
Body: file (multipart/form-data)
```

#### ä¸Šä¼ é¡¹ç›®æ–‡ä»¶
```http
POST /api/uploads/project
Authorization: Bearer {token}
Body: file (multipart/form-data)
```

#### ä¸Šä¼ é‡‡è´­è®¢å•æ–‡ä»¶
```http
POST /api/uploads/purchase-order
Authorization: Bearer {token}
Body: file (multipart/form-data)
```

**ä¼˜åŠ¿**:
- æ— éœ€æŒ‡å®šfolderå‚æ•°
- è‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”æ–‡ä»¶å¤¹
- æ›´ç®€æ´çš„APIè°ƒç”¨

---

### 4. åˆ é™¤æ–‡ä»¶

```http
DELETE /api/uploads/:id
Authorization: Bearer {token}
Content-Type: application/json
Body:
  - publicId: Cloudinaryæ–‡ä»¶IDï¼ˆCloudinaryå­˜å‚¨æ—¶ä½¿ç”¨ï¼‰
  - path: æ–‡ä»¶è·¯å¾„ï¼ˆæœ¬åœ°å­˜å‚¨æ—¶ä½¿ç”¨ï¼‰
  - storageType: å­˜å‚¨ç±»å‹ï¼ˆ'cloudinary' æˆ– 'local'ï¼‰
```

**è¯·æ±‚ç¤ºä¾‹ï¼ˆåˆ é™¤æœ¬åœ°æ–‡ä»¶ï¼‰**:
```bash
curl -X DELETE "http://localhost:5001/api/uploads/file123" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "path": "/Users/.../backend/uploads/contracts/file.pdf",
    "storageType": "local"
  }'
```

**è¯·æ±‚ç¤ºä¾‹ï¼ˆåˆ é™¤Cloudinaryæ–‡ä»¶ï¼‰**:
```bash
curl -X DELETE "http://localhost:5001/api/uploads/file123" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "publicId": "contracts/file_abc123",
    "storageType": "cloudinary"
  }'
```

---

### 5. è·å–ä¸Šä¼ é…ç½®ä¿¡æ¯

```http
GET /api/uploads/info
Authorization: Bearer {token}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "config": {
    "storageType": "local",
    "maxFileSize": "10MB",
    "supportedFormats": [
      "jpg", "jpeg", "png", "gif", "webp",
      "pdf", "doc", "docx", "xls", "xlsx", "csv",
      "zip"
    ],
    "availableFolders": [
      "contracts",
      "projects",
      "purchase_orders",
      "uploads"
    ]
  }
}
```

---

## ğŸ’» ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šåœ¨å…¶ä»–è·¯ç”±ä¸­ä½¿ç”¨ä¸Šä¼ æœåŠ¡

```javascript
// åœ¨ orderRoutes.js ä¸­
const { createUploadMiddleware, getFileInfo } = require('../services/upload.service');

// åˆ›å»ºè®¢å•æ—¶ä¸Šä¼ åˆåŒ
router.post('/orders', protect, (req, res) => {
  const uploadMiddleware = createUploadMiddleware({
    folderName: 'contracts',
    storageType: process.env.USE_CLOUDINARY === 'true' ? 'cloudinary' : 'local'
  });
  
  uploadMiddleware(req, res, async (err) => {
    if (err) {
      return res.status(400).json({ message: 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥', error: err.message });
    }
    
    const fileInfo = getFileInfo(req.file);
    
    // åˆ›å»ºè®¢å•å¹¶ä¿å­˜æ–‡ä»¶ä¿¡æ¯
    const order = await Order.create({
      ...req.body,
      contractFile: fileInfo
    });
    
    res.json({ success: true, data: order });
  });
});
```

### ç¤ºä¾‹2ï¼šå‰ç«¯ä¸Šä¼ æ–‡ä»¶

#### ä½¿ç”¨Fetch API
```javascript
async function uploadFile(file, folder = 'uploads') {
  const formData = new FormData();
  formData.append('file', file);
  
  const response = await fetch(
    `http://localhost:5001/api/uploads/single?folder=${folder}`,
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: formData
    }
  );
  
  const result = await response.json();
  return result.file;
}

// ä½¿ç”¨
const fileInput = document.getElementById('fileInput');
const file = fileInput.files[0];
const fileInfo = await uploadFile(file, 'contracts');
console.log('æ–‡ä»¶URL:', fileInfo.url);
```

#### ä½¿ç”¨Axios
```javascript
import axios from 'axios';

async function uploadFile(file, folder = 'uploads') {
  const formData = new FormData();
  formData.append('file', file);
  
  const response = await axios.post(
    `http://localhost:5001/api/uploads/single?folder=${folder}`,
    formData,
    {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'multipart/form-data'
      }
    }
  );
  
  return response.data.file;
}
```

#### Reactç»„ä»¶ç¤ºä¾‹
```jsx
import React, { useState } from 'react';
import { Upload, Button, message } from 'antd';
import { UploadOutlined } from '@ant-design/icons';
import axios from 'axios';

const FileUploader = ({ folder = 'uploads', onSuccess }) => {
  const [uploading, setUploading] = useState(false);
  
  const handleUpload = async (options) => {
    const { file, onSuccess: onSuccessCallback, onError } = options;
    
    const formData = new FormData();
    formData.append('file', file);
    
    setUploading(true);
    try {
      const response = await axios.post(
        `http://localhost:5001/api/uploads/single?folder=${folder}`,
        formData,
        {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'multipart/form-data'
          }
        }
      );
      
      message.success('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ');
      onSuccessCallback(response.data.file);
      onSuccess && onSuccess(response.data.file);
    } catch (error) {
      message.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
      onError(error);
    } finally {
      setUploading(false);
    }
  };
  
  return (
    <Upload
      customRequest={handleUpload}
      showUploadList={true}
      maxCount={1}
    >
      <Button icon={<UploadOutlined />} loading={uploading}>
        ä¸Šä¼ æ–‡ä»¶
      </Button>
    </Upload>
  );
};

export default FileUploader;
```

---

## ğŸ¯ æ”¯æŒçš„æ–‡ä»¶ç±»å‹

### å›¾ç‰‡æ–‡ä»¶
- `.jpg`, `.jpeg` - JPEGå›¾ç‰‡
- `.png` - PNGå›¾ç‰‡
- `.gif` - GIFåŠ¨å›¾
- `.webp` - WebPå›¾ç‰‡

### æ–‡æ¡£æ–‡ä»¶
- `.pdf` - PDFæ–‡æ¡£
- `.doc`, `.docx` - Wordæ–‡æ¡£
- `.xls`, `.xlsx` - Excelè¡¨æ ¼
- `.csv` - CSVæ–‡ä»¶

### å‹ç¼©æ–‡ä»¶
- `.zip` - ZIPå‹ç¼©åŒ…

### æ–‡ä»¶å¤§å°é™åˆ¶
- é»˜è®¤ï¼š10MB
- å¯é€šè¿‡é…ç½®è°ƒæ•´

---

## ğŸ“ æ–‡ä»¶å¤¹ç»„ç»‡

ç³»ç»Ÿé¢„è®¾äº†ä»¥ä¸‹æ–‡ä»¶å¤¹ï¼š

```
backend/uploads/
â”œâ”€â”€ contracts/           # åˆåŒæ–‡ä»¶
â”œâ”€â”€ projects/            # é¡¹ç›®æ–‡ä»¶
â”œâ”€â”€ purchase_orders/     # é‡‡è´­è®¢å•æ–‡ä»¶
â””â”€â”€ uploads/             # é€šç”¨ä¸Šä¼ æ–‡ä»¶
```

### æ·»åŠ è‡ªå®šä¹‰æ–‡ä»¶å¤¹

åªéœ€åœ¨ä¸Šä¼ æ—¶æŒ‡å®šfolderå‚æ•°ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºï¼š

```javascript
// ä¸Šä¼ åˆ°è‡ªå®šä¹‰æ–‡ä»¶å¤¹
const uploadMiddleware = createUploadMiddleware({
  folderName: 'invoices',  // å‘ç¥¨æ–‡ä»¶å¤¹
  storageType: 'local'
});
```

---

## ğŸ” å®‰å…¨ç‰¹æ€§

1. **è®¤è¯ä¿æŠ¤**
   - æ‰€æœ‰ä¸Šä¼ æ¥å£éœ€è¦JWTè®¤è¯
   - ä½¿ç”¨ `protect` ä¸­é—´ä»¶éªŒè¯token

2. **æ–‡ä»¶ç±»å‹é™åˆ¶**
   - åªå…è®¸é¢„å®šä¹‰çš„å®‰å…¨æ–‡ä»¶ç±»å‹
   - é˜²æ­¢ä¸Šä¼ å¯æ‰§è¡Œæ–‡ä»¶

3. **æ–‡ä»¶å¤§å°é™åˆ¶**
   - é»˜è®¤é™åˆ¶10MB
   - é˜²æ­¢æœåŠ¡å™¨å­˜å‚¨è¢«å æ»¡

4. **æ–‡ä»¶åå®‰å…¨**
   - è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
   - é˜²æ­¢æ–‡ä»¶åå†²çªå’Œæ³¨å…¥æ”»å‡»

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼ˆé»˜è®¤ï¼‰

**æ­¥éª¤1**: ç¡®è®¤é…ç½®
```env
USE_CLOUDINARY=false
```

**æ­¥éª¤2**: å¯åŠ¨æœåŠ¡å™¨
```bash
cd backend
npm start
```

**æ­¥éª¤3**: æµ‹è¯•ä¸Šä¼ 
```bash
curl -X POST "http://localhost:5001/api/uploads/single" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@test.jpg"
```

**æ­¥éª¤4**: è®¿é—®æ–‡ä»¶
```
http://localhost:5001/uploads/uploads/test-123456789.jpg
```

---

### 2. ä½¿ç”¨Cloudinaryäº‘å­˜å‚¨

**æ­¥éª¤1**: å®‰è£…ä¾èµ–
```bash
npm install cloudinary multer-storage-cloudinary
```

**æ­¥éª¤2**: æ³¨å†ŒCloudinaryè´¦å·
- è®¿é—® https://cloudinary.com/
- æ³¨å†Œå…è´¹è´¦å·
- è·å–é…ç½®ä¿¡æ¯ï¼ˆDashboardé¡µé¢ï¼‰

**æ­¥éª¤3**: é…ç½®ç¯å¢ƒå˜é‡
```env
USE_CLOUDINARY=true
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_api_key
CLOUDINARY_API_SECRET=your_api_secret
```

**æ­¥éª¤4**: é‡å¯æœåŠ¡å™¨
```bash
npm start
```

**æ­¥éª¤5**: æµ‹è¯•ä¸Šä¼ 
```bash
curl -X POST "http://localhost:5001/api/uploads/single" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@test.jpg"
```

**æ­¥éª¤6**: æ–‡ä»¶ä¼šè‡ªåŠ¨ä¸Šä¼ åˆ°Cloudinary
- è¿”å›çš„URLç›´æ¥å¯ç”¨
- è‡ªåŠ¨è·å¾—CDNåŠ é€Ÿ

---

## ğŸ¨ é«˜çº§é…ç½®

### è‡ªå®šä¹‰æ–‡ä»¶è¿‡æ»¤å™¨

```javascript
const { createUploadMiddleware } = require('../services/upload.service');

// åªå…è®¸å›¾ç‰‡
const imageFilter = (req, file, cb) => {
  if (file.mimetype.startsWith('image/')) {
    cb(null, true);
  } else {
    cb(new Error('åªå…è®¸ä¸Šä¼ å›¾ç‰‡'), false);
  }
};

const uploadMiddleware = createUploadMiddleware({
  folderName: 'avatars',
  storageType: 'cloudinary',
  fileFilter: imageFilter
});
```

### è°ƒæ•´æ–‡ä»¶å¤§å°é™åˆ¶

```javascript
const uploadMiddleware = createUploadMiddleware({
  folderName: 'videos',
  storageType: 'cloudinary',
  maxSize: 50 * 1024 * 1024  // 50MB
});
```

### æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ 

```javascript
const uploadMiddleware = createUploadMiddleware({
  folderName: 'gallery',
  storageType: 'cloudinary',
  multiple: true  // å¯ç”¨å¤šæ–‡ä»¶ä¸Šä¼ 
});
```

---

## ğŸ“Š å¯¹æ¯”ï¼šæœ¬åœ°å­˜å‚¨ vs Cloudinary

| ç‰¹æ€§ | æœ¬åœ°å­˜å‚¨ | Cloudinary |
|------|---------|-----------|
| **è´¹ç”¨** | å…è´¹ï¼ˆä½¿ç”¨è‡ªå·±çš„æœåŠ¡å™¨ï¼‰ | å…è´¹å¥—é¤æœ‰é™é¢ |
| **CDN** | âŒ æ—  | âœ… å…¨çƒCDN |
| **å­˜å‚¨å®¹é‡** | å—æœåŠ¡å™¨é™åˆ¶ | äº‘ç«¯æ— é™ï¼ˆä»˜è´¹ï¼‰ |
| **å›¾ç‰‡å¤„ç†** | âŒ éœ€è‡ªå·±å®ç° | âœ… è‡ªåŠ¨ä¼˜åŒ–ã€è£å‰ªã€è½¬æ¢ |
| **å¤‡ä»½** | âŒ éœ€è‡ªå·±å¤‡ä»½ | âœ… è‡ªåŠ¨å¤‡ä»½ |
| **æœåŠ¡å™¨è´Ÿè½½** | âš ï¸ æ¶ˆè€—æœåŠ¡å™¨èµ„æº | âœ… å‡è½»æœåŠ¡å™¨è´Ÿæ‹… |
| **é…ç½®å¤æ‚åº¦** | âœ… ç®€å• | âš ï¸ éœ€æ³¨å†Œé…ç½® |
| **é€‚ç”¨åœºæ™¯** | å¼€å‘ç¯å¢ƒã€å°å‹é¡¹ç›® | ç”Ÿäº§ç¯å¢ƒã€å¤§å‹é¡¹ç›® |

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ä¸Šä¼ æ–‡ä»¶è¿”å›403é”™è¯¯
**åŸå› **: æœªæä¾›è®¤è¯tokenæˆ–tokenè¿‡æœŸ  
**è§£å†³**: æ£€æŸ¥è¯·æ±‚å¤´ä¸­æ˜¯å¦åŒ…å«æœ‰æ•ˆçš„ `Authorization: Bearer {token}`

### Q2: æ–‡ä»¶ä¸Šä¼ åæ— æ³•è®¿é—®ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰
**åŸå› **: é™æ€æ–‡ä»¶æœåŠ¡æœªé…ç½®  
**è§£å†³**: ç¡®è®¤ `server.js` ä¸­å·²æ·»åŠ :
```javascript
app.use('/uploads', express.static(path.join(__dirname, 'uploads')));
```

### Q3: Cloudinaryä¸Šä¼ å¤±è´¥
**åŸå› **: ç¯å¢ƒå˜é‡æœªé…ç½®æˆ–åŒ…æœªå®‰è£…  
**è§£å†³**: 
1. æ£€æŸ¥ `.env` é…ç½®
2. ç¡®è®¤å·²å®‰è£… `cloudinary` å’Œ `multer-storage-cloudinary`

### Q4: ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹
**åŸå› **: æ–‡ä»¶ç±»å‹ä¸åœ¨å…è®¸åˆ—è¡¨ä¸­  
**è§£å†³**: ä¿®æ”¹ `upload.service.js` ä¸­çš„ `fileFilter` å‡½æ•°

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. æ–‡ä»¶å‘½å
```javascript
// âœ… å¥½çš„åšæ³•ï¼šè‡ªåŠ¨ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
// ç³»ç»Ÿä¼šè‡ªåŠ¨æ·»åŠ æ—¶é—´æˆ³å’Œéšæœºæ•°

// âŒ é¿å…ï¼šç›´æ¥ä½¿ç”¨ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶å
// å¯èƒ½å¯¼è‡´æ–‡ä»¶åå†²çªå’Œå®‰å…¨é—®é¢˜
```

### 2. å­˜å‚¨é€‰æ‹©
```javascript
// å¼€å‘ç¯å¢ƒï¼šä½¿ç”¨æœ¬åœ°å­˜å‚¨
if (process.env.NODE_ENV === 'development') {
  storageType = 'local';
}

// ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨Cloudinary
if (process.env.NODE_ENV === 'production') {
  storageType = 'cloudinary';
}
```

### 3. é”™è¯¯å¤„ç†
```javascript
try {
  const fileInfo = await uploadFile(file);
  // ä¿å­˜åˆ°æ•°æ®åº“
  await saveToDatabase(fileInfo);
} catch (error) {
  // å¦‚æœä¿å­˜å¤±è´¥ï¼Œåˆ é™¤å·²ä¸Šä¼ çš„æ–‡ä»¶
  if (fileInfo.storageType === 'cloudinary') {
    await deleteCloudinaryFile(fileInfo.publicId);
  } else {
    await deleteLocalFile(fileInfo.path);
  }
  throw error;
}
```

### 4. è¿›åº¦æ˜¾ç¤º
```javascript
// å‰ç«¯æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
const formData = new FormData();
formData.append('file', file);

axios.post('/api/uploads/single', formData, {
  onUploadProgress: (progressEvent) => {
    const percentCompleted = Math.round(
      (progressEvent.loaded * 100) / progressEvent.total
    );
    console.log(`ä¸Šä¼ è¿›åº¦: ${percentCompleted}%`);
  }
});
```

---

## ğŸ”„ è¿ç§»æŒ‡å—

### ä»æ—§çš„ä¸Šä¼ é€»è¾‘è¿ç§»

**æ—§ä»£ç **:
```javascript
// orders.routes.js (å‡è®¾çš„æ—§ä»£ç )
const multer = require('multer');
const upload = multer({ dest: 'uploads/' });

router.post('/upload', upload.single('file'), (req, res) => {
  // å¤„ç†ä¸Šä¼ 
});
```

**æ–°ä»£ç **:
```javascript
// orders.routes.js (ä½¿ç”¨æ–°æœåŠ¡)
const { createUploadMiddleware, getFileInfo } = require('../services/upload.service');

router.post('/upload', protect, (req, res) => {
  const uploadMiddleware = createUploadMiddleware({
    folderName: 'orders',
    storageType: process.env.USE_CLOUDINARY === 'true' ? 'cloudinary' : 'local'
  });
  
  uploadMiddleware(req, res, (err) => {
    if (err) {
      return res.status(400).json({ message: err.message });
    }
    
    const fileInfo = getFileInfo(req.file);
    res.json({ success: true, file: fileInfo });
  });
});
```

**æˆ–è€…ç›´æ¥ä½¿ç”¨é€šç”¨æ¥å£**:
```javascript
// å‰ç«¯ä»£ç 
const response = await axios.post('/api/uploads/single?folder=orders', formData);
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **Multeræ–‡æ¡£**: https://github.com/expressjs/multer
- **Cloudinaryæ–‡æ¡£**: https://cloudinary.com/documentation
- **Expressé™æ€æ–‡ä»¶**: https://expressjs.com/en/starter/static-files.html

---

## ğŸ‰ æ€»ç»“

é€šè¿‡è¿™æ¬¡é‡æ„ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

âœ… **ç»Ÿä¸€çš„æ–‡ä»¶ä¸Šä¼ æœåŠ¡** - ä¸€å¤„é…ç½®ï¼Œåˆ°å¤„ä½¿ç”¨  
âœ… **çµæ´»çš„å­˜å‚¨é€‰æ‹©** - æœ¬åœ°æˆ–äº‘ç«¯ï¼ŒæŒ‰éœ€åˆ‡æ¢  
âœ… **å®Œæ•´çš„APIæ¥å£** - å¼€ç®±å³ç”¨  
âœ… **é«˜åº¦å¯å¤ç”¨** - è½»æ¾æ‰©å±•åˆ°æ–°æ¨¡å—  
âœ… **ç”Ÿäº§ç¯å¢ƒå°±ç»ª** - æ”¯æŒCloudinary CDN  

**æ–‡ä»¶æ¸…å•**:
- âœ… `backend/services/upload.service.js` - æ ¸å¿ƒæœåŠ¡
- âœ… `backend/routes/uploadRoutes.js` - APIè·¯ç”±
- âœ… `backend/server.js` - å·²æ›´æ–°
- âœ… æœ¬æ–‡æ¡£

**ä¸‹ä¸€æ­¥**:
1. å¦‚éœ€ä½¿ç”¨Cloudinaryï¼Œå®‰è£…ä¾èµ–å¹¶é…ç½®ç¯å¢ƒå˜é‡
2. åœ¨å…¶ä»–æ¨¡å—ä¸­æ›¿æ¢æ—§çš„ä¸Šä¼ é€»è¾‘
3. æ›´æ–°å‰ç«¯è°ƒç”¨æ–°çš„APIæ¥å£

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ28æ—¥  
**ä½œè€…**: Cursor AI Assistant

