# æƒé™æ§åˆ¶å¿«é€Ÿå‚è€ƒ

## ğŸ“‹ æƒé™çŸ©é˜µé€ŸæŸ¥è¡¨

### é¡µé¢è®¿é—®æƒé™

| é¡µé¢ | Admin | æŠ€æœ¯å·¥ç¨‹å¸ˆ | å•†åŠ¡å·¥ç¨‹å¸ˆ | é”€å”®ç»ç† | é‡‡è´­ä¸“å‘˜ | ç”Ÿäº§è®¡åˆ’å‘˜ | å”®åå·¥ç¨‹å¸ˆ |
|------|:-----:|:--------:|:--------:|:------:|:------:|:--------:|:--------:|
| ğŸ­ ç”Ÿäº§æ’æœŸ | âœ… | âŒ | âŒ | ğŸ‘ï¸ | âŒ | âœ… | âŒ |
| ğŸ« å”®åæœåŠ¡ | âœ… | âœ…* | âœ…* | âœ…* | âŒ | âŒ | âœ… |
| ğŸ‘¥ ä¾›åº”å•†ç®¡ç† | âœ… | âŒ | âŒ | âŒ | âœ… | âŒ | âŒ |

> âœ… = å®Œæ•´æƒé™ | ğŸ‘ï¸ = åªè¯» | âŒ = æ— æƒé™ | * = æœ‰é™æƒé™

---

## ğŸ­ è§’è‰²åŠŸèƒ½è¯¦è§£

### 1ï¸âƒ£ ç”Ÿäº§æ’æœŸé¡µé¢

#### Administrator & Production Planner (å®Œæ•´æƒé™)
```
âœ… æŸ¥çœ‹æ‰€æœ‰ç”Ÿäº§è®¢å•
âœ… æ›´æ–°ç”Ÿäº§çŠ¶æ€ (å¼€å§‹/æš‚åœ/å®Œæˆ)
âœ… åˆ é™¤ç”Ÿäº§è®¢å•
âœ… ä¿®æ”¹ä¼˜å…ˆçº§å’Œæ’æœŸ
```

#### Sales Manager (åªè¯»æƒé™)
```
âœ… æŸ¥çœ‹æ‰€æœ‰ç”Ÿäº§è®¢å•
âœ… æŸ¥çœ‹ç»Ÿè®¡æ•°æ®
âŒ æ— æ³•ä¿®æ”¹ä»»ä½•ä¿¡æ¯
ğŸ’¡ çœ‹åˆ°é»„è‰²æç¤ºï¼š"åªè¯»æ¨¡å¼"
```

---

### 2ï¸âƒ£ å”®åæœåŠ¡ä¸­å¿ƒ

#### Administrator (å®Œæ•´æƒé™)
```
âœ… æŸ¥çœ‹æ‰€æœ‰å·¥å•
âœ… åˆ›å»º/åˆ é™¤å·¥å•
âœ… åˆ†é…å·¥ç¨‹å¸ˆ
âœ… æ›´æ–°çŠ¶æ€
âœ… æ·»åŠ è·Ÿè¿›è®°å½•
```

#### After-sales Engineer (æ ¸å¿ƒæƒé™)
```
ğŸ¯ é»˜è®¤æ˜¾ç¤º: æˆ‘çš„å·¥å•
âœ… åˆ‡æ¢æŸ¥çœ‹: æ‰€æœ‰å·¥å•
âœ… åˆ›å»ºå·¥å•
âœ… æ›´æ–°çŠ¶æ€ (ä»…è‡ªå·±çš„å·¥å•)
âœ… æ·»åŠ è·Ÿè¿› (ä»…è‡ªå·±çš„å·¥å•)
âŒ æ— æ³•åˆ†é…å·¥ç¨‹å¸ˆ
âŒ æ— æ³•åˆ é™¤å·¥å•
```

#### Sales Engineer / Technical Engineer
```
âœ… æŸ¥çœ‹æ‰€æœ‰å·¥å•
âœ… åˆ›å»ºå·¥å•
âœ… æ·»åŠ è·Ÿè¿›è®°å½•
âŒ æ— æ³•æ›´æ–°çŠ¶æ€
âŒ æ— æ³•åˆ†é…å·¥ç¨‹å¸ˆ
```

#### Sales Manager
```
âœ… æŸ¥çœ‹æ‰€æœ‰å·¥å•
âœ… åˆ†é…å·¥ç¨‹å¸ˆ
âŒ æ— æ³•åˆ›å»ºå·¥å•
âŒ æ— æ³•æ›´æ–°çŠ¶æ€
```

---

### 3ï¸âƒ£ å·¥å•è¯¦æƒ…é¡µ

#### æŒ‰é’®æƒé™çŸ©é˜µ

| æŒ‰é’® | Admin | å”®åå·¥ç¨‹å¸ˆ* | æŠ€æœ¯å·¥ç¨‹å¸ˆ | å•†åŠ¡å·¥ç¨‹å¸ˆ | é”€å”®ç»ç† |
|------|:-----:|:----------:|:--------:|:--------:|:------:|
| ğŸ”„ æ›´æ–°çŠ¶æ€ | âœ… | âœ…* | âœ… | âŒ | âŒ |
| ğŸ‘¤ åˆ†é…å·¥ç¨‹å¸ˆ | âœ… | âŒ | âŒ | âŒ | âœ… |
| ğŸ“ æ·»åŠ è·Ÿè¿› | âœ… | âœ…* | âœ… | âŒ | âŒ |
| â­ æäº¤åé¦ˆ | âœ… | âœ… | âœ… | âŒ | âŒ |

> *å”®åå·¥ç¨‹å¸ˆä»…èƒ½æ“ä½œåˆ†é…ç»™è‡ªå·±çš„å·¥å•

#### å”®åå·¥ç¨‹å¸ˆç‰¹æ®Šè§„åˆ™

**è‡ªå·±çš„å·¥å•** (isAssignedEngineer = true):
```
âœ… çœ‹åˆ°æ‰€æœ‰æ“ä½œæŒ‰é’®
âœ… å¯ä»¥æ›´æ–°çŠ¶æ€
âœ… å¯ä»¥æ·»åŠ è·Ÿè¿›
```

**åˆ«äººçš„å·¥å•** (isAssignedEngineer = false):
```
âš ï¸ çœ‹åˆ°é»„è‰²è­¦å‘Šï¼š"åªè¯»æ¨¡å¼"
ğŸ‘ï¸ åªèƒ½æŸ¥çœ‹ä¿¡æ¯
âŒ æ‰€æœ‰æ“ä½œæŒ‰é’®éšè—
```

---

### 4ï¸âƒ£ ä¾›åº”å•†ç®¡ç†

#### Administrator & Procurement Specialist
```
âœ… æŸ¥çœ‹ä¾›åº”å•†åˆ—è¡¨
âœ… åˆ›å»ºä¾›åº”å•†
âœ… æ›´æ–°ä¾›åº”å•†ä¿¡æ¯
âœ… æ›´æ–°è¯„çº§å’ŒçŠ¶æ€
âœ… åˆ é™¤ä¾›åº”å•† (ä»… Admin)
```

#### å…¶ä»–è§’è‰²
```
ğŸš« å®Œå…¨æ— æ³•è®¿é—®
ğŸ’¡ æ˜¾ç¤º 403 ç¦æ­¢é¡µé¢
```

---

## ğŸ”§ API è·¯ç”±æƒé™

### ä¾›åº”å•†ç®¡ç† API

```javascript
// âœ… æŸ¥è¯¢æ“ä½œ - Admin, Procurement Specialist
GET  /api/suppliers
GET  /api/suppliers/:id
GET  /api/suppliers/stats/summary

// âœ… åˆ›å»º/ä¿®æ”¹ - Admin, Procurement Specialist
POST  /api/suppliers
PUT   /api/suppliers/:id
PATCH /api/suppliers/:id/status
PATCH /api/suppliers/:id/rating

// ğŸ”’ åˆ é™¤æ“ä½œ - ä»… Administrator
DELETE /api/suppliers/:id
```

### ç”Ÿäº§ç®¡ç† API

```javascript
// âœ… æŸ¥è¯¢ - Admin, Production Planner, Sales Manager
GET /api/production

// âœ… ä¿®æ”¹ - Admin, Production Planner
POST  /api/production
PUT   /api/production/:id
PATCH /api/production/:id/status

// ğŸ”’ åˆ é™¤ - ä»… Administrator
DELETE /api/production/:id
```

### å·¥å•ç®¡ç† API

```javascript
// âœ… åˆ›å»º - Admin, After-sales Engineer, Sales Engineer, Technical Engineer
POST /api/tickets

// âœ… æ›´æ–° - Admin, After-sales Engineer, Technical Engineer
PUT   /api/tickets/:id
PATCH /api/tickets/:id/status

// âœ… åˆ†é… - Admin, After-sales Engineer, Sales Manager
POST /api/tickets/:id/assign

// ğŸ”’ åˆ é™¤ - ä»… Administrator
DELETE /api/tickets/:id
```

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### å‰ç«¯æƒé™æ£€æŸ¥

#### 1. ä½¿ç”¨ useAuth Hook

```javascript
import { useAuth } from '../hooks/useAuth'

const MyComponent = () => {
  const { user, hasAnyRole, isAdmin } = useAuth()
  
  // æ£€æŸ¥è§’è‰²
  const canEdit = hasAnyRole(['Administrator', 'Sales Manager'])
  
  // æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
  if (isAdmin()) {
    // ç®¡ç†å‘˜ä¸“å±åŠŸèƒ½
  }
  
  return (
    <div>
      {canEdit && <Button>ç¼–è¾‘</Button>}
    </div>
  )
}
```

#### 2. ä½¿ç”¨ RoleBasedAccess ç»„ä»¶

```javascript
import RoleBasedAccess from '../components/RoleBasedAccess'

<RoleBasedAccess allowedRoles={['Administrator', 'Sales Manager']}>
  <Button type="danger">åˆ é™¤</Button>
</RoleBasedAccess>
```

#### 3. æ¡ä»¶æ¸²æŸ“

```javascript
{canEdit && (
  <Button>ç¼–è¾‘</Button>
)}

{user?.role === 'After-sales Engineer' && isAssignedEngineer && (
  <Button>æ›´æ–°çŠ¶æ€</Button>
)}
```

### åç«¯è·¯ç”±æƒé™

```javascript
const { protect, authorize } = require('../middleware/auth')

// å•è§’è‰²æˆæƒ
router.delete('/:id', protect, authorize('Administrator'), deleteItem)

// å¤šè§’è‰²æˆæƒ
router.post('/', protect, authorize('Administrator', 'Sales Manager'), createItem)
```

---

## ğŸ“ æµ‹è¯•æ¸…å•

### ç”Ÿäº§æ’æœŸé¡µé¢æµ‹è¯•

- [ ] Administrator ç™»å½• â†’ çœ‹åˆ°å®Œæ•´åŠŸèƒ½
- [ ] Production Planner ç™»å½• â†’ çœ‹åˆ°å®Œæ•´åŠŸèƒ½
- [ ] Sales Manager ç™»å½• â†’ çœ‹åˆ°åªè¯»æ¨¡å¼æç¤º
- [ ] Technical Engineer ç™»å½• â†’ çœ‹åˆ° 403 é¡µé¢

### å”®åæœåŠ¡æµ‹è¯•

- [ ] After-sales Engineer ç™»å½• â†’ é»˜è®¤æ˜¾ç¤º"æˆ‘çš„å·¥å•"
- [ ] ç‚¹å‡»åˆ‡æ¢æŒ‰é’® â†’ æ˜¾ç¤º"æ‰€æœ‰å·¥å•"
- [ ] Administrator ç‚¹å‡»åˆ é™¤ â†’ æˆåŠŸåˆ é™¤
- [ ] Sales Engineer ç‚¹å‡»åˆ é™¤ â†’ æŒ‰é’®ä¸å­˜åœ¨

### å·¥å•è¯¦æƒ…æµ‹è¯•

- [ ] After-sales Engineer è®¿é—®è‡ªå·±çš„å·¥å• â†’ çœ‹åˆ°æ‰€æœ‰æŒ‰é’®
- [ ] After-sales Engineer è®¿é—®åˆ«äººçš„å·¥å• â†’ çœ‹åˆ°è­¦å‘Šæç¤º
- [ ] Sales Manager ç™»å½• â†’ çœ‹åˆ°"åˆ†é…å·¥ç¨‹å¸ˆ"æŒ‰é’®
- [ ] Technical Engineer ç™»å½• â†’ æ— "åˆ†é…å·¥ç¨‹å¸ˆ"æŒ‰é’®

### ä¾›åº”å•†ç®¡ç†æµ‹è¯•

- [ ] Administrator ç™»å½• â†’ çœ‹åˆ°å®Œæ•´é¡µé¢
- [ ] Procurement Specialist ç™»å½• â†’ çœ‹åˆ°å®Œæ•´é¡µé¢
- [ ] Sales Manager ç™»å½• â†’ çœ‹åˆ° 403 é¡µé¢

### API æµ‹è¯•

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æµ‹è¯• API æƒé™ï¼š

```bash
# æµ‹è¯•ä¾›åº”å•†åˆ é™¤ (ä»… Admin)
curl -X DELETE http://localhost:5000/api/suppliers/:id \
  -H "Authorization: Bearer {admin_token}"

# æµ‹è¯•ç”Ÿäº§çŠ¶æ€æ›´æ–° (Admin + Planner)
curl -X PATCH http://localhost:5000/api/production/:id/status \
  -H "Authorization: Bearer {planner_token}" \
  -d '{"status": "In Production"}'

# æµ‹è¯•å·¥å•åˆ†é… (Admin + Sales Manager)
curl -X POST http://localhost:5000/api/tickets/:id/assign \
  -H "Authorization: Bearer {sales_manager_token}" \
  -d '{"engineerId": "xxx"}'
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: å”®åå·¥ç¨‹å¸ˆçœ‹ä¸åˆ°è‡ªå·±çš„å·¥å•ï¼Ÿ
**A**: æ£€æŸ¥ç”¨æˆ·å¯¹è±¡çš„ `_id` æˆ– `id` å­—æ®µæ˜¯å¦ä¸å·¥å•çš„ `assignedEngineer` åŒ¹é…ã€‚

### Q2: æƒé™æ£€æŸ¥å¤±æ•ˆï¼Ÿ
**A**: ç¡®ä¿å·²ç™»å½•å¹¶ä¸” token æœ‰æ•ˆã€‚æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¹¶é‡æ–°ç™»å½•ã€‚

### Q3: API è¿”å› 403 é”™è¯¯ï¼Ÿ
**A**: æ£€æŸ¥åç«¯è·¯ç”±æ˜¯å¦æ·»åŠ äº† `authorize` ä¸­é—´ä»¶ï¼Œä»¥åŠä¼ å…¥çš„è§’è‰²åç§°æ˜¯å¦æ­£ç¡®ã€‚

### Q4: åˆ‡æ¢ç”¨æˆ·åæƒé™æ²¡æ›´æ–°ï¼Ÿ
**A**: åˆ·æ–°é¡µé¢æˆ–é‡æ–°ç™»å½•ï¼Œç¡®ä¿ `useAuthStore` ä¸­çš„ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°ã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **å®Œæ•´æŠ¥å‘Š**: `æƒé™æ§åˆ¶å®æ–½å®ŒæˆæŠ¥å‘Š.md`
- **useAuth Hook**: `frontend/src/hooks/useAuth.js`
- **RoleBasedAccess**: `frontend/src/components/RoleBasedAccess.jsx`
- **åç«¯ä¸­é—´ä»¶**: `backend/middleware/auth.js`

---

**æœ€åæ›´æ–°**: 2025-10-28

