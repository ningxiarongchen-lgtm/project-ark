# 权限控制快速参考

## 📋 权限矩阵速查表

### 页面访问权限

| 页面 | Admin | 技术工程师 | 商务工程师 | 销售经理 | 采购专员 | 生产计划员 | 售后工程师 |
|------|:-----:|:--------:|:--------:|:------:|:------:|:--------:|:--------:|
| 🏭 生产排期 | ✅ | ❌ | ❌ | 👁️ | ❌ | ✅ | ❌ |
| 🎫 售后服务 | ✅ | ✅* | ✅* | ✅* | ❌ | ❌ | ✅ |
| 👥 供应商管理 | ✅ | ❌ | ❌ | ❌ | ✅ | ❌ | ❌ |

> ✅ = 完整权限 | 👁️ = 只读 | ❌ = 无权限 | * = 有限权限

---

## 🎭 角色功能详解

### 1️⃣ 生产排期页面

#### Administrator & Production Planner (完整权限)
```
✅ 查看所有生产订单
✅ 更新生产状态 (开始/暂停/完成)
✅ 删除生产订单
✅ 修改优先级和排期
```

#### Sales Manager (只读权限)
```
✅ 查看所有生产订单
✅ 查看统计数据
❌ 无法修改任何信息
💡 看到黄色提示："只读模式"
```

---

### 2️⃣ 售后服务中心

#### Administrator (完整权限)
```
✅ 查看所有工单
✅ 创建/删除工单
✅ 分配工程师
✅ 更新状态
✅ 添加跟进记录
```

#### After-sales Engineer (核心权限)
```
🎯 默认显示: 我的工单
✅ 切换查看: 所有工单
✅ 创建工单
✅ 更新状态 (仅自己的工单)
✅ 添加跟进 (仅自己的工单)
❌ 无法分配工程师
❌ 无法删除工单
```

#### Sales Engineer / Technical Engineer
```
✅ 查看所有工单
✅ 创建工单
✅ 添加跟进记录
❌ 无法更新状态
❌ 无法分配工程师
```

#### Sales Manager
```
✅ 查看所有工单
✅ 分配工程师
❌ 无法创建工单
❌ 无法更新状态
```

---

### 3️⃣ 工单详情页

#### 按钮权限矩阵

| 按钮 | Admin | 售后工程师* | 技术工程师 | 商务工程师 | 销售经理 |
|------|:-----:|:----------:|:--------:|:--------:|:------:|
| 🔄 更新状态 | ✅ | ✅* | ✅ | ❌ | ❌ |
| 👤 分配工程师 | ✅ | ❌ | ❌ | ❌ | ✅ |
| 📝 添加跟进 | ✅ | ✅* | ✅ | ❌ | ❌ |
| ⭐ 提交反馈 | ✅ | ✅ | ✅ | ❌ | ❌ |

> *售后工程师仅能操作分配给自己的工单

#### 售后工程师特殊规则

**自己的工单** (isAssignedEngineer = true):
```
✅ 看到所有操作按钮
✅ 可以更新状态
✅ 可以添加跟进
```

**别人的工单** (isAssignedEngineer = false):
```
⚠️ 看到黄色警告："只读模式"
👁️ 只能查看信息
❌ 所有操作按钮隐藏
```

---

### 4️⃣ 供应商管理

#### Administrator & Procurement Specialist
```
✅ 查看供应商列表
✅ 创建供应商
✅ 更新供应商信息
✅ 更新评级和状态
✅ 删除供应商 (仅 Admin)
```

#### 其他角色
```
🚫 完全无法访问
💡 显示 403 禁止页面
```

---

## 🔧 API 路由权限

### 供应商管理 API

```javascript
// ✅ 查询操作 - Admin, Procurement Specialist
GET  /api/suppliers
GET  /api/suppliers/:id
GET  /api/suppliers/stats/summary

// ✅ 创建/修改 - Admin, Procurement Specialist
POST  /api/suppliers
PUT   /api/suppliers/:id
PATCH /api/suppliers/:id/status
PATCH /api/suppliers/:id/rating

// 🔒 删除操作 - 仅 Administrator
DELETE /api/suppliers/:id
```

### 生产管理 API

```javascript
// ✅ 查询 - Admin, Production Planner, Sales Manager
GET /api/production

// ✅ 修改 - Admin, Production Planner
POST  /api/production
PUT   /api/production/:id
PATCH /api/production/:id/status

// 🔒 删除 - 仅 Administrator
DELETE /api/production/:id
```

### 工单管理 API

```javascript
// ✅ 创建 - Admin, After-sales Engineer, Sales Engineer, Technical Engineer
POST /api/tickets

// ✅ 更新 - Admin, After-sales Engineer, Technical Engineer
PUT   /api/tickets/:id
PATCH /api/tickets/:id/status

// ✅ 分配 - Admin, After-sales Engineer, Sales Manager
POST /api/tickets/:id/assign

// 🔒 删除 - 仅 Administrator
DELETE /api/tickets/:id
```

---

## 🎯 使用示例

### 前端权限检查

#### 1. 使用 useAuth Hook

```javascript
import { useAuth } from '../hooks/useAuth'

const MyComponent = () => {
  const { user, hasAnyRole, isAdmin } = useAuth()
  
  // 检查角色
  const canEdit = hasAnyRole(['Administrator', 'Sales Manager'])
  
  // 检查是否为管理员
  if (isAdmin()) {
    // 管理员专属功能
  }
  
  return (
    <div>
      {canEdit && <Button>编辑</Button>}
    </div>
  )
}
```

#### 2. 使用 RoleBasedAccess 组件

```javascript
import RoleBasedAccess from '../components/RoleBasedAccess'

<RoleBasedAccess allowedRoles={['Administrator', 'Sales Manager']}>
  <Button type="danger">删除</Button>
</RoleBasedAccess>
```

#### 3. 条件渲染

```javascript
{canEdit && (
  <Button>编辑</Button>
)}

{user?.role === 'After-sales Engineer' && isAssignedEngineer && (
  <Button>更新状态</Button>
)}
```

### 后端路由权限

```javascript
const { protect, authorize } = require('../middleware/auth')

// 单角色授权
router.delete('/:id', protect, authorize('Administrator'), deleteItem)

// 多角色授权
router.post('/', protect, authorize('Administrator', 'Sales Manager'), createItem)
```

---

## 📝 测试清单

### 生产排期页面测试

- [ ] Administrator 登录 → 看到完整功能
- [ ] Production Planner 登录 → 看到完整功能
- [ ] Sales Manager 登录 → 看到只读模式提示
- [ ] Technical Engineer 登录 → 看到 403 页面

### 售后服务测试

- [ ] After-sales Engineer 登录 → 默认显示"我的工单"
- [ ] 点击切换按钮 → 显示"所有工单"
- [ ] Administrator 点击删除 → 成功删除
- [ ] Sales Engineer 点击删除 → 按钮不存在

### 工单详情测试

- [ ] After-sales Engineer 访问自己的工单 → 看到所有按钮
- [ ] After-sales Engineer 访问别人的工单 → 看到警告提示
- [ ] Sales Manager 登录 → 看到"分配工程师"按钮
- [ ] Technical Engineer 登录 → 无"分配工程师"按钮

### 供应商管理测试

- [ ] Administrator 登录 → 看到完整页面
- [ ] Procurement Specialist 登录 → 看到完整页面
- [ ] Sales Manager 登录 → 看到 403 页面

### API 测试

使用以下命令测试 API 权限：

```bash
# 测试供应商删除 (仅 Admin)
curl -X DELETE http://localhost:5000/api/suppliers/:id \
  -H "Authorization: Bearer {admin_token}"

# 测试生产状态更新 (Admin + Planner)
curl -X PATCH http://localhost:5000/api/production/:id/status \
  -H "Authorization: Bearer {planner_token}" \
  -d '{"status": "In Production"}'

# 测试工单分配 (Admin + Sales Manager)
curl -X POST http://localhost:5000/api/tickets/:id/assign \
  -H "Authorization: Bearer {sales_manager_token}" \
  -d '{"engineerId": "xxx"}'
```

---

## 🐛 常见问题

### Q1: 售后工程师看不到自己的工单？
**A**: 检查用户对象的 `_id` 或 `id` 字段是否与工单的 `assignedEngineer` 匹配。

### Q2: 权限检查失效？
**A**: 确保已登录并且 token 有效。清除浏览器缓存并重新登录。

### Q3: API 返回 403 错误？
**A**: 检查后端路由是否添加了 `authorize` 中间件，以及传入的角色名称是否正确。

### Q4: 切换用户后权限没更新？
**A**: 刷新页面或重新登录，确保 `useAuthStore` 中的用户信息已更新。

---

## 📚 相关文档

- **完整报告**: `权限控制实施完成报告.md`
- **useAuth Hook**: `frontend/src/hooks/useAuth.js`
- **RoleBasedAccess**: `frontend/src/components/RoleBasedAccess.jsx`
- **后端中间件**: `backend/middleware/auth.js`

---

**最后更新**: 2025-10-28

