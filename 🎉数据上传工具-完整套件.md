# 🎉 数据上传工具 - 完整套件

## 📦 已创建的工具

### 1️⃣ 数据导出（已完成）✅

**导出位置**: `local_data_export_20251107_153153/`

**导出数据**:
- ✅ 执行器: 338个
- ✅ 手动覆盖规则: 18个
- ✅ 配件: 10个
- ✅ 供应商: 5个
- ✅ 用户: 10个
- ✅ 项目: 4个

---

### 2️⃣ 检查生产环境工具 🔍

**文件**: `check-production-data.js`

**用途**: 在上传前查看生产环境的数据状态

**使用方法**:
```bash
node check-production-data.js
```

**功能**:
- ✅ 显示所有集合的文档数量
- ✅ 分析执行器、用户、项目等核心数据
- ✅ 提供上传建议
- ✅ 检查数据库连接

---

### 3️⃣ 安全上传工具（Shell版）⚡

**文件**: `upload-data-safe.sh`

**用途**: 安全地上传数据到生产环境（推荐）

**使用方法**:
```bash
./upload-data-safe.sh
```

**特点**:
- ✅ 提供两种模式：安全模式 vs 覆盖模式
- ✅ 多次确认保护
- ✅ 使用 mongorestore 工具
- ✅ 只上传核心数据集合
- ✅ 快速高效

**上传的集合**:
- actuators (执行器)
- manualoverrides (手动覆盖规则)
- accessories (配件)
- suppliers (供应商)

---

### 4️⃣ 精细上传工具（Node.js版）🔧

**文件**: `upload-to-production.js`

**用途**: 逐个文档检查和上传，更精细的控制

**使用方法**:
```bash
node upload-to-production.js
```

**特点**:
- ✅ 逐个文档处理
- ✅ 自动跳过重复数据（基于 _id）
- ✅ 显示详细的上传统计
- ✅ 上传前后数据对比
- ✅ 更好的错误处理

---

### 5️⃣ 使用文档 📖

#### 详细指南
**文件**: `📖上传数据到生产环境-完整指南.md`
- 完整的步骤说明
- 安全措施详解
- 常见问题解答
- 验证和回滚方法

#### 快速参考
**文件**: `⚡快速上传数据到生产环境.md`
- 3步完成上传
- 快速参考卡
- 预计用时：5分钟

---

## 🚀 推荐使用流程

### 步骤 1: 检查生产环境（可选但推荐）

```bash
node check-production-data.js
```

**目的**: 
- 了解生产环境当前的数据状态
- 确定需要上传哪些数据
- 避免覆盖重要数据

---

### 步骤 2: 获取生产环境 MongoDB URI

**方法 A**: 从 Render
1. https://dashboard.render.com
2. 选择后端服务
3. Environment → MONGODB_URI

**方法 B**: 从 MongoDB Atlas
1. https://cloud.mongodb.com
2. Connect → Connect your application
3. 复制连接字符串

---

### 步骤 3: 执行上传

**快速方式**（推荐新手）:
```bash
./upload-data-safe.sh
```

**精细方式**（需要更多控制）:
```bash
node upload-to-production.js
```

---

### 步骤 4: 验证结果

1. **登录生产环境**
   - 访问前端URL
   - 使用管理员账号登录

2. **检查数据**
   - 数据管理 → 执行器管理
   - 验证执行器数量和数据

3. **测试功能**
   - 创建测试项目
   - 运行选型功能
   - 确认一切正常

---

## 🛡️ 安全保证

### ✅ 内置保护

1. **多次确认**: 需要明确输入 YES/UPLOAD 才执行
2. **安全模式**: 默认不覆盖已存在数据
3. **选择性上传**: 不上传敏感数据（用户密码、tokens等）
4. **错误处理**: 遇到错误会跳过并继续
5. **数据统计**: 显示上传前后对比

### ⚠️ 注意事项

1. **建议先检查**: 使用 `check-production-data.js` 查看生产环境
2. **建议先备份**: 在生产环境先备份数据
3. **选择安全模式**: 除非明确需要，否则不要选择覆盖模式
4. **错峰上传**: 选择业务低峰期进行上传
5. **先测试后正式**: 如果有测试环境，先在测试环境验证

---

## 📊 数据映射

### 本地 → 生产环境

| 数据类型 | 本地数量 | 操作 | 说明 |
|---------|---------|------|------|
| 执行器 | 338个 | ✅ 上传 | 核心数据，必须上传 |
| 手动覆盖规则 | 18个 | ✅ 上传 | 选型规则，必须上传 |
| 配件 | 10个 | ✅ 上传 | 配件数据 |
| 供应商 | 5个 | ✅ 上传 | 供应商信息 |
| 用户 | 10个 | ⏭️ 跳过 | 避免覆盖生产用户 |
| 项目 | 4个 | ⏭️ 跳过 | 避免覆盖真实项目 |
| Tokens | 102个 | ⏭️ 跳过 | 临时令牌，无需上传 |

---

## 🔧 故障排除

### 问题 1: 连接超时

**症状**: `ETIMEDOUT` 或 `ENOTFOUND`

**解决**:
- 检查网络连接
- 确认 MongoDB URI 正确
- 确认 IP 白名单设置（MongoDB Atlas）

### 问题 2: 认证失败

**症状**: `Authentication failed`

**解决**:
- 检查用户名和密码
- 确认数据库用户权限
- 检查 authSource 参数

### 问题 3: 部分数据上传失败

**症状**: 某些文档跳过或失败

**解决**:
- 查看具体错误信息
- 可能是数据格式问题
- 可能是唯一索引冲突

### 问题 4: 上传很慢

**症状**: 上传时间超过预期

**解决**:
- 检查网络速度
- MongoDB 服务器可能在处理其他任务
- 考虑分批上传

---

## 📈 性能参考

| 操作 | 预计用时 |
|------|---------|
| 检查生产环境 | 10-30秒 |
| 上传执行器(338个) | 1-2分钟 |
| 上传其他数据 | 30秒 |
| **总计** | **2-3分钟** |

---

## 📞 需要帮助？

### 上传前检查清单

- [ ] 已导出本地数据
- [ ] 已获取生产环境 MongoDB URI
- [ ] 已检查生产环境数据状态
- [ ] 已备份生产环境（推荐）
- [ ] 了解将要上传的数据
- [ ] 选择了合适的上传模式

### 上传后验证清单

- [ ] 执行器数量正确
- [ ] 选型功能正常
- [ ] 供应商数据完整
- [ ] 配件数据可用
- [ ] 没有数据丢失
- [ ] 没有重复数据

---

## 🎯 快速命令参考

```bash
# 1. 检查生产环境
node check-production-data.js

# 2. 上传数据（Shell方式）
./upload-data-safe.sh

# 3. 上传数据（Node.js方式）
node upload-to-production.js

# 4. 查看导出的数据
ls -lh local_data_export_20251107_153153/cmax/

# 5. 重新导出数据（如果需要）
mongodump --uri="mongodb://localhost:27017/cmax" --out=./new_export
```

---

## 🌟 最佳实践

1. **先检查再上传**: 使用 check-production-data.js
2. **使用安全模式**: 避免数据丢失
3. **错峰操作**: 业务低峰期上传
4. **分步验证**: 上传后立即验证
5. **保留备份**: 保留本地导出文件

---

## ✅ 完成标志

数据上传成功后，您将拥有：

- ✅ 338个执行器的完整数据
- ✅ 18个智能选型规则
- ✅ 完整的供应商和配件数据
- ✅ 保留的生产环境真实数据
- ✅ 可正常工作的选型系统

**恭喜！生产环境现在已经准备好使用了！** 🎉

