# 质检模块 - 完整实现文档 (v1.0)

## 📋 目录

1. [模块概述](#模块概述)
2. [核心功能](#核心功能)
3. [数据模型](#数据模型)
4. [工作流程](#工作流程)
5. [API 接口](#api-接口)
6. [前端页面](#前端页面)
7. [初始化设置](#初始化设置)
8. [使用指南](#使用指南)
9. [角色权限](#角色权限)

---

## 模块概述

质检模块是一个数字化的质量管理系统，覆盖了从来料检验(IQC)到成品检验(FQC)的全流程质量控制。系统实现了检验任务的自动触发、标准化执行和数据的永久追溯。

### 设计理念

- **被动触发**: 质检员不主动发起工作，而是响应由采购到货或生产完成自动触发的检验任务
- **标准化执行**: 基于检验模板，确保每次检验都遵循统一的标准
- **数据追溯**: 完整记录检验过程和结果，支持质量追溯和分析
- **自动联动**: 检验结果自动更新源单据状态，触发下游流程

---

## 核心功能

### 1. 检验类型

- **IQC (Incoming Quality Control)**: 来料检验
- **IPQC (In-Process Quality Control)**: 过程检验
- **FQC (Final Quality Control)**: 成品检验
- **OQC (Outgoing Quality Control)**: 出货检验

### 2. 自动化工作流

#### 来料检验 (IQC) 流程
```
采购专员确认收货
    ↓
系统自动创建IQC检验任务
    ↓
质检员执行检验
    ↓
判定结果：合格 → 更新库存状态为"可用"
判定结果：不合格 → 冻结库存 + 通知采购员
```

#### 成品检验 (FQC) 流程
```
生产完成
    ↓
系统自动创建FQC检验任务
    ↓
质检员执行检验
    ↓
判定结果：合格 → 通知物流专员准备发货
判定结果：不合格 → 通知生产计划员返工/报废
```

### 3. 检验模板管理

- 支持按产品系列和检验类型定义检验项目
- 预置多种标准模板（AT、GT、PSQ系列等）
- 管理员可自定义和维护模板

---

## 数据模型

### QualityCheck (质检任务)

```javascript
{
  checkNumber: String,              // 质检单号 (QC-YYYYMM-XXXX)
  checkType: String,                // 检验类型 (IQC/IPQC/FQC/OQC)
  sourceDocument: {                 // 来源单据
    id: ObjectId,
    type: String,                   // PurchaseOrder/ProductionOrder
    number: String
  },
  itemsToCheck: [{                  // 待检物料/产品
    item: ObjectId,
    itemType: String,               // Actuator/Accessory
    model: String,
    quantity: Number
  }],
  status: String,                   // Pending/In Progress/Completed
  inspector: ObjectId,              // 检验员
  checkList: [{                     // 检验项目清单
    itemName: String,
    standard: String,
    result: String,                 // Pass/Fail/N/A
    notes: String
  }],
  overallResult: String,            // Pass/Fail
  defectCount: Number,              // 缺陷数量
  images: [String],                 // 现场照片URL
  reportUrl: String,                // 检验报告URL
  completedAt: Date
}
```

### ChecklistTemplate (检验模板)

```javascript
{
  name: String,                     // 模板名称
  productSeries: String,            // 产品系列 (AT/GT/PSQ/ALL)
  checkType: String,                // 检验类型
  items: [{                         // 检验项
    itemName: String,
    standard: String,
    displayOrder: Number
  }],
  isActive: Boolean
}
```

---

## 工作流程

### 质检员日常工作流程

#### 1. 登录系统
- 访问: `/quality/dashboard`
- 系统自动显示所有待检任务

#### 2. 开始检验
- 在"待处理任务"列表中点击"开始检验"
- 系统自动：
  - 更新任务状态为"进行中"
  - 记录检验员信息
  - 加载对应的检验模板

#### 3. 执行检验
- 逐项进行检验，选择结果：合格/不合格/N/A
- 填写备注说明
- 上传现场照片
- 填写综合结论

#### 4. 提交结果
- 点击"判定合格"或"判定不合格"
- 系统自动：
  - 保存检验数据
  - 更新源单据状态
  - 触发下游流程
  - 发送相关通知

---

## API 接口

### 质检任务相关

#### 获取质检任务列表
```http
GET /api/quality-checks?status=Pending&checkType=IQC
Authorization: Bearer {token}
```

#### 获取单个质检任务
```http
GET /api/quality-checks/:id
Authorization: Bearer {token}
```

#### 开始检验
```http
POST /api/quality-checks/:id/start
Authorization: Bearer {token}
```

#### 完成检验
```http
POST /api/quality-checks/:id/complete
Authorization: Bearer {token}
Content-Type: application/json

{
  "checkList": [...],
  "overallResult": "Pass",
  "images": [...],
  "notes": "..."
}
```

#### 获取质检统计
```http
GET /api/quality-checks/stats?startDate=2025-01-01&endDate=2025-12-31
Authorization: Bearer {token}
```

### 检验模板相关

#### 获取所有模板
```http
GET /api/quality-checks/templates?checkType=FQC
Authorization: Bearer {token}
```

#### 根据检验类型和产品系列获取模板
```http
GET /api/quality-checks/templates/:checkType/:productSeries
Authorization: Bearer {token}

示例: GET /api/quality-checks/templates/FQC/AT
```

#### 创建模板（管理员）
```http
POST /api/quality-checks/templates
Authorization: Bearer {token}
Content-Type: application/json

{
  "name": "FQC - AT系列执行器",
  "productSeries": "AT",
  "checkType": "FQC",
  "items": [...]
}
```

#### 更新模板（管理员）
```http
PUT /api/quality-checks/templates/:id
Authorization: Bearer {token}
Content-Type: application/json

{
  "items": [...]
}
```

---

## 前端页面

### 1. 质检员工作台 (`/quality/dashboard`)

#### 功能特点
- **双标签页布局**: 待处理任务 / 已完成任务
- **统计卡片**: 各类型检验的数量和合格率
- **智能筛选**: 按检验类型、状态、关键词搜索
- **快速操作**: 一键开始检验

#### 页面组件
- 统计卡片区域
- 筛选器
- 任务列表表格
- 刷新按钮

### 2. 检验执行页面 (`/quality/inspect/:id`)

#### 功能特点
- **基础信息展示**: 检验单号、类型、来源、数量
- **检验进度追踪**: 实时显示已完成/待完成项目
- **标准化检验表单**: 自动加载检验模板
- **照片上传**: 支持多张现场照片
- **双重确认**: 最终判定需二次确认

#### 页面布局
```
┌─────────────────────────────────────┐
│  基础信息卡片组 (4列)                │
├─────────────────────────────────────┤
│  待检产品信息表格                    │
├─────────────────────────────────────┤
│  检验进度统计 (进行中任务才显示)    │
├─────────────────────────────────────┤
│  检验项目清单表格                    │
│  ├─ 序号                             │
│  ├─ 检验项目                         │
│  ├─ 检验标准                         │
│  ├─ 检验结果 (Pass/Fail/N/A 单选)   │
│  └─ 备注                             │
├─────────────────────────────────────┤
│  现场照片 (上传/预览)                │
├─────────────────────────────────────┤
│  综合结论 (文本框)                   │
├─────────────────────────────────────┤
│  最终判定按钮                        │
│  [判定合格] [判定不合格]             │
└─────────────────────────────────────┘
```

---

## 初始化设置

### 1. 安装依赖
```bash
# 后端依赖已包含在项目中
cd backend
npm install
```

### 2. 初始化检验模板
```bash
# 运行模板初始化脚本
node backend/scripts/initQualityTemplates.js
```

该脚本会创建以下模板：
- IQC 通用来料检验模板
- IQC 执行器主机检验模板
- FQC AT系列成品检验模板
- FQC GT系列成品检验模板
- FQC PSQ系列成品检验模板
- IPQC 装配过程检验模板
- OQC 出货检验模板

### 3. 创建质检员账户
```bash
# 使用管理员账户登录系统
# 在"用户管理"中创建角色为"QA"的用户
```

### 4. 启动服务
```bash
# 启动后端
cd backend
npm start

# 启动前端
cd frontend
npm run dev
```

---

## 使用指南

### 采购专员操作指南

#### 确认收货时自动创建IQC任务
```javascript
// 前端调用
POST /api/purchase-orders/:id/receive
{
  "received_items": [
    {
      "item_id": "...",
      "item_name": "执行器主机",
      "received_quantity": 10
    }
  ],
  "warehouse_location": "A区-01架",
  "notes": "已收货"
}

// 系统自动：
// 1. 更新采购订单状态为"已收货"
// 2. 自动创建IQC检验任务
// 3. 通知质检员有新任务
```

### 生产计划员操作指南

#### 生产完成时自动创建FQC任务
```javascript
// 前端调用
POST /api/production/:id/mark-awaiting-qc
{
  "notes": "生产完成，待质检"
}

// 系统自动：
// 1. 更新生产订单状态为"Awaiting QC"
// 2. 自动创建FQC检验任务
// 3. 通知质检员有新任务
```

### 质检员操作指南

#### 每日工作流程
1. **登录系统**
   - 访问 `/quality/dashboard`
   
2. **查看待检任务**
   - 在"待处理任务"标签页查看所有待检项目
   - 可按类型筛选：IQC、FQC等
   
3. **开始检验**
   - 点击"开始检验"按钮
   - 系统跳转到检验执行页面
   
4. **执行检验**
   - 逐项检查，选择结果
   - 对不合格项填写详细备注
   - 上传现场照片
   
5. **提交结果**
   - 所有项目完成后，填写综合结论
   - 点击"判定合格"或"判定不合格"
   - 确认提交
   
6. **查看历史**
   - 在"已完成任务"标签页查看历史记录

---

## 角色权限

### QA (质检员)
- ✅ 查看所有质检任务
- ✅ 开始检验
- ✅ 完成检验
- ✅ 上传照片和报告
- ✅ 查看统计数据
- ❌ 修改检验模板

### Administrator (管理员)
- ✅ 所有质检员权限
- ✅ 创建/修改/删除检验模板
- ✅ 查看所有统计和报告
- ✅ 管理质检员账户

### 其他角色
- **采购专员**: 触发IQC任务创建，接收IQC结果通知
- **生产计划员**: 触发FQC任务创建，接收FQC结果通知
- **物流专员**: 接收FQC合格通知

---

## 技术实现细节

### 后端实现

#### 1. 模型定义
- `backend/models/QualityCheck.js`: 质检任务模型
- `backend/models/ChecklistTemplate.js`: 检验模板模型

#### 2. 控制器
- `backend/controllers/qualityCheckController.js`: 质检业务逻辑

#### 3. 路由
- `backend/routes/qualityCheckRoutes.js`: API路由定义

#### 4. 集成点
- `backend/controllers/purchaseOrderController.js`: 采购收货时创建IQC
- `backend/controllers/productionController.js`: 生产完成时创建FQC

### 前端实现

#### 1. 页面组件
- `frontend/src/pages/quality/QualityInspectorDashboard.jsx`: 工作台
- `frontend/src/pages/quality/QualityInspectionPage.jsx`: 检验执行页

#### 2. 路由配置
- `frontend/src/App.jsx`: 添加质检路由

#### 3. UI组件库
- Material-UI: 提供丰富的UI组件

---

## 常见问题

### Q1: 如何添加新的检验模板？
**A**: 管理员可以通过以下方式添加：
1. 直接在数据库中添加
2. 调用API: `POST /api/quality-checks/templates`
3. 修改 `backend/scripts/initQualityTemplates.js` 并重新运行

### Q2: 检验任务没有自动创建？
**A**: 检查以下几点：
1. 确认采购订单状态是否为"已发货"
2. 确认生产订单状态是否为"Completed"
3. 查看后端日志是否有错误信息
4. 确认 qualityCheckController 已正确导入

### Q3: 如何修改检验标准？
**A**: 
1. 管理员登录系统
2. 调用模板更新API
3. 现有未完成的检验任务不受影响，只影响新创建的任务

### Q4: 检验结果能否修改？
**A**: 
- 已完成的检验任务结果不可修改（保证数据完整性）
- 如需修改，需要管理员权限，并记录修改日志

---

## 未来扩展

### 计划中的功能
- [ ] 检验结果统计分析dashboard
- [ ] 不合格品处理流程（NCR）
- [ ] 供应商质量评级
- [ ] 检验报告自动生成（PDF）
- [ ] 移动端检验APP
- [ ] 检验数据导出（Excel）
- [ ] 质量趋势分析图表

---

## 总结

质检模块实现了完整的数字化质量管理流程，主要特点：

✅ **自动化**: 检验任务自动触发，无需人工创建  
✅ **标准化**: 基于模板的检验流程，确保一致性  
✅ **可追溯**: 完整记录检验过程和结果  
✅ **集成性**: 与采购、生产系统无缝集成  
✅ **易用性**: 简洁直观的用户界面  

---

## 联系方式

如有问题或建议，请联系开发团队。

**文档版本**: v1.0  
**最后更新**: 2025-10-31  
**作者**: Project Ark 开发团队

