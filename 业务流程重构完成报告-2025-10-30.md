# 业务流程重构完成报告

> 更新时间：2025年10月30日  
> 版本：v2.0  
> 状态：进行中

---

## 📋 修改概述

根据用户需求，对整个业务流程进行了重新梳理和系统化调整，明确了各角色的职责边界和工作流程。

### 核心修改原则

1. **询价≠赢单**：明确区分询价阶段和赢单阶段
   - 询价阶段：商务报价完成，销售可下载报价单（未签约）
   - 赢单阶段：客户盖章完成，合同正式签订才算赢单

2. **技术不涉价**：技术工程师完全不接触价格
   - 不能查看报价单
   - 不能访问产品数据库（含价格）
   - 工作到技术选型提交为止

3. **预付款启动生产**：预付款未到账不能生产
   - 合同签订后等待预付款
   - 预付款到账后商务确认
   - 确认后通知生产部门开始排期

4. **BOM拆分流程**：生产员区分有料和缺料
   - 有料部分：通知车间加工生产
   - 缺料部分：通知采购，到货后再生产

---

## ✅ 已完成修改

### 1. 数据模型更新

#### `/backend/models/Project.js`

**状态枚举重构**
```javascript
// 旧状态（已废弃）
'待指派技术', '选型中', '待商务报价', '已报价', '赢单', '失单'

// 新状态（已实施）
enum: [
  // 1. 销售阶段
  '待指派技术',          // 销售创建项目，等待指派技术工程师
  '选型中',              // 技术工程师正在进行技术选型
  '待商务报价',          // 技术选型完成，等待商务报价
  '已报价-询价中',       // 商务报价完成，销售可下载报价单（未签约）⭐
  '失单',                // 客户未接受报价，项目结束
  
  // 2. 合同阶段
  '待上传合同',          // 客户接受报价，销售需上传销售合同
  '待商务审核合同',      // 销售已上传合同，等待商务审核盖章
  '待客户盖章',          // 商务盖章完成，等待客户盖章
  '合同已签订-赢单',     // 客户盖章完成，正式赢单⭐
  
  // 3. 生产阶段
  '待预付款',            // 等待客户支付预付款
  '生产准备中',          // 预付款到账，生产员准备BOM和排期⭐
  '采购中',              // 缺料部分正在采购⭐
  '生产中',              // 工厂正在生产
  
  // 4. 完成阶段
  '已完成',              // 项目完成
  
  // 兼容旧状态
  '赢单', 'Won', ...
]
```

### 2. 前端Dashboard更新

#### `/frontend/src/pages/Dashboard.jsx`

**销售经理Dashboard** ✅
```javascript
// 统计卡片
1. 待指派技术 - 需指派技术工程师
2. 询价中项目 - 可下载报价单给客户（未签约）⭐
3. 已赢单项目 - 合同已签订⭐
4. 全部项目

// 使用指南
1. 创建项目并指派 - 拿到客户技术文件或需求后创建
2. 询价阶段 - 下载报价单给客户，尚未签约⭐
3. 赢单阶段 - 上传合同，客户盖章后正式赢单⭐
4. 跟进生产 - 跟进预付款到账
```

**技术工程师Dashboard** ✅
```javascript
// 使用指南
1. 接收选型任务 - 销售指派后查看技术文件
2. 技术选型 - 选择执行器型号和配件
3. 提交给商务 - 工作到此结束，不涉及后续⭐
```

**商务专员Dashboard** ✅
```javascript
// 使用指南
1. 商务报价 - 设置价格策略，完成报价⭐
2. 审核合同 - 审核销售上传的合同⭐
3. 上传盖章合同 - 公司盖章后上传给销售⭐
4. 催收预付款 - 跟进预付款到账，到账后通知生产⭐
```

**生产员Dashboard** ✅
```javascript
// 使用指南
1. 接收生产订单 - 预付款到账后接收⭐
2. 拆分BOM表 - 检查库存，区分有料和缺料⭐
3. 安排生产采购 - 有料通知车间，缺料通知采购⭐
4. 跟进生产进度 - 跟踪生产和采购到货⭐
```

### 3. 菜单权限优化

#### `/frontend/src/components/Layout/AttioLayout.jsx`

**权限调整** ✅
```javascript
// 技术工程师：移除产品数据库访问权限
{
  key: '/products',
  label: '产品数据库',
  roles: ['Sales Engineer', 'Procurement Specialist', 'Production Planner', 'After-sales Engineer'],
  // ❌ 不包含 'Technical Engineer' - 避免看到价格⭐
}
```

### 4. 文档创建

**新增文档** ✅
1. `业务流程说明-2025-10-30.md` - 完整业务流程说明
2. `角色权限功能清单-2025-10-30.md` - 各角色权限详细说明

---

## 🔄 待完成修改

### 1. 项目详情页面（高优先级）

#### `/frontend/src/pages/ProjectDetails.jsx`

**需要修改的部分：**

**A. renderWorkflowButtons函数** ⚠️ 待修改
```javascript
// 当前问题：
// 1. 使用旧状态（Won, Pending Approval, Approved, Quoted等）
// 2. 销售经理可手动"标记为赢单" - 违反新流程
// 3. 缺少新状态的按钮（待上传合同、待客户盖章等）

// 需要按新流程重写：
const renderWorkflowButtons = () => {
  // 根据项目状态和用户角色显示对应按钮
  
  // 状态：待指派技术
  if (project.status === '待指派技术' && ['Sales Manager', 'Sales Engineer'].includes(user?.role)) {
    // 显示：指派技术工程师
  }
  
  // 状态：选型中
  if (project.status === '选型中' && user?.role === 'Technical Engineer') {
    // 显示：提交技术选型
  }
  
  // 状态：待商务报价
  if (project.status === '待商务报价' && user?.role === 'Sales Engineer') {
    // 显示：完成报价
  }
  
  // 状态：已报价-询价中
  if (project.status === '已报价-询价中' && user?.role === 'Sales Manager') {
    // 显示：下载报价单、客户接受-上传合同
  }
  
  // 状态：待商务审核合同
  if (project.status === '待商务审核合同' && user?.role === 'Sales Engineer') {
    // 显示：审核并上传盖章合同
  }
  
  // 状态：待客户盖章
  if (project.status === '待客户盖章' && user?.role === 'Sales Manager') {
    // 显示：下载盖章合同、上传客户盖章合同
  }
  
  // 状态：合同已签订-赢单 / 待预付款
  if (['合同已签订-赢单', '待预付款'].includes(project.status) && user?.role === 'Sales Engineer') {
    // 显示：确认预付款到账
  }
  
  // 状态：生产准备中/采购中/生产中
  if (['生产准备中', '采购中', '生产中'].includes(project.status) && user?.role === 'Production Planner') {
    // 显示：生产管理按钮
  }
}
```

**B. 权限控制** ⚠️ 待检查
```javascript
// 需要检查的权限：
const canEditTechnical = ... // 技术选型编辑权限
const canSeeCost = ...       // 成本价查看权限
const canEdit = ...          // 项目编辑权限

// 确保：
// ✅ 技术工程师不能查看价格
// ✅ 销售经理不能修改技术选型
// ✅ 销售经理不能修改报价
```

**C. Tab显示控制** ⚠️ 待检查
```javascript
// 需要根据角色和状态控制Tab显示：
// - 技术清单Tab：技术工程师可编辑，其他角色只读
// - 报价工作台Tab：商务可编辑，销售只读
// - 合同管理Tab：根据状态显示不同操作
```

### 2. 后端API更新（高优先级）

#### `/backend/controllers/projectController.js`

**需要添加的API：** ⚠️ 待实现
```javascript
// 1. 提交技术选型
POST /api/projects/:id/submit-technical
// 状态：选型中 → 待商务报价

// 2. 完成商务报价
POST /api/projects/:id/complete-quotation
// 状态：待商务报价 → 已报价-询价中

// 3. 客户接受报价（销售操作）
POST /api/projects/:id/client-accept-quotation
// 状态：已报价-询价中 → 待上传合同

// 4. 上传销售合同
POST /api/projects/:id/upload-draft-contract
// 状态：待上传合同 → 待商务审核合同

// 5. 商务审核并上传盖章合同
POST /api/projects/:id/upload-sealed-contract
// 状态：待商务审核合同 → 待客户盖章

// 6. 上传客户盖章合同（最终合同）
POST /api/projects/:id/upload-final-contract
// 状态：待客户盖章 → 合同已签订-赢单

// 7. 确认预付款到账
POST /api/projects/:id/confirm-prepayment
// 状态：待预付款 → 生产准备中

// 8. 标记失单
POST /api/projects/:id/mark-lost
// 状态：已报价-询价中 → 失单
```

**状态流转控制：** ⚠️ 待实现
```javascript
// 确保只有特定角色可以执行特定状态变更
// 例如：
// - 只有技术工程师可以提交技术选型
// - 只有商务专员可以完成报价
// - 只有商务专员可以确认预付款
```

### 3. 合同管理优化（中优先级）

#### 合同文件上传流程

**当前状态：** ⚠️ 需优化
```javascript
// 已有的合同字段：
contract_files: {
  draft_contract,          // 草签合同（销售上传）
  company_sealed_contract, // 公司盖章合同（商务上传）
  final_contract           // 最终合同（销售上传客户盖章版）
}

// 需要优化：
// 1. 明确每个阶段允许上传的合同类型
// 2. 添加合同上传后自动状态流转
// 3. 添加合同下载日志记录
```

### 4. 订单管理优化（中优先级）

#### 生产订单创建

**需要修改：** ⚠️ 待实现
```javascript
// 当前：销售经理可以创建订单
// 问题：违反新流程（商务确认预付款后才能创建）

// 修改为：
// 1. 只有商务专员可以创建生产订单
// 2. 必须在预付款到账并确认后才能创建
// 3. 创建订单后自动变更状态为"生产准备中"
```

### 5. 生产管理增强（低优先级）

#### BOM拆分和采购流程

**需要添加：** ⚠️ 待规划
```javascript
// 1. BOM拆分界面
// - 查看技术清单
// - 拆分为零部件
// - 标记有料/缺料

// 2. 生产工单
// - 有料部分创建生产工单
// - 分配车间和工期

// 3. 采购申请
// - 缺料部分创建采购申请
// - 通知采购部门
// - 跟踪到货状态
```

---

## 📊 状态对照表

### 旧状态 → 新状态映射

| 旧状态 | 新状态 | 说明 |
|--------|--------|------|
| 待指派技术 | 待指派技术 | 保持不变 |
| 选型中/选型进行中 | 选型中 | 统一名称 |
| 待商务报价 | 待商务报价 | 保持不变 |
| 已报价/Quoted | 已报价-询价中 | ⚠️ 强调"询价"阶段 |
| - | 待上传合同 | ✅ 新增 |
| Pending Contract Review | 待商务审核合同 | 改名 |
| Pending Client Signature | 待客户盖章 | 改名 |
| Won/赢单 | 合同已签订-赢单 | ⚠️ 强调"合同签订" |
| - | 待预付款 | ✅ 新增 |
| - | 生产准备中 | ✅ 新增 |
| - | 采购中 | ✅ 新增 |
| In Production | 生产中 | 改名 |
| Completed | 已完成 | 改名 |
| Lost/失单 | 失单 | 保持不变 |

---

## 🎯 实施计划

### 第一阶段：核心流程（高优先级）✅ 已完成

- [x] 更新Project模型状态枚举
- [x] 更新各角色Dashboard
- [x] 更新菜单权限
- [x] 创建业务流程文档

### 第二阶段：项目详情页面（当前进行中）⚠️

- [ ] 重写renderWorkflowButtons函数
- [ ] 更新权限控制逻辑
- [ ] 测试各状态的按钮显示
- [ ] 测试各角色的操作权限

### 第三阶段：后端API（待开始）⏳

- [ ] 实现状态流转API
- [ ] 添加权限校验
- [ ] 测试状态流转逻辑
- [ ] 测试权限控制

### 第四阶段：测试和优化（待开始）⏳

- [ ] 完整业务流程测试
- [ ] 角色权限测试
- [ ] 性能优化
- [ ] 用户体验优化

---

## 📝 注意事项

### 关键修改点

1. **"询价"与"赢单"的明确区分** ⚠️ 重要
   - 不能再手动标记赢单
   - 必须走完整合同流程
   - 客户盖章后自动变为赢单

2. **技术工程师权限严格控制** ⚠️ 重要
   - 完全隔离价格信息
   - 工作边界清晰（选型提交后结束）
   - 不参与后续商务和生产环节

3. **预付款作为生产启动条件** ⚠️ 重要
   - 预付款未到账不能生产
   - 商务确认后通知生产
   - 避免资金风险

4. **BOM拆分流程明确** ⚠️ 重要
   - 生产员负责拆分
   - 区分有料和缺料
   - 协调生产和采购

### 兼容性考虑

为保证系统向后兼容，旧状态仍在enum中保留：
```javascript
'赢单', 'Won', 'Pending Contract Review', 
'Pending Client Signature', 'Contract Signed', 'In Production'
```

但新创建的项目应使用新状态，前端显示时可统一映射。

---

## 📞 后续支持

### 文档资源

1. **业务流程说明**：`业务流程说明-2025-10-30.md`
2. **角色权限清单**：`角色权限功能清单-2025-10-30.md`
3. **本报告**：`业务流程重构完成报告-2025-10-30.md`

### 待解决问题

1. 项目详情页面的renderWorkflowButtons函数重写
2. 后端状态流转API实现
3. 合同上传流程优化
4. 生产BOM拆分界面设计

---

**报告版本**：v1.0  
**创建日期**：2025年10月30日  
**状态**：进行中  
**下一步**：修改项目详情页面的工作流按钮  
**维护团队**：智能制造系统开发组

