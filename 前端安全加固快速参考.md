# 前端安全加固快速参考指南 ⚡

## 🎯 核心改进

### 1️⃣ Token 安全 - HttpOnly Cookie
**之前:** localStorage 存储（易被 XSS 窃取）  
**现在:** HttpOnly Cookie（JavaScript 无法访问）

### 2️⃣ XSS 防护
**检查结果:** ✅ 无 `dangerouslySetInnerHTML` 使用  
**防护状态:** React 默认转义生效

### 3️⃣ 权限验证
**前端:** UI 隐藏（用户体验）  
**后端:** protect + authorize 中间件（真正安全边界）

---

## 📦 部署前检查清单

### 后端
```bash
cd backend
npm install  # 安装 cookie-parser
```

**必需文件修改:**
- ✅ `package.json` - 添加 cookie-parser 依赖
- ✅ `server.js` - 添加 cookieParser() 中间件
- ✅ `controllers/authController.js` - 登录/注册/登出使用 Cookie
- ✅ `middleware/auth.js` - 从 Cookie 读取 token

### 前端
```bash
cd frontend
# 无需额外安装
```

**必需文件修改:**
- ✅ `services/api.js` - withCredentials: true
- ✅ `pages/Login.jsx` - 不再从响应获取 token
- ✅ `store/authStore.js` - login() 不要求 token 参数

---

## 🔍 测试验证 (5分钟)

### 1. 登录测试
```
1. 打开浏览器 DevTools
2. 登录系统
3. Application > Cookies > 查看 accessToken & refreshToken
4. 确认有 HttpOnly 标记 ✅
```

### 2. API 测试
```
1. Network > 查看任意 API 请求
2. Request Headers > Cookie 自动发送 ✅
3. 无 Authorization: Bearer <token> 头
```

### 3. 安全测试
```
1. Console 输入: document.cookie
2. 看不到 accessToken 和 refreshToken ✅
```

---

## 🚨 重要环境变量

```bash
# backend/.env
NODE_ENV=production  # 启用 secure cookie
FRONTEND_URL=https://your-domain.com
```

---

## 📞 问题排查

### 问题: 登录后 Cookie 未设置
**检查:**
- 后端是否安装了 `cookie-parser`
- `server.js` 是否添加了 `app.use(cookieParser())`
- CORS 是否设置了 `credentials: true`

### 问题: API 请求 401 错误
**检查:**
- 前端 axios 是否设置了 `withCredentials: true`
- 浏览器 Network 面板，Cookie 是否自动发送
- 后端中间件是否从 `req.cookies.accessToken` 读取

### 问题: 生产环境 Cookie 未传输
**检查:**
- 是否启用 HTTPS
- `NODE_ENV=production` 是否设置
- `secure: true` 需要 HTTPS

---

## 💡 核心代码片段

### 后端 - 设置 Cookie
```javascript
res.cookie('accessToken', token, {
  httpOnly: true,
  secure: process.env.NODE_ENV === 'production',
  sameSite: 'strict',
  maxAge: 8 * 60 * 60 * 1000
});
```

### 前端 - Axios 配置
```javascript
const api = axios.create({
  baseURL: API_URL,
  withCredentials: true  // ✅ 关键配置
})
```

### 前端 - 登录逻辑
```javascript
const user = response.data  // 不再包含 token
login(user, null)  // token 在 Cookie 中
```

---

## ✅ 安全检查通过标准

- [ ] Cookie 有 HttpOnly 标记
- [ ] Cookie 有 SameSite=Strict
- [ ] 生产环境 Cookie 有 Secure 标记
- [ ] Console 无法访问 token
- [ ] API 请求自动带 Cookie
- [ ] 登出清除 Cookie
- [ ] 低权限用户访问高权限 API 返回 403

---

**快速联系:** 如有疑问请查看《前端安全加固完成报告.md》完整文档

