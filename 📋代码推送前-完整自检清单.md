# 📋 代码推送前 - 完整自检清单

## 🎯 目的
在推送代码到 Git 之前，确保所有功能都能正确实现，数据库能够保存，避免推送不完整或有问题的代码。

---

## ✅ 自检流程（必须全部通过）

### 📦 第1步：数据库模型检查

#### 检查内容
- [ ] 数据库模型是否包含所有必需字段
- [ ] 字段类型是否正确（String, Number, Boolean, Date, etc.）
- [ ] 字段验证规则是否完整（required, min, max, enum, etc.）
- [ ] 默认值是否设置正确
- [ ] 索引是否正确创建（unique, index）

#### 检查文件
```bash
backend/models/*.js
```

#### 检查命令
```bash
# 查找模型定义
grep -n "type: String\|type: Number\|type: Boolean" backend/models/User.js
```

#### ✅ 验证标准
- 新增功能涉及的所有字段都已在模型中定义
- 字段名称与前端保持一致（避免 name vs full_name 这类问题）
- 字段约束合理（例如：maxlength, required）

---

### 🔌 第2步：后端API端点检查

#### 检查内容
- [ ] API 是否正确接收前端发送的所有字段
- [ ] API 是否正确返回前端需要的所有字段
- [ ] API 返回的字段名是否与模型一致
- [ ] 错误处理是否完整
- [ ] 权限验证是否正确（需要 auth middleware 的路由）

#### 检查文件
```bash
backend/controllers/*.js
backend/routes/*.js
```

#### 关键检查点

##### 2.1 创建/更新操作
```javascript
// ❌ 错误示例
if (req.body.name !== undefined) user.name = req.body.name;
// 但数据库字段是 full_name

// ✅ 正确示例
if (req.body.full_name !== undefined) user.full_name = req.body.full_name;
```

##### 2.2 返回数据
```javascript
// ❌ 错误示例 - 遗漏新字段
res.json({
  _id: user._id,
  full_name: user.full_name,
  role: user.role
  // 遗漏了 english_name 和 signature
});

// ✅ 正确示例 - 返回所有字段
res.json({
  _id: user._id,
  full_name: user.full_name,
  english_name: user.english_name,
  signature: user.signature,
  role: user.role,
  department: user.department,
  phone: user.phone,
  isActive: user.isActive
});
```

##### 2.3 特别关注的API端点
- `POST /api/auth/login` - 登录时必须返回所有用户字段
- `GET /api/auth/me` - 获取用户信息
- `PUT /api/auth/profile` - 更新用户信息
- 所有返回用户对象的API

#### ✅ 验证标准
- 前端发送的字段，后端能正确接收并保存
- 后端返回的数据，包含前端需要显示的所有字段
- 登录API返回完整的用户信息（这个最容易遗漏）

---

### 💻 第3步：前端数据发送检查

#### 检查内容
- [ ] 表单是否正确收集用户输入
- [ ] API 调用是否发送了所有必需字段
- [ ] 字段名是否与后端一致
- [ ] 数据格式是否正确（例如：字符串、数字、日期）

#### 检查文件
```bash
frontend/src/pages/*.jsx
frontend/src/components/**/*.jsx
```

#### 关键检查点

##### 3.1 表单提交
```javascript
// ✅ 检查表单字段与API调用的一致性
const handleUpdate = async (values) => {
  const response = await authAPI.updateProfile({
    full_name: values.full_name,      // ✅ 字段名正确
    english_name: values.english_name, // ✅ 字段名正确
    signature: values.signature        // ✅ 字段名正确
  })
}
```

##### 3.2 API 服务定义
```bash
# 检查 API 定义
cat frontend/src/services/api.js | grep -A 10 "updateProfile"
```

#### ✅ 验证标准
- 表单字段名与后端API参数名一致
- 所有必需字段都被发送
- 可选字段的处理逻辑正确

---

### 🔄 第4步：数据流完整性检查

#### 检查内容
- [ ] 登录 → 数据存储 → 界面显示
- [ ] 用户修改 → API调用 → 数据库保存 → 返回更新
- [ ] 本地状态更新 → 界面刷新

#### 数据流程图
```
用户登录
  ↓
后端验证 + 返回完整用户信息（包括新字段）
  ↓
前端存储到 authStore（zustand/localStorage）
  ↓
界面从 authStore 读取并显示
  ↓
用户修改信息
  ↓
前端发送更新请求（包含修改的字段）
  ↓
后端保存到数据库
  ↓
后端返回更新后的完整用户信息
  ↓
前端更新 authStore
  ↓
界面刷新显示最新信息
```

#### 关键检查点

##### 4.1 登录数据存储
```javascript
// frontend/src/pages/Login.jsx
const response = await authAPI.login(values)
const user = response.data
login(user, null) // ✅ 必须存储完整的 user 对象
```

##### 4.2 状态更新
```javascript
// frontend/src/store/authStore.js
updateUser: (userData) => {
  set((state) => ({ 
    user: { ...state.user, ...userData } // ✅ 合并更新，保留现有字段
  }))
}
```

##### 4.3 界面显示
```javascript
// 检查所有显示用户信息的地方
// frontend/src/components/Layout/AttioLayout.jsx
{user?.full_name || user?.phone}
{user?.english_name && <span>({user.english_name})</span>}
```

#### ✅ 验证标准
- 登录后能立即看到所有用户信息
- 修改后保存，数据持久化到数据库
- 刷新页面后，修改的数据依然存在

---

### 🔐 第5步：权限控制检查

#### 检查内容
- [ ] 路由权限保护是否正确
- [ ] UI元素是否根据权限显示/隐藏
- [ ] API端点是否有权限验证中间件
- [ ] 前端权限判断逻辑是否正确

#### 检查文件
```bash
frontend/src/App.jsx
frontend/src/components/Layout/*.jsx
backend/routes/*.js
backend/middleware/auth.js
```

#### 关键检查点

##### 5.1 路由保护
```javascript
// frontend/src/App.jsx
<Route path="settings" element={
  <ProtectedRoute requiredRole="Administrator">
    <Settings />
  </ProtectedRoute>
} />
```

##### 5.2 UI条件渲染
```javascript
// frontend/src/components/Layout/AttioLayout.jsx
if (user?.role === 'Administrator') {
  items.push({
    key: 'settings',
    label: '设置'
  })
}
```

##### 5.3 后端权限验证
```javascript
// backend/routes/admin/*.js
router.post('/some-admin-action', auth, isAdmin, someController)
```

#### ✅ 验证标准
- 无权限用户无法访问受保护的路由
- 无权限用户看不到不应该看到的UI元素
- 后端API有相应的权限验证，防止前端绕过

---

### 🌐 第6步：界面中文化检查

#### 检查内容
- [ ] 所有页面标题、按钮、提示都是中文
- [ ] 角色名称使用中文显示
- [ ] 表单标签和占位符都是中文
- [ ] 错误提示信息都是中文
- [ ] 没有中英文混合显示

#### 检查命令
```bash
# 查找可能的英文残留
grep -r "Password\|Username\|Save\|Cancel\|Edit\|Delete" frontend/src/pages/
grep -r "My Profile\|Settings\|Department" frontend/src/pages/
```

#### 关键检查点

##### 6.1 角色翻译
```javascript
// frontend/src/utils/roleTranslations.js
export const roleTranslations = {
  'Administrator': '管理员',
  'Sales Manager': '销售经理',
  // ... 所有角色
}

// 使用统一的翻译函数
import { getRoleNameCN } from '../utils/roleTranslations'
{getRoleNameCN(user?.role)}
```

##### 6.2 表单文本
```javascript
// ❌ 错误
<Form.Item label="Full Name">
  <Input placeholder="Enter your full name" />
</Form.Item>

// ✅ 正确
<Form.Item label="中文姓名">
  <Input placeholder="请输入中文姓名" />
</Form.Item>
```

#### ✅ 验证标准
- 系统界面 100% 中文化
- 使用统一的翻译工具函数
- 没有 Chinglish（中英混合）

---

### 🧪 第7步：本地测试验证

#### 测试清单

##### 7.1 管理员功能测试
```
1. ✅ 登录管理员账号
2. ✅ 查看右上角显示：中文姓名 (英文名字)
3. ✅ 点击用户菜单，应看到"个人资料"和"设置"
4. ✅ 访问个人资料页面
   - 修改英文名字
   - 修改个性签名
   - 保存
   - 刷新页面，验证数据已保存 ⭐ 关键
5. ✅ 访问设置页面
   - 修改中文姓名
   - 修改手机号
   - 保存
   - 刷新页面，验证数据已保存 ⭐ 关键
6. ✅ 修改密码功能测试
   - 输入当前密码
   - 输入新密码
   - 确认新密码
   - 保存
   - 退出登录，用新密码重新登录 ⭐ 关键
```

##### 7.2 非管理员功能测试
```
1. ✅ 登录非管理员账号（如技术工程师）
2. ✅ 查看右上角显示：中文姓名 (英文名字)
3. ✅ 点击用户菜单，应只看到"个人资料"（没有"设置"）
4. ✅ 访问个人资料页面
   - 修改英文名字
   - 修改个性签名
   - 保存
   - 刷新页面，验证数据已保存 ⭐ 关键
5. ✅ 尝试直接访问 /settings
   - 应被拒绝访问或重定向 ⭐ 关键
```

##### 7.3 数据库验证（最终确认）
```bash
# 连接到 MongoDB 数据库
mongo "mongodb+srv://..."

# 切换到数据库
use cmax

# 查询用户数据，确认字段已保存
db.users.find({ phone: "13000000001" }).pretty()

# ✅ 确认输出包含：
# - full_name: "何晓晓"
# - english_name: "Kay"
# - signature: "个性签名内容"
```

#### ✅ 验证标准
- 所有功能在本地开发环境正常工作
- 数据能够正确保存到数据库
- 刷新页面后数据依然存在

---

## 📝 自检报告模板

### 功能：[功能名称]

#### ✅ 数据库模型
- [ ] 字段已定义：`field1`, `field2`, `field3`
- [ ] 字段类型正确
- [ ] 验证规则完整

#### ✅ 后端API
- [ ] API接收字段：`field1`, `field2`, `field3`
- [ ] API返回字段：`field1`, `field2`, `field3`
- [ ] 登录API返回新字段：✅
- [ ] 错误处理：✅

#### ✅ 前端发送
- [ ] 表单收集字段：`field1`, `field2`, `field3`
- [ ] API调用发送字段：`field1`, `field2`, `field3`
- [ ] 字段名与后端一致：✅

#### ✅ 数据流
- [ ] 登录 → 存储 → 显示：✅
- [ ] 修改 → 保存 → 更新：✅
- [ ] 刷新后数据保留：✅

#### ✅ 权限控制
- [ ] 路由保护：✅
- [ ] UI条件显示：✅
- [ ] 后端权限验证：✅

#### ✅ 界面
- [ ] 100% 中文化：✅
- [ ] 角色中文显示：✅
- [ ] 显示格式统一：✅

#### ✅ 本地测试
- [ ] 管理员功能测试通过
- [ ] 非管理员功能测试通过
- [ ] 数据库数据验证通过

---

## 🚨 常见错误检查清单

### 错误1：字段名不匹配
```javascript
// ❌ 前端发送 full_name，后端使用 user.name
if (req.body.full_name !== undefined) user.name = req.body.full_name;

// ✅ 保持一致
if (req.body.full_name !== undefined) user.full_name = req.body.full_name;
```

### 错误2：登录API遗漏新字段
```javascript
// ❌ 登录时不返回新字段
res.json({
  _id: user._id,
  full_name: user.full_name,
  role: user.role
});

// ✅ 返回所有字段
res.json({
  _id: user._id,
  full_name: user.full_name,
  english_name: user.english_name,  // 新增
  signature: user.signature,         // 新增
  role: user.role
});
```

### 错误3：前端不更新状态
```javascript
// ❌ 只保存到数据库，不更新本地状态
await authAPI.updateProfile(values)

// ✅ 保存后更新本地状态
const response = await authAPI.updateProfile(values)
updateUser(response.data)
```

### 错误4：权限控制不完整
```javascript
// ❌ 只在前端做权限控制
<Route path="settings" element={<Settings />} />

// ✅ 前端 + 后端双重保护
// 前端
<Route path="settings" element={
  <ProtectedRoute requiredRole="Administrator">
    <Settings />
  </ProtectedRoute>
} />

// 后端
router.put('/profile', auth, isAdmin, updateProfile)
```

### 错误5：没有测试数据持久化
```javascript
// ⚠️ 常见问题：
// - 修改后没有刷新页面测试
// - 没有退出登录重新登录测试
// - 没有在数据库中直接查询验证

// ✅ 完整测试流程：
// 1. 修改数据
// 2. 保存
// 3. 刷新页面 ⭐
// 4. 退出登录
// 5. 重新登录 ⭐
// 6. 数据库查询验证 ⭐
```

---

## ✅ 推送前最终确认

### 方法1：使用自动检查脚本（推荐）⭐

```bash
# 运行自动检查脚本
./scripts/pre-push-check.sh

# 如果所有检查通过，脚本会显示 ✅ 并允许推送
# 如果有错误，脚本会显示 ❌ 并给出修复建议
```

### 方法2：手动检查

在执行 `git push` 之前，请确认：

```bash
# 1. 所有文件已添加
git status

# 2. 提交信息清晰
git log -1

# 3. ⭐ 检查中文标点符号（关键！）
grep -rn '[""'']' frontend/src/ --include="*.jsx" --include="*.tsx"

# 4. ESLint代码质量检查
cd frontend && npm run lint:check

# 5. 检查调试代码
grep -r "console.log" frontend/src/ | grep -v "console.warn\|console.error"
grep -r "debugger" frontend/src/

# 6. 没有临时文件
find . -name "*.tmp" -o -name "*.bak"

# 7. 环境变量配置正确
cat backend/.env | grep -v "PASSWORD\|SECRET"
```

### 最终确认清单
- [ ] 所有自检步骤都已完成
- [ ] 本地测试通过
- [ ] 数据库能正确保存数据
- [ ] 功能完整可用
- [ ] 界面100%中文化
- [ ] 权限控制正确
- [ ] 没有调试代码残留
- [ ] Git提交信息清晰

### 推送命令
```bash
git add .
git commit -m "功能完整实现：[功能名称] - 已完成完整自检"
git push origin main
```

---

## 📚 相关文档

- [数据库配置说明](./数据库配置说明.md)
- [API文档](./docs/api/)
- [角色权限说明](./角色权限功能清单-2025-10-30.md)
- [测试账号列表](./📋系统测试账号-完整列表.md)

---

## 🎯 总结

**核心原则**：
1. **数据完整性**：从数据库模型 → API → 前端，数据流必须完整
2. **字段一致性**：前后端字段名必须完全一致
3. **测试充分性**：必须测试数据持久化（刷新、重新登录）
4. **权限正确性**：前后端双重验证
5. **用户体验**：界面100%中文化，显示格式统一

**记住**：每次推送前，问自己三个问题：
1. ✅ 数据能保存到数据库吗？
2. ✅ 功能完整可用吗？
3. ✅ 我测试过了吗？

---

**最后更新**：2025-11-01
**维护者**：开发团队

