# ✅ 当前部署状态与下一步操作

**方案**: Vercel + Render + MongoDB Atlas香港  
**检查时间**: 2025-10-31  

---

## 📊 当前状态总结

### 1️⃣ 前端（Vercel）- ✅ 已完成

| 项目 | 状态 |
|------|------|
| 部署状态 | ✅ 成功 |
| 域名 | `project-ark-one.vercel.app` |
| 构建 | ✅ 正常 |
| 依赖问题 | ✅ 已修复（cmdk, @mui/icons-material）|

**⚠️ 待完成**:
- 需要配置环境变量 `VITE_API_URL`（等后端部署完成后配置）

---

### 2️⃣ 后端（Render）- ❓ 未确认

**需要确认**:
- 是否已在 Render 创建后端服务？
- 如果已创建，URL 是什么？

**如果未创建**，需要：
1. 注册 Render 账号
2. 创建 Web Service
3. 配置环境变量
4. 部署后端

---

### 3️⃣ 数据库（MongoDB Atlas 香港）- ❓ 未确认

**需要确认**:
- 是否已创建 MongoDB Atlas 账号？
- 是否已创建香港节点集群？
- 是否已获取连接字符串？

**本地数据情况**:
```
数据库名: cmax
数据大小: 2.95 MB

数据明细:
- users: 9 个用户
- actuators: 337 个执行器产品
- projects: 4 个项目
- accessories: 10 个配件
- suppliers: 5 个供应商
- manualoverrides: 18 个手动操作装置
- refreshtokens: 101 个刷新令牌（可删除）
```

**数据迁移选项**:
- **选项A**: 迁移本地数据到云端（保留现有数据）
- **选项B**: 使用 seed 脚本生成测试数据（推荐预售阶段）

---

## 🎯 下一步操作方案

### 方案A：从头开始部署（推荐）

**适合**: 刚开始部署，还没有创建 Render 和 MongoDB Atlas

**步骤**:
1. 部署 MongoDB Atlas 香港节点（5分钟）
2. 部署后端到 Render（10分钟）
3. 配置 Vercel 环境变量（2分钟）
4. 测试完整功能（3分钟）

**总耗时**: 约20分钟

---

### 方案B：继续未完成的部署

**适合**: 已经部署了部分服务，需要继续完成

**需要您告诉我**:
1. Render 后端 URL（如果已部署）
2. MongoDB Atlas 连接字符串（如果已创建）
3. 当前遇到的问题（如果有）

---

## 🚀 详细部署步骤（方案A）

### 第1步：部署 MongoDB Atlas 香港节点（5分钟）

#### 1.1 注册账号
```
访问：https://www.mongodb.com/cloud/atlas/register
选择：Sign up with Google（最快）
```

#### 1.2 创建免费集群
```
1. 点击：Build a Database
2. 选择：Shared (FREE)
3. 云服务商：AWS
4. 区域：⭐ Hong Kong (ap-east-1) 【必须选这个！】
5. 集群名称：project-ark-hk
6. 点击：Create
```

**⚠️ 关键**：必须选择 Hong Kong (ap-east-1)，这样延迟最低（20-50ms）

#### 1.3 创建数据库用户
```
Security → Database Access → Add New Database User

Username: arkadmin
Password: 点击 "Autogenerate Secure Password"
【保存这个密码，后面要用】
Role: Atlas admin
点击：Add User
```

#### 1.4 配置网络访问
```
Security → Network Access → Add IP Address
选择：Allow Access from Anywhere
输入：0.0.0.0/0
点击：Confirm
```

#### 1.5 获取连接字符串
```
Database → Connect → Connect your application

Driver: Node.js
Version: 4.1 or later

复制连接字符串：
mongodb+srv://arkadmin:<password>@project-ark-hk.xxxxx.mongodb.net/?retryWrites=true&w=majority

⚠️ 把 <password> 替换成你的实际密码
⚠️ 保存这个连接字符串
```

**✅ 检查点**: 已获取 MongoDB 连接字符串

---

### 第2步：部署后端到 Render（10分钟）

#### 2.1 注册 Render
```
访问：https://render.com
点击：Get Started
选择：Sign Up with GitHub
```

#### 2.2 创建 Web Service
```
Dashboard → New + → Web Service
选择仓库：ningxiarongchen-lgtm/project-ark
点击：Connect
```

#### 2.3 配置服务
```
Name: project-ark-backend
Region: Singapore ⭐（离香港最近）
Branch: main
Root Directory: backend
Runtime: Node
Build Command: npm install
Start Command: node server.js
Instance Type: Free
```

#### 2.4 配置环境变量（重要）

点击 "Advanced" → "Add Environment Variable"

添加以下6个变量：

**1. NODE_ENV**
```
production
```

**2. PORT**
```
5001
```

**3. MONGODB_URI**
```
mongodb+srv://arkadmin:你的密码@project-ark-hk.xxxxx.mongodb.net/cmax?retryWrites=true&w=majority
```
⚠️ 使用第1步获得的连接字符串，末尾添加 `/cmax`

**4. JWT_SECRET**
```
624f154889a31793e7a74857fc8699296080cd1883bce90a6ff75d831f8dc77736037dddc00e14f9c0dbfefb42916ecb0dae6eb86c8133b821ab56e494f4d6dd
```

**5. JWT_REFRESH_SECRET**
```
0bef6a83aa1e56bcf61f4f9fdce62d16e7ec90dc221e734d4ba6b21f8f9efd965786cb8bd542e127113a33711f5ef9c7e2bedf9194ef0c4d1d49e59270aa66d4
```

**6. ALLOWED_ORIGINS**
```
https://project-ark-one.vercel.app
```
⚠️ 使用您的实际 Vercel 前端地址

#### 2.5 创建并等待部署
```
点击：Create Web Service
等待5-10分钟自动部署
```

部署完成后，记下网址：
```
https://project-ark-backend.onrender.com
（或类似的地址）
```

#### 2.6 初始化数据库

**选项A：使用测试数据（推荐）**
```
Render 控制台 → Shell 标签

执行：
npm run seed:final

等待完成（约30秒）
```

**选项B：迁移本地数据**
```
在本地运行：
cd backend

# 导出本地数据
mongodump --db cmax --out ./local_backup

# 导入到云端
mongorestore --uri "mongodb+srv://arkadmin:密码@project-ark-hk.xxxxx.mongodb.net/" --db cmax ./local_backup/cmax
```

**✅ 检查点**: 后端已部署，URL 已获取

---

### 第3步：配置 Vercel 环境变量（2分钟）

#### 3.1 进入 Vercel 项目设置
```
访问：https://vercel.com/dashboard
选择项目：project-ark
点击：Settings
点击：Environment Variables
```

#### 3.2 添加环境变量
```
Key: VITE_API_URL
Value: https://project-ark-backend.onrender.com
（使用第2步获得的 Render 后端 URL）

Environment: 
✅ Production
✅ Preview
✅ Development

点击：Save
```

#### 3.3 重新部署
```
点击：Deployments
找到最新部署
点击：... → Redeploy
等待1-2分钟
```

**✅ 检查点**: 前端环境变量已配置

---

### 第4步：测试完整功能（3分钟）

#### 4.1 测试后端
```
浏览器访问：
https://project-ark-backend.onrender.com/api/health

应该返回：
{
  "status": "OK",
  "message": "Project Ark Platform API is running"
}
```

#### 4.2 测试前端
```
访问：https://project-ark-one.vercel.app

应该看到：
✅ 登录页面正常显示
```

#### 4.3 测试登录
```
使用测试账号：
手机号：13000000002
密码：password

登录后应该：
✅ 跳转到仪表盘
✅ 可以看到数据
✅ 功能正常使用
```

**✅ 部署完成！**

---

## 📝 部署完成后的信息记录

完成部署后，请记录以下信息：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  Project Ark - 部署信息
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

前端 URL:
https://project-ark-one.vercel.app

后端 URL:
https://project-ark-backend.onrender.com

数据库:
MongoDB Atlas 香港节点

测试账号:
管理员：13000000001 / password
销售经理：13000000002 / password
技术工程师：13000000003 / password

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 🔄 本地数据迁移详细步骤（如果需要）

如果您想保留本地的337个产品和其他数据：

### 步骤1：备份本地数据
```bash
cd "/Users/hexiaoxiao/Desktop/Model Selection System"
mongodump --db cmax --out ./cloud_migration_backup
```

### 步骤2：导入到 MongoDB Atlas
```bash
# 使用 MongoDB Atlas 的连接字符串
mongorestore \
  --uri "mongodb+srv://arkadmin:你的密码@project-ark-hk.xxxxx.mongodb.net/" \
  --db cmax \
  ./cloud_migration_backup/cmax
```

### 步骤3：验证数据
```bash
# 登录 MongoDB Atlas
mongosh "mongodb+srv://project-ark-hk.xxxxx.mongodb.net/" --username arkadmin

# 检查数据
use cmax
db.users.countDocuments()
db.actuators.countDocuments()
db.projects.countDocuments()
```

---

## 💡 重要提示

### 1. MongoDB 必须选香港节点
```
❌ 不要选：Singapore、Tokyo、Mumbai
✅ 必须选：Hong Kong (ap-east-1)

原因：延迟最低（20-50ms）
```

### 2. Render 第一次访问会慢
```
原因：免费版15分钟无访问会休眠
解决：配置 UptimeRobot（5分钟间隔ping）
```

### 3. 数据选择
```
测试数据（推荐）：
- 使用 seed:final 脚本
- 9个测试账号
- 337个执行器产品
- 干净整洁

迁移本地数据：
- 保留现有数据
- 需要额外步骤
- 可能有冗余数据
```

---

## ❓ 现在请告诉我

为了继续帮助您，请回答：

**1. 您想使用哪个方案？**
- [ ] 方案A：从头开始部署（我一步步指导）
- [ ] 方案B：已经部署了部分，需要继续

**2. 如果选方案B，请提供：**
- Render 后端 URL：_________________
- MongoDB Atlas 连接字符串：_________________
- 当前问题：_________________

**3. 数据选择：**
- [ ] 使用 seed 测试数据（推荐）
- [ ] 迁移本地337个产品数据

**4. 当前能做的测试：**
- 能打开 `https://project-ark-one.vercel.app` 吗？
- 能看到登录页面吗？
- 尝试登录有什么提示？

回答这些问题后，我会提供精确的下一步操作！🚀

