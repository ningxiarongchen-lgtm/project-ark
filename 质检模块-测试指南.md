# 质检模块 - 测试指南

## 🧪 测试环境准备

### 1. 确认服务运行
```bash
# 确认后端服务运行在 http://localhost:5001
# 确认前端服务运行在 http://localhost:5173
# 确认MongoDB服务运行
```

### 2. 初始化测试数据

#### 创建质检员账户
```
用户名: qa_tester
角色: QA
密码: 自定义
```

#### 确认检验模板已创建
```bash
node backend/scripts/initQualityTemplates.js
```

---

## 📝 测试场景

### 场景1: IQC来料检验流程

#### Step 1: 创建采购订单（采购专员）
```
1. 登录采购专员账户
2. 创建采购订单
3. 将状态改为"已发货"
```

#### Step 2: 确认收货（采购专员）
```
1. 在采购订单详情页点击"确认收货"
2. 填写收货信息:
   - 收货数量
   - 仓库位置
   - 备注
3. 提交
```

#### Step 3: 系统自动创建IQC任务
```
✅ 检查后端日志，应看到:
"✅ 自动创建IQC检验任务: 采购订单 PO-XXXXXX"
```

#### Step 4: 质检员执行检验
```
1. 登录质检员账户 (qa_tester)
2. 访问 /quality/dashboard
3. 应看到新创建的IQC任务
4. 点击"开始检验"
5. 逐项进行检验，选择 Pass/Fail
6. 上传照片（可选）
7. 填写综合结论
8. 点击"判定合格"
9. 确认提交
```

#### Step 5: 验证结果
```
✅ 检查:
- 质检任务状态变为"Completed"
- 采购订单状态更新为"IQC Passed"
- 库存状态更新为可用
```

---

### 场景2: FQC成品检验流程

#### Step 1: 创建生产订单（生产计划员）
```
1. 登录生产计划员账户
2. 创建生产订单
3. 开始生产
```

#### Step 2: 生产完成（生产计划员）
```
1. 在生产订单详情页
2. 点击"标记为待质检"
3. 填写备注
4. 提交
```

#### Step 3: 系统自动创建FQC任务
```
✅ 检查后端日志，应看到:
"✅ 自动创建FQC检验任务: 生产订单 PROD-XXXXXX"
```

#### Step 4: 质检员执行检验
```
1. 登录质检员账户
2. 访问 /quality/dashboard
3. 应看到新创建的FQC任务
4. 点击"开始检验"
5. 系统自动加载AT/GT/PSQ系列对应的检验模板
6. 逐项进行检验:
   - 外观检查
   - 尺寸检验
   - 气密性测试
   - 开关动作测试
   - 扭矩测试
   - 电气测试
7. 上传现场照片
8. 填写综合结论
9. 点击"判定合格"或"判定不合格"
10. 确认提交
```

#### Step 5: 验证结果

**如果判定合格:**
```
✅ 检查:
- 质检任务状态变为"Completed"
- 生产订单状态更新为"FQC Passed"
- 物流专员收到通知（待实现）
```

**如果判定不合格:**
```
✅ 检查:
- 质检任务状态变为"Completed"
- 生产订单状态更新为"FQC Failed"
- 记录缺陷数量
- 生产计划员收到通知（待实现）
```

---

## 🎯 测试检查清单

### 功能测试

#### 质检员工作台
- [ ] 能看到待处理任务列表
- [ ] 能看到已完成任务列表
- [ ] 统计卡片显示正确
- [ ] 筛选器工作正常
- [ ] 搜索功能正常
- [ ] 刷新按钮工作

#### 检验执行页面
- [ ] 基础信息显示正确
- [ ] 检验模板自动加载
- [ ] 能逐项选择检验结果
- [ ] 能填写备注
- [ ] 能上传照片
- [ ] 能填写综合结论
- [ ] 判定按钮在所有项完成前禁用
- [ ] 确认对话框正常弹出
- [ ] 提交成功后跳转回工作台

#### 自动化工作流
- [ ] 采购收货后自动创建IQC任务
- [ ] 生产完成后自动创建FQC任务
- [ ] 检验完成后自动更新源单据状态
- [ ] 活动日志正确记录

#### 数据完整性
- [ ] 质检单号自动生成且唯一
- [ ] 检验数据完整保存
- [ ] 照片URL正确保存
- [ ] 时间戳准确记录

---

## 🐛 已知问题和解决方案

### 问题1: 检验模板未加载
**原因**: 产品系列识别错误或模板不存在  
**解决**: 
1. 检查产品型号格式（如 AT-100）
2. 确认对应的检验模板存在
3. 使用默认检验清单

### 问题2: 照片上传失败
**原因**: 当前版本使用base64存储，大文件可能失败  
**解决**: 
1. 限制照片大小（建议<2MB）
2. 未来版本将实现文件服务器上传

### 问题3: 任务未自动创建
**原因**: 
- 源单据状态不正确
- 控制器导入错误
- 数据库连接问题

**解决**:
1. 检查后端日志
2. 确认采购订单状态为"已发货"
3. 确认生产订单状态为"Completed"
4. 重启后端服务

---

## 📊 测试数据示例

### 测试用检验清单数据
```json
{
  "checkList": [
    {
      "itemName": "外观检查",
      "standard": "表面光洁、无划痕",
      "result": "Pass",
      "notes": "外观良好"
    },
    {
      "itemName": "气密性测试",
      "standard": "6bar，5分钟，压降<0.1%",
      "result": "Pass",
      "notes": "测试合格，压降0.05%"
    },
    {
      "itemName": "扭矩测试",
      "standard": "符合规格±5%",
      "result": "Fail",
      "notes": "扭矩不足，仅达到规格的90%"
    }
  ],
  "overallResult": "Fail",
  "notes": "扭矩测试不合格，需要返工调整"
}
```

---

## 🔍 调试技巧

### 后端调试
```bash
# 查看实时日志
tail -f backend/logs/server.log

# 检查质检任务
# 在MongoDB中查询
db.qualitychecks.find().pretty()

# 检查检验模板
db.checklisttemplates.find().pretty()
```

### 前端调试
```javascript
// 在浏览器控制台
// 查看localStorage中的token
localStorage.getItem('token')

// 查看网络请求
// 打开开发者工具 -> Network 标签
// 筛选 XHR 请求
```

### API测试
```bash
# 使用curl测试
curl -X GET http://localhost:5001/api/quality-checks \
  -H "Authorization: Bearer YOUR_TOKEN"

# 使用Postman
# 导入接口文档进行测试
```

---

## ✅ 验收标准

### 基本功能
- [x] 采购收货自动创建IQC任务
- [x] 生产完成自动创建FQC任务
- [x] 质检员能查看任务列表
- [x] 质检员能执行检验
- [x] 检验结果能正确保存
- [x] 源单据状态能自动更新

### 用户体验
- [x] 界面清晰直观
- [x] 操作流程顺畅
- [x] 响应速度快
- [x] 错误提示友好

### 数据质量
- [x] 数据完整性
- [x] 数据一致性
- [x] 可追溯性

---

## 📈 性能测试

### 负载测试
```
场景: 100个并发质检任务
预期: 响应时间<2秒
```

### 压力测试
```
场景: 1000个质检记录查询
预期: 加载时间<3秒
```

---

## 🚀 下一步优化

### 短期 (v1.1)
- [ ] 添加通知功能
- [ ] 支持批量检验
- [ ] 导出检验报告（PDF）

### 中期 (v1.2)
- [ ] 不合格品处理流程
- [ ] 供应商质量评级
- [ ] 质量趋势分析

### 长期 (v2.0)
- [ ] 移动端APP
- [ ] AI辅助检验
- [ ] 质量预测模型

---

## 📚 参考资料

- 完整文档: `质检模块-完整实现文档.md`
- 快速参考: `📋质检模块-快速参考.md`
- API文档: 见完整文档中的API接口章节

---

**测试指南版本**: v1.0  
**最后更新**: 2025-10-31  
**适用环境**: 开发/测试环境

