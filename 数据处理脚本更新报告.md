# 数据处理脚本更新报告

## 更新时间
2025-10-28

## 更新目标
根据新的定价模型架构，更新所有数据导入和迁移脚本，使其能够正确处理固定价格模式（fixed）和阶梯价格模式（tiered）。

---

## 一、数据导入脚本更新

### 1. seed.js ✅ （已完成）

**状态**: 已经包含完整的定价模式智能判断逻辑，无需修改

**核心逻辑** (第98-136行):
- ✅ 检查 Excel 中是否提供了阶梯价格列（qty_1, price_1 等）
- ✅ 如果有阶梯价格 → 设置 `pricing_model = 'tiered'`，解析到 `price_tiers` 数组
- ✅ 如果只有单一价格 → 设置 `pricing_model = 'fixed'`，价格存入 `base_price`
- ✅ 如果阶梯价格解析失败 → 自动回退到固定价格模式

**支持的 CSV 列格式**:
```
# 固定价格模式
base_price 或 price

# 阶梯价格模式
qty_1, price_1, price_type_1, notes_1
qty_2, price_2, price_type_2, notes_2
...
```

---

### 2. seed_at_gy.js ✅ （已更新）

**更新内容**:
- ✅ 添加了完整的定价模式智能判断逻辑（第103-141行）
- ✅ 支持从 CSV 解析阶梯价格数据
- ✅ 根据是否有多个价格列自动设置 `pricing_model`
- ✅ 如果有阶梯价格则解析到 `price_tiers`，否则存入 `base_price`

**处理流程**:
1. 读取 CSV 文件 `at_gy_actuators_data.csv`
2. 检查是否有阶梯价格列（qty_X, price_X）
3. 如果有：
   - 设置 `pricing_model = 'tiered'`
   - 解析所有价格档位到 `price_tiers` 数组
   - 如果解析失败，回退到固定价格模式
4. 如果没有：
   - 设置 `pricing_model = 'fixed'`
   - 价格存入 `base_price`

**支持的价格字段**:
- `qty_1` ~ `qty_5` 或 `min_quantity_1` ~ `min_quantity_5`
- `price_1` ~ `price_5` 或 `unit_price_1` ~ `unit_price_5`
- `price_type_1` ~ `price_type_5` (可选)
- `notes_1` ~ `notes_5` (可选)

---

### 3. seed_at_gy_final.js ✅ （已更新）

**更新内容**:
- ✅ 添加了高级定价模式智能判断逻辑（第189-267行）
- ✅ 支持多种价格格式（阶梯价格、低/标准/高价格）
- ✅ 保留了向后兼容的 `pricing` 对象
- ✅ 同时维护 `base_price` 和 `price_tiers`

**特殊处理**:
1. **阶梯价格优先**: 如果 CSV 中有 `qty_X` 和 `price_X` 列，优先解析为阶梯价格
2. **价格范围转换**: 如果有 `base_price_low`、`base_price_normal`、`base_price_high`，自动转换为阶梯价格：
   ```javascript
   price_tiers: [
     { min_quantity: 10, unit_price: basePriceLow, price_type: 'low' },
     { min_quantity: 1, unit_price: basePriceNormal, price_type: 'normal' },
     { min_quantity: 1, unit_price: basePriceHigh, price_type: 'high' }
   ]
   ```
3. **保留 base_price**: 即使设置了阶梯价格，也会保留 `base_price` 字段（使用标准价格）
4. **向后兼容**: 保存额外的价格信息到 `pricing` 对象，包含：
   - base_price_normal
   - base_price_low
   - base_price_high
   - manual_override_model
   - manual_override_price
   - seal_kit_price

**判断逻辑**:
```javascript
// 如果满足以下任一条件，视为阶梯定价：
- 有 qty_X 和 price_X 列
- 同时有 basePriceLow 和 basePriceHigh
```

---

### 4. seed_mock_suppliers.js ℹ️ （无需修改）

**说明**: 此脚本仅用于导入供应商基本信息，不涉及产品定价，无需修改。

---

### 5. seed_test_ticket.js ℹ️ （无需修改）

**说明**: 此脚本用于创建测试售后工单，不涉及产品定价，无需修改。

---

### 6. import_suppliers.js ℹ️ （无需修改）

**说明**: 此脚本用于批量导入供应商数据，不涉及产品定价，无需修改。

---

## 二、数据迁移脚本更新

### migration_price_tiers.js ✅ （已正确实现）

**当前状态**: 已按照新需求正确实现，无需修改

**核心逻辑**:
1. ✅ 遍历所有执行器和配件文档
2. ✅ **保留** `base_price` 字段（不删除）
3. ✅ **新增** `pricing_model` 字段：
   - 如果文档有 `price_tiers` 且长度 > 0 → 设置为 `'tiered'`
   - 如果有 `base_price_low` 或 `base_price_high` → 设置为 `'tiered'`
   - 否则 → 设置为 `'fixed'`（默认）
4. ✅ 如果是固定价格模式且缺少 `base_price`，从其他字段提取价格

**定价模式判断函数** (第144-158行):
```javascript
function determinePricingModel(doc) {
  // 检查是否已有 price_tiers 且包含多个档位
  if (doc.price_tiers && Array.isArray(doc.price_tiers) && doc.price_tiers.length > 0) {
    return 'tiered';
  }
  
  // 检查是否有多个价格字段（low/high），暗示可能需要阶梯定价
  if (doc.pricing?.base_price_low || doc.pricing?.base_price_high) {
    return 'tiered';
  }
  
  // 默认为固定价格模式
  return 'fixed';
}
```

**执行结果**:
- ✅ 所有现有 SF 系列产品将被标记为 `pricing_model: 'fixed'`
- ✅ 保留原有的 `base_price` 字段
- ✅ 如果有 AT/GY 产品有多个价格档位，将被标记为 `'tiered'`

**运行命令**:
```bash
cd backend
node migration_price_tiers.js
```

**输出示例**:
```
═══════════════════════════════════════════════
  定价模式字段迁移脚本 v2.0.0
  Pricing Model Migration Script
═══════════════════════════════════════════════

迁移内容：
  ✓ 为所有执行器添加 pricing_model 字段（默认: fixed）
  ✓ 为所有配件添加 pricing_model 字段（默认: fixed）
  ✓ 保留原有的 base_price/price 字段
  ✓ 如果文档已有 price_tiers，设置为 tiered 模式

📊 迁移完成统计

【执行器 Actuators】
┌─────────────────────────────────────┐
│ 总文档数:            50 个          │
│ ✓ 成功迁移:          50 个          │
│ ⊘ 已有定价模式:       0 个          │
│ ? 无价格字段:         0 个          │
│ ✗ 失败:               0 个          │
└─────────────────────────────────────┘

执行器 - 固定价格模式: 50 个
执行器 - 阶梯价格模式: 0 个
```

---

## 三、数据模型要求

### Actuator 模型必需字段

```javascript
{
  // 基本信息
  model_base: String,        // 型号
  series: String,            // 系列 (SF/AT/GY)
  
  // 定价信息（新架构）
  pricing_model: {           // ⭐ 新增字段
    type: String,
    enum: ['fixed', 'tiered'],
    default: 'fixed'
  },
  
  base_price: Number,        // 基础价格（必须保留）
  
  price_tiers: [{            // 阶梯价格（可选）
    min_quantity: Number,
    unit_price: Number,
    price_type: String,
    notes: String
  }],
  
  // 其他字段...
}
```

---

## 四、使用指南

### 1. 导入固定价格产品（如 SF 系列）

**CSV 格式**:
```csv
model_base,series,action_type,base_price
SF025,SF,DA,1200
SF040,SF,SR,1500
```

**结果**:
```javascript
{
  model_base: "SF025",
  series: "SF",
  pricing_model: "fixed",  // 自动设置
  base_price: 1200
}
```

---

### 2. 导入阶梯价格产品（如 AT/GY 系列）

**CSV 格式**:
```csv
model_base,series,qty_1,price_1,qty_2,price_2,qty_3,price_3
AT-SR52K8,AT,1,2500,10,2300,50,2100
```

**结果**:
```javascript
{
  model_base: "AT-SR52K8",
  series: "AT",
  pricing_model: "tiered",  // 自动设置
  base_price: 2500,         // 使用第一档价格
  price_tiers: [
    { min_quantity: 1, unit_price: 2500, price_type: 'normal' },
    { min_quantity: 10, unit_price: 2300, price_type: 'normal' },
    { min_quantity: 50, unit_price: 2100, price_type: 'normal' }
  ]
}
```

---

### 3. 导入多价格档位产品

**CSV 格式**:
```csv
model_base,series,base_price_low,base_price_normal,base_price_high
GY-63,GY,3500,4000,4500
```

**结果**:
```javascript
{
  model_base: "GY-63",
  series: "GY",
  pricing_model: "tiered",  // 自动识别为阶梯定价
  base_price: 4000,         // 使用标准价格
  price_tiers: [
    { min_quantity: 10, unit_price: 3500, price_type: 'low', notes: '大批量优惠价' },
    { min_quantity: 1, unit_price: 4000, price_type: 'normal', notes: '标准价格' },
    { min_quantity: 1, unit_price: 4500, price_type: 'high', notes: '小批量价格' }
  ],
  pricing: {  // 保留原始价格信息（向后兼容）
    base_price_normal: 4000,
    base_price_low: 3500,
    base_price_high: 4500
  }
}
```

---

## 五、运行脚本

### 1. 导入 SF 系列数据
```bash
cd backend
node seed.js
```

### 2. 导入 AT/GY 系列数据（基础版）
```bash
cd backend
node seed_at_gy.js
```

### 3. 导入 AT/GY 系列数据（最终版，含完整价格）
```bash
cd backend
node seed_at_gy_final.js
```

### 4. 迁移现有数据
```bash
cd backend
node migration_price_tiers.js
```

---

## 六、验证清单

### ✅ 数据导入验证

- [ ] SF 系列产品的 `pricing_model` 为 `'fixed'`
- [ ] SF 系列产品的 `base_price` 已正确设置
- [ ] AT/GY 单价产品的 `pricing_model` 为 `'fixed'`
- [ ] AT/GY 阶梯价格产品的 `pricing_model` 为 `'tiered'`
- [ ] AT/GY 阶梯价格产品的 `price_tiers` 数组已正确解析
- [ ] AT/GY 阶梯价格产品的 `base_price` 已保留（使用标准价格）

### ✅ 数据迁移验证

- [ ] 所有现有文档都添加了 `pricing_model` 字段
- [ ] 原有的 `base_price` 字段已保留
- [ ] SF 系列产品标记为 `'fixed'` 模式
- [ ] 有 `price_tiers` 的产品标记为 `'tiered'` 模式
- [ ] 迁移过程无数据丢失

### ✅ API 兼容性验证

- [ ] 价格计算 API 正确识别 `pricing_model`
- [ ] 固定价格产品返回 `base_price`
- [ ] 阶梯价格产品根据数量返回正确价格
- [ ] 向后兼容原有的 `pricing` 对象

---

## 七、注意事项

### ⚠️ 重要提示

1. **保留 base_price**: 即使是阶梯定价，也必须保留 `base_price` 字段，用于快速价格查询
2. **向后兼容**: `seed_at_gy_final.js` 保留了 `pricing` 对象，确保旧代码仍能正常工作
3. **自动回退**: 如果阶梯价格解析失败，自动回退到固定价格模式
4. **数据验证**: 所有脚本都包含数据验证逻辑，确保导入数据的完整性

### 🔧 故障排除

**问题**: 导入后 `pricing_model` 字段缺失
- **原因**: 脚本版本过旧
- **解决**: 使用更新后的脚本重新导入

**问题**: 阶梯价格未正确解析
- **原因**: CSV 列名不匹配
- **解决**: 检查 CSV 是否有 `qty_X` 和 `price_X` 列

**问题**: `base_price` 字段被删除
- **原因**: 使用了旧版迁移脚本
- **解决**: 使用 `migration_price_tiers.js v2.0.0` 重新迁移

---

## 八、总结

### ✅ 已完成

1. ✅ 更新 `seed_at_gy.js` - 添加定价模式判断逻辑
2. ✅ 更新 `seed_at_gy_final.js` - 添加高级定价模式判断逻辑
3. ✅ 验证 `seed.js` - 已有完整的定价模式判断逻辑
4. ✅ 验证 `migration_price_tiers.js` - 已正确实现新需求
5. ✅ 创建详细的使用文档和验证清单

### 🎯 关键改进

- **智能判断**: 脚本自动根据 Excel 数据判断定价模式
- **灵活兼容**: 支持多种 CSV 格式（qty_X/price_X, low/normal/high）
- **数据完整**: 同时保留 `base_price` 和 `price_tiers`
- **自动回退**: 解析失败时自动回退到固定价格模式
- **向后兼容**: 保留原有的 `pricing` 对象

### 📊 影响范围

- **数据导入**: 3个脚本（seed.js, seed_at_gy.js, seed_at_gy_final.js）
- **数据迁移**: 1个脚本（migration_price_tiers.js）
- **数据模型**: Actuator 模型新增 `pricing_model` 字段
- **API**: 价格计算逻辑需根据 `pricing_model` 调整

---

## 九、下一步操作建议

1. **运行迁移脚本**: 为现有数据添加 `pricing_model` 字段
   ```bash
   node backend/migration_price_tiers.js
   ```

2. **重新导入数据**: 如果需要全新导入
   ```bash
   node backend/seed.js           # SF系列
   node backend/seed_at_gy_final.js  # AT/GY系列
   ```

3. **验证数据**: 检查数据库中的 `pricing_model` 字段
   ```javascript
   // MongoDB Shell
   db.actuators.find({ pricing_model: { $exists: false } }).count()  // 应为 0
   db.actuators.find({ pricing_model: 'fixed' }).count()
   db.actuators.find({ pricing_model: 'tiered' }).count()
   ```

4. **测试 API**: 验证价格计算接口是否正确
   ```bash
   # 测试固定价格产品
   curl http://localhost:3000/api/actuators/price?model=SF025&quantity=5
   
   # 测试阶梯价格产品
   curl http://localhost:3000/api/actuators/price?model=AT-SR52K8&quantity=50
   ```

---

**文档版本**: v1.0  
**更新日期**: 2025-10-28  
**维护者**: C-MAX 技术团队

