# 配件选配功能快速测试指南 🧪

**版本**: 2.0  
**测试时间**: 2025-10-27

---

## 🚀 快速启动

### 1. 启动后端
```bash
cd "/Users/hexiaoxiao/Desktop/Model Selection System/backend"
npm start
# 后端应该运行在: http://localhost:5001
```

### 2. 启动前端
```bash
cd "/Users/hexiaoxiao/Desktop/Model Selection System/frontend"
npm run dev
# 前端应该运行在: http://localhost:5173
```

---

## ✅ 核心功能测试流程

### 测试 1: 完整选型流程（包含配件）

#### 步骤 1: 登录系统
1. 打开浏览器访问 `http://localhost:5173`
2. 使用管理员账号登录

#### 步骤 2: 创建或选择项目
1. 进入"项目管理"页面
2. 创建新项目或选择现有项目
3. 点击"选型引擎"按钮

#### 步骤 3: 填写选型参数
```
执行机构类型: 拨叉式 (SF系列)
阀门类型: 球阀 (Ball Valve)
阀门口径: DN100
法兰尺寸: F07/F10
需求扭矩: 500 Nm
工作压力: 0.6 MPa
旋转角度: 90°
手动操作装置: 需要
```

#### 步骤 4: 选择执行器
1. 点击"查找匹配执行器"
2. 查看推荐结果
3. 选择一个执行器（点击"选择此型号"）

**✅ 验证点**:
- 推荐结果列表正确显示
- 扭矩裕度显示
- 价格信息完整

#### 步骤 5: 选择手动操作装置
1. 在弹出的"选择手动操作装置"Modal中
2. 选择一个兼容的手轮
3. 点击"确认"

**✅ 验证点**:
- 兼容手轮列表正确显示
- 价格信息完整

#### 步骤 6: 选择配件 ⭐ 核心测试
**Modal应自动弹出: "步骤 3: 选择控制附件"**

##### 6.1 验证智能推荐
**✅ 验证点**:
- [ ] 顶部显示智能推荐提示
- [ ] 部分配件已自动勾选（推荐配件）
- [ ] 推荐配件有蓝色边框和"推荐"标签
- [ ] 推荐数量显示正确

##### 6.2 验证"全部配件"Tab
**✅ 验证点**:
- [ ] 配件按5大类别分组显示
  - 控制类
  - 连接与传动类
  - 安全与保护类
  - 检测与反馈类
  - 辅助与安装工具
- [ ] 每个类别显示配件数量徽章
- [ ] "控制类"默认展开
- [ ] 可以展开/折叠类别

##### 6.3 验证单个类别Tab
**✅ 验证点**:
- [ ] 每个类别有独立Tab页
- [ ] Tab之间可以切换
- [ ] 配件信息完整显示

##### 6.4 验证配件信息卡片
**每个配件应显示**:
- [ ] 配件名称（加粗）
- [ ] 价格（格式化显示）
- [ ] 描述信息
- [ ] 制造商信息
- [ ] Checkbox选择框
- [ ] 推荐配件特殊样式

##### 6.5 验证配件选择交互
**操作步骤**:
1. 勾选一个未选中的配件
2. 取消勾选一个已选中的配件
3. 观察底部统计面板

**✅ 验证点**:
- [ ] 勾选后配件添加到已选列表
- [ ] 取消勾选后配件从已选列表移除
- [ ] "已选配件"数量实时更新
- [ ] "配件总价"实时更新
- [ ] 价格计算正确

##### 6.6 确认配件选择
1. 确认已选择至少2-3个配件
2. 点击"确认选择 (X 个)"按钮

---

#### 步骤 7: 最终汇总 ⭐ 核心测试
**"保存选型结果"Modal应显示**

**✅ 验证点**:
- [ ] 执行器型号显示正确
- [ ] 执行器价格显示正确
- [ ] 手动操作装置信息显示正确
- [ ] **配件区域显示**:
  - [ ] "已选配件：X 个"
  - [ ] 配件列表滚动显示
  - [ ] 每个配件显示：序号 + 名称 + 价格
  - [ ] "配件总价"显示正确
- [ ] **总价计算正确**:
  ```
  总价 = 执行器价格 + 手轮价格 + 配件总价
  ```

#### 步骤 8: 保存到项目
1. 点击"保存"按钮
2. 观察成功提示信息

**✅ 验证点**:
- [ ] 显示成功提示：`已保存到项目（包含 X 个配件）`
- [ ] Modal自动关闭
- [ ] 表单重置

---

### 测试 2: PDF生成 ⭐ 核心测试

#### 步骤 1: 进入项目详情
1. 返回"项目管理"页面
2. 打开刚才创建的选型记录

#### 步骤 2: 生成技术规格书PDF

**操作**: 点击"下载技术规格书"按钮

**✅ 验证PDF内容**:
- [ ] 项目信息区域完整
- [ ] 阀门参数区域显示（valve_type, valve_size, flange_size）
- [ ] 执行器信息区域完整
- [ ] 手动操作装置信息显示（如果有）
- [ ] **配件清单区域** ⭐:
  ```
  ACCESSORY LIST / 附件清单
  ┌────┬──────────────┬────────────┬─────┬───────────┬──────────┐
  │No. │Name / 名称   │Category    │Qty  │Unit Price │Total     │
  ├────┼──────────────┼────────────┼─────┼───────────┼──────────┤
  │ 1  │双作用电磁阀  │控制类      │  1  │  ¥1,200   │ ¥1,200  │
  │ 2  │智能定位器    │控制类      │  1  │  ¥3,500   │ ¥3,500  │
  │ 3  │防护罩        │安全与保护类│  1  │    ¥800   │   ¥800  │
  └────┴──────────────┴────────────┴─────┴───────────┴──────────┘
  ```
  - [ ] 表格格式专业
  - [ ] 序号列正确
  - [ ] 双语列头显示
  - [ ] 数据对齐正确（序号和数量居中，价格右对齐）
  - [ ] 价格格式化正确
- [ ] 总价显示正确

#### 步骤 3: 生成报价单PDF

**操作**: 点击"下载报价单"按钮

**✅ 验证PDF内容**:
- [ ] 报价信息区域完整
- [ ] 客户信息区域显示
- [ ] 阀门参数区域显示
- [ ] **报价明细表** ⭐:
  ```
  ┌────┬──────────┬────────────────┬─────┬───────────┬──────────┐
  │No. │Item      │Description     │Qty  │Unit Price │Total     │
  ├────┼──────────┼────────────────┼─────┼───────────┼──────────┤
  │ 1  │SF10-DA-SY│Pneumatic...    │  1  │  ¥8,500   │ ¥8,500  │
  │ 2  │HS-001    │Manual Override │  1  │  ¥1,200   │ ¥1,200  │
  │ 3  │双作用电磁阀│控制类 / 配件  │  1  │  ¥1,200   │ ¥1,200  │
  │ 4  │智能定位器  │控制类 / 配件  │  1  │  ¥3,500   │ ¥3,500  │
  │ 5  │防护罩      │安全与保护类/配件│1  │    ¥800   │   ¥800  │
  └────┴──────────┴────────────────┴─────┴───────────┴──────────┘
  
  TOTAL: ¥15,200
  ```
  - [ ] 执行器、手轮、配件统一编号
  - [ ] 配件描述包含类别
  - [ ] 序号连续
  - [ ] 总价正确计算
- [ ] **无旧备注** ⭐:
  - [ ] 确认没有"此报价仅包含执行器本体，不含其他控制附件"的文字
- [ ] 条款区域显示

---

### 测试 3: 不选配件的情况

#### 步骤:
1. 重复测试1的步骤1-5
2. 在配件选择Modal中，**取消所有勾选**
3. 点击"确认选择 (0 个)"
4. 保存选型记录

**✅ 验证点**:
- [ ] 可以保存没有配件的选型记录
- [ ] 最终汇总不显示配件区域
- [ ] PDF中不显示配件表格
- [ ] 总价 = 执行器 + 手轮

---

### 测试 4: 只选择执行器（不需要手轮）

#### 步骤:
1. 填写选型参数
2. **手动操作装置选择"不需要"**
3. 选择执行器
4. 验证**直接跳到配件选择Modal**（跳过手轮选择）

**✅ 验证点**:
- [ ] 配件选择Modal自动弹出
- [ ] 流程正确：执行器 → 配件 → 保存

---

## 🔍 边缘情况测试

### 边缘1: 配件为空的情况
- [ ] 当系统没有配件数据时，Modal应显示空状态提示
- [ ] 可以正常关闭Modal
- [ ] 可以保存选型记录

### 边缘2: 大量配件的情况
- [ ] 滚动列表流畅
- [ ] 性能良好
- [ ] UI不卡顿

### 边缘3: 智能推荐无匹配
- [ ] 当没有推荐配件时，推荐数量显示0
- [ ] 不影响手动选择

---

## 📊 数据验证

### 数据库验证
```bash
# 连接MongoDB
mongo

use cmax_selection

# 查询最新的选型记录
db.newprojects.find().sort({createdAt: -1}).limit(1).pretty()
```

**✅ 验证点**:
```javascript
{
  selections: [{
    selected_actuator: {...},
    selected_override: {...},
    selected_accessories: [  // ⭐ 核心验证
      {
        accessory_id: ObjectId("..."),
        name: "双作用电磁阀",
        category: "控制类",
        quantity: 1,
        unit_price: 1200,
        total_price: 1200,
      },
      ...
    ],
    total_price: 15200  // 应等于所有价格之和
  }]
}
```

---

## 🐛 常见问题排查

### 问题1: 配件Modal不弹出
**原因**: 前端API调用失败  
**排查**:
```bash
# 检查后端日志
# 检查浏览器Console是否有错误
# 验证accessoriesAPI.getAll()返回数据
```

### 问题2: 智能推荐不工作
**原因**: 推荐算法条件不满足  
**排查**:
- 确认阀门类型选择了"Ball Valve"或"Butterfly Valve"
- 确认配件数据库中有包含"定位器"的配件

### 问题3: PDF不显示配件
**原因**: 数据未正确保存  
**排查**:
- 检查数据库中的`selected_accessories`字段
- 检查`total_price`是否包含配件价格

### 问题4: 总价计算错误
**排查**:
```javascript
// 手动计算验证
总价 = 执行器价格 + (手轮价格 || 0) + Σ(配件单价 × 数量)
```

---

## ✅ 测试完成清单

- [ ] 完整选型流程测试（包含配件）
- [ ] 智能推荐功能测试
- [ ] 配件浏览和选择测试
- [ ] 最终汇总显示测试
- [ ] 技术规格书PDF测试
- [ ] 报价单PDF测试
- [ ] 不选配件情况测试
- [ ] 不需要手轮流程测试
- [ ] 边缘情况测试
- [ ] 数据库数据验证

---

## 📝 测试报告模板

```markdown
## 配件选配功能测试报告

**测试时间**: YYYY-MM-DD HH:mm
**测试人员**: XXX
**测试环境**: 
- 后端: http://localhost:5001
- 前端: http://localhost:5173

### 测试结果

| 测试项 | 状态 | 备注 |
|-------|------|------|
| 完整选型流程 | ✅ / ❌ | |
| 智能推荐 | ✅ / ❌ | |
| 配件选择交互 | ✅ / ❌ | |
| 最终汇总 | ✅ / ❌ | |
| 技术规格书PDF | ✅ / ❌ | |
| 报价单PDF | ✅ / ❌ | |
| 数据保存 | ✅ / ❌ | |

### 发现的问题
1. 
2. 
3. 

### 改进建议
1. 
2. 
3. 
```

---

**祝测试顺利！** 🎉

如有任何问题，请参考 [在线配件选配功能完成报告.md](./在线配件选配功能完成报告.md)

