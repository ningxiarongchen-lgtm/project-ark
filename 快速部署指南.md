# 🚀 快速部署指南

## 📋 目录

1. [测试环境部署](#测试环境部署)
2. [生产环境部署](#生产环境部署)
3. [常用命令](#常用命令)
4. [故障排查](#故障排查)

---

## 测试环境部署

### 一键启动（推荐）

```bash
# 启动测试环境
bash 演示环境启动.sh

# 访问系统
# 前端: http://localhost:5173
# 后端: http://localhost:5001

# 停止测试环境
bash 停止演示环境.sh
```

### 测试账号

| 角色 | 账号 | 密码 |
|------|------|------|
| 管理员 | 13000000001 | password |
| 销售经理 | 13000000002 | password |
| 技术工程师 | 13000000003 | password |

---

## 生产环境部署

### 前置准备

#### 1. 配置生产环境变量

```bash
# 1. 复制配置模板
cp backend/env.production.template backend/.env.production

# 2. 生成安全密钥（已生成，查看文件）
cat JWT密钥-生产环境专用.txt

# 3. 编辑配置文件
nano backend/.env.production

# 4. 填入以下必要配置：
# - JWT_SECRET（从JWT密钥文件复制）
# - JWT_REFRESH_SECRET（从JWT密钥文件复制）
# - SESSION_SECRET（从JWT密钥文件复制）
# - MONGODB_URI（数据库连接字符串）
# - ALLOWED_ORIGINS（前端域名）
```

#### 2. 运行部署前检查

```bash
# 检查系统是否就绪
bash deploy-check.sh

# 确保所有关键检查通过
```

### 一键部署

```bash
# 执行部署脚本
bash deploy-production.sh

# 脚本会自动完成：
# ✅ 系统环境检查
# ✅ 配置文件验证
# ✅ 代码和数据库备份
# ✅ 依赖安装
# ✅ 前端构建
# ✅ 服务启动
# ✅ 健康检查
```

### 分步部署（可选）

如果您想手动控制每一步：

```bash
# 1. 安装依赖
cd backend
npm ci --production
cd ../frontend
npm ci

# 2. 构建前端
cd frontend
npm run build

# 3. 备份数据库
bash backup-database.sh

# 4. 启动后端（使用PM2）
cd backend
pm2 start ../ecosystem.config.js --env production

# 5. 部署前端到Nginx（如果已配置）
sudo cp -r frontend/dist/* /var/www/cmax/frontend/

# 6. 验证服务
curl http://localhost:5001/api/health
```

---

## 常用命令

### PM2进程管理

```bash
# 查看服务状态
pm2 status

# 查看日志（实时）
pm2 logs cmax-backend

# 查看日志（最近50行）
pm2 logs cmax-backend --lines 50

# 重启服务
pm2 restart cmax-backend

# 停止服务
pm2 stop cmax-backend

# 重新加载（零停机）
pm2 reload cmax-backend

# 删除进程
pm2 delete cmax-backend

# 查看进程详情
pm2 describe cmax-backend

# 监控CPU和内存
pm2 monit
```

### 数据库管理

```bash
# 备份数据库
bash backup-database.sh

# 恢复数据库
bash restore-database.sh

# 手动备份
mongodump --db=cmax_production --out=./backup_manual

# 手动恢复
mongorestore --db=cmax_production --drop ./backup_manual/cmax_production
```

### 系统维护

```bash
# 查看系统资源
htop

# 查看磁盘使用
df -h

# 查看数据库备份大小
du -sh database_backups/*

# 清理旧日志
find logs/ -name "*.log" -mtime +30 -delete

# 清理旧备份（保留最近30天）
find database_backups/ -name "*.tar.gz" -mtime +30 -delete
```

---

## 回滚操作

如果部署出现问题，快速回滚：

```bash
# 使用回滚脚本
bash rollback.sh

# 脚本会：
# 1. 列出所有可用备份
# 2. 选择要回滚的版本
# 3. 自动停止服务
# 4. 恢复代码和配置
# 5. 重新安装依赖
# 6. 重启服务
# 7. 健康检查
```

### 手动回滚

```bash
# 1. 停止服务
pm2 stop cmax-backend

# 2. 查看备份列表
ls -lh backups/

# 3. 恢复备份（替换为实际备份文件名）
tar -xzf backups/backup_20251030_143000.tar.gz

# 4. 重新安装依赖
cd backend && npm ci --production
cd ../frontend && npm ci && npm run build

# 5. 重启服务
pm2 restart cmax-backend

# 6. 验证
curl http://localhost:5001/api/health
```

---

## 故障排查

### 问题1：后端服务无法启动

**症状**：`pm2 logs` 显示错误

**排查步骤**：

```bash
# 1. 查看详细日志
pm2 logs cmax-backend --lines 100

# 2. 检查配置文件
cat backend/.env.production | grep -v "^#" | grep -v "^$"

# 3. 检查数据库连接
mongo mongodb://localhost:27017/cmax_production --eval "db.stats()"

# 4. 检查端口占用
lsof -i :5001

# 5. 手动启动测试
cd backend
NODE_ENV=production node server.js
```

**常见原因**：
- JWT密钥未配置
- 数据库连接失败
- 端口已被占用
- 依赖包缺失

### 问题2：MongoDB连接失败

**症状**：`MongoNetworkError` 或 `Authentication failed`

**排查步骤**：

```bash
# 1. 检查MongoDB服务
sudo systemctl status mongod

# 2. 检查端口
lsof -i :27017

# 3. 测试连接
mongo --eval "db.serverStatus()"

# 4. 检查认证配置
mongo admin --eval "db.getUsers()"
```

**解决方案**：

```bash
# 启动MongoDB
sudo systemctl start mongod

# 或使用Homebrew（Mac）
brew services start mongodb-community
```

### 问题3：前端页面无法访问

**症状**：访问域名显示404或502

**排查步骤**：

```bash
# 1. 检查Nginx状态
sudo systemctl status nginx

# 2. 检查Nginx配置
sudo nginx -t

# 3. 查看Nginx错误日志
sudo tail -f /var/log/nginx/error.log

# 4. 检查静态文件
ls -la /var/www/cmax/frontend/dist/

# 5. 检查后端API
curl http://localhost:5001/api/health
```

**解决方案**：

```bash
# 重新构建前端
cd frontend
npm run build

# 重新部署
sudo cp -r dist/* /var/www/cmax/frontend/

# 重启Nginx
sudo systemctl restart nginx
```

### 问题4：API返回401错误

**症状**：登录失败或Token无效

**排查步骤**：

```bash
# 1. 检查JWT密钥
grep JWT_SECRET backend/.env.production

# 2. 检查环境变量加载
cd backend
node -e "require('dotenv').config({path: '.env.production'}); console.log(process.env.JWT_SECRET)"

# 3. 检查用户数据
mongo cmax_production --eval "db.users.count()"
```

**解决方案**：
- 确认JWT密钥已正确配置
- 清除浏览器缓存和Cookie
- 重新登录

### 问题5：性能问题

**症状**：响应慢或超时

**排查步骤**：

```bash
# 1. 检查系统资源
htop

# 2. 检查PM2进程
pm2 monit

# 3. 检查数据库性能
mongo cmax_production --eval "db.currentOp()"

# 4. 检查慢查询
mongo cmax_production --eval "db.getProfilingStatus()"
```

**优化建议**：
- 增加PM2实例数
- 添加数据库索引
- 启用Redis缓存
- 使用CDN加速静态资源

---

## 监控和维护

### 日常检查（每天）

```bash
# 1. 查看服务状态
pm2 status

# 2. 查看磁盘空间
df -h

# 3. 查看最近日志
pm2 logs cmax-backend --lines 50

# 4. 数据库备份检查
ls -lh database_backups/ | tail -1
```

### 每周维护

```bash
# 1. 清理旧日志
find logs/ -name "*.log" -mtime +7 -delete

# 2. 清理旧备份
find backups/ -name "*.tar.gz" -mtime +14 -delete

# 3. 重启服务（零停机）
pm2 reload cmax-backend

# 4. 更新系统包
sudo apt update && sudo apt upgrade -y
```

### 性能监控

```bash
# 安装性能监控工具
npm install -g pm2-server-monit

# 启动监控
pm2-server-monit

# 或使用PM2内置监控
pm2 plus
```

---

## 更新和升级

### 更新代码

```bash
# 1. 备份当前版本
tar -czf backups/backup_before_update_$(date +%Y%m%d).tar.gz backend/ frontend/

# 2. 拉取最新代码
git pull origin main

# 3. 更新依赖
cd backend && npm ci --production
cd ../frontend && npm ci

# 4. 重新构建前端
cd frontend && npm run build

# 5. 重启服务
pm2 reload cmax-backend

# 6. 验证
curl http://localhost:5001/api/health
```

### 数据库迁移

```bash
# 如果有数据库结构变更

# 1. 备份数据库
bash backup-database.sh

# 2. 运行迁移脚本
cd backend
node migrations/migrate.js

# 3. 验证迁移
mongo cmax_production --eval "db.stats()"
```

---

## 安全建议

### 必须完成（生产环境）

- ✅ 更换默认JWT密钥
- ✅ 启用HTTPS（SSL证书）
- ✅ 配置防火墙规则
- ✅ 启用MongoDB认证
- ✅ 定期更新系统和依赖
- ✅ 设置定期备份
- ✅ 配置日志监控

### 推荐完成

- 配置Rate Limiting（防止API滥用）
- 启用CORS白名单
- 使用环境变量管理敏感信息
- 配置错误追踪（如Sentry）
- 设置监控告警
- 定期安全审计

---

## 联系支持

如遇到部署问题，请：

1. 查看本文档的故障排查部分
2. 检查系统日志：`pm2 logs`
3. 查看详细文档：`docs/` 目录
4. 运行诊断：`bash deploy-check.sh`

---

**祝部署顺利！** 🚀

最后更新：2025-10-30  
版本：v1.0.0

