# ğŸš€ å¿«é€Ÿéƒ¨ç½²æŒ‡å—

## ğŸ“‹ ç›®å½•

1. [æµ‹è¯•ç¯å¢ƒéƒ¨ç½²](#æµ‹è¯•ç¯å¢ƒéƒ¨ç½²)
2. [ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²](#ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²)
3. [å¸¸ç”¨å‘½ä»¤](#å¸¸ç”¨å‘½ä»¤)
4. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## æµ‹è¯•ç¯å¢ƒéƒ¨ç½²

### ä¸€é”®å¯åŠ¨ï¼ˆæ¨èï¼‰

```bash
# å¯åŠ¨æµ‹è¯•ç¯å¢ƒ
bash æ¼”ç¤ºç¯å¢ƒå¯åŠ¨.sh

# è®¿é—®ç³»ç»Ÿ
# å‰ç«¯: http://localhost:5173
# åç«¯: http://localhost:5001

# åœæ­¢æµ‹è¯•ç¯å¢ƒ
bash åœæ­¢æ¼”ç¤ºç¯å¢ƒ.sh
```

### æµ‹è¯•è´¦å·

| è§’è‰² | è´¦å· | å¯†ç  |
|------|------|------|
| ç®¡ç†å‘˜ | 13000000001 | password |
| é”€å”®ç»ç† | 13000000002 | password |
| æŠ€æœ¯å·¥ç¨‹å¸ˆ | 13000000003 | password |

---

## ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### å‰ç½®å‡†å¤‡

#### 1. é…ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡

```bash
# 1. å¤åˆ¶é…ç½®æ¨¡æ¿
cp backend/env.production.template backend/.env.production

# 2. ç”Ÿæˆå®‰å…¨å¯†é’¥ï¼ˆå·²ç”Ÿæˆï¼ŒæŸ¥çœ‹æ–‡ä»¶ï¼‰
cat JWTå¯†é’¥-ç”Ÿäº§ç¯å¢ƒä¸“ç”¨.txt

# 3. ç¼–è¾‘é…ç½®æ–‡ä»¶
nano backend/.env.production

# 4. å¡«å…¥ä»¥ä¸‹å¿…è¦é…ç½®ï¼š
# - JWT_SECRETï¼ˆä»JWTå¯†é’¥æ–‡ä»¶å¤åˆ¶ï¼‰
# - JWT_REFRESH_SECRETï¼ˆä»JWTå¯†é’¥æ–‡ä»¶å¤åˆ¶ï¼‰
# - SESSION_SECRETï¼ˆä»JWTå¯†é’¥æ–‡ä»¶å¤åˆ¶ï¼‰
# - MONGODB_URIï¼ˆæ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼‰
# - ALLOWED_ORIGINSï¼ˆå‰ç«¯åŸŸåï¼‰
```

#### 2. è¿è¡Œéƒ¨ç½²å‰æ£€æŸ¥

```bash
# æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦å°±ç»ª
bash deploy-check.sh

# ç¡®ä¿æ‰€æœ‰å…³é”®æ£€æŸ¥é€šè¿‡
```

### ä¸€é”®éƒ¨ç½²

```bash
# æ‰§è¡Œéƒ¨ç½²è„šæœ¬
bash deploy-production.sh

# è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆï¼š
# âœ… ç³»ç»Ÿç¯å¢ƒæ£€æŸ¥
# âœ… é…ç½®æ–‡ä»¶éªŒè¯
# âœ… ä»£ç å’Œæ•°æ®åº“å¤‡ä»½
# âœ… ä¾èµ–å®‰è£…
# âœ… å‰ç«¯æ„å»º
# âœ… æœåŠ¡å¯åŠ¨
# âœ… å¥åº·æ£€æŸ¥
```

### åˆ†æ­¥éƒ¨ç½²ï¼ˆå¯é€‰ï¼‰

å¦‚æœæ‚¨æƒ³æ‰‹åŠ¨æ§åˆ¶æ¯ä¸€æ­¥ï¼š

```bash
# 1. å®‰è£…ä¾èµ–
cd backend
npm ci --production
cd ../frontend
npm ci

# 2. æ„å»ºå‰ç«¯
cd frontend
npm run build

# 3. å¤‡ä»½æ•°æ®åº“
bash backup-database.sh

# 4. å¯åŠ¨åç«¯ï¼ˆä½¿ç”¨PM2ï¼‰
cd backend
pm2 start ../ecosystem.config.js --env production

# 5. éƒ¨ç½²å‰ç«¯åˆ°Nginxï¼ˆå¦‚æœå·²é…ç½®ï¼‰
sudo cp -r frontend/dist/* /var/www/cmax/frontend/

# 6. éªŒè¯æœåŠ¡
curl http://localhost:5001/api/health
```

---

## å¸¸ç”¨å‘½ä»¤

### PM2è¿›ç¨‹ç®¡ç†

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—ï¼ˆå®æ—¶ï¼‰
pm2 logs cmax-backend

# æŸ¥çœ‹æ—¥å¿—ï¼ˆæœ€è¿‘50è¡Œï¼‰
pm2 logs cmax-backend --lines 50

# é‡å¯æœåŠ¡
pm2 restart cmax-backend

# åœæ­¢æœåŠ¡
pm2 stop cmax-backend

# é‡æ–°åŠ è½½ï¼ˆé›¶åœæœºï¼‰
pm2 reload cmax-backend

# åˆ é™¤è¿›ç¨‹
pm2 delete cmax-backend

# æŸ¥çœ‹è¿›ç¨‹è¯¦æƒ…
pm2 describe cmax-backend

# ç›‘æ§CPUå’Œå†…å­˜
pm2 monit
```

### æ•°æ®åº“ç®¡ç†

```bash
# å¤‡ä»½æ•°æ®åº“
bash backup-database.sh

# æ¢å¤æ•°æ®åº“
bash restore-database.sh

# æ‰‹åŠ¨å¤‡ä»½
mongodump --db=cmax_production --out=./backup_manual

# æ‰‹åŠ¨æ¢å¤
mongorestore --db=cmax_production --drop ./backup_manual/cmax_production
```

### ç³»ç»Ÿç»´æŠ¤

```bash
# æŸ¥çœ‹ç³»ç»Ÿèµ„æº
htop

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æŸ¥çœ‹æ•°æ®åº“å¤‡ä»½å¤§å°
du -sh database_backups/*

# æ¸…ç†æ—§æ—¥å¿—
find logs/ -name "*.log" -mtime +30 -delete

# æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘30å¤©ï¼‰
find database_backups/ -name "*.tar.gz" -mtime +30 -delete
```

---

## å›æ»šæ“ä½œ

å¦‚æœéƒ¨ç½²å‡ºç°é—®é¢˜ï¼Œå¿«é€Ÿå›æ»šï¼š

```bash
# ä½¿ç”¨å›æ»šè„šæœ¬
bash rollback.sh

# è„šæœ¬ä¼šï¼š
# 1. åˆ—å‡ºæ‰€æœ‰å¯ç”¨å¤‡ä»½
# 2. é€‰æ‹©è¦å›æ»šçš„ç‰ˆæœ¬
# 3. è‡ªåŠ¨åœæ­¢æœåŠ¡
# 4. æ¢å¤ä»£ç å’Œé…ç½®
# 5. é‡æ–°å®‰è£…ä¾èµ–
# 6. é‡å¯æœåŠ¡
# 7. å¥åº·æ£€æŸ¥
```

### æ‰‹åŠ¨å›æ»š

```bash
# 1. åœæ­¢æœåŠ¡
pm2 stop cmax-backend

# 2. æŸ¥çœ‹å¤‡ä»½åˆ—è¡¨
ls -lh backups/

# 3. æ¢å¤å¤‡ä»½ï¼ˆæ›¿æ¢ä¸ºå®é™…å¤‡ä»½æ–‡ä»¶åï¼‰
tar -xzf backups/backup_20251030_143000.tar.gz

# 4. é‡æ–°å®‰è£…ä¾èµ–
cd backend && npm ci --production
cd ../frontend && npm ci && npm run build

# 5. é‡å¯æœåŠ¡
pm2 restart cmax-backend

# 6. éªŒè¯
curl http://localhost:5001/api/health
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šåç«¯æœåŠ¡æ— æ³•å¯åŠ¨

**ç—‡çŠ¶**ï¼š`pm2 logs` æ˜¾ç¤ºé”™è¯¯

**æ’æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
pm2 logs cmax-backend --lines 100

# 2. æ£€æŸ¥é…ç½®æ–‡ä»¶
cat backend/.env.production | grep -v "^#" | grep -v "^$"

# 3. æ£€æŸ¥æ•°æ®åº“è¿æ¥
mongo mongodb://localhost:27017/cmax_production --eval "db.stats()"

# 4. æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :5001

# 5. æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•
cd backend
NODE_ENV=production node server.js
```

**å¸¸è§åŸå› **ï¼š
- JWTå¯†é’¥æœªé…ç½®
- æ•°æ®åº“è¿æ¥å¤±è´¥
- ç«¯å£å·²è¢«å ç”¨
- ä¾èµ–åŒ…ç¼ºå¤±

### é—®é¢˜2ï¼šMongoDBè¿æ¥å¤±è´¥

**ç—‡çŠ¶**ï¼š`MongoNetworkError` æˆ– `Authentication failed`

**æ’æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æ£€æŸ¥MongoDBæœåŠ¡
sudo systemctl status mongod

# 2. æ£€æŸ¥ç«¯å£
lsof -i :27017

# 3. æµ‹è¯•è¿æ¥
mongo --eval "db.serverStatus()"

# 4. æ£€æŸ¥è®¤è¯é…ç½®
mongo admin --eval "db.getUsers()"
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# å¯åŠ¨MongoDB
sudo systemctl start mongod

# æˆ–ä½¿ç”¨Homebrewï¼ˆMacï¼‰
brew services start mongodb-community
```

### é—®é¢˜3ï¼šå‰ç«¯é¡µé¢æ— æ³•è®¿é—®

**ç—‡çŠ¶**ï¼šè®¿é—®åŸŸåæ˜¾ç¤º404æˆ–502

**æ’æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æ£€æŸ¥NginxçŠ¶æ€
sudo systemctl status nginx

# 2. æ£€æŸ¥Nginxé…ç½®
sudo nginx -t

# 3. æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log

# 4. æ£€æŸ¥é™æ€æ–‡ä»¶
ls -la /var/www/cmax/frontend/dist/

# 5. æ£€æŸ¥åç«¯API
curl http://localhost:5001/api/health
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# é‡æ–°æ„å»ºå‰ç«¯
cd frontend
npm run build

# é‡æ–°éƒ¨ç½²
sudo cp -r dist/* /var/www/cmax/frontend/

# é‡å¯Nginx
sudo systemctl restart nginx
```

### é—®é¢˜4ï¼šAPIè¿”å›401é”™è¯¯

**ç—‡çŠ¶**ï¼šç™»å½•å¤±è´¥æˆ–Tokenæ— æ•ˆ

**æ’æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æ£€æŸ¥JWTå¯†é’¥
grep JWT_SECRET backend/.env.production

# 2. æ£€æŸ¥ç¯å¢ƒå˜é‡åŠ è½½
cd backend
node -e "require('dotenv').config({path: '.env.production'}); console.log(process.env.JWT_SECRET)"

# 3. æ£€æŸ¥ç”¨æˆ·æ•°æ®
mongo cmax_production --eval "db.users.count()"
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®è®¤JWTå¯†é’¥å·²æ­£ç¡®é…ç½®
- æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’ŒCookie
- é‡æ–°ç™»å½•

### é—®é¢˜5ï¼šæ€§èƒ½é—®é¢˜

**ç—‡çŠ¶**ï¼šå“åº”æ…¢æˆ–è¶…æ—¶

**æ’æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æ£€æŸ¥ç³»ç»Ÿèµ„æº
htop

# 2. æ£€æŸ¥PM2è¿›ç¨‹
pm2 monit

# 3. æ£€æŸ¥æ•°æ®åº“æ€§èƒ½
mongo cmax_production --eval "db.currentOp()"

# 4. æ£€æŸ¥æ…¢æŸ¥è¯¢
mongo cmax_production --eval "db.getProfilingStatus()"
```

**ä¼˜åŒ–å»ºè®®**ï¼š
- å¢åŠ PM2å®ä¾‹æ•°
- æ·»åŠ æ•°æ®åº“ç´¢å¼•
- å¯ç”¨Redisç¼“å­˜
- ä½¿ç”¨CDNåŠ é€Ÿé™æ€èµ„æº

---

## ç›‘æ§å’Œç»´æŠ¤

### æ—¥å¸¸æ£€æŸ¥ï¼ˆæ¯å¤©ï¼‰

```bash
# 1. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
pm2 status

# 2. æŸ¥çœ‹ç£ç›˜ç©ºé—´
df -h

# 3. æŸ¥çœ‹æœ€è¿‘æ—¥å¿—
pm2 logs cmax-backend --lines 50

# 4. æ•°æ®åº“å¤‡ä»½æ£€æŸ¥
ls -lh database_backups/ | tail -1
```

### æ¯å‘¨ç»´æŠ¤

```bash
# 1. æ¸…ç†æ—§æ—¥å¿—
find logs/ -name "*.log" -mtime +7 -delete

# 2. æ¸…ç†æ—§å¤‡ä»½
find backups/ -name "*.tar.gz" -mtime +14 -delete

# 3. é‡å¯æœåŠ¡ï¼ˆé›¶åœæœºï¼‰
pm2 reload cmax-backend

# 4. æ›´æ–°ç³»ç»ŸåŒ…
sudo apt update && sudo apt upgrade -y
```

### æ€§èƒ½ç›‘æ§

```bash
# å®‰è£…æ€§èƒ½ç›‘æ§å·¥å…·
npm install -g pm2-server-monit

# å¯åŠ¨ç›‘æ§
pm2-server-monit

# æˆ–ä½¿ç”¨PM2å†…ç½®ç›‘æ§
pm2 plus
```

---

## æ›´æ–°å’Œå‡çº§

### æ›´æ–°ä»£ç 

```bash
# 1. å¤‡ä»½å½“å‰ç‰ˆæœ¬
tar -czf backups/backup_before_update_$(date +%Y%m%d).tar.gz backend/ frontend/

# 2. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 3. æ›´æ–°ä¾èµ–
cd backend && npm ci --production
cd ../frontend && npm ci

# 4. é‡æ–°æ„å»ºå‰ç«¯
cd frontend && npm run build

# 5. é‡å¯æœåŠ¡
pm2 reload cmax-backend

# 6. éªŒè¯
curl http://localhost:5001/api/health
```

### æ•°æ®åº“è¿ç§»

```bash
# å¦‚æœæœ‰æ•°æ®åº“ç»“æ„å˜æ›´

# 1. å¤‡ä»½æ•°æ®åº“
bash backup-database.sh

# 2. è¿è¡Œè¿ç§»è„šæœ¬
cd backend
node migrations/migrate.js

# 3. éªŒè¯è¿ç§»
mongo cmax_production --eval "db.stats()"
```

---

## å®‰å…¨å»ºè®®

### å¿…é¡»å®Œæˆï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

- âœ… æ›´æ¢é»˜è®¤JWTå¯†é’¥
- âœ… å¯ç”¨HTTPSï¼ˆSSLè¯ä¹¦ï¼‰
- âœ… é…ç½®é˜²ç«å¢™è§„åˆ™
- âœ… å¯ç”¨MongoDBè®¤è¯
- âœ… å®šæœŸæ›´æ–°ç³»ç»Ÿå’Œä¾èµ–
- âœ… è®¾ç½®å®šæœŸå¤‡ä»½
- âœ… é…ç½®æ—¥å¿—ç›‘æ§

### æ¨èå®Œæˆ

- é…ç½®Rate Limitingï¼ˆé˜²æ­¢APIæ»¥ç”¨ï¼‰
- å¯ç”¨CORSç™½åå•
- ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†æ•æ„Ÿä¿¡æ¯
- é…ç½®é”™è¯¯è¿½è¸ªï¼ˆå¦‚Sentryï¼‰
- è®¾ç½®ç›‘æ§å‘Šè­¦
- å®šæœŸå®‰å…¨å®¡è®¡

---

## è”ç³»æ”¯æŒ

å¦‚é‡åˆ°éƒ¨ç½²é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„æ•…éšœæ’æŸ¥éƒ¨åˆ†
2. æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—ï¼š`pm2 logs`
3. æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£ï¼š`docs/` ç›®å½•
4. è¿è¡Œè¯Šæ–­ï¼š`bash deploy-check.sh`

---

**ç¥éƒ¨ç½²é¡ºåˆ©ï¼** ğŸš€

æœ€åæ›´æ–°ï¼š2025-10-30  
ç‰ˆæœ¬ï¼šv1.0.0

