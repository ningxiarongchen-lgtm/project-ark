# 增强版选型算法说明文档

## 📅 更新时间
2025-10-27

---

## 🎯 概述

根据您提供的伪代码，我们实现了增强版的执行器选型算法。新算法提供了更灵活、更精确的匹配逻辑。

---

## 🚀 核心改进

### 1. 支持安全系数 ⭐
现在可以输入阀门扭矩和安全系数，系统自动计算所需扭矩。

**使用示例**:
```javascript
{
  "valve_torque": 500,      // 阀门扭矩 500 Nm
  "safety_factor": 1.2,     // 安全系数 1.2
  // 系统自动计算：所需扭矩 = 500 × 1.2 = 600 Nm
  "working_pressure": 0.5
}
```

### 2. 轭架偏好系统 ⭐⭐⭐
支持三种轭架偏好模式：

#### Auto 模式（自动）
```javascript
{
  "yoke_preference": "Auto"
}
```
- 优先匹配对称轭架
- 如果对称不满足，尝试倾斜轭架
- 如果两种都满足，标记为 "Both"

#### Symmetric 模式（仅对称）
```javascript
{
  "yoke_preference": "Symmetric"
}
```
- 仅考虑对称轭架
- 只返回对称轭架满足要求的执行器

#### Canted 模式（仅倾斜）
```javascript
{
  "yoke_preference": "Canted"
}
```
- 仅考虑倾斜轭架
- 只返回倾斜轭架满足要求的执行器

### 3. 详细的轭架匹配逻辑 ⭐⭐

**算法流程**:
```
1. 获取候选执行器
   ↓
2. 对每个执行器：
   • 检查对称轭架扭矩是否满足
   • 检查倾斜轭架扭矩是否满足
   ↓
3. 根据轭架偏好决定是否包含：
   • Symmetric: 仅对称满足 → 包含
   • Canted: 仅倾斜满足 → 包含
   • Auto: 任一满足 → 包含，标记推荐类型
   ↓
4. 按价格排序（从低到高）
```

### 4. 推荐轭架类型标记 ⭐

每个结果都标记了推荐的轭架类型：

```javascript
{
  "recommended_yoke": "Symmetric",  // 或 "Canted" 或 "Both"
  "symmetric_torque": 858,          // 对称轭架扭矩
  "canted_torque": 1158            // 倾斜轭架扭矩
}
```

### 5. 按价格排序 ⭐

结果按价格从低到高排序，而不是按扭矩排序：

```javascript
// 旧版：按扭矩排序（最接近需求的）
// 新版：按价格排序（最经济的）

results.sort((a, b) => a.price - b.price);
```

### 6. 更智能的预算过滤 ⭐

在匹配过程中就进行预算过滤，提高效率：

```javascript
{
  "max_budget": 7000  // 仅返回价格 ≤ 7000 的执行器
}
```

---

## 📝 完整API使用示例

### 基础选型
```javascript
POST /api/selection/calculate

{
  "required_torque": 600,
  "working_pressure": 0.5,
  "yoke_preference": "Auto"
}
```

### 使用安全系数
```javascript
POST /api/selection/calculate

{
  "valve_torque": 500,
  "safety_factor": 1.2,        // 所需扭矩 = 600 Nm
  "working_pressure": 0.5,
  "working_angle": 0,
  "yoke_preference": "Auto"
}
```

### 指定轭架类型
```javascript
POST /api/selection/calculate

{
  "required_torque": 600,
  "working_pressure": 0.5,
  "yoke_preference": "Symmetric",  // 仅对称轭架
  "action_type_preference": "SR"    // 仅单作用弹簧复位
}
```

### 带预算限制
```javascript
POST /api/selection/calculate

{
  "required_torque": 600,
  "working_pressure": 0.5,
  "yoke_preference": "Auto",
  "max_budget": 7000,              // 预算上限
  "needs_manual_override": true     // 需要手动装置
}
```

### 完整参数示例
```javascript
POST /api/selection/calculate

{
  // 扭矩参数（二选一）
  "valve_torque": 500,              // 阀门扭矩
  "safety_factor": 1.2,             // 安全系数
  // 或直接提供
  "required_torque": 600,           // 所需扭矩
  
  // 必需参数
  "working_pressure": 0.5,          // 工作压力（MPa）
  
  // 可选参数
  "working_angle": 0,               // 工作角度（0 或 90）
  "yoke_preference": "Auto",        // 轭架偏好
  "action_type_preference": "SR",   // 作用类型偏好
  "body_size_preference": "SF12",   // 本体尺寸偏好
  "max_budget": 10000,              // 最大预算
  "needs_manual_override": true     // 是否需要手动装置
}
```

---

## 📊 响应结构

### 成功响应
```json
{
  "success": true,
  "message": "找到 4 个满足要求的执行器",
  "count": 4,
  "search_criteria": {
    "valve_torque": 500,
    "safety_factor": 1.2,
    "required_torque": 600,
    "working_pressure": 0.5,
    "working_angle": 0,
    "yoke_preference": "Auto",
    "action_type_preference": "不限",
    "needs_manual_override": true,
    "max_budget": "不限"
  },
  "data": [
    {
      "_id": "...",
      "model_base": "SF12-250SR",
      "body_size": "SF12",
      "action_type": "SR",
      "price": 6500,
      "actual_torque": 858,
      "torque_margin": 43.00,
      "recommended_yoke": "Symmetric",
      "recommend_level": "强烈推荐",
      "symmetric_torque": 858,
      "canted_torque": 1158,
      "lead_time": "14天",
      "manual_override": {
        "_id": "...",
        "model": "HG",
        "price": 800
      },
      "total_price": 7300,
      "compatible_overrides_count": 2
    },
    // ... 更多结果（按价格排序）
  ],
  "best_choice": {
    // 价格最低的选项
  },
  "timestamp": "2025-10-27T03:00:00.000Z"
}
```

### 失败响应
```json
{
  "success": false,
  "message": "未找到满足要求的执行器",
  "suggestions": [
    "尝试降低扭矩要求或减小安全系数",
    "选择更高的工作压力",
    "考虑使用倾斜轭架（扭矩更大）",
    "增加预算限制",
    "联系技术支持获取定制方案"
  ],
  "search_criteria": {
    "required_torque": 1000,
    "valve_torque": 800,
    "safety_factor": 1.25,
    "working_pressure": 0.3,
    "yoke_preference": "Symmetric",
    "max_budget": 5000
  }
}
```

---

## 🔄 算法逻辑详解

### 伪代码实现

```javascript
function findMatchingActuators(inputs) {
  const { 
    valve_torque, 
    safety_factor, 
    required_torque,
    working_pressure, 
    yoke_preference 
  } = inputs;
  
  // 计算实际所需扭矩
  const finalRequiredTorque = required_torque || 
                               (valve_torque * safety_factor);
  
  // 1. 从数据库获取候选执行器
  let candidateActuators = await Actuator.find(query);
  
  let finalResults = [];
  
  // 2. 循环并详细匹配
  for (const actuator of candidateActuators) {
    let isSymmetricMatch = false;
    let isCantedMatch = false;
    
    // 检查对称轭架扭矩
    const symmetricTorque = actuator.torque_symmetric.get(key);
    if (symmetricTorque >= finalRequiredTorque) {
      isSymmetricMatch = true;
    }
    
    // 检查倾斜轭架扭矩
    const cantedTorque = actuator.torque_canted.get(key);
    if (cantedTorque >= finalRequiredTorque) {
      isCantedMatch = true;
    }
    
    // 3. 根据偏好确定最终推荐
    if (yoke_preference === 'Symmetric' && isSymmetricMatch) {
      actuator.recommended_yoke = 'Symmetric';
      finalResults.push(actuator);
    } 
    else if (yoke_preference === 'Canted' && isCantedMatch) {
      actuator.recommended_yoke = 'Canted';
      finalResults.push(actuator);
    } 
    else if (yoke_preference === 'Auto') {
      if (isSymmetricMatch && isCantedMatch) {
        actuator.recommended_yoke = 'Both';
        finalResults.push(actuator);
      } else if (isSymmetricMatch) {
        actuator.recommended_yoke = 'Symmetric';
        finalResults.push(actuator);
      } else if (isCantedMatch) {
        actuator.recommended_yoke = 'Canted';
        finalResults.push(actuator);
      }
    }
  }
  
  // 4. 按价格排序（从低到高）
  return finalResults.sort((a, b) => a.price - b.price);
}
```

---

## 📈 使用场景对比

### 场景 1: 标准选型
**需求**: 选择满足600Nm扭矩要求的执行器

**旧版**:
```javascript
{
  "required_torque": 600,
  "working_pressure": 0.5,
  "yoke_type": "symmetric"  // 只检查对称
}
```

**新版**:
```javascript
{
  "required_torque": 600,
  "working_pressure": 0.5,
  "yoke_preference": "Auto"  // 自动检查两种轭架
}
```

**改进**: 新版会同时检查对称和倾斜轭架，提供更多选择。

---

### 场景 2: 考虑安全系数
**需求**: 阀门扭矩500Nm，安全系数1.2

**旧版**:
```javascript
// 需要手动计算
{
  "required_torque": 600,  // 手动计算 500 × 1.2
  "working_pressure": 0.5
}
```

**新版**:
```javascript
{
  "valve_torque": 500,
  "safety_factor": 1.2,     // 系统自动计算
  "working_pressure": 0.5
}
```

**改进**: 系统自动计算，减少人为错误。

---

### 场景 3: 预算敏感
**需求**: 找最便宜的满足要求的执行器

**旧版**:
```javascript
// 按扭矩排序，需要手动筛选价格
{
  "required_torque": 600,
  "working_pressure": 0.5
}
// 结果：SF14-400DA ($8000) - 扭矩最接近
```

**新版**:
```javascript
// 按价格排序，直接返回最便宜的
{
  "required_torque": 600,
  "working_pressure": 0.5,
  "yoke_preference": "Auto"
}
// 结果：SF12-250SR ($6500) - 价格最低
```

**改进**: 默认推荐最经济的方案。

---

## 🎯 推荐等级说明

系统根据扭矩裕度自动计算推荐等级：

| 扭矩裕度 | 推荐等级 | 说明 |
|---------|---------|------|
| 20% - 50% | 强烈推荐 | 扭矩裕度适中，最佳选择 |
| 10% - 20% | 推荐 | 扭矩裕度较小，可以使用 |
| 0% - 10% | 勉强可用 | 扭矩裕度很小，建议慎重 |
| > 50% | 可选 | 扭矩裕度过大，可能浪费 |

**计算公式**:
```
扭矩裕度 = (实际扭矩 - 所需扭矩) / 所需扭矩 × 100%
```

---

## 🧪 测试用例

### 测试 1: 基础功能
```bash
curl -X POST http://localhost:5001/api/selection/calculate \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "required_torque": 600,
    "working_pressure": 0.5,
    "yoke_preference": "Auto"
  }'
```

### 测试 2: 安全系数
```bash
curl -X POST http://localhost:5001/api/selection/calculate \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "valve_torque": 500,
    "safety_factor": 1.2,
    "working_pressure": 0.5,
    "yoke_preference": "Auto"
  }'
```

### 测试 3: 仅对称轭架
```bash
curl -X POST http://localhost:5001/api/selection/calculate \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "required_torque": 600,
    "working_pressure": 0.5,
    "yoke_preference": "Symmetric"
  }'
```

### 测试 4: 预算限制
```bash
curl -X POST http://localhost:5001/api/selection/calculate \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "required_torque": 600,
    "working_pressure": 0.5,
    "yoke_preference": "Auto",
    "max_budget": 7000
  }'
```

---

## 📊 对比总结

| 功能 | 旧版 | 新版 |
|------|------|------|
| 安全系数 | ❌ 不支持 | ✅ 支持 |
| 轭架偏好 | 单一类型 | Auto/Symmetric/Canted |
| 匹配逻辑 | 单一检查 | 同时检查两种轭架 |
| 推荐标记 | ❌ 无 | ✅ 标记推荐轭架类型 |
| 排序方式 | 按扭矩 | 按价格 |
| 预算过滤 | 查询后过滤 | 匹配中过滤 |
| 扭矩信息 | 单一扭矩 | 两种轭架扭矩都显示 |
| 推荐等级 | 简单 | 详细（4个等级）|

---

## 💡 使用建议

### 1. 首次选型
```javascript
{
  "valve_torque": 500,
  "safety_factor": 1.2,
  "working_pressure": 0.5,
  "yoke_preference": "Auto"  // 获取最多选项
}
```

### 2. 预算有限
```javascript
{
  "required_torque": 600,
  "working_pressure": 0.5,
  "yoke_preference": "Auto",
  "max_budget": 7000  // 限制预算
}
```

### 3. 特定要求
```javascript
{
  "required_torque": 600,
  "working_pressure": 0.5,
  "yoke_preference": "Symmetric",      // 指定轭架
  "action_type_preference": "SR",      // 指定类型
  "body_size_preference": "SF12"       // 指定尺寸
}
```

---

## 🎊 总结

增强版选型算法提供了：

1. ✅ **更灵活的输入方式**（支持安全系数）
2. ✅ **更智能的匹配逻辑**（Auto模式）
3. ✅ **更详细的结果信息**（推荐轭架类型）
4. ✅ **更经济的推荐方案**（按价格排序）
5. ✅ **更精确的过滤机制**（预算过滤）

**完全兼容您提供的伪代码逻辑！**

---

**文档版本**: v2.1.0  
**最后更新**: 2025-10-27  
**适用版本**: C-MAX 选型系统 v2.0.0+

