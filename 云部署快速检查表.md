# 云部署快速检查表 ⚡

## 部署前 (5分钟检查)

### 1. 环境变量
```bash
# 后端 (Render)
✅ MONGODB_URI
✅ JWT_SECRET (至少32字符)
✅ REFRESH_TOKEN_SECRET
✅ NODE_ENV=production
✅ FRONTEND_URL=https://your-app.vercel.app

# 前端 (Vercel)
✅ VITE_API_URL=https://your-backend.onrender.com/api
```

### 2. 代码检查
```bash
# 运行这些命令
cd backend
npm audit | grep -i "high\|critical"  # 应该无结果

cd frontend
npm audit | grep -i "high\|critical"  # 应该无结果

# 检查 .gitignore
cat .gitignore | grep ".env"  # ✅ 应该包含 .env
```

### 3. 配置文件
```javascript
// backend/server.js
cors({ origin: process.env.FRONTEND_URL })  // ✅ 不是 '*'

// backend/controllers/authController.js
secure: process.env.NODE_ENV === 'production'  // ✅ Cookie 配置
```

---

## 部署后 (10分钟验证)

### 1. HTTPS 检查 (2分钟)
```
访问 https://your-app.vercel.app
✅ 浏览器地址栏显示 🔒
✅ 不会跳转到 http://
```

### 2. Cookie 检查 (2分钟)
```
1. 登录应用
2. F12 > Application > Cookies
3. 找到 accessToken
   ✅ HttpOnly: true
   ✅ Secure: true (生产环境)
   ✅ SameSite: Strict
```

### 3. 数据库访问 (3分钟)
```
MongoDB Atlas > Network Access
✅ 无 0.0.0.0/0 规则
✅ 有 Render 出站 IP 规则
✅ 后端应用正常连接数据库
```

### 4. CORS 测试 (2分钟)
```bash
# 在浏览器 Console
fetch('https://your-backend.onrender.com/api/health', {
  method: 'GET',
  credentials: 'include'
}).then(r => r.json()).then(console.log)

✅ 成功返回数据
✅ 无 CORS 错误
```

### 5. 安全头检查 (1分钟)
```bash
curl -I https://your-backend.onrender.com/api/health

✅ 看到这些头:
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
Strict-Transport-Security: max-age=15552000
```

---

## 常见问题速查

| 问题 | 检查 | 解决 |
|------|------|------|
| 登录后无 Cookie | CORS credentials | 确保 `credentials: true` |
| Cookie 丢失 | HTTPS | 确保生产环境用 HTTPS |
| 数据库连接失败 | IP 白名单 | 添加 Render 出站 IP |
| CORS 错误 | origin 配置 | 设置正确的前端 URL |
| 401 错误 | 环境变量 | 检查 JWT_SECRET 是否一致 |

---

## 紧急回滚

```bash
# Render - 回滚到上一版本
Dashboard > Deploys > 选择之前的版本 > Redeploy

# Vercel - 回滚
Dashboard > Deployments > 选择之前的版本 > Promote to Production

# MongoDB Atlas - 恢复备份
Cluster > Backup > 选择时间点 > Restore
```

---

## 定期维护

```
每周:  npm audit
每月:  npm audit fix
每季度: 更新依赖 + 安全审计
每半年: 轮换密钥
```

---

**✅ 所有检查通过 = 安全部署完成！** 🎉

