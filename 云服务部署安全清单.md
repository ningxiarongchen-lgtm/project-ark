# 云服务部署安全清单 ☁️🔒

## 📋 部署架构
- **前端**: Vercel
- **后端**: Render
- **数据库**: MongoDB Atlas
- **CDN/文件存储**: Cloudinary (如使用)

---

## ✅ 部署前安全检查清单

### 1️⃣ 环境变量安全 🔐

#### ❌ 绝对禁止
- ❌ 在代码中硬编码任何密钥或敏感信息
- ❌ 将 `.env` 文件提交到 Git 仓库
- ❌ 在前端代码中暴露后端密钥

#### ✅ 正确做法

**后端 (Render) 环境变量:**

登录 Render Dashboard > 选择你的服务 > Environment

```bash
# 数据库
MONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/cmax?retryWrites=true&w=majority

# JWT 密钥 (必须强密码)
JWT_SECRET=your-super-secret-key-at-least-32-characters-long
REFRESH_TOKEN_SECRET=your-refresh-token-secret-at-least-32-characters

# JWT 过期时间
JWT_EXPIRE=8h
REFRESH_TOKEN_EXPIRE=7d

# 环境设置
NODE_ENV=production

# 前端 URL (用于 CORS)
FRONTEND_URL=https://your-app.vercel.app

# 端口 (Render 自动提供)
PORT=5001

# OpenAI API (如使用 AI 功能)
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxx

# Cloudinary (如使用文件上传)
CLOUDINARY_CLOUD_NAME=your-cloud-name
CLOUDINARY_API_KEY=your-api-key
CLOUDINARY_API_SECRET=your-api-secret
```

**前端 (Vercel) 环境变量:**

登录 Vercel Dashboard > 选择项目 > Settings > Environment Variables

```bash
# 后端 API URL
VITE_API_URL=https://your-backend.onrender.com/api

# 其他公开配置
VITE_APP_NAME=C-MAX Selection System
```

**⚠️ 重要提示:**
- 使用强随机密钥，至少 32 字符
- 生产环境和开发环境使用不同的密钥
- 定期轮换密钥（建议每 3-6 个月）

**生成强密钥的方法:**
```bash
# 在终端运行
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

#### 验证清单
- [ ] 检查本地 `.env` 文件是否在 `.gitignore` 中
- [ ] 运行 `git log --all --full-history -- "*/.env"` 确认历史中无 .env
- [ ] 检查 Render 和 Vercel 环境变量已正确配置
- [ ] 确认代码中无硬编码密钥

---

### 2️⃣ HTTPS 强制 🔒

#### Vercel (前端)

✅ **Vercel 默认强制 HTTPS**，无需额外配置

验证步骤:
1. 访问 `http://your-app.vercel.app`
2. 确认自动重定向到 `https://your-app.vercel.app`

#### Render (后端)

✅ **Render 默认提供 HTTPS**

额外配置 - 在代码中强制 HTTPS:

**文件: `backend/server.js`**

```javascript
// 生产环境强制 HTTPS
if (process.env.NODE_ENV === 'production') {
  app.use((req, res, next) => {
    if (req.header('x-forwarded-proto') !== 'https') {
      res.redirect(`https://${req.header('host')}${req.url}`)
    } else {
      next()
    }
  })
}
```

#### Cookie 安全配置验证

**文件: `backend/controllers/authController.js`**

确认 Cookie 配置:
```javascript
res.cookie('accessToken', accessToken, {
  httpOnly: true,
  secure: process.env.NODE_ENV === 'production',  // ✅ 生产环境必须为 true
  sameSite: 'strict',
  maxAge: 8 * 60 * 60 * 1000
});
```

#### 验证清单
- [ ] Vercel 应用访问时 URL 显示 🔒 (HTTPS)
- [ ] Render 后端 API 访问时使用 HTTPS
- [ ] 浏览器 DevTools > Security 标签显示 "Connection is secure"
- [ ] Cookie 有 Secure 标记 (生产环境)

---

### 3️⃣ 数据库访问权限 🗄️

#### MongoDB Atlas 网络访问控制

**当前状态 (不安全):**
```
Network Access: 0.0.0.0/0 (Allow from Anywhere)
```
⚠️ 这意味着任何人都可以尝试连接你的数据库！

**安全配置步骤:**

1. **获取 Render 出站 IP 地址**

   登录 Render Dashboard:
   - 选择你的后端服务
   - 进入 "Connect" 标签
   - 找到 "Outbound IP Addresses" (出站IP地址)
   - 复制所有 IP 地址 (通常有 3-4 个)

   示例:
   ```
   52.45.123.456
   54.78.234.567
   35.90.345.678
   ```

2. **配置 MongoDB Atlas**

   登录 MongoDB Atlas:
   - 进入你的 Cluster
   - 左侧菜单 > Network Access
   - 点击 "Delete" 删除 `0.0.0.0/0` 规则
   
3. **添加 Render IP 白名单**

   - 点击 "+ ADD IP ADDRESS"
   - 选择 "Add a different IP address"
   - 逐个添加 Render 的出站 IP
   - Comment: "Render Backend Server"
   - 点击 "Confirm"

   重复此步骤，添加所有 Render 出站 IP。

4. **可选: 添加你的开发机器 IP**

   如果需要从本地连接数据库:
   - 点击 "+ ADD IP ADDRESS"
   - 选择 "Add Current IP Address"
   - Comment: "My Development Machine"

**⚠️ 重要:**
- Render 的出站 IP 可能会变化（重新部署时）
- 如果突然无法连接数据库，检查 IP 是否变化
- 可以设置警报监控连接失败

#### 数据库用户权限

确保数据库用户只有必需权限:

1. MongoDB Atlas > Database Access
2. 检查用户权限
3. 生产环境建议使用 "Read and write to any database" 而非 "Atlas admin"

```
User: cmax_app_user
Role: readWriteAnyDatabase (推荐)
     ❌ 不要用 atlasAdmin
```

#### 验证清单
- [ ] MongoDB Atlas Network Access 移除了 0.0.0.0/0
- [ ] 添加了所有 Render 出站 IP
- [ ] 后端服务能正常连接数据库
- [ ] 数据库用户权限最小化
- [ ] 连接字符串使用了强密码

---

### 4️⃣ 依赖项安全扫描 📦

#### 定期安全审计

**后端安全扫描:**
```bash
cd backend
npm audit

# 查看详细报告
npm audit --json

# 尝试自动修复
npm audit fix

# 强制修复（可能破坏兼容性，谨慎使用）
npm audit fix --force
```

**前端安全扫描:**
```bash
cd frontend
npm audit
npm audit fix
```

#### 建议的定期维护计划

| 频率 | 操作 |
|------|------|
| **每周** | 运行 `npm audit` 检查 |
| **每月** | 运行 `npm audit fix` 修复低危漏洞 |
| **每季度** | 更新主要依赖版本 |
| **发现高危漏洞** | 立即修复 |

#### 自动化扫描 (推荐)

**方法 1: GitHub Dependabot**

如果代码托管在 GitHub:
1. 仓库 > Settings > Security & analysis
2. 启用 "Dependabot alerts"
3. 启用 "Dependabot security updates"

**方法 2: Snyk**

```bash
# 安装 Snyk CLI
npm install -g snyk

# 认证
snyk auth

# 扫描项目
cd backend
snyk test

cd frontend
snyk test
```

#### 当前已知安全依赖

以下依赖已经在项目中用于安全:

```json
{
  "helmet": "^8.1.0",           // HTTP 安全头
  "express-rate-limit": "^8.1.0", // API 限流
  "express-validator": "^7.3.0",   // 输入验证
  "bcryptjs": "^2.4.3",           // 密码哈希
  "jsonwebtoken": "^9.0.2",       // JWT 认证
  "cookie-parser": "^1.4.6"       // Cookie 解析
}
```

#### 验证清单
- [ ] 后端 `npm audit` 无高危漏洞
- [ ] 前端 `npm audit` 无高危漏洞
- [ ] 已设置自动化安全扫描
- [ ] 订阅了安全更新通知

---

### 5️⃣ CORS 策略 🌐

#### ❌ 不安全的配置

```javascript
// 后端 server.js - 错误示例
app.use(cors({
  origin: '*',  // ❌ 允许任何域名访问
  credentials: true
}))
```

#### ✅ 安全的配置

**文件: `backend/server.js`**

```javascript
// 生产环境严格 CORS
const allowedOrigins = [
  process.env.FRONTEND_URL || 'http://localhost:5173',
  'https://your-app.vercel.app',  // 你的 Vercel 域名
  'https://cmax-platform.vercel.app' // 如有多个域名
]

app.use(cors({
  origin: function (origin, callback) {
    // 允许没有 origin 的请求（如移动应用、Postman）
    if (!origin) return callback(null, true)
    
    if (allowedOrigins.indexOf(origin) === -1) {
      const msg = 'The CORS policy for this site does not allow access from the specified Origin.'
      return callback(new Error(msg), false)
    }
    return callback(null, true)
  },
  credentials: true,  // ✅ 允许 Cookie
  optionsSuccessStatus: 200
}))
```

**或简单配置:**

```javascript
app.use(cors({
  origin: process.env.FRONTEND_URL,  // ✅ 精确匹配
  credentials: true
}))
```

#### Render 环境变量设置

```bash
FRONTEND_URL=https://your-app.vercel.app
```

#### 验证方法

**测试 1: 正确的域名**
```bash
curl -H "Origin: https://your-app.vercel.app" \
     -H "Access-Control-Request-Method: POST" \
     -X OPTIONS \
     https://your-backend.onrender.com/api/auth/login \
     --verbose
```

期望结果:
```
< Access-Control-Allow-Origin: https://your-app.vercel.app
< Access-Control-Allow-Credentials: true
```

**测试 2: 错误的域名**
```bash
curl -H "Origin: https://evil-site.com" \
     -X OPTIONS \
     https://your-backend.onrender.com/api/auth/login \
     --verbose
```

期望结果: 无 `Access-Control-Allow-Origin` 头，或返回错误

#### 验证清单
- [ ] CORS origin 不是 `*`
- [ ] CORS origin 设置为 Vercel 前端 URL
- [ ] credentials 设置为 true (Cookie 需要)
- [ ] 测试了不同 origin 的请求
- [ ] 生产环境只允许你的域名

---

## 🚀 额外安全加固

### 6️⃣ API 速率限制

防止暴力破解和 DDoS 攻击。

**文件: `backend/server.js`**

```javascript
const rateLimit = require('express-rate-limit')

// 通用 API 限流
const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 分钟
  max: 100, // 限制 100 次请求
  message: 'Too many requests from this IP, please try again later.',
  standardHeaders: true,
  legacyHeaders: false,
})

// 登录接口严格限流
const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 5, // 15 分钟内最多 5 次登录尝试
  skipSuccessfulRequests: true,
  message: 'Too many login attempts, please try again later.'
})

// 应用限流
app.use('/api/', apiLimiter)
app.use('/api/auth/login', loginLimiter)
```

**验证:**
- [ ] 连续快速请求 API 会被限制
- [ ] 登录失败 5 次后暂时锁定

---

### 7️⃣ 安全响应头 (Helmet)

**文件: `backend/server.js`**

当前配置检查:
```javascript
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"],
    },
  },
  crossOriginEmbedderPolicy: false,
}))
```

**验证:**
```bash
curl -I https://your-backend.onrender.com/api/health
```

期望看到的响应头:
```
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
X-XSS-Protection: 0
Strict-Transport-Security: max-age=15552000; includeSubDomains
```

---

### 8️⃣ 日志和监控 📊

#### Render 日志监控

1. Render Dashboard > 选择服务 > Logs
2. 监控:
   - 登录失败次数异常增加
   - 401/403 错误频繁
   - 数据库连接失败

#### 推荐工具

**应用监控:**
- **Sentry** - 错误追踪 (https://sentry.io)
- **LogRocket** - 用户会话录制
- **New Relic** - 性能监控

**安全监控:**
- **Cloudflare** - DDoS 防护
- **Sucuri** - 网站安全扫描

#### 简单日志配置

**文件: `backend/middleware/logger.js`**

```javascript
const logger = (req, res, next) => {
  const start = Date.now()
  
  res.on('finish', () => {
    const duration = Date.now() - start
    console.log({
      method: req.method,
      path: req.path,
      status: res.statusCode,
      duration: `${duration}ms`,
      ip: req.ip,
      userAgent: req.get('user-agent')
    })
  })
  
  next()
}

module.exports = logger
```

---

### 9️⃣ 备份策略 💾

#### MongoDB Atlas 自动备份

1. MongoDB Atlas > Cluster > Backup
2. 启用 "Cloud Backup"
3. 设置保留策略:
   - 每日备份保留 7 天
   - 每周备份保留 4 周
   - 每月备份保留 12 月

#### 代码备份

- ✅ 使用 Git 版本控制
- ✅ 推送到 GitHub/GitLab
- ✅ 定期标记重要版本

---

### 🔟 安全检查工具

#### 在线工具

**SSL/TLS 检查:**
- https://www.ssllabs.com/ssltest/
- 输入你的 Vercel 和 Render 域名
- 目标: A+ 评级

**安全头检查:**
- https://securityheaders.com/
- 检查 HTTP 安全头配置
- 目标: A 评级

**网站安全扫描:**
- https://observatory.mozilla.org/

#### 本地工具

```bash
# 安装安全扫描工具
npm install -g retire

# 扫描过时的库
cd backend
retire

cd frontend
retire
```

---

## 📋 部署后最终验证清单

### 环境变量 ✅
- [ ] Render 环境变量已配置（包括所有密钥）
- [ ] Vercel 环境变量已配置（VITE_API_URL）
- [ ] 本地 .env 文件在 .gitignore 中
- [ ] Git 历史中无敏感信息泄露
- [ ] JWT_SECRET 至少 32 字符

### HTTPS ✅
- [ ] Vercel 前端强制 HTTPS
- [ ] Render 后端使用 HTTPS
- [ ] Cookie secure 标记在生产环境启用
- [ ] SSL Labs 测试评级 A+

### 数据库 ✅
- [ ] MongoDB Atlas 移除 0.0.0.0/0 规则
- [ ] 添加了所有 Render 出站 IP
- [ ] 数据库密码强度足够（至少 16 字符）
- [ ] 数据库用户权限最小化
- [ ] 启用了自动备份

### 依赖安全 ✅
- [ ] 后端 npm audit 通过
- [ ] 前端 npm audit 通过
- [ ] 设置了 Dependabot 或 Snyk
- [ ] 订阅了安全更新通知

### CORS ✅
- [ ] origin 不是 '*'
- [ ] origin 设置为精确的前端 URL
- [ ] credentials: true 已配置
- [ ] 测试了跨域请求成功
- [ ] 测试了非法域名被拒绝

### Cookie 安全 ✅
- [ ] accessToken 有 HttpOnly 标记
- [ ] refreshToken 有 HttpOnly 标记
- [ ] Cookie 有 Secure 标记（生产环境）
- [ ] Cookie 有 SameSite=Strict
- [ ] Console 无法访问 token

### API 安全 ✅
- [ ] 登录接口有速率限制
- [ ] 通用 API 有速率限制
- [ ] 所有敏感接口有 protect 中间件
- [ ] 所有权限接口有 authorize 中间件
- [ ] Helmet 安全头已启用

### 监控和日志 ✅
- [ ] Render 日志正常记录
- [ ] 设置了错误监控（可选）
- [ ] 设置了性能监控（可选）
- [ ] 设置了备份策略

---

## 🚨 安全事件响应计划

### 如果发现安全漏洞

1. **立即行动**
   - 评估影响范围
   - 如果 Token 泄露，立即轮换所有密钥
   - 如果数据库泄露，重置所有用户密码

2. **修复漏洞**
   - 更新代码
   - 重新部署
   - 运行安全扫描确认修复

3. **通知用户**（如必要）
   - 透明沟通
   - 提供补救措施

4. **事后总结**
   - 记录事件
   - 更新安全流程
   - 加强监控

---

## 📞 支持资源

### 官方文档
- **Render**: https://render.com/docs
- **Vercel**: https://vercel.com/docs
- **MongoDB Atlas**: https://docs.atlas.mongodb.com/

### 安全资源
- **OWASP Top 10**: https://owasp.org/www-project-top-ten/
- **MDN Web Security**: https://developer.mozilla.org/en-US/docs/Web/Security
- **Express Security Best Practices**: https://expressjs.com/en/advanced/best-practice-security.html

---

## ✅ 部署完成确认

**部署负责人签字:**

- 姓名: _______________
- 日期: _______________
- 确认所有清单项已完成: ☐

**安全审核:**

- 审核人: _______________
- 审核日期: _______________
- 批准上线: ☐

---

**🎉 恭喜！您的应用已采用业界最佳安全实践部署！**

**定期维护提醒:**
- ⏰ 每周一次 npm audit 扫描
- ⏰ 每月一次依赖更新
- ⏰ 每季度一次安全审计
- ⏰ 每半年一次密钥轮换

