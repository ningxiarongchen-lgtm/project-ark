# 📖 上传数据到生产环境 - 完整指南

## 🎯 目标

将本地数据库的数据**安全地**上传到生产环境，**不删除**生产环境的现有数据。

---

## 📊 本地数据统计

已导出的本地数据：

- ✅ **执行器(actuators)**: 338个
- ✅ **手动覆盖规则(manualoverrides)**: 18个
- ✅ **配件(accessories)**: 10个
- ✅ **供应商(suppliers)**: 5个
- ✅ **用户(users)**: 10个
- ✅ **项目(projects)**: 4个

导出位置：`local_data_export_20251107_153153/`

---

## 🚀 方法一：使用 Shell 脚本（推荐）

### 步骤 1: 获取生产环境 MongoDB URI

#### 选项 A：从 Render 获取

1. 登录 Render Dashboard: https://dashboard.render.com
2. 找到您的后端服务
3. 点击 "Environment" 标签
4. 找到 `MONGODB_URI` 环境变量
5. 复制 URI（格式类似）：
   ```
   mongodb+srv://username:password@cluster.mongodb.net/cmax?retryWrites=true
   ```

#### 选项 B：从 MongoDB Atlas 获取

1. 登录 MongoDB Atlas: https://cloud.mongodb.com
2. 点击 "Connect" 按钮
3. 选择 "Connect your application"
4. 复制连接字符串

### 步骤 2: 运行上传脚本

```bash
cd "/Users/hexiaoxiao/Desktop/Model Selection System"
./upload-data-safe.sh
```

### 步骤 3: 按提示操作

1. **输入生产环境 MongoDB URI**
   ```
   请输入生产环境MongoDB URI: mongodb+srv://...
   ```

2. **选择上传模式**
   ```
   1) 安全模式 - 只添加新数据，不覆盖已存在的数据（推荐）
   2) 覆盖模式 - 删除生产环境数据并替换为本地数据（危险！）
   
   请选择 (1 或 2): 1
   ```
   
   ⚠️ **强烈推荐选择 1（安全模式）**

3. **确认操作**
   ```
   最终确认：继续执行？(输入 YES): YES
   ```

4. **等待上传完成**
   - 脚本会依次上传：actuators, manualoverrides, accessories, suppliers
   - 显示每个集合的上传进度

---

## 🔧 方法二：使用 Node.js 脚本（更精细控制）

### 运行脚本

```bash
cd "/Users/hexiaoxiao/Desktop/Model Selection System"
node upload-to-production.js
```

### 按提示操作

1. 输入生产环境 MongoDB URI
2. 输入 `YES` 确认连接
3. 查看数据统计对比
4. 输入 `UPLOAD` 开始上传

### 特点

- ✅ 逐个文档检查，避免重复
- ✅ 显示详细的上传统计
- ✅ 自动跳过已存在的数据
- ✅ 显示上传前后的数据对比

---

## 🛡️ 安全措施

### 脚本已内置的安全机制

1. ✅ **不删除现有数据** - 默认只添加新数据
2. ✅ **多次确认** - 需要用户明确确认才执行
3. ✅ **数据统计** - 显示上传前后的数据对比
4. ✅ **错误处理** - 遇到错误会跳过并继续
5. ✅ **选择性上传** - 只上传核心数据，不上传敏感数据（如 tokens）

### 建议的额外安全措施

1. **在上传前备份生产环境**
   
   在 Render Shell 中运行：
   ```bash
   mongodump --uri="$MONGODB_URI" --out=/tmp/backup_$(date +%Y%m%d_%H%M%S)
   ```

2. **先在测试环境验证**
   
   如果有测试环境，建议先在测试环境执行一次

3. **错峰上传**
   
   选择业务低峰期进行上传

---

## 📋 上传的数据集合

### ✅ 会上传的数据

| 集合名 | 说明 | 数量 | 重要性 |
|--------|------|------|--------|
| `actuators` | 执行器数据 | 338个 | ⭐⭐⭐⭐⭐ 最重要 |
| `manualoverrides` | 手动覆盖规则 | 18个 | ⭐⭐⭐⭐ |
| `accessories` | 配件数据 | 10个 | ⭐⭐⭐ |
| `suppliers` | 供应商数据 | 5个 | ⭐⭐⭐ |

### ⏭️ 不会上传的数据

| 集合名 | 原因 |
|--------|------|
| `users` | 避免覆盖生产环境用户 |
| `projects` | 生产环境可能已有真实项目 |
| `refreshtokens` | 临时令牌，无需上传 |
| 其他订单/工单数据 | 生产环境应该已有真实数据 |

---

## ✅ 验证上传结果

### 1. 登录生产环境管理后台

访问：`https://your-frontend-url.vercel.app`

### 2. 检查执行器数据

1. 登录管理员账号
2. 进入 "数据管理" → "执行器管理"
3. 检查执行器数量是否增加
4. 随机检查几个执行器的数据是否完整

### 3. 测试选型功能

1. 创建一个新项目
2. 输入选型参数
3. 验证是否能正确返回执行器推荐

### 4. 检查供应商和配件

1. 进入 "供应商管理"
2. 验证供应商数据
3. 检查配件数据是否完整

---

## 🔍 常见问题

### Q1: 如果上传失败怎么办？

**A:** 脚本会自动跳过失败的文档，继续上传其他数据。查看错误信息，通常是：
- 网络连接问题 → 检查网络
- URI 错误 → 验证 URI 是否正确
- 权限问题 → 确认数据库用户有写入权限

### Q2: 会不会覆盖生产环境的数据？

**A:** 使用安全模式（选项1）时：
- ✅ 只添加新数据
- ✅ 跳过已存在的数据（基于 `_id`）
- ❌ 不会删除或覆盖现有数据

### Q3: 上传需要多长时间？

**A:** 根据数据量和网络速度：
- 执行器数据（338个）：约 1-2 分钟
- 其他数据：约 30 秒
- **总计：约 2-3 分钟**

### Q4: 如果数据有重复怎么办？

**A:** MongoDB 使用 `_id` 作为唯一标识：
- 相同 `_id` 的数据会被跳过（安全模式）
- 或被覆盖（覆盖模式）
- 不会产生重复数据

### Q5: 如何回滚？

**A:** 如果需要回滚：
1. 使用上传前的备份恢复
   ```bash
   mongorestore --uri="$MONGODB_URI" --drop /tmp/backup_XXXXXXXX
   ```

---

## 📞 需要帮助？

### 上传前检查清单

- [ ] 已获取生产环境 MongoDB URI
- [ ] 已检查本地数据导出文件存在
- [ ] 已备份生产环境数据（推荐）
- [ ] 选择了安全模式（推荐）
- [ ] 了解了上传的数据集合

### 上传后检查清单

- [ ] 生产环境执行器数量是否正确
- [ ] 选型功能是否正常工作
- [ ] 供应商数据是否完整
- [ ] 配件数据是否可用
- [ ] 没有产生重复数据

---

## 🎉 完成！

数据上传完成后，您的生产环境将拥有：
- ✅ 完整的执行器数据库（338个执行器）
- ✅ 智能选型规则（18个手动覆盖规则）
- ✅ 供应商和配件数据
- ✅ 保留的原有业务数据（用户、项目、订单等）

**现在可以开始使用生产环境进行真实业务了！** 🚀

