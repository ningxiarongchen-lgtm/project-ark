# 🚀 Project Ark 生产环境部署检查清单
## Production Environment Deployment Checklist

**版本**: v1.0.0  
**更新日期**: 2025-10-30  
**适用场景**: 生产环境部署、版本更新、演示环境搭建

---

## ⚠️ 重要提示

**本清单旨在确保演示环境和生产环境的完全一致性，避免"演示正常但上线后出错"的情况。**

部署前请逐项检查并在 `[ ]` 中标记 `[x]`。

---

## 📋 第一部分：基础环境检查

### 1.1 系统要求

- [ ] **操作系统**: Linux/macOS/Windows Server
- [ ] **Node.js**: v16.x 或更高版本
- [ ] **npm**: v8.x 或更高版本
- [ ] **MongoDB**: v5.x 或更高版本
- [ ] **内存**: 最低 4GB，推荐 8GB+
- [ ] **磁盘空间**: 最低 10GB 可用空间

### 1.2 网络和端口

- [ ] **后端端口** (默认 5001) 未被占用
- [ ] **前端端口** (默认 5173 开发/80 生产) 未被占用
- [ ] **MongoDB端口** (默认 27017) 可访问
- [ ] **防火墙规则**: 已配置必要的端口开放
- [ ] **SSL证书**: 生产环境已配置 HTTPS

### 1.3 依赖安装

- [ ] **后端依赖**: 运行 `cd backend && npm install`
- [ ] **前端依赖**: 运行 `cd frontend && npm install`
- [ ] **关键依赖验证**:
  - [ ] `xlsx` (产品批量导入必需)
  - [ ] `multer` (文件上传必需)
  - [ ] `mongoose` (数据库连接必需)
  - [ ] `jsonwebtoken` (认证必需)

---

## 📦 第二部分：代码完整性检查

### 2.1 后端文件结构

- [ ] **server.js** - 主服务器文件
- [ ] **config/database.js** - 数据库配置
- [ ] **controllers/** - 所有控制器文件
  - [ ] `productController.js` 包含 `bulkImportProducts` 函数
  - [ ] `userController.js`
  - [ ] 其他业务控制器完整
- [ ] **routes/** - 所有路由文件
  - [ ] `productRoutes.js` 包含 `/import` 路由
  - [ ] 其他路由配置正确
- [ ] **middleware/** - 中间件文件
  - [ ] `auth.js` - 认证中间件
  - [ ] `upload.js` - 文件上传中间件 (包含 `dataUpload`)
  - [ ] `errorHandler.js` - 错误处理
- [ ] **models/** - 数据模型完整
  - [ ] `Product.js`
  - [ ] `User.js`
  - [ ] 其他模型文件
- [ ] **templates/** - 模板文件
  - [ ] `product_import_template.csv` ⭐ 新增
  - [ ] `suppliers_import_template.csv`
  - [ ] `PRODUCT_IMPORT_TEMPLATE_GUIDE.md` ⭐ 新增

### 2.2 前端文件结构

- [ ] **src/App.jsx** - 主应用组件
  - [ ] 包含 ProductImport 路由配置
- [ ] **src/pages/** - 页面组件
  - [ ] `ProductImport.jsx` ⭐ 新增
  - [ ] 其他页面完整
- [ ] **src/styles/** - 样式文件
  - [ ] `ProductImport.css` ⭐ 新增
- [ ] **src/components/Layout/AttioLayout.jsx**
  - [ ] 导航菜单包含「产品批量导入」⭐ 新增
- [ ] **src/services/api.js** - API 服务配置
- [ ] **index.html** - HTML 入口文件
- [ ] **vite.config.js** - Vite 配置

### 2.3 配置文件检查

- [ ] **后端 .env 文件**:
  ```env
  PORT=5001
  MONGODB_URI=mongodb://localhost:27017/your_database_name
  JWT_SECRET=your_secure_secret_key
  JWT_REFRESH_SECRET=your_refresh_secret_key
  NODE_ENV=production
  ```
- [ ] **前端环境变量**:
  - [ ] `VITE_API_URL` 设置正确（生产环境 API 地址）
- [ ] **数据库连接字符串**: 已配置为生产数据库

---

## 🔐 第三部分：安全性检查

### 3.1 认证与授权

- [ ] **JWT Secret**: 使用强密码（至少32字符随机字符串）
- [ ] **JWT Refresh Secret**: 独立且强密码
- [ ] **密码哈希**: 使用 bcrypt (已实现)
- [ ] **角色权限**: 产品导入功能限制为 Administrator 和 Technical Engineer
- [ ] **API 路由保护**: 所有敏感路由已添加 `protect` 和 `authorize` 中间件

### 3.2 文件上传安全

- [ ] **文件类型验证**: MIME type + 扩展名双重验证
- [ ] **文件大小限制**: 10MB (可根据需求调整)
- [ ] **危险文件黑名单**: 已配置 (`.exe`, `.sh`, `.js` 等)
- [ ] **文件存储**: 使用内存存储或安全的磁盘位置
- [ ] **静态文件服务**: 仅允许访问 templates 目录

### 3.3 数据安全

- [ ] **数据库备份**: 已配置定期备份策略
- [ ] **环境变量**: 敏感信息不在代码中硬编码
- [ ] **CORS 配置**: 只允许可信域名访问
- [ ] **Rate Limiting**: 已配置API访问频率限制
- [ ] **Helmet.js**: 已启用HTTP安全头

---

## 🧪 第四部分：功能测试

### 4.1 基础功能测试

- [ ] **用户登录**: 各角色账号可正常登录
- [ ] **项目创建**: 可创建新项目
- [ ] **技术选型**: 技术工程师可添加需求
- [ ] **BOM生成**: 商务工程师可生成BOM
- [ ] **采购管理**: 可创建采购订单
- [ ] **生产流程**: 生产相关功能正常
- [ ] **售后服务**: 可创建和处理工单

### 4.2 新功能测试 (产品批量导入) ⭐

- [ ] **访问权限**:
  - [ ] 管理员可访问「产品批量导入」页面
  - [ ] 技术工程师可访问「产品批量导入」页面
  - [ ] 其他角色无法看到此菜单项
  - [ ] 未授权访问会被拒绝

- [ ] **模板下载**:
  - [ ] 点击「下载产品导入模板」可下载 CSV 文件
  - [ ] 模板文件包含正确的字段名
  - [ ] 模板包含示例数据（SF-100, SF-200）

- [ ] **文件上传**:
  - [ ] 可上传 CSV 格式文件
  - [ ] 可上传 XLSX 格式文件
  - [ ] 可上传 XLS 格式文件
  - [ ] 拒绝非Excel文件 (如 .txt, .pdf)
  - [ ] 拒绝超过10MB的文件

- [ ] **数据导入**:
  - [ ] **成功场景**: 上传有效数据，显示成功统计
  - [ ] **重复场景**: 上传已存在的产品型号，正确跳过
  - [ ] **错误场景**: 上传缺少必填字段的数据，显示具体错误
  - [ ] **混合场景**: 部分成功、部分失败、部分跳过，统计正确

- [ ] **结果显示**:
  - [ ] 成功数量统计正确
  - [ ] 失败数量统计正确
  - [ ] 跳过数量统计正确
  - [ ] 错误详情包含行号和原因
  - [ ] 跳过详情说明原因

- [ ] **数据验证**:
  - [ ] 返回产品列表可以看到新导入的产品
  - [ ] 产品详情中所有字段正确
  - [ ] 数据类型正确（数字、字符串、枚举等）

### 4.3 集成测试

- [ ] **API 端点**: `/api/products/import` 响应正常
- [ ] **静态文件**: `/templates/product_import_template.csv` 可访问
- [ ] **数据库**: 导入的产品正确存储
- [ ] **日志**: 操作日志正确记录
- [ ] **错误处理**: 异常情况有友好提示

---

## 🔄 第五部分：演示环境一致性

### 5.1 数据一致性

- [ ] **测试账号**: 与演示环境相同的账号可用
- [ ] **测试数据**: 种子数据脚本可正常运行
- [ ] **数据库结构**: 与演示环境完全一致
- [ ] **索引**: 所有必要的数据库索引已创建

### 5.2 功能一致性

- [ ] **前端路由**: 所有路由与演示环境一致
- [ ] **API 端点**: 所有API与演示环境一致
- [ ] **权限控制**: 与演示环境的权限规则一致
- [ ] **UI/UX**: 界面和交互与演示环境一致

### 5.3 配置一致性

- [ ] **环境变量**: 除了连接字符串，其他配置一致
- [ ] **中间件**: 加载顺序和配置一致
- [ ] **依赖版本**: package.json 中的版本号一致
- [ ] **构建配置**: Vite配置与演示环境一致

---

## 📊 第六部分：性能和监控

### 6.1 性能优化

- [ ] **前端构建**: 运行 `npm run build` 生成生产版本
- [ ] **静态资源**: 配置CDN或静态资源服务器
- [ ] **数据库索引**: 所有查询字段已建立索引
- [ ] **缓存策略**: 配置适当的缓存机制
- [ ] **文件上传**: 大文件上传使用流式处理

### 6.2 日志和监控

- [ ] **应用日志**: 配置生产级日志（Winston/Morgan）
- [ ] **错误日志**: 错误自动记录到文件或监控系统
- [ ] **性能监控**: 配置APM工具（可选）
- [ ] **数据库监控**: MongoDB性能监控配置
- [ ] **告警机制**: 关键错误有告警通知

### 6.3 备份和恢复

- [ ] **数据库备份**: 每日自动备份
- [ ] **文件备份**: 重要文件定期备份
- [ ] **恢复测试**: 已验证备份可正常恢复
- [ ] **灾难恢复计划**: 文档化并经过测试

---

## 🚦 第七部分：上线前最终检查

### 7.1 自动化验证

运行自动验证脚本：
```bash
bash 演示前验证.sh
```

确保所有检查项通过。

### 7.2 手动功能验收

- [ ] **完整用户流程测试**: 从登录到各个功能模块
- [ ] **跨浏览器测试**: Chrome, Firefox, Safari, Edge
- [ ] **响应式测试**: 桌面、平板、手机端显示正常
- [ ] **压力测试**: 模拟并发用户访问
- [ ] **数据导入压力测试**: 上传100+条记录的文件

### 7.3 文档检查

- [ ] **API文档**: 与实际实现一致
- [ ] **用户手册**: 包含新功能说明
- [ ] **运维文档**: 部署、备份、恢复流程清晰
- [ ] **变更日志**: 记录所有功能变更

---

## ✅ 第八部分：部署执行

### 8.1 部署步骤

```bash
# 1. 停止旧服务
pm2 stop all  # 或使用其他进程管理器

# 2. 备份当前版本
tar -czf backup-$(date +%Y%m%d-%H%M%S).tar.gz backend/ frontend/

# 3. 拉取最新代码
git pull origin main

# 4. 安装依赖
cd backend && npm install
cd ../frontend && npm install

# 5. 构建前端
cd frontend && npm run build

# 6. 运行数据库迁移（如有）
cd backend && npm run migrate

# 7. 验证配置
bash 演示前验证.sh

# 8. 启动服务
pm2 start ecosystem.config.js
pm2 save

# 9. 验证服务运行
pm2 status
curl http://localhost:5001/api/health

# 10. 检查日志
pm2 logs --lines 50
```

### 8.2 部署后验证

- [ ] **健康检查**: `/api/health` 返回 OK
- [ ] **前端访问**: 首页正常加载
- [ ] **登录功能**: 测试账号可登录
- [ ] **新功能**: 产品批量导入可访问且功能正常
- [ ] **日志检查**: 无错误日志
- [ ] **性能检查**: 响应时间在可接受范围内

### 8.3 回滚计划

如果部署失败，执行回滚：
```bash
# 1. 停止服务
pm2 stop all

# 2. 恢复备份
tar -xzf backup-YYYYMMDD-HHMMSS.tar.gz

# 3. 重启服务
pm2 restart all

# 4. 验证
curl http://localhost:5001/api/health
```

---

## 📞 第九部分：支持和维护

### 9.1 常见问题处理

**问题1: 产品导入失败**
```bash
# 检查模板文件
ls -la backend/templates/product_import_template.csv

# 检查静态文件服务
curl http://localhost:5001/templates/product_import_template.csv

# 查看后端日志
pm2 logs backend | grep import

# 验证 xlsx 依赖
cd backend && npm list xlsx
```

**问题2: 认证失败**
```bash
# 检查JWT Secret配置
grep JWT_SECRET backend/.env

# 验证用户数据
mongo
> use your_database_name
> db.users.find().limit(1)
```

**问题3: 文件上传失败**
```bash
# 检查上传目录权限
ls -la backend/uploads/

# 查看 multer 配置
cat backend/middleware/upload.js | grep dataUpload

# 测试文件上传
curl -X POST -F "productFile=@test.csv" http://localhost:5001/api/products/import
```

### 9.2 维护任务

**每日**:
- [ ] 检查系统日志
- [ ] 检查数据库备份
- [ ] 监控系统资源使用

**每周**:
- [ ] 审查错误日志
- [ ] 数据库性能优化
- [ ] 备份文件清理

**每月**:
- [ ] 依赖包更新检查
- [ ] 安全漏洞扫描
- [ ] 性能测试和优化

### 9.3 联系方式

- **技术支持**: tech-support@example.com
- **紧急热线**: +86-xxx-xxxx-xxxx
- **文档地址**: https://docs.example.com

---

## 📝 检查清单总结

### 关键检查项（必须全部通过）

- [ ] 所有依赖已安装（包括 xlsx, multer）
- [ ] 产品导入模板文件存在且可访问
- [ ] ProductImport.jsx 页面组件存在
- [ ] 产品路由包含 /import 端点
- [ ] 导航菜单包含「产品批量导入」
- [ ] 权限控制正确配置
- [ ] 文件上传安全验证已启用
- [ ] 数据库连接正常
- [ ] 所有环境变量正确配置
- [ ] 演示环境验证脚本全部通过

### 签署确认

部署负责人: _________________ 日期: _____________

技术审核人: _________________ 日期: _____________

运维负责人: _________________ 日期: _____________

---

**最后更新**: 2025-10-30  
**文档版本**: v1.0.0  
**下次审核**: 根据系统更新周期调整

---

## 🎯 特别提醒

> ⚠️ **避免"演示正常但上线出错"的关键**:
> 
> 1. **使用本检查清单**: 逐项检查，不要跳过任何项目
> 2. **运行验证脚本**: `bash 演示前验证.sh` 在每次部署前运行
> 3. **保持环境一致**: 演示环境和生产环境使用相同的代码库和配置
> 4. **完整测试**: 在类生产环境中进行完整的端到端测试
> 5. **版本控制**: 所有变更通过Git管理，标记版本号
> 6. **文档同步**: 及时更新文档，确保与代码一致
> 7. **团队沟通**: 所有人员了解新功能和变更内容
> 8. **逐步部署**: 先在测试环境验证，再部署到生产环境

---

**祝部署顺利！** 🚀

