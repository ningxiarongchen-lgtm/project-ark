# Project Ark - Bug 追踪与修复记录

## 文档说明

本文档记录所有发现的Bug及其修复过程。这不仅仅是一个问题清单，更是**团队知识积累的宝库**。

### 使用目的
1. **防止Bug复发**: 记录每个Bug的根本原因和修复方案
2. **知识沉淀**: 将经验教训转化为测试用例
3. **趋势分析**: 识别系统的薄弱环节
4. **新人培训**: 帮助新成员快速了解系统曾经遇到的问题

### 工作流程

```
发现Bug → 记录到本文档 → 分析根因 → 修复 → 验证 → 更新测试用例 → 关闭
```

**关键：每个Bug修复后，必须同步更新 `5_MANUAL_TEST_CASES.md`，确保该Bug不会再次出现！**

---

## Bug 状态说明

| 状态 | 含义 |
|------|------|
| 🔴 **Open** | 已发现，待修复 |
| 🟡 **In Progress** | 正在修复中 |
| 🟢 **Fixed** | 已修复，待验证 |
| ✅ **Closed** | 已验证修复，已关闭 |
| 🔵 **Wontfix** | 不修复（需注明原因） |

## 严重程度

| 级别 | 说明 | 示例 |
|------|------|------|
| **P0 - 致命** | 系统崩溃、数据丢失、安全漏洞 | 登录功能完全失效 |
| **P1 - 严重** | 核心功能无法使用 | 选型计算结果错误 |
| **P2 - 重要** | 重要功能受影响，有替代方案 | 报表导出失败，但可手动复制 |
| **P3 - 一般** | 次要功能问题 | UI显示错位 |
| **P4 - 轻微** | 体验优化 | 提示信息不够友好 |

---

## Bug 记录模板

```markdown
### BUG-XXX: [简短描述]

**报告信息**
- 报告人: [姓名]
- 报告日期: YYYY-MM-DD
- 发现版本: vX.X.X
- 严重程度: PX
- 状态: 🔴 Open

**问题描述**
[详细描述Bug的表现症状]

**重现步骤**
1. 第一步操作
2. 第二步操作
3. 观察到的错误

**预期行为**
[应该如何表现]

**实际行为**
[实际发生了什么]

**环境信息**
- 浏览器: Chrome 120
- 操作系统: macOS 14.0
- 数据库状态: 初始化/含历史数据

**根本原因分析**
[技术层面的根本原因，例如：前端未校验输入、后端缺少边界检查等]

**修复方案**
[如何修复该问题]

**影响范围**
- 影响模块: [用户模块/选型引擎/...]
- 影响用户: [所有用户/特定角色/...]
- 数据影响: [是否需要数据迁移]

**修复记录**
- 修复人: [姓名]
- 修复日期: YYYY-MM-DD
- PR 链接: #XXX
- 修复版本: vX.X.X

**验证方法**
[如何验证该Bug已被修复]

**测试用例更新**
- [ ] 已更新 `5_MANUAL_TEST_CASES.md` 中的 [X-XX] 用例
- [ ] 或新增测试用例: [描述]

**经验教训**
[从这个Bug中学到了什么？未来如何避免类似问题？]

---
```

---

## Bug 记录

### BUG-001: 示例 - 登录时密码包含特殊字符导致验证失败

**报告信息**
- 报告人: 张三
- 报告日期: 2025-10-15
- 发现版本: v0.9.0
- 严重程度: P1
- 状态: ✅ Closed

**问题描述**
当用户密码包含特殊字符（如 `@`, `#`, `%`）时，登录验证总是失败，即使密码正确。

**重现步骤**
1. 创建一个密码为 `Pass@123#` 的用户
2. 尝试使用该密码登录
3. 系统提示"用户名或密码错误"

**预期行为**
使用正确的用户名和密码应该能成功登录。

**实际行为**
登录失败，即使密码正确。

**环境信息**
- 浏览器: Chrome 119
- 操作系统: Windows 11
- 数据库状态: 含历史数据

**根本原因分析**
后端在密码验证前进行了 URL 解码，但前端发送时已经进行了一次编码，导致特殊字符被错误处理。

**修复方案**
- 移除后端不必要的 URL 解码逻辑
- 使用 bcrypt 直接比对加密后的密码

**影响范围**
- 影响模块: 用户认证模块
- 影响用户: 所有密码包含特殊字符的用户
- 数据影响: 无需数据迁移

**修复记录**
- 修复人: 李四
- 修复日期: 2025-10-16
- PR 链接: #45
- 修复版本: v0.9.1

**验证方法**
1. 运行 `npm run seed:final` 初始化环境
2. 创建密码为 `Test@#$%123` 的新用户
3. 退出登录
4. 使用该用户名和密码重新登录
5. 验证登录成功

**测试用例更新**
- [x] 已更新 `5_MANUAL_TEST_CASES.md` 中的 A-01 用例
  - 增加步骤：测试使用包含特殊字符的密码登录

**经验教训**
- 密码处理应该只在加密时进行，中间不应做任何编码/解码处理
- 关键的认证逻辑需要充分的边界测试，包括各种特殊字符

---

### BUG-002: 示例 - 选型时扭矩单位未统一导致计算错误

**报告信息**
- 报告人: 王五
- 报告日期: 2025-10-20
- 发现版本: v0.9.5
- 严重程度: P0
- 状态: ✅ Closed

**问题描述**
在某些特定工况下，选型推荐的执行器无法满足实际扭矩需求，原因是计算时混用了 N·m 和 kN·m 单位。

**重现步骤**
1. 技术工程师登录
2. 输入工况：蝶阀，DN500，5.0MPa
3. 系统推荐了 AT-160DA
4. 但实际计算发现 AT-160DA 的输出扭矩不足

**预期行为**
推荐的执行器应该满足扭矩需求，且有 15%-25% 的安全裕量。

**实际行为**
推荐的执行器输出扭矩不足，实际裕量为负值。

**环境信息**
- 浏览器: Chrome 120
- 操作系统: macOS 14.1
- 数据库状态: 初始化后的干净状态

**根本原因分析**
1. 数据库中 `SF` 系列的扭矩数据单位为 kN·m
2. `AT` 系列的扭矩数据单位为 N·m
3. 选型算法未进行单位统一，直接比较数值

**修复方案**
1. 在 `Product` model 中添加 `torqueUnit` 字段
2. 在选型算法中，统一转换为 N·m 进行计算
3. 对现有数据进行迁移，明确标注单位

**影响范围**
- 影响模块: 智能选型引擎（核心功能）
- 影响用户: 所有使用 SF 系列的技术工程师
- 数据影响: 需要更新所有 SF 系列产品的扭矩单位标注

**修复记录**
- 修复人: 赵六
- 修复日期: 2025-10-21
- PR 链接: #52
- 修复版本: v0.9.6
- 数据迁移脚本: `migrations/add_torque_unit.js`

**验证方法**
1. 运行 `npm run seed:final`
2. 执行 B-01 到 B-03 所有选型测试用例
3. 验证推荐结果的扭矩裕量在 15%-25% 范围内
4. 特别测试大口径工况（DN400+）

**测试用例更新**
- [x] 已更新 `5_MANUAL_TEST_CASES.md` 中的 B-01, B-02, B-03
  - 明确要求验证扭矩裕量百分比
- [x] 新增测试用例 B-08: "大口径工况选型验证"

**经验教训**
- **永远不要假设数据的单位是统一的**，必须在代码中明确处理单位转换
- 核心算法变更必须进行全面回归测试
- 数据导入时必须包含单位信息，不能只有数值
- 这类问题应该在 `3_CORE_LOGIC_AND_APIS.md` 中明确文档化

---

### BUG-003: 项目名称包含 Emoji 导致列表页崩溃

**报告信息**
- 报告人: 测试团队
- 报告日期: 2025-10-25
- 发现版本: v1.0.0-beta
- 严重程度: P2
- 状态: ✅ Closed

**问题描述**
当项目名称包含 Emoji 表情符号时，项目列表页面无法渲染，浏览器控制台报错。

**重现步骤**
1. 销售经理登录
2. 创建新项目，项目名称输入 "重点项目 🚀"
3. 保存成功
4. 导航到项目列表页
5. 页面白屏，控制台显示 JSON 解析错误

**预期行为**
项目名称应该支持 Unicode 字符，包括 Emoji。

**实际行为**
包含 Emoji 的项目导致整个列表页崩溃。

**环境信息**
- 浏览器: Safari 17
- 操作系统: macOS 14.1
- 数据库状态: 含多个正常项目 + 1个包含Emoji的项目

**根本原因分析**
1. MongoDB 存储 Emoji 正常
2. 但 Express 响应时，未设置正确的字符编码
3. 导致 JSON 序列化时 Emoji 被截断

**修复方案**
1. 在 Express 中间件中设置 `charset=utf-8`
2. 前端输入时增加字符类型提示
3. 后端增加输入验证，限制或转义特殊字符

**影响范围**
- 影响模块: 项目管理模块
- 影响用户: 输入特殊字符的用户
- 数据影响: 无

**修复记录**
- 修复人: 前端团队
- 修复日期: 2025-10-26
- PR 链接: #58
- 修复版本: v1.0.0-rc1

**验证方法**
1. 创建项目，名称包含 Emoji: "测试 🎉 项目"
2. 创建项目，名称包含特殊字符: "A&B公司-50%折扣"
3. 验证列表页正常显示
4. 验证项目详情页正常显示

**测试用例更新**
- [x] 已更新 `5_MANUAL_TEST_CASES.md` 中的 C-01
  - 增加步骤：项目名称包含特殊字符和 Emoji 的测试

**经验教训**
- 所有用户输入都应该进行边界测试，包括特殊字符、Unicode、超长文本
- Express 应用应该统一设置字符编码
- 前端应该对用户输入给出明确的格式提示

---

## Bug 统计分析

### 按模块统计（示例数据）

| 模块 | Bug 总数 | 已关闭 | 待修复 | 平均修复时间 |
|------|---------|--------|--------|--------------|
| 用户认证 | 1 | 1 | 0 | 1天 |
| 选型引擎 | 1 | 1 | 0 | 1天 |
| 项目管理 | 1 | 1 | 0 | 1天 |
| **总计** | **3** | **3** | **0** | **1天** |

### 按严重程度统计（示例数据）

| 严重程度 | 数量 | 占比 |
|---------|------|------|
| P0 - 致命 | 1 | 33% |
| P1 - 严重 | 1 | 33% |
| P2 - 重要 | 1 | 33% |
| P3 - 一般 | 0 | 0% |
| P4 - 轻微 | 0 | 0% |

### 趋势分析

```
【在实际使用中，这里可以记录每月的Bug数量趋势】

2025-10 月: 发现 3 个，修复 3 个，复发 0 个
2025-11 月: 发现 X 个，修复 X 个，复发 X 个
...
```

---

## 使用指南

### 当发现新Bug时

1. **立即记录**: 按照模板在本文档中创建新条目
2. **分配编号**: 使用递增的 BUG-XXX 编号
3. **设置优先级**: 根据严重程度决定处理优先级
4. **通知团队**: 在团队群中同步Bug信息

### 当开始修复Bug时

1. 更新状态为 🟡 **In Progress**
2. 填写根本原因分析
3. 设计修复方案

### 当修复完成后

1. 更新状态为 🟢 **Fixed**
2. 填写修复记录和PR链接
3. **最重要**: 思考并更新 `5_MANUAL_TEST_CASES.md`
4. 执行验证方法，确认修复有效

### 当验证通过后

1. 更新状态为 ✅ **Closed**
2. 填写经验教训
3. 在月度质量回顾会议上分享

---

## 附录：常见Bug类型与预防

### 1. 输入验证类
- **典型例子**: BUG-001, BUG-003
- **预防措施**: 
  - 前后端都要做输入验证
  - 测试各种边界情况（空值、特殊字符、超长文本）
  - 参考 OWASP 输入验证指南

### 2. 数据一致性类
- **典型例子**: BUG-002
- **预防措施**:
  - 数据库设计时明确字段含义和单位
  - 代码中显式处理单位转换
  - 使用类型系统（TypeScript）增强约束

### 3. 并发与竞态条件
- **预防措施**:
  - 使用数据库事务
  - 实现乐观锁或悲观锁
  - 充分的并发测试

### 4. 性能问题
- **预防措施**:
  - 对大数据量场景进行压力测试
  - 使用分页和延迟加载
  - 监控关键接口的响应时间

---

## 维护说明

- **更新频率**: 发现Bug时立即记录，修复后及时更新
- **维护责任人**: 测试负责人
- **审查周期**: 每月质量回顾会议
- **归档策略**: 已关闭的Bug保留在本文档中，不删除（作为知识库）

---

**记住**: 每个Bug都是改进系统的机会。通过系统地记录和分析，我们的产品会越来越稳定！

