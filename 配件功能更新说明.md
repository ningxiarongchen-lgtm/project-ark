# 配件功能更新说明

## 📅 更新时间
2025-10-27

---

## ✅ 已完成的更新

### 1. 新建 Accessory 模型 ⭐

**文件**: `backend/models/Accessory.js`

#### 必需字段
- ✅ `name` - String, required（配件名称）
- ✅ `category` - String, required, 枚举值：
  - 控制类
  - 连接与传动类
  - 安全与保护类
  - 检测与反馈类
  - 辅助与安装工具
- ✅ `specifications` - Map of String（规格参数）
- ✅ `price` - Number, required（价格）
- ✅ `compatibility_rules` - Object（兼容性规则）

#### 额外字段
- `description` - 描述
- `manufacturer` - 制造商
- `model_number` - 型号
- `stock_info` - 库存信息
- `images` - 图片数组
- `is_active` - 是否激活

#### 实用方法

**实例方法**:
```javascript
// 检查与执行器的兼容性
accessory.isCompatibleWith(actuator)
```

**静态方法**:
```javascript
// 按类别查找
Accessory.findByCategory('控制类')

// 查找兼容配件
Accessory.findCompatibleAccessories(actuator, '控制类')

// 按价格范围查找
Accessory.findByPriceRange(1000, 5000, '控制类')
```

**虚拟字段**:
```javascript
accessory.in_stock  // 自动计算是否有货
```

---

### 2. 更新 NewProject 模型 ⭐

**文件**: `backend/models/NewProject.js`

#### 在 selections 数组中新增字段

```javascript
selected_accessories: [{
  accessory_id: ObjectId,      // 配件ID（引用 Accessory）
  name: String,                // 配件名称
  category: String,            // 配件类别
  quantity: Number,            // 数量（默认1，最小1）
  unit_price: Number,          // 单价
  total_price: Number,         // 总价
  notes: String                // 备注
}]
```

#### 增强的实例方法

**1. 增强的价格计算** - `calculateSelectionPrice()`
```javascript
// 现在自动计算配件总价
project.calculateSelectionPrice(selectionId)

// 计算逻辑：
// 总价 = 执行器价格 + 手动装置价格 + 所有配件价格总和
```

**2. 新增配件管理方法**

```javascript
// 添加配件到选型
project.addAccessoryToSelection(selectionId, {
  accessory_id: '...',
  name: '电磁阀',
  category: '控制类',
  quantity: 2,
  unit_price: 1200
})

// 从选型中移除配件
project.removeAccessoryFromSelection(selectionId, accessoryId)
```

---

## 📝 使用示例

### 示例 1: 创建配件

```javascript
const Accessory = require('./models/Accessory');

const accessory = await Accessory.create({
  name: '双作用电磁阀',
  category: '控制类',
  price: 1200,
  specifications: new Map([
    ['电压', '24V DC'],
    ['接口尺寸', 'G1/4'],
    ['防护等级', 'IP65'],
    ['工作压力', '0-10 bar']
  ]),
  compatibility_rules: {
    body_sizes: ['SF10', 'SF12', 'SF14'],
    action_types: ['DA', 'SR']
  },
  description: '高性能双作用电磁阀，适用于自动控制系统',
  manufacturer: 'ASCO',
  model_number: 'SCG353A044',
  stock_info: {
    quantity: 50,
    available: true,
    lead_time: '7天'
  }
});
```

### 示例 2: 查找兼容配件

```javascript
const Actuator = require('./models/Actuator');
const Accessory = require('./models/Accessory');

// 获取执行器
const actuator = await Actuator.findById(actuatorId);

// 查找所有兼容的配件
const compatibleAccessories = await Accessory.findCompatibleAccessories(
  actuator, 
  '控制类'  // 可选：限制类别
);

// 检查单个配件兼容性
const accessory = await Accessory.findById(accessoryId);
const isCompatible = accessory.isCompatibleWith(actuator);
```

### 示例 3: 为项目选型添加配件

```javascript
const NewProject = require('./models/NewProject');

// 获取项目
const project = await NewProject.findById(projectId);

// 添加配件到选型
await project.addAccessoryToSelection(selectionId, {
  accessory_id: accessory._id,
  name: accessory.name,
  category: accessory.category,
  quantity: 2,
  unit_price: accessory.price
  // total_price 会自动计算
});

// 重新计算选型总价
await project.calculateSelectionPrice(selectionId);
```

### 示例 4: 完整的选型流程（含配件）

```javascript
// 1. 创建项目
const project = await NewProject.create({
  project_name: '化工厂阀门自动化项目',
  client_name: '某化工有限公司',
  created_by: userId
});

// 2. 添加选型配置
await project.addSelection({
  tag_number: 'FV-101',
  input_params: {
    required_torque: 600,
    working_pressure: 0.5,
    working_angle: 90,
    yoke_type: 'symmetric',
    needs_manual_override: true
  },
  selected_actuator: {
    actuator_id: actuator._id,
    model_base: 'SF12-250SR',
    body_size: 'SF12',
    action_type: 'SR',
    yoke_type: 'symmetric',
    actual_torque: 858,
    price: 6500
  },
  selected_override: {
    override_id: override._id,
    model: 'HG',
    price: 800
  }
});

// 3. 添加配件
const selection = project.selections[0];

await project.addAccessoryToSelection(selection._id, {
  accessory_id: solenoidValve._id,
  name: '双作用电磁阀',
  category: '控制类',
  quantity: 1,
  unit_price: 1200
});

await project.addAccessoryToSelection(selection._id, {
  accessory_id: positioner._id,
  name: '智能定位器',
  category: '检测与反馈类',
  quantity: 1,
  unit_price: 3500
});

// 4. 计算总价
await project.calculateSelectionPrice(selection._id);

// 结果：
// 执行器: 6500
// 手动装置: 800
// 电磁阀: 1200
// 定位器: 3500
// 总价: 12000
```

---

## 🔄 数据结构对比

### 更新前的 Selection
```javascript
{
  tag_number: "FV-101",
  selected_actuator: { ... },
  selected_override: { ... },
  total_price: 7300  // 仅包含执行器和手动装置
}
```

### 更新后的 Selection
```javascript
{
  tag_number: "FV-101",
  selected_actuator: { ... },
  selected_override: { ... },
  selected_accessories: [        // 新增！
    {
      accessory_id: "...",
      name: "双作用电磁阀",
      category: "控制类",
      quantity: 1,
      unit_price: 1200,
      total_price: 1200
    },
    {
      accessory_id: "...",
      name: "智能定位器",
      category: "检测与反馈类",
      quantity: 1,
      unit_price: 3500,
      total_price: 3500
    }
  ],
  total_price: 12000  // 现在包含所有配件
}
```

---

## 📊 配件兼容性规则示例

### 示例 1: 电磁阀
```javascript
{
  name: "双作用电磁阀",
  category: "控制类",
  price: 1200,
  compatibility_rules: {
    body_sizes: ["SF10", "SF12", "SF14"],      // 兼容的机身尺寸
    action_types: ["DA"],                       // 仅兼容双作用
    models: ["SF10-", "SF12-", "SF14-"]        // 兼容的型号模式
  }
}
```

### 示例 2: 手轮
```javascript
{
  name: "手动操作手轮",
  category: "辅助与安装工具",
  price: 300,
  compatibility_rules: {
    body_sizes: ["SF10", "SF12", "SF14", "SF16"],  // 全尺寸兼容
    action_types: ["DA", "SR"]                      // 全类型兼容
  }
}
```

### 示例 3: 限位开关盒
```javascript
{
  name: "限位开关盒",
  category: "检测与反馈类",
  price: 800,
  compatibility_rules: {
    // 空规则表示兼容所有执行器
  }
}
```

---

## 🎯 下一步建议

### 1. 创建配件控制器
**文件**: `backend/controllers/accessoryController.js`

```javascript
// CRUD 操作
exports.getAllAccessories = async (req, res) => { ... }
exports.getAccessoryById = async (req, res) => { ... }
exports.createAccessory = async (req, res) => { ... }
exports.updateAccessory = async (req, res) => { ... }
exports.deleteAccessory = async (req, res) => { ... }

// 特殊功能
exports.getAccessoriesByCategory = async (req, res) => { ... }
exports.getCompatibleAccessories = async (req, res) => { ... }
exports.searchAccessories = async (req, res) => { ... }
```

### 2. 创建配件路由
**文件**: `backend/routes/accessoryRoutes.js`

```javascript
const router = require('express').Router();
const { authenticate, authorize } = require('../middleware/auth');
const accessoryController = require('../controllers/accessoryController');

router.get('/', authenticate, accessoryController.getAllAccessories);
router.get('/category/:category', authenticate, accessoryController.getAccessoriesByCategory);
router.get('/compatible/:actuatorId', authenticate, accessoryController.getCompatibleAccessories);
router.post('/', authenticate, authorize('Administrator'), accessoryController.createAccessory);
// ... 更多路由
```

### 3. 更新项目控制器
在 `backend/controllers/newProjectController.js` 中添加配件管理端点：

```javascript
// 为选型添加配件
exports.addAccessoryToSelection = async (req, res) => { ... }

// 从选型移除配件
exports.removeAccessoryFromSelection = async (req, res) => { ... }

// 更新配件数量
exports.updateAccessoryQuantity = async (req, res) => { ... }
```

### 4. 前端集成
在智能选型页面添加配件选择功能：

```javascript
// SelectionEngine.jsx
- 显示兼容配件列表
- 添加配件到购物车
- 显示配件总价
- 保存配件到项目
```

---

## 📚 API端点建议

### 配件管理
```
GET    /api/accessories                          // 获取所有配件
GET    /api/accessories/:id                      // 获取单个配件
POST   /api/accessories                          // 创建配件（管理员）
PUT    /api/accessories/:id                      // 更新配件（管理员）
DELETE /api/accessories/:id                      // 删除配件（管理员）
GET    /api/accessories/category/:category       // 按类别获取
GET    /api/accessories/compatible/:actuatorId   // 获取兼容配件
POST   /api/accessories/search                   // 搜索配件
```

### 项目配件管理
```
POST   /api/new-projects/:projectId/selections/:selectionId/accessories
       // 添加配件到选型

DELETE /api/new-projects/:projectId/selections/:selectionId/accessories/:accessoryId
       // 从选型移除配件

PUT    /api/new-projects/:projectId/selections/:selectionId/accessories/:accessoryId
       // 更新配件（如数量）
```

---

## 🎊 总结

### ✅ 已完成

1. **Accessory 模型** - 完整的配件数据模型
2. **NewProject 模型更新** - 支持配件管理
3. **兼容性系统** - 自动检查配件兼容性
4. **价格计算** - 自动计算包含配件的总价
5. **便捷方法** - 添加/移除配件的实例方法

### 📊 数据流程

```
1. 创建配件 (Accessory)
   ↓
2. 设置兼容性规则
   ↓
3. 在选型时查找兼容配件
   ↓
4. 添加配件到选型
   ↓
5. 自动计算总价
   ↓
6. 保存到项目
```

### 🚀 系统增强

现在系统支持：
- ✅ 5种配件类别
- ✅ 自动兼容性检查
- ✅ 配件数量管理
- ✅ 自动价格计算
- ✅ 完整的配件生命周期管理

---

**更新版本**: v2.2.0  
**更新日期**: 2025-10-27  
**状态**: ✅ 模型已更新，待添加控制器和路由

