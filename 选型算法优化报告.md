# 选型算法优化报告

## 📋 优化概述

本次优化对选型算法进行了重大改进，确保了扭矩计算逻辑的清晰性、准确性和可追溯性。

---

## ✅ 核心改进

### 1. 标准化扭矩计算流程

**位置**: `backend/controllers/selectionController.js` - 第 49-87 行

**改进内容**:

#### a) 新增 camelCase 参数支持（推荐使用）
```javascript
valveTorque   // 阀门扭矩 (新版参数)
safetyFactor  // 安全系数 (默认 1.3)
```

#### b) 保持向后兼容
```javascript
valve_torque    // 阀门扭矩 (旧版参数)
safety_factor   // 安全系数 (旧版参数)
required_torque // 直接提供需求扭矩 (旧版参数)
```

#### c) 优先级规则
1. **优先使用新版参数**: `valveTorque` + `safetyFactor`
2. **兼容旧版参数**: `valve_torque` + `safety_factor`
3. **直接使用**: `required_torque`（跳过计算）

---

### 2. 明确的扭矩计算公式

**核心公式**:
```javascript
requiredTorque = valveTorque × safetyFactor
```

**示例计算**:
- 阀门扭矩: `100 N·m`
- 安全系数: `1.3` (默认值)
- **需求扭矩**: `100 × 1.3 = 130 N·m`

**控制台输出**:
```bash
📊 扭矩计算：阀门扭矩 100 N·m × 安全系数 1.3 = 130 N·m
```

---

### 3. 安全系数默认值调整

| 参数 | 旧值 | 新值 | 说明 |
|------|------|------|------|
| `safetyFactor` | 1.0 | **1.3** | 提高30%的安全裕度，符合行业标准 |

---

### 4. 统一变量命名

**全局替换**: `finalRequiredTorque` → `requiredTorque`

**影响范围**:
- ✅ Scotch Yoke (SF系列) 扭矩比较
- ✅ Rack & Pinion (AT/GY系列) 扭矩比较
- ✅ 扭矩裕度计算
- ✅ 响应数据返回

---

## 🔍 算法步骤详解

### 步骤 1: 验证必需参数
```javascript
if (!working_pressure) {
  return res.status(400).json({ message: '请提供工作压力' });
}

if (!mechanism) {
  return res.status(400).json({ message: '请提供机构类型' });
}
```

### 步骤 2: 计算最终需求扭矩 ⭐
```javascript
// 优先使用新版参数
if (valveTorque !== undefined) {
  actualValveTorque = valveTorque;
  actualSafetyFactor = safetyFactor; // 默认1.3
  requiredTorque = valveTorque * safetyFactor;
  console.log(`📊 扭矩计算：阀门扭矩 ${valveTorque} N·m × 安全系数 ${safetyFactor} = ${requiredTorque} N·m`);
}
```

### 步骤 3: 构建查询条件
```javascript
let query = { mechanism: mechanism };

if (action_type_preference) {
  query.action_type = action_type_preference.toUpperCase();
}

if (body_size_preference) {
  query.body_size = body_size_preference.toUpperCase();
}

console.log('🔍 查询条件:', query);
```

### 步骤 4: 执行扭矩匹配逻辑
根据机构类型分别处理：

#### Scotch Yoke (拨叉式)
```javascript
if (symmetricTorque >= requiredTorque) {
  isSymmetricMatch = true;
}

if (cantedTorque >= requiredTorque) {
  isCantedMatch = true;
}
```

#### Rack & Pinion (齿轮齿条式)
```javascript
// DA (双作用)
if (actualTorque >= requiredTorque) {
  shouldInclude = true;
}

// SR (弹簧复位)
if (springEndTorque >= requiredTorque && airStartTorque >= requiredTorque) {
  shouldInclude = true;
}
```

### 步骤 5: 计算扭矩裕度
```javascript
const torqueMargin = ((actualTorque - requiredTorque) / requiredTorque * 100);
```

### 步骤 6: 按价格排序并返回
```javascript
finalResults.sort((a, b) => a.price - b.price);

res.json({
  success: true,
  count: finalResults.length,
  search_criteria: {
    valve_torque: actualValveTorque,
    safety_factor: actualSafetyFactor,
    required_torque: requiredTorque,
    // ... 其他条件
  },
  data: finalResults,
  best_choice: finalResults[0]
});
```

---

## 📊 API 请求示例

### 推荐方式（新版 camelCase）
```json
{
  "valveTorque": 100,
  "safetyFactor": 1.3,
  "working_pressure": 0.6,
  "mechanism": "Scotch Yoke",
  "yoke_preference": "Auto"
}
```

### 兼容方式（旧版 snake_case）
```json
{
  "valve_torque": 100,
  "safety_factor": 1.3,
  "working_pressure": 0.6,
  "mechanism": "Scotch Yoke",
  "yoke_preference": "Auto"
}
```

### 直接提供需求扭矩（跳过计算）
```json
{
  "required_torque": 130,
  "working_pressure": 0.6,
  "mechanism": "Scotch Yoke"
}
```

---

## 📈 响应数据示例

```json
{
  "success": true,
  "message": "找到 5 个满足要求的执行器",
  "count": 5,
  "search_criteria": {
    "valve_torque": 100,
    "safety_factor": 1.3,
    "required_torque": 130,
    "working_pressure": 0.6,
    "mechanism": "Scotch Yoke",
    "yoke_preference": "Auto"
  },
  "data": [
    {
      "model_base": "SF14-200DA",
      "actual_torque": 150,
      "torque_margin": 15.38,
      "recommend_level": "推荐",
      "price": 2850
    }
  ],
  "best_choice": {
    "model_base": "SF14-200DA",
    "actual_torque": 150,
    "price": 2850
  }
}
```

---

## 🎯 关键优势

### 1. 清晰性
- ✅ 扭矩计算逻辑在算法最开始就明确执行
- ✅ 每个步骤都有清晰的注释和分隔符
- ✅ 控制台输出详细的计算过程

### 2. 准确性
- ✅ 统一使用 `requiredTorque` 进行所有扭矩比较
- ✅ 消除了多个变量名导致的混淆风险
- ✅ 安全系数默认值提升至 1.3，符合工程标准

### 3. 可追溯性
- ✅ 响应数据包含完整的计算参数
- ✅ 控制台输出详细的中间计算步骤
- ✅ 可以轻松追溯每个结果的来源

### 4. 兼容性
- ✅ 支持新版 camelCase 参数（推荐）
- ✅ 向后兼容旧版 snake_case 参数
- ✅ 支持直接提供需求扭矩

---

## 🧪 测试建议

### 测试场景 1: 使用新版参数
```bash
curl -X POST http://localhost:5001/api/selection/calculate \
  -H "Content-Type: application/json" \
  -d '{
    "valveTorque": 100,
    "safetyFactor": 1.3,
    "working_pressure": 0.6,
    "mechanism": "Scotch Yoke",
    "yoke_preference": "Auto"
  }'
```

**预期结果**:
- ✅ 计算出 `requiredTorque = 130 N·m`
- ✅ 控制台输出: `📊 扭矩计算：阀门扭矩 100 N·m × 安全系数 1.3 = 130 N·m`
- ✅ 返回所有满足 `actualTorque >= 130` 的执行器

### 测试场景 2: 省略安全系数（使用默认值）
```bash
curl -X POST http://localhost:5001/api/selection/calculate \
  -H "Content-Type: application/json" \
  -d '{
    "valveTorque": 100,
    "working_pressure": 0.6,
    "mechanism": "Rack & Pinion",
    "action_type_preference": "DA"
  }'
```

**预期结果**:
- ✅ 自动使用默认值 `safetyFactor = 1.3`
- ✅ 计算出 `requiredTorque = 130 N·m`

### 测试场景 3: 向后兼容（旧版参数）
```bash
curl -X POST http://localhost:5001/api/selection/calculate \
  -H "Content-Type: application/json" \
  -d '{
    "valve_torque": 100,
    "safety_factor": 1.5,
    "working_pressure": 0.6,
    "mechanism": "Scotch Yoke"
  }'
```

**预期结果**:
- ✅ 使用旧版参数计算
- ✅ `requiredTorque = 100 × 1.5 = 150 N·m`
- ✅ 控制台输出: `📊 扭矩计算（旧版）：...`

---

## 📝 修改文件清单

| 文件 | 修改内容 | 行数 |
|------|---------|------|
| `backend/controllers/selectionController.js` | 完整重构扭矩计算逻辑 | 9-87 |
| `backend/controllers/selectionController.js` | 更新所有 `requiredTorque` 使用 | 全文 |
| `backend/controllers/selectionController.js` | 添加调试日志 | 63, 71, 79, 104, 117, 435 |
| `backend/controllers/selectionController.js` | 更新响应数据结构 | 417-456 |

---

## 🎉 总结

本次优化确保了选型算法的扭矩计算逻辑：

1. ✅ **在算法最开始就明确执行**
2. ✅ **使用统一的 `requiredTorque` 变量**
3. ✅ **安全系数默认值调整为 1.3**
4. ✅ **支持新旧两种参数格式**
5. ✅ **添加详细的控制台日志**
6. ✅ **响应数据包含完整计算参数**

这些改进使得算法更加健壮、易于维护和调试！

---

**优化日期**: 2025-10-27  
**负责人**: Cursor AI Assistant  
**版本**: v2.0

