# å®šä»·å‡½æ•°å‡çº§ä½¿ç”¨æŒ‡å—

## ğŸ“… æ›´æ–°æ—¶é—´
2025-10-28

## ğŸ¯ æ›´æ–°å†…å®¹

æ ¸å¿ƒå®šä»·å‡½æ•° `calculatePrice` å·²å‡çº§ï¼Œç°åœ¨æ”¯æŒæ–°çš„å®šä»·æ¨¡å¼æ¶æ„ï¼ˆå›ºå®šä»·æ ¼ + é˜¶æ¢¯ä»·æ ¼ï¼‰ã€‚

---

## ğŸ“‹ æ ¸å¿ƒå‡½æ•°ï¼šcalculatePrice

### å‡½æ•°ç­¾å
```javascript
calculatePrice(productOrPriceTiers, quantity, priceType)
```

### æ”¯æŒä¸¤ç§è°ƒç”¨æ–¹å¼

#### âœ… æ–¹å¼ä¸€ï¼šæ–°æ–¹å¼ï¼ˆæ¨èï¼‰- ä¼ å…¥äº§å“å¯¹è±¡

```javascript
const product = {
  model_base: 'AT-SR52K8',
  pricing_model: 'tiered',  // 'fixed' æˆ– 'tiered'
  base_price: 2500,
  price_tiers: [
    { min_quantity: 1, unit_price: 2500 },
    { min_quantity: 10, unit_price: 2300 },
    { min_quantity: 50, unit_price: 2100 }
  ]
};

const unitPrice = calculatePrice(product, 15);
// è¿”å›: 2300 (å•ä»·)
```

#### âœ… æ–¹å¼äºŒï¼šæ—§æ–¹å¼ï¼ˆå‘åå…¼å®¹ï¼‰- ä¼ å…¥ä»·æ ¼æ•°ç»„

```javascript
const priceTiers = [
  { min_quantity: 1, unit_price: 5280, price_type: 'normal' },
  { min_quantity: 10, unit_price: 4752, price_type: 'normal' }
];

const priceInfo = calculatePrice(priceTiers, 8, 'normal');
// è¿”å›: { 
//   unit_price: 5280, 
//   total_price: 42240,
//   min_quantity: 1,
//   quantity: 8,
//   price_type: 'normal'
// }
```

---

## ğŸ†• æ–°å¢å‡½æ•°ï¼šgetProductPriceInfo

è·å–äº§å“çš„è¯¦ç»†ä»·æ ¼ä¿¡æ¯ï¼ŒåŒ…å«åº”ç”¨çš„ä»·æ ¼æ¡£ä½ã€èŠ‚çœé‡‘é¢ã€ä¸‹ä¸€æ¡£æ¨èç­‰ã€‚

### å‡½æ•°ç­¾å
```javascript
getProductPriceInfo(product, quantity)
```

### ä½¿ç”¨ç¤ºä¾‹

#### å›ºå®šä»·æ ¼äº§å“
```javascript
const product = {
  model_base: 'SF025',
  pricing_model: 'fixed',
  base_price: 1200
};

const priceInfo = getProductPriceInfo(product, 5);
console.log(priceInfo);
```

**è¾“å‡º**:
```javascript
{
  unit_price: 1200,
  total_price: 6000,
  quantity: 5,
  pricing_model: 'fixed',
  base_price: 1200
}
```

#### é˜¶æ¢¯ä»·æ ¼äº§å“
```javascript
const product = {
  model_base: 'AT-SR52K8',
  pricing_model: 'tiered',
  base_price: 2500,
  price_tiers: [
    { min_quantity: 1, unit_price: 2500, price_type: 'normal', notes: 'æ ‡å‡†ä»·æ ¼' },
    { min_quantity: 10, unit_price: 2300, price_type: 'normal', notes: 'æ‰¹é‡ä¼˜æƒ ' },
    { min_quantity: 50, unit_price: 2100, price_type: 'normal', notes: 'å¤§æ‰¹é‡ä¼˜æƒ ' }
  ]
};

const priceInfo = getProductPriceInfo(product, 15);
console.log(priceInfo);
```

**è¾“å‡º**:
```javascript
{
  unit_price: 2300,
  total_price: 34500,
  quantity: 15,
  pricing_model: 'tiered',
  base_price: 2500,
  
  // å½“å‰åº”ç”¨çš„ä»·æ ¼æ¡£ä½
  applied_tier: {
    min_quantity: 10,
    unit_price: 2300,
    price_type: 'normal',
    notes: 'æ‰¹é‡ä¼˜æƒ '
  },
  
  // èŠ‚çœé‡‘é¢ï¼ˆç›¸å¯¹äºåŸºç¡€ä»·æ ¼ï¼‰
  savings: {
    amount: 3000,        // æ€»èŠ‚çœé‡‘é¢ = (2500 - 2300) * 15
    rate: 8.00,          // èŠ‚çœæ¯”ä¾‹ 8%
    per_unit: 200        // æ¯ä»¶èŠ‚çœ 200 å…ƒ
  },
  
  // ä¸‹ä¸€ä¸ªä»·æ ¼æ¡£ä½æ¨è
  next_tier: {
    min_quantity: 50,
    unit_price: 2100,
    additional_quantity_needed: 35,    // å†ä¹° 35 ä»¶å¯è¾¾åˆ°ä¸‹ä¸€æ¡£
    additional_savings_per_unit: 200   // æ¯ä»¶å†èŠ‚çœ 200 å…ƒ
  },
  
  // æ‰€æœ‰å¯ç”¨çš„ä»·æ ¼æ¡£ä½
  available_tiers: [
    { min_quantity: 1, unit_price: 2500, price_type: 'normal', notes: 'æ ‡å‡†ä»·æ ¼' },
    { min_quantity: 10, unit_price: 2300, price_type: 'normal', notes: 'æ‰¹é‡ä¼˜æƒ ' },
    { min_quantity: 50, unit_price: 2100, price_type: 'normal', notes: 'å¤§æ‰¹é‡ä¼˜æƒ ' }
  ]
}
```

---

## ğŸ’¡ å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯ 1: åœ¨ API è·¯ç”±ä¸­ä½¿ç”¨

```javascript
// backend/routes/actuators.js

const { calculatePrice, getProductPriceInfo } = require('../utils/pricing');
const Actuator = require('../models/Actuator');

// è·å–äº§å“ä»·æ ¼ API
router.get('/actuators/:id/price', async (req, res) => {
  try {
    const { id } = req.params;
    const { quantity = 1 } = req.query;
    
    // ä»æ•°æ®åº“è·å–äº§å“
    const product = await Actuator.findById(id);
    
    if (!product) {
      return res.status(404).json({ error: 'äº§å“ä¸å­˜åœ¨' });
    }
    
    // è®¡ç®—ä»·æ ¼ï¼ˆç®€å•æ–¹å¼ï¼‰
    const unitPrice = calculatePrice(product, parseInt(quantity));
    
    res.json({
      model: product.model_base,
      quantity: parseInt(quantity),
      unit_price: unitPrice,
      total_price: unitPrice * parseInt(quantity)
    });
    
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// è·å–è¯¦ç»†ä»·æ ¼ä¿¡æ¯ API
router.get('/actuators/:id/price-detail', async (req, res) => {
  try {
    const { id } = req.params;
    const { quantity = 1 } = req.query;
    
    const product = await Actuator.findById(id);
    
    if (!product) {
      return res.status(404).json({ error: 'äº§å“ä¸å­˜åœ¨' });
    }
    
    // è·å–è¯¦ç»†ä»·æ ¼ä¿¡æ¯
    const priceInfo = getProductPriceInfo(product, parseInt(quantity));
    
    res.json({
      model: product.model_base,
      series: product.series,
      price_info: priceInfo
    });
    
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});
```

### åœºæ™¯ 2: åœ¨é€‰å‹ç®—æ³•ä¸­ä½¿ç”¨

```javascript
// backend/utils/selectionAlgorithm.js

const { calculatePrice } = require('./pricing');

function selectOptimalActuator(requirements, candidates) {
  const results = candidates.map(product => {
    const quantity = requirements.quantity || 1;
    
    // è®¡ç®—è¯¥äº§å“çš„ä»·æ ¼
    const unitPrice = calculatePrice(product, quantity);
    const totalPrice = unitPrice * quantity;
    
    return {
      product: product,
      unit_price: unitPrice,
      total_price: totalPrice,
      // ... å…¶ä»–é€‰å‹å‚æ•°
    };
  });
  
  // æŒ‰æ€»ä»·æ’åº
  results.sort((a, b) => a.total_price - b.total_price);
  
  return results;
}
```

### åœºæ™¯ 3: æ‰¹é‡è®¡ç®—å¤šä¸ªäº§å“

```javascript
const { calculateBulkPrice } = require('../utils/pricing');

// æ–°æ–¹å¼ï¼šä¼ å…¥äº§å“å¯¹è±¡
const items = [
  { product: sfProduct1, quantity: 5 },
  { product: atProduct1, quantity: 15 },
  { product: gyProduct1, quantity: 30 }
];

const bulkPrice = calculateBulkPrice(items);
console.log(bulkPrice);
```

**è¾“å‡º**:
```javascript
{
  total_price: 125000,
  items_count: 3,
  total_quantity: 50,
  items: [
    {
      index: 0,
      quantity: 5,
      unit_price: 1200,
      subtotal: 6000,
      pricing_model: 'fixed'
    },
    {
      index: 1,
      quantity: 15,
      unit_price: 2300,
      subtotal: 34500,
      pricing_model: 'tiered'
    },
    {
      index: 2,
      quantity: 30,
      unit_price: 2800,
      subtotal: 84500,
      pricing_model: 'tiered'
    }
  ]
}
```

### åœºæ™¯ 4: åœ¨å‰ç«¯æ˜¾ç¤ºä»·æ ¼

```javascript
// å‰ç«¯è¯·æ±‚ä»·æ ¼ä¿¡æ¯
const response = await fetch(`/api/actuators/${productId}/price-detail?quantity=${quantity}`);
const data = await response.json();

// æ˜¾ç¤ºä»·æ ¼ä¿¡æ¯
if (data.price_info.pricing_model === 'tiered') {
  console.log(`å½“å‰å•ä»·: Â¥${data.price_info.unit_price}`);
  console.log(`æ€»ä»·: Â¥${data.price_info.total_price}`);
  
  if (data.price_info.savings) {
    console.log(`ç›¸æ¯”åŸºç¡€ä»·èŠ‚çœ: Â¥${data.price_info.savings.amount} (${data.price_info.savings.rate}%)`);
  }
  
  if (data.price_info.next_tier) {
    console.log(`æç¤º: å†è´­ä¹° ${data.price_info.next_tier.additional_quantity_needed} ä»¶ï¼Œæ¯ä»¶å¯å†èŠ‚çœ Â¥${data.price_info.next_tier.additional_savings_per_unit}`);
  }
} else {
  console.log(`å›ºå®šå•ä»·: Â¥${data.price_info.unit_price}`);
  console.log(`æ€»ä»·: Â¥${data.price_info.total_price}`);
}
```

---

## ğŸ”„ å®šä»·æ¨¡å¼åˆ¤æ–­é€»è¾‘

### é˜¶æ¢¯ä»·æ ¼æŸ¥æ‰¾ï¼ˆTiered Pricingï¼‰

å½“ `pricing_model === 'tiered'` æ—¶ï¼Œæ‰§è¡Œä»¥ä¸‹é€»è¾‘ï¼š

```javascript
// 1. åˆå§‹åŒ–ä¸ºåŸºç¡€ä»·æ ¼
let applicablePrice = product.base_price || 0;

// 2. å€’åºéå†ä»·æ ¼æ¡£ä½
for (let i = product.price_tiers.length - 1; i >= 0; i--) {
  // 3. æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³æ•°é‡è¦æ±‚çš„æ¡£ä½
  if (quantity >= product.price_tiers[i].min_quantity) {
    applicablePrice = product.price_tiers[i].unit_price;
    break;  // æ‰¾åˆ°å³é€€å‡º
  }
}

// 4. è¿”å›é€‚ç”¨çš„å•ä»·
return applicablePrice;
```

**ç¤ºä¾‹**:
```javascript
// å‡è®¾ä»·æ ¼æ¡£ä½å¦‚ä¸‹ï¼š
price_tiers = [
  { min_quantity: 1, unit_price: 2500 },
  { min_quantity: 10, unit_price: 2300 },
  { min_quantity: 50, unit_price: 2100 }
]

// æ•°é‡ = 5
// å€’åºéå†ï¼š50 (ä¸æ»¡è¶³) -> 10 (ä¸æ»¡è¶³) -> 1 (æ»¡è¶³!)
// è¿”å›: 2500

// æ•°é‡ = 15
// å€’åºéå†ï¼š50 (ä¸æ»¡è¶³) -> 10 (æ»¡è¶³!)
// è¿”å›: 2300

// æ•°é‡ = 60
// å€’åºéå†ï¼š50 (æ»¡è¶³!)
// è¿”å›: 2100
```

### å›ºå®šä»·æ ¼ï¼ˆFixed Pricingï¼‰

å½“ `pricing_model === 'fixed'` æˆ–æœªè®¾ç½®æ—¶ï¼š

```javascript
return product.base_price || 0;
```

---

## ğŸ“Š å‡½æ•°å¯¹æ¯”è¡¨

| å‡½æ•° | è¾“å…¥ | è¾“å‡º | ç”¨é€” |
|-----|------|------|------|
| `calculatePrice` | äº§å“å¯¹è±¡ + æ•°é‡ | å•ä»·ï¼ˆNumberï¼‰ | å¿«é€Ÿè®¡ç®—å•ä»· |
| `getProductPriceInfo` | äº§å“å¯¹è±¡ + æ•°é‡ | è¯¦ç»†ä»·æ ¼å¯¹è±¡ | è·å–å®Œæ•´ä»·æ ¼ä¿¡æ¯ |
| `calculateBulkPrice` | äº§å“æ•°ç»„ | æ‰¹é‡æ€»ä»·å¯¹è±¡ | è®¡ç®—å¤šä¸ªäº§å“æ€»ä»· |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å‘åå…¼å®¹

æ—§çš„è°ƒç”¨æ–¹å¼ä»ç„¶æœ‰æ•ˆï¼š
```javascript
// æ—§æ–¹å¼ï¼ˆä»ç„¶æ”¯æŒï¼‰
const priceInfo = calculatePrice(priceTiers, quantity, priceType);

// æ–°æ–¹å¼ï¼ˆæ¨èï¼‰
const unitPrice = calculatePrice(product, quantity);
```

### 2. è¿”å›å€¼ç±»å‹

- **æ–°æ–¹å¼**: è¿”å› `Number`ï¼ˆå•ä»·ï¼‰
- **æ—§æ–¹å¼**: è¿”å› `Object`ï¼ˆåŒ…å«è¯¦ç»†ä¿¡æ¯ï¼‰

è¯·æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©è°ƒç”¨æ–¹å¼ã€‚

### 3. æ•°æ®å®Œæ•´æ€§

ç¡®ä¿äº§å“å¯¹è±¡åŒ…å«å¿…è¦å­—æ®µï¼š
- `pricing_model`: 'fixed' æˆ– 'tiered'
- `base_price`: åŸºç¡€ä»·æ ¼ï¼ˆå¿…éœ€ï¼‰
- `price_tiers`: ä»·æ ¼æ¡£ä½æ•°ç»„ï¼ˆé˜¶æ¢¯å®šä»·æ—¶å¿…éœ€ï¼‰

### 4. ä»·æ ¼æ¡£ä½é¡ºåº

`price_tiers` æ•°ç»„æ— éœ€é¢„å…ˆæ’åºï¼Œå‡½æ•°ä¼šè‡ªåŠ¨å¤„ç†ã€‚ä½†å»ºè®®æŒ‰ `min_quantity` å‡åºå­˜å‚¨ï¼š
```javascript
price_tiers: [
  { min_quantity: 1, unit_price: 2500 },    // æœ€å°æ¡£
  { min_quantity: 10, unit_price: 2300 },   // ä¸­é—´æ¡£
  { min_quantity: 50, unit_price: 2100 }    // æœ€å¤§æ¡£
]
```

---

## ğŸ§ª æµ‹è¯•ç¤ºä¾‹

### æµ‹è¯•å›ºå®šä»·æ ¼

```javascript
const { calculatePrice } = require('./utils/pricing');

const sfProduct = {
  model_base: 'SF025',
  pricing_model: 'fixed',
  base_price: 1200
};

console.log('æ•°é‡ 1:', calculatePrice(sfProduct, 1));   // 1200
console.log('æ•°é‡ 5:', calculatePrice(sfProduct, 5));   // 1200
console.log('æ•°é‡ 100:', calculatePrice(sfProduct, 100)); // 1200
```

### æµ‹è¯•é˜¶æ¢¯ä»·æ ¼

```javascript
const atProduct = {
  model_base: 'AT-SR52K8',
  pricing_model: 'tiered',
  base_price: 2500,
  price_tiers: [
    { min_quantity: 1, unit_price: 2500 },
    { min_quantity: 10, unit_price: 2300 },
    { min_quantity: 50, unit_price: 2100 }
  ]
};

console.log('æ•°é‡ 1:', calculatePrice(atProduct, 1));    // 2500
console.log('æ•°é‡ 5:', calculatePrice(atProduct, 5));    // 2500
console.log('æ•°é‡ 10:', calculatePrice(atProduct, 10));  // 2300
console.log('æ•°é‡ 15:', calculatePrice(atProduct, 15));  // 2300
console.log('æ•°é‡ 50:', calculatePrice(atProduct, 50));  // 2100
console.log('æ•°é‡ 100:', calculatePrice(atProduct, 100)); // 2100
```

### æµ‹è¯•è¾¹ç•Œæƒ…å†µ

```javascript
// æƒ…å†µ1: æ•°é‡ä¸º 0ï¼ˆè‡ªåŠ¨è®¾ä¸º 1ï¼‰
console.log('æ•°é‡ 0:', calculatePrice(atProduct, 0));    // 2500

// æƒ…å†µ2: ç¼ºå°‘ price_tiersï¼ˆå›é€€åˆ° base_priceï¼‰
const invalidProduct = {
  pricing_model: 'tiered',
  base_price: 3000
  // ç¼ºå°‘ price_tiers
};
console.log('æ— ä»·æ ¼æ¡£ä½:', calculatePrice(invalidProduct, 10)); // 3000

// æƒ…å†µ3: ç¼ºå°‘ base_price
const noPriceProduct = {
  pricing_model: 'fixed'
  // ç¼ºå°‘ base_price
};
console.log('æ— åŸºç¡€ä»·æ ¼:', calculatePrice(noPriceProduct, 5)); // 0
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **æ•°æ®å¤„ç†è„šæœ¬**: `æ•°æ®å¤„ç†è„šæœ¬æ›´æ–°æŠ¥å‘Š.md`
- **å¿«é€Ÿå‚è€ƒ**: `å®šä»·æ¨¡å¼æ•°æ®å¤„ç†å¿«é€Ÿå‚è€ƒ.md`
- **æ¨¡å‹å®šä¹‰**: `backend/models/Actuator.js`
- **API æ–‡æ¡£**: `APIæ¥å£æ–‡æ¡£.md`

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åœ¨ API è·¯ç”±ä¸­ä½¿ç”¨

```javascript
const { calculatePrice } = require('../utils/pricing');

router.get('/products/:id/price', async (req, res) => {
  const product = await Product.findById(req.params.id);
  const unitPrice = calculatePrice(product, req.query.quantity);
  res.json({ unit_price: unitPrice });
});
```

### 2. åœ¨é€‰å‹ç®—æ³•ä¸­ä½¿ç”¨

```javascript
const unitPrice = calculatePrice(candidateProduct, requirements.quantity);
const score = calculateScore(candidateProduct, unitPrice, requirements);
```

### 3. åœ¨å‰ç«¯æ˜¾ç¤ºä»·æ ¼

```javascript
const data = await fetchProductPrice(productId, quantity);
setUnitPrice(data.unit_price);
setTotalPrice(data.unit_price * quantity);
```

---

## âœ… å‡çº§æ£€æŸ¥æ¸…å•

- [ ] æ›´æ–°æ‰€æœ‰è°ƒç”¨ `calculatePrice` çš„ä»£ç 
- [ ] æµ‹è¯•å›ºå®šä»·æ ¼äº§å“çš„ä»·æ ¼è®¡ç®—
- [ ] æµ‹è¯•é˜¶æ¢¯ä»·æ ¼äº§å“çš„ä»·æ ¼è®¡ç®—
- [ ] éªŒè¯ API è¿”å›çš„ä»·æ ¼æ­£ç¡®
- [ ] æ£€æŸ¥å‰ç«¯ä»·æ ¼æ˜¾ç¤ºæ­£å¸¸
- [ ] æµ‹è¯•æ‰¹é‡è®¡ç®—åŠŸèƒ½
- [ ] éªŒè¯å‘åå…¼å®¹æ€§

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¥æœŸ**: 2025-10-28  
**ç»´æŠ¤è€…**: C-MAX æŠ€æœ¯å›¢é˜Ÿ

