# 📋 批量操作与提醒系统 - 快速参考

## 🚀 快速启动

### 启动后端（包含提醒服务）
```bash
cd backend
npm start
```

**提示**：服务器启动时会自动激活提醒服务
```
╔════════════════════════════════════════════════════════╗
║        Project Ark Platform API                        ║
║   Contract Reminder: Active                            ║
╚════════════════════════════════════════════════════════╝
✅ 合同提醒服务已启动
🔔 开始执行合同提醒任务...
```

### 启动前端
```bash
cd frontend
npm run dev
```

---

## 💼 批量操作功能

### 使用步骤

1. **进入合同管理中心**
   ```
   登录系统 → Dashboard → 点击"合同管理中心"
   ```

2. **选择合同**
   - 勾选单个合同
   - 或点击表头全选所有合同

3. **执行批量操作**

   | 操作 | 功能 | 快捷键 |
   |------|------|--------|
   | 批量接单 | 快速接收多个待盖章合同 | - |
   | 导出Excel | 导出合同数据表格（.xlsx） | - |
   | 导出PDF | 生成合同PDF报告 | - |
   | 批量删除 | 删除待盖章合同（需确认） | - |

### 导出文件示例

**Excel导出内容**：
```
合同编号 | 合同名称 | 合同类型 | 金额 | 币种 | 状态 | ...
CT-001  | XXX项目  | 销售合同 | 50000| CNY  | 已盖章|...
CT-002  | YYY采购  | 采购合同 | 30000| CNY  | 待盖章|...
```

**PDF导出格式**：
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Contract Details

Contract Number: CT-2025-001
Contract Name: XXX销售合同
Contract Type: 销售合同
Amount: ¥50,000 CNY
Status: 已盖章
Counterparty: 客户A
Created: 2025-10-28 10:30
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 🔔 提醒系统

### 提醒类型

| 图标 | 类型 | 触发条件 | 优先级 |
|------|------|----------|--------|
| ⏰ | 即将到期 | 合同7天内到期 | 3天内：高🔴<br>4-7天：中🟡 |
| 📄 | 待处理过久 | 提交3天未处理 | 5天+：高🔴<br>3-5天：中🟡 |
| 💰 | 付款逾期 | 盖章7天未付款 | 14天+：高🔴<br>7-14天：中🟡 |

### Dashboard显示

```
┌──────────────────────────────────────────────┐
│ 🔔 合同提醒 (3)              [刷新] [折叠]    │
├──────────────────────────────────────────────┤
│ 高优先级: 1    中优先级: 2                    │
│                                              │
│ ⚠️ 紧急提醒                                   │
│ ┌──────────────────────────────────────┐   │
│ │ 🔴 CT-2025-001  [即将到期]      [X]   │   │
│ │ 合同将在 2 天后到期                    │   │
│ │ 到期日期: 2025-11-02                  │   │
│ │                          [查看详情]    │   │
│ └──────────────────────────────────────┘   │
└──────────────────────────────────────────────┘
```

### 提醒操作

- **查看详情**：跳转到合同管理中心
- **关闭提醒**：点击 [X] 忽略该提醒
- **手动刷新**：点击刷新图标立即更新

### 自动刷新

- **后端**：每天早上 9:00 自动检查
- **前端**：每 5 分钟自动刷新
- **手动**：点击刷新按钮立即更新

---

## 🔧 API 接口

### 批量操作（前端直接调用后端API）

所有批量操作都通过现有的合同API完成，前端循环调用：

```javascript
// 批量接单
for (const contractId of selectedIds) {
  await api.put(`/contracts/${contractId}/accept`);
}

// 批量删除
for (const contractId of selectedIds) {
  await api.delete(`/contracts/${contractId}`);
}
```

### 提醒API

```bash
# 获取当前用户提醒
GET /api/reminders

# 获取所有提醒（管理员）
GET /api/reminders/all

# 获取提醒统计
GET /api/reminders/stats

# 手动刷新提醒
POST /api/reminders/refresh

# 关闭提醒
DELETE /api/reminders/:contractId/:type
```

**示例请求**：
```javascript
// 获取我的提醒
const response = await api.get('/reminders');
// 返回：{ success: true, data: [...], count: 3 }

// 关闭提醒
await api.delete('/reminders/60abc123def/contract_expiring');
```

---

## 🎯 常见问题

### Q1: 批量操作失败怎么办？

**A**: 查看操作结果提示，显示成功和失败的数量。失败的合同可能是：
- 状态不符合（如删除已盖章的合同）
- 权限不足
- 网络问题

### Q2: 提醒没有显示？

**A**: 检查以下几点：
1. 确认服务器已启动提醒服务
2. 检查是否有符合条件的合同
3. 尝试点击刷新按钮手动刷新
4. 查看浏览器控制台是否有错误

### Q3: 如何修改提醒时间？

**A**: 编辑 `backend/services/contractReminderService.js`：
```javascript
// 修改定时任务时间
cron.schedule('0 9 * * *', async () => {
  // 改为每天8点：'0 8 * * *'
  // 改为每2小时：'0 */2 * * *'
});
```

### Q4: 导出的Excel乱码怎么办？

**A**: 确保使用支持UTF-8的软件打开（如WPS、Excel 2016+）

### Q5: 提醒优先级如何调整？

**A**: 编辑 `backend/services/contractReminderService.js`：
```javascript
// 修改到期提醒阈值
priority: daysUntilExpiry <= 3 ? 'high' : 'medium'
// 改为2天：daysUntilExpiry <= 2 ? 'high' : 'medium'
```

---

## 📊 性能优化

### 批量操作优化
```javascript
// 使用 Promise.all 并发处理
await Promise.all(
  selectedIds.map(id => api.put(`/contracts/${id}/accept`))
);
```

### 提醒系统优化
- 内存缓存：避免频繁查询数据库
- 非高峰执行：早上9点执行定时任务
- 前端节流：5分钟自动刷新

---

## 🔒 权限控制

### 批量操作权限
- **商务工程师**：全部功能
- **管理员**：全部功能
- **其他角色**：无权限

### 提醒权限
- **所有用户**：可查看自己的提醒
- **商务工程师/管理员**：可查看所有提醒和统计

---

## 📝 日志监控

### 查看提醒服务日志
```bash
cd backend
npm start

# 输出示例：
✅ 合同提醒服务已启动
🔔 开始执行合同提醒任务...
⏰ 发现 2 个即将到期的合同
⚠️  发现 3 个长时间未处理的合同
💰 发现 1 个需要催款的合同
📊 合同提醒检查完成，共生成 6 条提醒
```

### 调试模式
```javascript
// 在 contractReminderService.js 中添加
console.log('提醒数据:', this.reminders);
```

---

## 🎉 快速测试

### 测试批量操作
```bash
1. 创建 3-5 个待盖章合同
2. 进入合同管理中心
3. 全选所有合同
4. 依次测试：批量接单、导出Excel、导出PDF
```

### 测试提醒系统
```javascript
// 方法1：手动刷新
打开Dashboard → 点击提醒卡片的刷新按钮

// 方法2：API测试
POST http://localhost:5001/api/reminders/refresh

// 方法3：查看定时任务日志
查看后端控制台输出
```

---

## 📞 技术支持

如有问题，请查看：
1. **完整报告**：`✅批量操作与提醒系统-实现完成报告.md`
2. **代码文件**：
   - 批量操作：`frontend/src/pages/ContractCenter.jsx`
   - 提醒服务：`backend/services/contractReminderService.js`
   - 提醒组件：`frontend/src/components/ContractReminders.jsx`

---

**最后更新**：2025-10-31
**版本**：v1.0
**状态**：✅ 生产就绪

