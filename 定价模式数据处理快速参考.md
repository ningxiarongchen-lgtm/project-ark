# 定价模式数据处理快速参考

## 📋 目录
- [核心概念](#核心概念)
- [数据导入](#数据导入)
- [数据迁移](#数据迁移)
- [CSV 格式示例](#csv-格式示例)
- [常见问题](#常见问题)

---

## 核心概念

### 定价模式（pricing_model）

系统支持两种定价模式：

| 模式 | 值 | 说明 | 适用场景 |
|-----|-----|------|---------|
| 固定价格 | `'fixed'` | 单一价格，不论数量 | SF系列、标准产品 |
| 阶梯价格 | `'tiered'` | 根据数量不同价格不同 | AT/GY系列、批量优惠 |

### 数据结构

```javascript
// 固定价格模式
{
  model_base: "SF025",
  pricing_model: "fixed",
  base_price: 1200
}

// 阶梯价格模式
{
  model_base: "AT-SR52K8",
  pricing_model: "tiered",
  base_price: 2500,  // 保留基础价格
  price_tiers: [
    { min_quantity: 1, unit_price: 2500 },
    { min_quantity: 10, unit_price: 2300 },
    { min_quantity: 50, unit_price: 2100 }
  ]
}
```

---

## 数据导入

### 方式一：导入固定价格产品（SF系列）

```bash
cd backend
node seed.js
```

**CSV 格式**:
```csv
model_base,series,base_price
SF025,SF,1200
SF040,SF,1500
```

**自动处理**:
- ✅ 自动设置 `pricing_model = 'fixed'`
- ✅ 价格存入 `base_price`

---

### 方式二：导入阶梯价格产品（AT/GY系列 - 基础版）

```bash
cd backend
node seed_at_gy.js
```

**CSV 格式（固定价格）**:
```csv
model_base,series,base_price
AT-SR52K8,AT,2500
```

**CSV 格式（阶梯价格）**:
```csv
model_base,series,qty_1,price_1,qty_2,price_2,qty_3,price_3
AT-SR52K8,AT,1,2500,10,2300,50,2100
```

**自动处理**:
- ✅ 检测是否有 `qty_X` 和 `price_X` 列
- ✅ 有：设置 `pricing_model = 'tiered'`，解析到 `price_tiers`
- ✅ 无：设置 `pricing_model = 'fixed'`，价格存入 `base_price`

---

### 方式三：导入完整价格产品（AT/GY系列 - 最终版）

```bash
cd backend
node seed_at_gy_final.js
```

**CSV 格式（多价格档位）**:
```csv
model_base,series,base_price_low,base_price_normal,base_price_high
AT-SR52K8,AT,2300,2500,2700
```

**自动处理**:
- ✅ 检测到 `base_price_low` 和 `base_price_high`
- ✅ 自动转换为阶梯价格模式
- ✅ 生成 3 个价格档位
- ✅ 保留 `base_price`（使用 `base_price_normal`）
- ✅ 保留原始价格到 `pricing` 对象（向后兼容）

---

## 数据迁移

### 迁移现有数据（添加 pricing_model 字段）

```bash
cd backend
node migration_price_tiers.js
```

**功能**:
1. ✅ 遍历所有执行器和配件文档
2. ✅ **保留** 原有的 `base_price` 字段
3. ✅ **新增** `pricing_model` 字段
4. ✅ 智能判断定价模式：
   - 有 `price_tiers` → `'tiered'`
   - 有 `base_price_low/high` → `'tiered'`
   - 其他情况 → `'fixed'`（默认）

**预期结果**:
- SF 系列产品 → `pricing_model: 'fixed'`
- AT/GY 单价产品 → `pricing_model: 'fixed'`
- AT/GY 阶梯价格产品 → `pricing_model: 'tiered'`

---

## CSV 格式示例

### 1️⃣ 固定价格（最简单）

```csv
model_base,series,action_type,base_price
SF025,SF,DA,1200
SF040,SF,SR,1500
SF063,SF,DA,2300
```

**结果**: `pricing_model = 'fixed'`, `base_price` = CSV中的价格

---

### 2️⃣ 阶梯价格（标准格式）

```csv
model_base,series,qty_1,price_1,qty_2,price_2,qty_3,price_3
AT-SR52K8,AT,1,2500,10,2300,50,2100
AT-DA63,AT,1,3200,20,3000,100,2800
```

**结果**: 
```javascript
pricing_model = 'tiered'
base_price = 2500  // 第一档价格
price_tiers = [
  { min_quantity: 1, unit_price: 2500 },
  { min_quantity: 10, unit_price: 2300 },
  { min_quantity: 50, unit_price: 2100 }
]
```

---

### 3️⃣ 阶梯价格（低/标准/高格式）

```csv
model_base,series,base_price_low,base_price_normal,base_price_high
GY-63,GY,3500,4000,4500
AT-SR52K8,AT,2300,2500,2700
```

**结果**: 
```javascript
pricing_model = 'tiered'
base_price = 4000  // 标准价格
price_tiers = [
  { min_quantity: 10, unit_price: 3500, price_type: 'low', notes: '大批量优惠价' },
  { min_quantity: 1, unit_price: 4000, price_type: 'normal', notes: '标准价格' },
  { min_quantity: 1, unit_price: 4500, price_type: 'high', notes: '小批量价格' }
]
pricing = {  // 向后兼容
  base_price_normal: 4000,
  base_price_low: 3500,
  base_price_high: 4500
}
```

---

### 4️⃣ 阶梯价格（完整格式，带备注）

```csv
model_base,series,qty_1,price_1,price_type_1,notes_1,qty_2,price_2,price_type_2,notes_2
AT-SR52K8,AT,1,2500,normal,标准价,50,2100,low,批量优惠
```

**结果**: 
```javascript
price_tiers = [
  { 
    min_quantity: 1, 
    unit_price: 2500, 
    price_type: 'normal', 
    notes: '标准价' 
  },
  { 
    min_quantity: 50, 
    unit_price: 2100, 
    price_type: 'low', 
    notes: '批量优惠' 
  }
]
```

---

## 常见问题

### Q1: 如何判断我的产品应该用哪种定价模式？

**A**: 
- **固定价格**: 价格不随数量变化（如 SF 系列）
- **阶梯价格**: 买的越多，单价越低（如 AT/GY 系列批量采购）

---

### Q2: 我的 CSV 只有一个 `base_price` 列，会被识别为什么模式？

**A**: 自动识别为 **固定价格模式** (`'fixed'`)

---

### Q3: 如果我有 `base_price_low` 和 `base_price_high`，会怎样？

**A**: 自动识别为 **阶梯价格模式** (`'tiered'`)，并生成 3 个价格档位：
- 低价（数量 ≥ 10）
- 标准价（数量 ≥ 1）
- 高价（数量 ≥ 1，小批量）

---

### Q4: 阶梯价格模式还会保留 `base_price` 吗？

**A**: **会**！即使是阶梯价格，也会保留 `base_price`（使用标准价格或第一档价格），用于快速查询。

---

### Q5: 如果阶梯价格解析失败会怎样？

**A**: 自动回退到固定价格模式，使用 `base_price` 或 `base_price_normal`。

---

### Q6: 导入数据后如何验证？

**A**: 
```bash
# 方法1: 使用 MongoDB Shell
mongosh
use cmax-actuators
db.actuators.find({ pricing_model: { $exists: false } }).count()  # 应为 0
db.actuators.find({ pricing_model: 'fixed' }).count()
db.actuators.find({ pricing_model: 'tiered' }).count()

# 方法2: 使用 API
curl http://localhost:3000/api/actuators?series=SF  # 查看 SF 系列
curl http://localhost:3000/api/actuators?series=AT  # 查看 AT 系列
```

---

### Q7: 我已经导入了数据，但没有 `pricing_model` 字段，怎么办？

**A**: 运行迁移脚本：
```bash
cd backend
node migration_price_tiers.js
```

---

### Q8: 迁移脚本会删除我的 `base_price` 吗？

**A**: **不会**！新版迁移脚本（v2.0.0）会保留所有现有字段，只添加 `pricing_model`。

---

### Q9: 支持的价格字段别名有哪些？

**A**: 
```javascript
// 基础价格
base_price, price

// 阶梯价格 - 数量
qty_1, qty_2, ..., qty_5
min_quantity_1, min_quantity_2, ..., min_quantity_5

// 阶梯价格 - 单价
price_1, price_2, ..., price_5
unit_price_1, unit_price_2, ..., unit_price_5

// 多档位价格
base_price_low, base_price_normal, base_price_high
```

---

### Q10: 可以混合使用两种定价模式吗？

**A**: **可以**！SF 系列用固定价格，AT/GY 系列用阶梯价格，系统会自动识别。

---

## 🚀 快速上手

### Step 1: 准备 CSV 数据

根据产品特性选择格式：
- SF 系列 → 只需 `base_price` 列
- AT/GY 系列（单价）→ 只需 `base_price` 列
- AT/GY 系列（阶梯）→ 需要 `qty_X` 和 `price_X` 列

### Step 2: 运行导入脚本

```bash
cd backend

# SF 系列
node seed.js

# AT/GY 系列
node seed_at_gy_final.js
```

### Step 3: 验证数据

```bash
# 连接数据库
mongosh
use cmax-actuators

# 检查 pricing_model 字段
db.actuators.find({}, { model_base: 1, pricing_model: 1, base_price: 1 }).pretty()
```

### Step 4: 测试 API

```bash
# 测试固定价格
curl http://localhost:3000/api/actuators/price?model=SF025&quantity=5

# 测试阶梯价格
curl http://localhost:3000/api/actuators/price?model=AT-SR52K8&quantity=50
```

---

## 📊 脚本对比表

| 脚本 | 用途 | 支持格式 | 定价模式判断 |
|-----|------|---------|------------|
| `seed.js` | SF系列导入 | 固定价格、阶梯价格 | ✅ 自动 |
| `seed_at_gy.js` | AT/GY基础导入 | 固定价格、阶梯价格 | ✅ 自动 |
| `seed_at_gy_final.js` | AT/GY完整导入 | 固定、阶梯、多档位 | ✅ 自动（高级） |
| `migration_price_tiers.js` | 现有数据迁移 | - | ✅ 智能判断 |

---

## 📞 技术支持

如有问题，请参考：
- 详细文档: `数据处理脚本更新报告.md`
- 模型定义: `backend/models/Actuator.js`
- API 文档: `API接口文档.md`

---

**版本**: v1.0  
**更新**: 2025-10-28  
**维护**: C-MAX 技术团队

