# 订单管理功能快速参考 🚀

## 📌 核心文件

### 后端
```
backend/
├── models/SalesOrder.js           # 订单数据模型
├── controllers/orderController.js # 订单控制器
└── routes/orderRoutes.js          # 订单路由
```

### 前端
```
frontend/src/
├── pages/
│   ├── OrderManagement.jsx        # 订单列表页
│   ├── OrderDetails.jsx           # 订单详情页
│   └── ProjectDetails.jsx         # 项目详情页（新增订单生成功能）
└── services/api.js                # API服务（新增ordersAPI）
```

---

## 🔗 API端点速查

| 功能 | 方法 | 端点 |
|------|------|------|
| 从项目创建订单 | POST | `/api/orders/from-project/:projectId` |
| 获取订单列表 | GET | `/api/orders?status=&page=&limit=` |
| 获取订单详情 | GET | `/api/orders/:id` |
| 更新订单 | PUT | `/api/orders/:id` |
| 更新状态 | PATCH | `/api/orders/:id/status` |
| 添加付款 | POST | `/api/orders/:id/payment` |
| 删除订单 | DELETE | `/api/orders/:id` |
| 获取统计 | GET | `/api/orders/statistics` |

---

## 📋 订单状态

```
Pending → Confirmed → In Production → Shipped → Delivered → Completed
                                                    ↓
                                                Cancelled
```

**付款状态**: Pending | Partial | Paid | Overdue

---

## 🎯 使用流程

### 1. 从项目生成订单

```javascript
// 前端调用
import { ordersAPI } from '../services/api'

const orderData = {
  requestedDeliveryDate: "2025-11-30",
  shippingAddress: "客户地址",
  shippingMethod: "Standard",
  deliveryTerms: "FOB Factory",
  paymentTerms: "Net 30",
  taxRate: 13,
  shippingCost: 500,
  discount: 0,
  notes: "订单备注",
  internalNotes: "内部备注"
}

const response = await ordersAPI.createFromProject(projectId, orderData)
```

### 2. 获取订单列表

```javascript
// 带筛选条件
const params = {
  status: 'Confirmed',
  paymentStatus: 'Pending',
  page: 1,
  limit: 20,
  startDate: '2025-01-01',
  endDate: '2025-12-31'
}

const response = await ordersAPI.getAll(params)
```

### 3. 添加付款记录

```javascript
const paymentData = {
  amount: 28500,
  date: "2025-10-27",
  method: "Bank Transfer",
  reference: "TXN20251027001",
  notes: "首付款50%"
}

await ordersAPI.addPayment(orderId, paymentData)
```

---

## ⚠️ 重要限制

1. **只有状态为 `Won` 的项目才能生成订单**
2. **每个项目只能生成一个订单**（防止重复）
3. **项目必须有BOM数据才能生成订单**
4. **只能删除 `Pending` 或 `Cancelled` 状态的订单**

---

## 🧪 快速测试

### 测试步骤
```bash
# 1. 启动后端
cd backend
npm start

# 2. 启动前端
cd frontend
npm run dev

# 3. 在浏览器中
# - 登录系统
# - 进入"项目管理"
# - 选择一个有BOM的项目
# - 点击"标记为赢单"
# - 点击"一键生成合同订单"
# - 填写表单并提交
# - 在"订单管理"查看新订单
```

---

## 🎨 UI组件特色

### ProjectDetails.jsx 新增按钮
```jsx
{/* 赢单按钮 - 绿色渐变 */}
{project.status !== 'Won' && (
  <Button icon={<CheckCircleOutlined />}>标记为赢单</Button>
)}

{/* 生成订单按钮 - 蓝色渐变 */}
{project.status === 'Won' && (
  <Button icon={<ShoppingCartOutlined />}>一键生成合同订单</Button>
)}
```

### OrderManagement.jsx 统计卡片
- 订单总数
- 待处理订单
- 总营收
- 未收款金额

### OrderDetails.jsx 关键组件
- Steps（订单进度条）
- Statistic（财务统计卡）
- Timeline（付款记录时间轴）
- Table（订单明细表格）

---

## 🔧 常见问题

### Q1: 为什么无法生成订单？
**A**: 检查以下条件：
- 项目状态必须为 `Won`
- 项目必须有BOM数据
- 该项目还没有生成过订单

### Q2: 如何修改订单？
**A**: 
- 在订单详情页点击"更新状态"
- 使用PUT `/api/orders/:id` 更新完整订单信息

### Q3: 付款状态如何自动更新？
**A**: 
- 添加付款记录时，系统自动计算已付金额
- 已付 >= 总额: `Paid`
- 已付 > 0: `Partial`
- 未付: `Pending`

### Q4: 可以取消订单吗？
**A**: 
- 可以，将订单状态更新为 `Cancelled`
- 已取消的订单可以删除

---

## 📊 数据库字段速查

### SalesOrder 核心字段
```javascript
{
  orderNumber: String,           // 自动生成 SO-YYYYMM-XXXX
  status: String,                // 订单状态
  project: ObjectId,             // 关联项目
  projectSnapshot: Object,       // 项目快照
  orderItems: Array,             // 订单明细
  financial: {
    subtotal: Number,
    tax_rate: Number,
    tax_amount: Number,
    shipping_cost: Number,
    discount: Number,
    total_amount: Number
  },
  payment: {
    payment_status: String,
    payment_terms: String,
    paid_amount: Number,
    payment_records: Array
  },
  delivery: {
    shipping_method: String,
    delivery_terms: String,
    shipping_address: String,
    tracking_number: String
  }
}
```

---

## 🌟 最佳实践

### 1. 订单创建
- 在项目BOM确认无误后再生成订单
- 填写完整的交付和付款信息
- 添加必要的备注说明

### 2. 订单跟踪
- 及时更新订单状态
- 记录每笔付款信息
- 添加物流跟踪号

### 3. 数据安全
- 重要操作前都有二次确认
- 内部备注不会显示给客户
- 项目快照确保订单数据独立

---

## 🎯 下一步功能

可扩展的功能方向：
- ✨ 订单PDF导出
- ✨ 邮件通知
- ✨ 订单搜索
- ✨ 批量操作
- ✨ 订单模板
- ✨ 库存检查
- ✨ 物流跟踪

---

**更新时间**: 2025-10-27  
**版本**: v1.0.0

💡 **提示**: 这是一个快速参考文档。详细信息请查看《订单管理功能完成报告.md》


