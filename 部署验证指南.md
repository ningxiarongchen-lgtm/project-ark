# 部署验证指南 ✅

## 🎯 验证目标
确保前端、后端和数据库的所有安全配置都已正确实施。

---

## 📋 验证清单

### 阶段 1: 部署前准备验证 (5分钟)

#### 1.1 环境变量检查

**后端 (Render):**
```bash
# 登录 Render Dashboard
# 进入你的服务 > Environment

检查以下变量是否存在:
✅ MONGODB_URI (不为空)
✅ JWT_SECRET (至少32字符)
✅ REFRESH_TOKEN_SECRET (至少32字符)
✅ NODE_ENV=production
✅ FRONTEND_URL (你的Vercel域名)
```

**前端 (Vercel):**
```bash
# 登录 Vercel Dashboard
# 进入项目 > Settings > Environment Variables

检查:
✅ VITE_API_URL (你的Render后端域名/api)
```

**本地检查:**
```bash
# 确保 .env 在 .gitignore 中
cd "Model Selection System"
cat .gitignore | grep ".env"
# 期望输出: .env

# 确保 Git 历史中无 .env
git log --all --full-history -- "**/.env" --oneline
# 期望输出: (空)
```

---

#### 1.2 代码安全检查

**CORS 配置:**
```bash
# 检查后端 CORS 配置
cd backend
grep -A 5 "cors({" server.js

# 期望看到:
# origin: process.env.FRONTEND_URL (✅ 不是 '*')
# credentials: true (✅)
```

**Cookie 配置:**
```bash
# 检查 Cookie 安全配置
grep -A 5 "res.cookie" controllers/authController.js

# 期望看到:
# httpOnly: true (✅)
# secure: process.env.NODE_ENV === 'production' (✅)
# sameSite: 'strict' (✅)
```

**依赖安全扫描:**
```bash
# 后端扫描
cd backend
npm audit --production
echo "---"
echo "高危和严重漏洞数:"
npm audit --production --json | jq '.metadata.vulnerabilities | .critical + .high'

# 期望输出: 0

# 前端扫描
cd ../frontend
npm audit --production
echo "---"
echo "高危和严重漏洞数:"
npm audit --production --json | jq '.metadata.vulnerabilities | .critical + .high'

# 期望输出: 0
```

---

### 阶段 2: 部署后基础验证 (10分钟)

#### 2.1 服务可用性检查

**前端检查:**
```bash
# 替换为你的实际 Vercel 域名
FRONTEND_URL="https://your-app.vercel.app"

echo "检查前端是否可访问..."
curl -I $FRONTEND_URL

# 期望看到:
# HTTP/2 200 OK (✅)
# 或自动重定向到 HTTPS
```

**后端健康检查:**
```bash
# 替换为你的实际 Render 域名
BACKEND_URL="https://your-backend.onrender.com"

echo "检查后端健康状态..."
curl -X GET "$BACKEND_URL/api/health" 2>/dev/null | jq '.'

# 期望输出:
# {
#   "status": "ok",
#   "timestamp": "2025-10-28T..."
# }
```

---

#### 2.2 HTTPS 验证

**强制 HTTPS 检查:**
```bash
# 测试 HTTP 是否自动重定向到 HTTPS
echo "测试 HTTP 重定向..."
curl -I http://your-app.vercel.app 2>&1 | grep -i "location: https"

# 期望看到:
# location: https://your-app.vercel.app (✅)

echo "测试后端 HTTPS..."
curl -I $BACKEND_URL/api/health 2>&1 | grep -i "strict-transport-security"

# 期望看到:
# strict-transport-security: max-age=15552000 (✅)
```

**SSL 证书验证:**
```bash
# 在线工具检查 (手动)
# 访问: https://www.ssllabs.com/ssltest/

# 输入你的域名:
# - https://your-app.vercel.app
# - https://your-backend.onrender.com

# 期望评级: A 或 A+
```

---

#### 2.3 Cookie 安全验证

**浏览器手动检查:**

1. **访问前端应用**: https://your-app.vercel.app
2. **打开开发者工具**: F12 或 Cmd+Option+I (Mac)
3. **登录系统**: 使用测试账号 admin@cmax.com / admin123
4. **检查 Cookies**:
   - 进入 **Application** 标签 (Chrome) 或 **Storage** 标签 (Firefox)
   - 左侧选择 **Cookies** > 你的域名
   - 查看 `accessToken` 和 `refreshToken`

**期望的 Cookie 属性:**
```
Name: accessToken
Value: (JWT token - 应该很长)
Domain: your-app.vercel.app
Path: /
Expires: (8小时后)
Size: ~200-500 bytes
HttpOnly: ✅ (有勾选标记)
Secure: ✅ (生产环境)
SameSite: Strict ✅

Name: refreshToken
(同样的属性检查)
```

**JavaScript 访问测试:**
```javascript
// 在浏览器 Console 中运行
console.log(document.cookie)

// 期望结果: 
// 看不到 accessToken 和 refreshToken ✅
// 或者只看到其他非 HttpOnly 的 cookies
```

**命令行验证:**
```bash
# 测试登录后是否设置 Cookie
curl -X POST "$BACKEND_URL/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@cmax.com","password":"admin123"}' \
  -c cookies.txt \
  -i

# 检查响应头
cat cookies.txt

# 期望看到:
# Set-Cookie: accessToken=...; HttpOnly; Secure; SameSite=Strict
# Set-Cookie: refreshToken=...; HttpOnly; Secure; SameSite=Strict
```

---

#### 2.4 CORS 验证

**正确的域名请求:**
```bash
echo "测试正确域名的 CORS..."
curl -H "Origin: https://your-app.vercel.app" \
     -H "Access-Control-Request-Method: POST" \
     -X OPTIONS \
     "$BACKEND_URL/api/auth/login" \
     -i

# 期望看到:
# Access-Control-Allow-Origin: https://your-app.vercel.app ✅
# Access-Control-Allow-Credentials: true ✅
```

**错误的域名请求:**
```bash
echo "测试错误域名应该被拒绝..."
curl -H "Origin: https://evil-site.com" \
     -H "Access-Control-Request-Method: POST" \
     -X OPTIONS \
     "$BACKEND_URL/api/auth/login" \
     -i

# 期望结果:
# 无 Access-Control-Allow-Origin 头 ✅
# 或返回 CORS 错误
```

**浏览器测试:**
```javascript
// 在前端应用的 Console 中运行
fetch('https://your-backend.onrender.com/api/health', {
  method: 'GET',
  credentials: 'include'
})
.then(r => r.json())
.then(data => console.log('✅ CORS 工作正常:', data))
.catch(err => console.error('❌ CORS 错误:', err))

// 期望输出: ✅ CORS 工作正常: {status: "ok", ...}
```

---

#### 2.5 数据库访问控制验证

**MongoDB Atlas 检查:**

1. **登录 MongoDB Atlas**: https://cloud.mongodb.com
2. **选择你的 Cluster**
3. **进入 Network Access**

**期望配置:**
```
IP Access List:
✅ 无 0.0.0.0/0 (Allow from Anywhere)
✅ 有 3-4 个 Render 出站 IP
   例如:
   - 52.45.123.456
   - 54.78.234.567
   - 35.90.345.678
```

**连接测试:**
```bash
# 从后端查看日志
# Render Dashboard > 你的服务 > Logs

# 期望看到:
# ✅ Database connected successfully
# 或类似的成功连接消息

# 不应该看到:
# ❌ MongoNetworkError
# ❌ Connection refused
```

**获取 Render 出站 IP:**
```bash
# Render Dashboard > 你的服务 > Connect 标签
# 查看 "Outbound IP Addresses"

# 记录下来并与 MongoDB Atlas 中的 IP 比对
# 确保完全匹配
```

---

### 阶段 3: 功能性验证 (15分钟)

#### 3.1 认证流程测试

**登录测试:**
```bash
# 1. 访问前端应用
open https://your-app.vercel.app

# 2. 使用测试账号登录
# Email: admin@cmax.com
# Password: admin123

# 3. 检查:
# ✅ 登录成功，跳转到首页
# ✅ 浏览器 DevTools > Application > Cookies 中有 accessToken
# ✅ 顶部显示用户名和角色
```

**登出测试:**
```bash
# 1. 点击用户菜单 > 登出
# 2. 检查:
# ✅ 跳转到登录页
# ✅ Cookies 中的 accessToken 和 refreshToken 被清除
# ✅ 无法访问受保护的页面
```

**Token 刷新测试 (可选):**
```bash
# 如果 accessToken 过期（8小时后），刷新页面应该:
# ✅ 自动使用 refreshToken 获取新的 accessToken
# ✅ 用户无感知，继续正常使用
```

---

#### 3.2 权限控制测试

**管理员权限测试:**
```bash
# 1. 以管理员身份登录 (admin@cmax.com)
# 2. 访问项目列表页面
# 3. 检查:
# ✅ 可以看到所有项目
# ✅ 可以创建新项目
# ✅ 可以删除项目
# ✅ 可以修改项目状态
```

**低权限用户测试 (如果有):**
```bash
# 1. 以普通用户身份登录
# 2. 尝试访问管理员功能
# 3. 检查:
# ✅ 删除按钮不显示 (前端权限控制)
# ✅ 手动调用删除 API 返回 403 (后端权限控制)
```

**API 权限测试:**
```bash
# 测试未授权访问
curl -X DELETE "$BACKEND_URL/api/new-projects/some-id" \
  -H "Cookie: accessToken=invalid-token" \
  -i

# 期望结果:
# HTTP/1.1 401 Unauthorized ✅
# {"message":"Not authorized, token failed"}
```

---

#### 3.3 数据完整性测试

**创建项目测试:**
```bash
# 1. 在前端创建一个新项目
# 2. 填写所有必填字段
# 3. 提交

# 检查:
# ✅ 项目创建成功
# ✅ 在项目列表中可见
# ✅ 可以查看项目详情
```

**数据持久化测试:**
```bash
# 1. 创建一些测试数据
# 2. 登出
# 3. 重新登录
# 4. 检查:
# ✅ 数据仍然存在
# ✅ 数据完整无损
```

---

#### 3.4 API 速率限制测试

**登录限流测试:**
```bash
# 快速连续尝试登录 6 次（错误密码）
for i in {1..6}; do
  echo "尝试 $i:"
  curl -X POST "$BACKEND_URL/api/auth/login" \
    -H "Content-Type: application/json" \
    -d '{"email":"admin@cmax.com","password":"wrong"}' \
    -w "\nHTTP Status: %{http_code}\n\n" \
    -s -o /dev/null
  sleep 1
done

# 期望结果:
# 前5次: HTTP Status: 401 (密码错误)
# 第6次: HTTP Status: 429 (Too Many Requests) ✅
```

**通用 API 限流测试:**
```bash
# 快速连续请求 API
for i in {1..110}; do
  curl -X GET "$BACKEND_URL/api/health" -s -o /dev/null -w "%{http_code}\n"
done | tail -10

# 期望结果:
# 前100次: 200
# 后续: 429 (Too Many Requests) ✅
```

---

### 阶段 4: 安全性深度验证 (20分钟)

#### 4.1 XSS 防护测试

**输入测试:**
```javascript
// 1. 在前端任意输入框中输入:
<script>alert('XSS')</script>

// 2. 提交表单

// 期望结果:
// ✅ 输入被显示为纯文本: &lt;script&gt;alert('XSS')&lt;/script&gt;
// ✅ 脚本不执行
```

**浏览器测试:**
```javascript
// 在 Console 中运行:
const div = document.createElement('div')
div.innerHTML = '<img src=x onerror=alert("XSS")>'
document.body.appendChild(div)

// 期望结果:
// ✅ 图片加载失败，但 alert 不执行（如果用了 CSP）
// 或 alert 执行，但这是你自己主动执行的，不是被注入的
```

---

#### 4.2 SQL/NoSQL 注入测试

**MongoDB 注入测试:**
```bash
# 尝试通过登录进行注入
curl -X POST "$BACKEND_URL/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email":{"$ne":null},"password":{"$ne":null}}' \
  -i

# 期望结果:
# HTTP/1.1 400 或 401 ✅
# 登录失败，注入被阻止
```

---

#### 4.3 敏感信息泄露检查

**响应头检查:**
```bash
# 检查是否泄露服务器信息
curl -I "$BACKEND_URL/api/health"

# 不应该看到:
# ❌ X-Powered-By: Express
# ❌ Server: nginx/1.x.x

# 应该看到:
# ✅ X-Content-Type-Options: nosniff
# ✅ X-Frame-Options: SAMEORIGIN
# ✅ X-XSS-Protection: 0
```

**错误信息检查:**
```bash
# 触发一个错误
curl -X GET "$BACKEND_URL/api/invalid-endpoint" \
  -H "Accept: application/json"

# 期望结果:
# ✅ 返回通用错误消息，不泄露技术细节
# ❌ 不应该看到数据库连接字符串
# ❌ 不应该看到完整的堆栈跟踪
```

---

#### 4.4 安全响应头验证

**完整的响应头检查:**
```bash
echo "检查安全响应头..."
curl -I "$BACKEND_URL/api/health"

# 期望看到以下所有头:
# ✅ X-DNS-Prefetch-Control: off
# ✅ X-Frame-Options: SAMEORIGIN
# ✅ Strict-Transport-Security: max-age=15552000; includeSubDomains
# ✅ X-Download-Options: noopen
# ✅ X-Content-Type-Options: nosniff
# ✅ X-XSS-Protection: 0
```

**在线安全头检查:**
```bash
# 访问: https://securityheaders.com/
# 输入你的后端 URL: https://your-backend.onrender.com

# 期望评级: A 或更高
```

---

### 阶段 5: 性能和监控验证 (10分钟)

#### 5.1 响应时间检查

**API 性能测试:**
```bash
echo "测试 API 响应时间..."
for i in {1..10}; do
  curl -o /dev/null -s -w "请求 $i: %{time_total}s\n" "$BACKEND_URL/api/health"
done

# 期望结果:
# ✅ 平均响应时间 < 500ms (国内)
# ✅ 平均响应时间 < 200ms (同区域)
```

**前端加载时间:**
```bash
# 使用浏览器 DevTools > Network
# 刷新页面

# 检查:
# ✅ 首次加载 < 3s
# ✅ 后续加载 < 1s (有缓存)
```

---

#### 5.2 日志检查

**Render 后端日志:**
```bash
# Render Dashboard > 你的服务 > Logs

# 应该看到:
# ✅ [启动] Server running on port 5001
# ✅ [数据库] Database connected successfully
# ✅ [请求] POST /api/auth/login 200 - 150ms

# 不应该看到:
# ❌ 大量 500 错误
# ❌ 数据库连接失败
# ❌ 未捕获的异常
```

**Vercel 前端日志:**
```bash
# Vercel Dashboard > 项目 > Deployments > 最新部署 > 查看日志

# 检查:
# ✅ 构建成功
# ✅ 无编译错误
# ✅ 无警告（或只有少量可忽略的警告）
```

---

### 阶段 6: 备份和恢复验证 (5分钟)

#### 6.1 数据库备份检查

**MongoDB Atlas 备份:**
```bash
# 1. 登录 MongoDB Atlas
# 2. 选择 Cluster > Backup

# 检查:
# ✅ Cloud Backup 已启用
# ✅ 最新备份时间在 24 小时内
# ✅ 保留策略已设置 (7天/4周/12月)
```

**恢复测试 (可选):**
```bash
# ⚠️ 仅在测试环境执行

# 1. MongoDB Atlas > Backup > 选择时间点
# 2. 点击 "Restore"
# 3. 选择 "Download" 或 "Restore to Cluster"
# 4. 验证数据完整性
```

---

#### 6.2 代码版本控制检查

**Git 状态:**
```bash
cd "Model Selection System"
git status

# 期望输出:
# On branch main
# Your branch is up to date with 'origin/main'
# nothing to commit, working tree clean ✅

# 检查远程仓库
git remote -v

# 期望看到:
# origin  https://github.com/your-username/your-repo.git ✅
```

---

## 📊 验证结果报告模板

### 总体评分

| 类别 | 检查项 | 结果 | 评分 |
|------|--------|------|------|
| **环境变量** | 所有密钥已配置 | ✅ | 10/10 |
| **HTTPS** | 强制 HTTPS 启用 | ✅ | 10/10 |
| **Cookie安全** | HttpOnly + Secure | ✅ | 10/10 |
| **CORS** | 精确域名配置 | ✅ | 10/10 |
| **数据库访问** | IP 白名单配置 | ✅ | 10/10 |
| **依赖安全** | 无高危漏洞 | ✅ | 10/10 |
| **XSS 防护** | 输入转义正常 | ✅ | 10/10 |
| **权限控制** | 前后端验证有效 | ✅ | 10/10 |
| **API 限流** | 速率限制生效 | ✅ | 10/10 |
| **日志监控** | 日志正常记录 | ✅ | 10/10 |
| **备份策略** | 自动备份启用 | ✅ | 10/10 |

**总分: ____/110**

- **90-110分**: 🎉 优秀！生产环境就绪
- **70-89分**: ⚠️ 良好，有少量改进空间
- **50-69分**: ⚠️ 需要改进关键安全问题
- **<50分**: 🚨 严重问题，不建议部署到生产环境

---

## 🚨 常见问题排查

### 问题 1: Cookie 未设置

**症状:**
- 登录后浏览器 DevTools > Application > Cookies 中没有 token

**排查步骤:**
```bash
# 1. 检查后端环境变量
FRONTEND_URL=https://your-app.vercel.app  # 是否正确?

# 2. 检查 CORS 配置
curl -H "Origin: $FRONTEND_URL" "$BACKEND_URL/api/auth/login" -i
# 应该看到: Access-Control-Allow-Credentials: true

# 3. 检查前端 axios 配置
# frontend/src/services/api.js
# withCredentials: true (是否设置?)

# 4. 检查响应头
curl -X POST "$BACKEND_URL/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@cmax.com","password":"admin123"}' \
  -i | grep -i "set-cookie"

# 应该看到: Set-Cookie: accessToken=...
```

---

### 问题 2: 数据库连接失败

**症状:**
- 后端日志显示 `MongoNetworkError` 或 `Connection refused`

**排查步骤:**
```bash
# 1. 获取 Render 当前出站 IP
# Render Dashboard > Connect > Outbound IP Addresses

# 2. 检查 MongoDB Atlas Network Access
# 确保包含所有 Render IP

# 3. 测试连接字符串
# 在 Render Shell 中运行:
mongo "$MONGODB_URI" --eval "db.adminCommand('ping')"

# 期望输出: { ok: 1 }
```

---

### 问题 3: CORS 错误

**症状:**
- 浏览器 Console 显示 CORS policy error

**排查步骤:**
```bash
# 1. 检查环境变量
echo $FRONTEND_URL  # 应该是精确的前端域名

# 2. 检查后端代码
grep "cors({" backend/server.js
# 应该看到: origin: process.env.FRONTEND_URL

# 3. 测试 CORS
curl -H "Origin: https://your-app.vercel.app" \
     -X OPTIONS \
     "$BACKEND_URL/api/auth/login" \
     -i

# 应该看到:
# Access-Control-Allow-Origin: https://your-app.vercel.app
# Access-Control-Allow-Credentials: true
```

---

## ✅ 验证完成确认

### 最终检查清单

- [ ] 所有阶段验证已完成
- [ ] 所有测试都通过
- [ ] 验证结果总分 ≥ 90
- [ ] 已记录所有发现的问题
- [ ] 已修复所有关键问题
- [ ] 备份策略已启用并测试
- [ ] 团队成员已培训
- [ ] 监控和告警已设置

### 签字确认

**技术负责人:** _______________  
**日期:** _______________  
**批准上线:** ☐

---

## 📞 获取帮助

如果验证过程中遇到问题:

1. **查看文档:**
   - `云服务部署安全清单.md`
   - `云部署快速检查表.md`
   - `前端安全加固完成报告.md`

2. **检查日志:**
   - Render Dashboard > Logs
   - Vercel Dashboard > Deployments > Logs
   - 浏览器 Console

3. **联系支持:**
   - Render Support: https://render.com/support
   - Vercel Support: https://vercel.com/support
   - MongoDB Atlas: https://support.mongodb.com/

---

**🎉 验证完成后，你的应用就可以安全地服务用户了！**

