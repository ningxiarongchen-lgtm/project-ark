# 🚀 快速测试指南

## 一键测试（最简单）

### 步骤 1: 启动后端服务器

打开终端，运行：
```bash
cd "/Users/hexiaoxiao/Desktop/Model Selection System/backend"
npm run dev
```

**看到这个说明服务器启动成功**:
```
╔════════════════════════════════════════════════════════╗
║   C-MAX Actuator Selection System - Backend API       ║
║   Server running on port 5001                          ║
╚════════════════════════════════════════════════════════╝
MongoDB Connected: localhost
```

### 步骤 2: 创建测试数据

**打开新的终端窗口**，运行：
```bash
cd "/Users/hexiaoxiao/Desktop/Model Selection System/backend"

# 创建用户账号
npm run seed

# 创建执行器和手动操作装置数据
npm run seed-new
```

### 步骤 3: 运行自动化测试

在同一个终端运行：
```bash
./test-api.sh
```

**✅ 如果看到 "所有测试通过！" 说明系统工作正常！**

---

## 手动测试（使用 curl）

### 1. 登录获取 Token

```bash
curl -X POST http://localhost:5001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@cmax.com",
    "password": "admin123"
  }'
```

**复制返回的 token，在后续请求中使用！**

### 2. 查看所有执行器

```bash
# 替换 YOUR_TOKEN 为上一步获取的 token
curl -X GET http://localhost:5001/api/actuators \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 3. 智能扭矩查找 🔍

```bash
curl -X POST http://localhost:5001/api/actuators/find-by-torque \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "required_torque": 500,
    "pressure": 0.4,
    "angle": 0,
    "yoke_type": "symmetric"
  }'
```

**系统会自动推荐最合适的执行器型号！**

### 4. 创建项目

```bash
curl -X POST http://localhost:5001/api/new-projects \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "project_name": "我的测试项目",
    "client_name": "测试客户公司"
  }'
```

**保存返回的项目 ID！**

### 5. 一键自动选型 🤖

```bash
# 替换 PROJECT_ID 为上一步返回的项目 ID
curl -X POST http://localhost:5001/api/new-projects/PROJECT_ID/auto-select \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "tag_number": "V-001",
    "required_torque": 600,
    "working_pressure": 0.5,
    "working_angle": 0,
    "yoke_type": "symmetric",
    "needs_manual_override": true
  }'
```

**系统会自动选择执行器和手动操作装置，并计算总价！**

---

## 使用 Postman 测试（推荐）

### 设置环境变量

1. 创建新的环境 "C-MAX Local"
2. 添加变量：
   - `base_url` = `http://localhost:5001`
   - `token` = (登录后获取)

### 导入测试集合

1. 新建 Collection: "C-MAX API Tests"
2. 在 Collection 的 Authorization 中选择 "Bearer Token"
3. Token 值使用: `{{token}}`

### 添加请求

#### 1. 登录
- Method: POST
- URL: `{{base_url}}/api/auth/login`
- Body (JSON):
```json
{
  "email": "admin@cmax.com",
  "password": "admin123"
}
```
- Tests (自动保存 token):
```javascript
if (pm.response.code === 200) {
    const response = pm.response.json();
    pm.environment.set("token", response.token);
}
```

#### 2. 获取执行器
- Method: GET
- URL: `{{base_url}}/api/actuators`
- Authorization: Inherit from parent

#### 3. 扭矩查找
- Method: POST
- URL: `{{base_url}}/api/actuators/find-by-torque`
- Body (JSON):
```json
{
  "required_torque": 500,
  "pressure": 0.4,
  "angle": 0,
  "yoke_type": "symmetric"
}
```

---

## 常见测试场景

### 场景 1: 小型阀门选型
**需求**: 300Nm 扭矩，0.3 MPa 压力

```bash
{
  "required_torque": 300,
  "pressure": 0.3,
  "angle": 0,
  "yoke_type": "symmetric"
}
```

**预期结果**: SF10-150DA (实际扭矩: 309Nm)

### 场景 2: 中型阀门选型
**需求**: 1000Nm 扭矩，0.5 MPa 压力

```bash
{
  "required_torque": 1000,
  "pressure": 0.5,
  "angle": 0,
  "yoke_type": "symmetric"
}
```

**预期结果**: SF14-400DA (实际扭矩: 1430Nm)

### 场景 3: 大型阀门选型（倾斜轭架）
**需求**: 2000Nm 扭矩，0.5 MPa 压力，倾斜轭架

```bash
{
  "required_torque": 2000,
  "pressure": 0.5,
  "angle": 0,
  "yoke_type": "canted"
}
```

**预期结果**: SF16-600DA (实际扭矩: 2316Nm)

---

## 测试数据说明

### 可用的执行器型号

| 型号 | 本体尺寸 | 作用类型 | 价格 | 适用场景 |
|------|---------|---------|------|---------|
| SF10-150DA | SF10 | 双作用 | ¥5,000 | 小型阀门 |
| SF12-250SR | SF12 | 弹簧复位 | ¥6,500 | 中型阀门 |
| SF14-400DA | SF14 | 双作用 | ¥8,500 | 中大型阀门 |
| SF16-600DA | SF16 | 双作用 | ¥12,000 | 大型阀门 |
| SF20-1000DA | SF20 | 双作用 | ¥18,000 | 超大型阀门 |

### 可用的手动操作装置

| 型号 | 名称 | 价格 | 兼容尺寸 |
|------|------|------|---------|
| HG | 手轮装置(标准) | ¥800 | SF10, SF12, SF14 |
| HW | 手轮装置(加长) | ¥1,200 | SF14, SF16, SF20 |
| HL | 手柄装置 | ¥600 | SF10, SF12 |
| HC | 链轮装置 | ¥1,500 | SF12, SF14, SF16 |
| HWG | 蜗轮箱 | ¥2,500 | SF16, SF20 |

### 测试账号

| 角色 | 邮箱 | 密码 |
|------|------|------|
| 管理员 | admin@cmax.com | admin123 |
| 工程师 | john@cmax.com | engineer123 |
| 销售经理 | sarah@cmax.com | sales123 |

---

## 扭矩数据键格式说明

**压力和角度组合**:
- 键格式: `{压力}_{角度}`
- 示例: `0_4_0` 表示 0.4 MPa 压力，0° 角度
- 示例: `0_5_15` 表示 0.5 MPa 压力，15° 角度

**可用的压力值**: 0.3, 0.4, 0.5, 0.6 (MPa)  
**可用的角度值**: 0, 15 (度)

---

## 故障排除

### 问题 1: 连接被拒绝
**错误**: `curl: (7) Failed to connect`

**解决**:
```bash
# 检查后端服务器是否运行
ps aux | grep node

# 如果没有运行，启动它
cd backend && npm run dev
```

### 问题 2: 401 Unauthorized
**错误**: `{"message": "Not authorized, no token"}`

**解决**: 确保在请求头中包含正确的 token
```bash
-H "Authorization: Bearer YOUR_TOKEN"
```

### 问题 3: MongoDB 连接失败
**错误**: `MongoNetworkError`

**解决**:
```bash
# 启动 MongoDB
brew services start mongodb-community

# 检查 MongoDB 状态
brew services list | grep mongodb
```

### 问题 4: 未找到满足要求的执行器
**错误**: `{"message": "未找到满足要求的执行器"}`

**原因**: 
- 扭矩要求超过所有可用执行器
- 压力/角度组合没有数据

**解决**: 调整查询参数或添加更多执行器数据

---

## 📚 更多资源

- **完整 API 文档**: 查看 `新API文档.md`
- **详细测试指南**: 查看 `API测试指南.md`
- **测试结果报告**: 查看 `测试结果报告.md`

---

## 🎯 快速测试清单

- [ ] 后端服务器已启动 (port 5001)
- [ ] MongoDB 已运行
- [ ] 已创建用户数据 (`npm run seed`)
- [ ] 已创建执行器数据 (`npm run seed-new`)
- [ ] 能成功登录获取 token
- [ ] 能获取执行器列表
- [ ] 能进行扭矩查找
- [ ] 能创建项目
- [ ] 能使用自动选型功能
- [ ] 自动化测试脚本通过 (`./test-api.sh`)

**全部完成？恭喜！系统已准备就绪！** 🎉


