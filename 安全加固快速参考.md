# åç«¯å®‰å…¨åŠ å›ºå¿«é€Ÿå‚è€ƒ

## ğŸ”‘ JWTé…ç½®

### ç¯å¢ƒå˜é‡ (.env)
```env
# è®¿é—®ä»¤ç‰Œï¼ˆ8å°æ—¶ï¼‰
JWT_SECRET=5d3bcb03a8407d6a9a76f03c3c852d386184aea8f2dd4c34f9e2e026dfcb975476e1e18ae0b6febe39dc11c8da7524fcbbcc6a701661eb230ea21fc93a0ff16e
JWT_EXPIRE=8h

# åˆ·æ–°ä»¤ç‰Œï¼ˆ7å¤©ï¼‰
REFRESH_TOKEN_SECRET=a7c4f9e2b8d6013ae5c7f1b4d8e9a2c6f3b7e1d5a9c4f8e2b6d0a3e7c1f5b9d8e3a7c2f6b1d5e9a4c8f3b7e2d6a1c5e9f4b8d3a7c2e6f1b5d9a4c8e3f7b2d6a1e5
REFRESH_TOKEN_EXPIRE=7d
```

### ç”Ÿæˆæ–°å¯†é’¥
```bash
# åœ¨backendç›®å½•æ‰§è¡Œ
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
```

---

## ğŸšª ç™»å½•ä¸Tokenç®¡ç†

### ç™»å½• API
```http
POST /api/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password123"
}
```

**å“åº”**:
```json
{
  "_id": "user_id",
  "name": "å¼ ä¸‰",
  "email": "user@example.com",
  "role": "Sales Engineer",
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." // å‘åå…¼å®¹
}
```

### åˆ·æ–°Token
```http
POST /api/auth/refresh-token
Content-Type: application/json

{
  "refreshToken": "your_refresh_token_here"
}
```

**å“åº”**:
```json
{
  "accessToken": "new_access_token",
  "refreshToken": "new_refresh_token",
  "token": "new_access_token"
}
```

### ç™»å‡º
```http
POST /api/auth/logout
Authorization: Bearer <accessToken>
```

### æŸ¥çœ‹æ´»è·ƒä¼šè¯
```http
GET /api/auth/sessions
Authorization: Bearer <accessToken>
```

---

## ğŸ‘¥ ç³»ç»Ÿè§’è‰²

| è§’è‰² | è‹±æ–‡åç§° | ä¸»è¦æƒé™ |
|------|---------|----------|
| ç³»ç»Ÿç®¡ç†å‘˜ | Administrator | æ‰€æœ‰æƒé™ |
| é”€å”®ç»ç† | Sales Manager | æ‰€æœ‰é”€å”®èµ„æº + å®¡æ‰¹ |
| é”€å”®å·¥ç¨‹å¸ˆ | Sales Engineer | é”€å”®ç›¸å…³æ“ä½œï¼ˆè‡ªå·±çš„ï¼‰ |
| æŠ€æœ¯å·¥ç¨‹å¸ˆ | Technical Engineer | æŠ€æœ¯ç›¸å…³æ“ä½œï¼ˆè‡ªå·±çš„ï¼‰ |
| é‡‡è´­ä¸“å‘˜ | Procurement Specialist | é‡‡è´­è®¢å•ç®¡ç† |
| ç”Ÿäº§è®¡åˆ’å‘˜ | Production Planner | ç”Ÿäº§ç®¡ç† |
| å”®åå·¥ç¨‹å¸ˆ | After-sales Engineer | å”®åæœåŠ¡ |

---

## ğŸ”’ æƒé™æ§åˆ¶ä¸­é—´ä»¶

### protect - éªŒè¯Token
```javascript
const { protect } = require('../middleware/auth');

// ç¡®ä¿ç”¨æˆ·å·²ç™»å½•
router.get('/api/projects', protect, getProjects);
```

### authorize - éªŒè¯è§’è‰²
```javascript
const { authorize } = require('../middleware/auth');

// åªå…è®¸ç‰¹å®šè§’è‰²è®¿é—®
router.post('/api/projects', 
  protect, 
  authorize('Technical Engineer', 'Sales Engineer', 'Administrator'),
  createProject
);

// åªå…è®¸ç®¡ç†å‘˜
router.delete('/api/projects/:id',
  protect,
  authorize('Administrator'),
  deleteProject
);
```

### æ‰€æœ‰æƒæ ¡éªŒ
```javascript
const { checkProjectOwnership } = require('../middleware/ownership');

// ç¡®ä¿ç”¨æˆ·åªèƒ½ä¿®æ”¹è‡ªå·±çš„é¡¹ç›®
router.put('/api/projects/:id',
  protect,
  authorize('Technical Engineer', 'Sales Engineer', 'Administrator'),
  checkProjectOwnership, // æ‰€æœ‰æƒæ ¡éªŒ
  updateProject
);
```

---

## ğŸ“‹ æ‰€æœ‰æƒä¸­é—´ä»¶åˆ—è¡¨

| ä¸­é—´ä»¶ | ç”¨é€” | ç‰¹æƒè§’è‰² |
|--------|------|----------|
| `checkProjectOwnership` | é¡¹ç›®æ‰€æœ‰æƒ | Administrator, Sales Manager |
| `checkOrderOwnership` | è®¢å•æ‰€æœ‰æƒ | Administrator, Sales Manager |
| `checkPurchaseOrderOwnership` | é‡‡è´­è®¢å•æ‰€æœ‰æƒ | Administrator |
| `checkTicketOwnership` | å·¥å•æ‰€æœ‰æƒ | Administrator, Sales Manager |
| `checkProductionOrderOwnership` | ç”Ÿäº§è®¢å•æ‰€æœ‰æƒ | Administrator |

### ä½¿ç”¨ç¤ºä¾‹
```javascript
const { 
  checkProjectOwnership,
  checkOrderOwnership,
  checkTicketOwnership 
} = require('../middleware/ownership');

// é¡¹ç›®æ›´æ–° - éœ€è¦æ‰€æœ‰æƒ
router.put('/projects/:id', protect, authorize(...), checkProjectOwnership, updateProject);

// è®¢å•ä¿®æ”¹ - éœ€è¦æ‰€æœ‰æƒ
router.put('/orders/:id', protect, authorize(...), checkOrderOwnership, updateOrder);

// å·¥å•å¤„ç† - åˆ›å»ºè€…æˆ–è¢«åˆ†é…è€…
router.put('/tickets/:id', protect, authorize(...), checkTicketOwnership, updateTicket);
```

---

## ğŸ¯ å¸¸è§æƒé™é…ç½®æ¨¡å¼

### æ¨¡å¼1: å…¬å¼€è¯»ï¼Œé™åˆ¶å†™
```javascript
// æ‰€æœ‰è®¤è¯ç”¨æˆ·å¯è¯»
router.get('/api/products', protect, getProducts);

// åªæœ‰ç®¡ç†å‘˜å¯åˆ›å»º/ä¿®æ”¹/åˆ é™¤
router.post('/api/products', protect, authorize('Administrator'), createProduct);
router.put('/api/products/:id', protect, authorize('Administrator'), updateProduct);
router.delete('/api/products/:id', protect, authorize('Administrator'), deleteProduct);
```

### æ¨¡å¼2: è§’è‰²é™åˆ¶ + æ‰€æœ‰æƒæ§åˆ¶
```javascript
// å¤šè§’è‰²å¯åˆ›å»º
router.post('/api/projects', 
  protect,
  authorize('Technical Engineer', 'Sales Engineer', 'Sales Manager', 'Administrator'),
  createProject
);

// å¤šè§’è‰²å¯ä¿®æ”¹ï¼Œä½†éœ€è¦æ‰€æœ‰æƒ
router.put('/api/projects/:id',
  protect,
  authorize('Technical Engineer', 'Sales Engineer', 'Sales Manager', 'Administrator'),
  checkProjectOwnership, // éç®¡ç†å‘˜åªèƒ½ä¿®æ”¹è‡ªå·±çš„
  updateProject
);

// åªæœ‰ç®¡ç†å‘˜å¯åˆ é™¤
router.delete('/api/projects/:id',
  protect,
  authorize('Administrator'),
  deleteProject
);
```

### æ¨¡å¼3: å®¡æ‰¹æµç¨‹
```javascript
// åˆ›å»ºè®¢å•
router.post('/api/orders',
  protect,
  authorize('Sales Engineer', 'Sales Manager', 'Administrator'),
  createOrder
);

// ä¿®æ”¹è®¢å• - éœ€è¦æ‰€æœ‰æƒ
router.put('/api/orders/:id',
  protect,
  authorize('Sales Engineer', 'Sales Manager', 'Administrator'),
  checkOrderOwnership,
  updateOrder
);

// å®¡æ‰¹è®¢å• - åªæœ‰ç»ç†/ç®¡ç†å‘˜
router.post('/api/orders/:id/approve',
  protect,
  authorize('Sales Manager', 'Administrator'),
  approveOrder
);
```

---

## ğŸ›¡ï¸ å®‰å…¨æœ€ä½³å®è·µ

### 1. Tokenå­˜å‚¨ï¼ˆå‰ç«¯ï¼‰
```javascript
// âœ… æ¨èï¼šHttpOnly Cookieï¼ˆæœ€å®‰å…¨ï¼‰
// éœ€è¦åç«¯é…ç½®cookieé€‰é¡¹

// âœ… å¯é€‰ï¼šlocalStorageï¼ˆè¾ƒå®‰å…¨ï¼Œéœ€é˜²XSSï¼‰
localStorage.setItem('accessToken', token);
localStorage.setItem('refreshToken', refreshToken);

// âŒ ä¸æ¨èï¼šsessionStorageï¼ˆä»…å•æ ‡ç­¾é¡µæœ‰æ•ˆï¼‰
// âŒ ç¦æ­¢ï¼šå…¨å±€å˜é‡ï¼ˆæä¸å®‰å…¨ï¼‰
```

### 2. APIè¯·æ±‚é…ç½®
```javascript
// Axioså…¨å±€é…ç½®
import axios from 'axios';

const api = axios.create({
  baseURL: 'http://localhost:5000/api',
  timeout: 10000
});

// è¯·æ±‚æ‹¦æˆªå™¨ - è‡ªåŠ¨æ·»åŠ token
api.interceptors.request.use(config => {
  const token = localStorage.getItem('accessToken');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// å“åº”æ‹¦æˆªå™¨ - è‡ªåŠ¨åˆ·æ–°token
api.interceptors.response.use(
  response => response,
  async error => {
    const originalRequest = error.config;
    
    if (error.response?.status === 401 && !originalRequest._retry) {
      originalRequest._retry = true;
      
      try {
        const refreshToken = localStorage.getItem('refreshToken');
        const { data } = await axios.post('/api/auth/refresh-token', { refreshToken });
        
        localStorage.setItem('accessToken', data.accessToken);
        localStorage.setItem('refreshToken', data.refreshToken);
        
        originalRequest.headers.Authorization = `Bearer ${data.accessToken}`;
        return api(originalRequest);
      } catch (err) {
        // åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬ç™»å½•
        localStorage.clear();
        window.location.href = '/login';
      }
    }
    
    return Promise.reject(error);
  }
);

export default api;
```

### 3. æƒé™æ‹’ç»å¤„ç†
```javascript
// å¤„ç†403é”™è¯¯ï¼ˆæƒé™ä¸è¶³ï¼‰
api.interceptors.response.use(
  response => response,
  error => {
    if (error.response?.status === 403) {
      // æ˜¾ç¤ºæƒé™ä¸è¶³æç¤º
      alert('æ‚¨æ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œ');
      
      // æˆ–æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
      const { message, reason } = error.response.data;
      if (reason === 'ownership_violation') {
        alert('æ‚¨åªèƒ½ä¿®æ”¹è‡ªå·±åˆ›å»ºçš„èµ„æº');
      }
    }
    return Promise.reject(error);
  }
);
```

### 4. ç”Ÿäº§ç¯å¢ƒæ¸…å•
- [ ] æ›´æ¢å¼ºéšæœºJWTå¯†é’¥
- [ ] å¯ç”¨HTTPS
- [ ] .envæ–‡ä»¶ä¸æäº¤åˆ°Git
- [ ] é…ç½®CORSç™½åå•
- [ ] è®¾ç½®åˆç†çš„tokenè¿‡æœŸæ—¶é—´
- [ ] å¯ç”¨é€Ÿç‡é™åˆ¶
- [ ] é…ç½®æ—¥å¿—å®¡è®¡
- [ ] å®šæœŸå¯†é’¥è½®æ¢

---

## ğŸ§ª æµ‹è¯•å‘½ä»¤

### æµ‹è¯•ç™»å½•
```bash
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@example.com","password":"admin123"}'
```

### æµ‹è¯•åˆ·æ–°Token
```bash
curl -X POST http://localhost:5000/api/auth/refresh-token \
  -H "Content-Type: application/json" \
  -d '{"refreshToken":"YOUR_REFRESH_TOKEN"}'
```

### æµ‹è¯•å—ä¿æŠ¤è·¯ç”±
```bash
curl -X GET http://localhost:5000/api/projects \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

### æµ‹è¯•æ‰€æœ‰æƒä¿æŠ¤ï¼ˆåº”è¯¥è¿”å›403ï¼‰
```bash
# ç”¨æˆ·Açš„tokenå°è¯•ä¿®æ”¹ç”¨æˆ·Bçš„é¡¹ç›®
curl -X PUT http://localhost:5000/api/projects/USER_B_PROJECT_ID \
  -H "Authorization: Bearer USER_A_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name":"Modified Name"}'
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: Tokenè¿‡æœŸäº†æ€ä¹ˆåŠï¼Ÿ
**A**: å‰ç«¯ä½¿ç”¨refreshTokenè‡ªåŠ¨åˆ·æ–°accessTokenï¼Œç”¨æˆ·æ— æ„ŸçŸ¥ã€‚å¦‚æœrefreshTokenä¹Ÿè¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•ã€‚

### Q2: å¦‚ä½•åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰æƒé™ï¼Ÿ
**A**: 
1. æ£€æŸ¥`req.user.role`æ˜¯å¦åœ¨å…è®¸çš„è§’è‰²åˆ—è¡¨ä¸­
2. æ£€æŸ¥`req.user._id`æ˜¯å¦ä¸èµ„æºçš„`createdBy`åŒ¹é…
3. Administratorå’Œéƒ¨åˆ†Managerè§’è‰²æ‹¥æœ‰ç‰¹æƒ

### Q3: ä¿®æ”¹ä»–äººèµ„æºè¿”å›ä»€ä¹ˆé”™è¯¯ï¼Ÿ
**A**: è¿”å›403 Forbiddenï¼Œå“åº”åŒ…å«:
```json
{
  "message": "Access denied. You can only modify resources you created.",
  "reason": "ownership_violation"
}
```

### Q4: å¦‚ä½•æ·»åŠ æ–°è§’è‰²ï¼Ÿ
**A**:
1. åœ¨`backend/models/User.js`çš„roleæšä¸¾ä¸­æ·»åŠ 
2. åœ¨ç›¸å…³è·¯ç”±çš„`authorize()`ä¸­æ·»åŠ è¯¥è§’è‰²
3. å¦‚éœ€ç‰¹æƒï¼Œåœ¨æ‰€æœ‰æƒä¸­é—´ä»¶ä¸­æ·»åŠ é€»è¾‘

### Q5: ç”Ÿäº§ç¯å¢ƒå¦‚ä½•æ›´æ¢å¯†é’¥ï¼Ÿ
**A**:
1. ç”Ÿæˆæ–°å¯†é’¥ï¼š`node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"`
2. æ›´æ–°`.env`æ–‡ä»¶çš„`JWT_SECRET`å’Œ`REFRESH_TOKEN_SECRET`
3. é‡å¯æœåŠ¡å™¨
4. **æ³¨æ„**: æ‰€æœ‰ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•

---

## ğŸ“ è·å–å¸®åŠ©

- **è¯¦ç»†æ–‡æ¡£**: æŸ¥çœ‹ã€Šåç«¯å®‰å…¨åŠ å›ºå®ŒæˆæŠ¥å‘Š.mdã€‹
- **ä»£ç ç¤ºä¾‹**: å‚è€ƒç°æœ‰è·¯ç”±æ–‡ä»¶ï¼ˆå¦‚`projectRoutes.js`ï¼‰
- **æµ‹è¯•**: è¿è¡Œ `npm test` æ‰§è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0 (2025-10-28)

