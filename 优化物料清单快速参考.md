# 优化物料清单快速参考 🚀

**版本**: v1.0  
**更新时间**: 2025-10-27

---

## 📊 字段结构

```javascript
optimized_bill_of_materials: [{
  actuator_model: String,    // 型号（大写）
  total_quantity: Number,    // 数量（≥1）
  unit_price: Number,        // 单价（≥0）
  total_price: Number,       // 总价（≥0）
  covered_tags: [String],    // 位号列表
  notes: String              // 备注
}]
```

---

## 💻 常用代码片段

### 生成优化清单

```javascript
const modelMap = new Map();

project.selections.forEach(sel => {
  const model = sel.selected_actuator?.final_model_name;
  const price = sel.selected_actuator?.price;
  const tag = sel.tag_number;
  
  if (modelMap.has(model)) {
    const item = modelMap.get(model);
    item.total_quantity += 1;
    item.total_price = item.unit_price * item.total_quantity;
    item.covered_tags.push(tag);
  } else {
    modelMap.set(model, {
      actuator_model: model,
      total_quantity: 1,
      unit_price: price,
      total_price: price,
      covered_tags: [tag]
    });
  }
});

project.optimized_bill_of_materials = Array.from(modelMap.values());
await project.save();
```

---

### 查询位号对应型号

```javascript
const findModelByTag = (project, tag) => {
  return project.optimized_bill_of_materials.find(
    item => item.covered_tags.includes(tag)
  );
};
```

---

### 统计总价

```javascript
const totalPrice = project.optimized_bill_of_materials.reduce(
  (sum, item) => sum + item.total_price, 0
);

const totalQuantity = project.optimized_bill_of_materials.reduce(
  (sum, item) => sum + item.total_quantity, 0
);
```

---

## 📊 数据示例

```javascript
{
  optimized_bill_of_materials: [
    {
      actuator_model: "SF10/C-150DA-T1",
      total_quantity: 3,
      unit_price: 8925,
      total_price: 26775,
      covered_tags: ["V-101", "V-102", "V-105"],
      notes: "低温环境"
    },
    {
      actuator_model: "AT-DA63-T2",
      total_quantity: 2,
      unit_price: 93,
      total_price: 186,
      covered_tags: ["V-103", "V-104"]
    }
  ]
}
```

---

## 🔧 API 端点

### 生成优化清单

```bash
POST /api/new-projects/:id/optimize-bom
```

### 获取优化清单

```bash
GET /api/new-projects/:id/optimized-bom
```

### 更新优化清单

```bash
PUT /api/new-projects/:id/optimized-bom
Content-Type: application/json

{
  "optimized_bill_of_materials": [...]
}
```

---

## 📈 优势对比

### 优化前

```
5个选型 → 5条记录
数据冗余多
难以统计
```

### 优化后

```
5个选型 → 2条记录（2个型号）
数据精简
一目了然
专业报价
```

---

## 🎯 关键字段

### covered_tags ⭐

**用途**: 追踪哪些位号使用了这个型号

**示例**:
```javascript
covered_tags: ["V-101", "V-102", "V-105"]
```

**应用**:
- 生成位号-型号对照表
- 反向查询位号对应的型号
- 统计型号使用频率

---

## ✅ 最佳实践

1. ✅ 总价 = 单价 × 数量
2. ✅ 位号自动转大写
3. ✅ 型号自动转大写
4. ✅ 数量最小为 1
5. ✅ 价格不能为负数

---

**详细文档**: 见 `选型优化物料清单字段说明.md`

