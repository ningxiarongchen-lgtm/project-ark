# 🗄️ 数据库配置说明
## Database Configuration Guide

**更新日期**: 2025-10-30

---

## 📋 数据库名称统一

### ✅ 已统一配置

所有演示相关的配置现已统一使用 `cmax` 数据库：

```
数据库名称: cmax
连接字符串: mongodb://localhost:27017/cmax
```

---

## 🔧 修改的配置文件

### 1. `backend/config/database.js`

**修改内容**:
```javascript
// 开发/生产环境默认数据库
dbUri = process.env.MONGODB_URI || 'mongodb://localhost:27017/cmax';
```

**说明**: 系统默认连接到 `cmax` 数据库

---

### 2. `backend/seed_final_acceptance.js`

**修改内容**:
```javascript
// 数据初始化脚本默认数据库
const mongoUri = process.env.MONGO_URI || 
                 process.env.MONGODB_URI || 
                 'mongodb://localhost:27017/cmax';
```

**说明**: 演示数据将被初始化到 `cmax` 数据库

---

### 3. `演示环境启动.sh`

**修改内容**:
```bash
# 启动时设置环境变量
MONGODB_URI=mongodb://localhost:27017/cmax NODE_ENV=development npm start
```

**说明**: 启动脚本明确指定使用 `cmax` 数据库

---

### 4. `backend/.env.demo`

**新增文件**:
```env
MONGODB_URI=mongodb://localhost:27017/cmax
```

**说明**: 演示环境配置模板

---

## 📊 数据库使用场景

### 开发/演示环境
```
数据库名称: cmax
用途: 日常开发、客户演示、系统测试
```

### 测试环境
```
数据库名称: cmax_test
用途: 自动化测试（自动添加 _test 后缀）
```

---

## 🚀 使用方法

### 方式一：使用演示启动脚本（推荐）

```bash
bash 演示环境启动.sh
```

**自动配置**:
- ✅ 自动设置 MONGODB_URI=mongodb://localhost:27017/cmax
- ✅ 自动初始化演示数据到 cmax 数据库
- ✅ 无需手动配置

---

### 方式二：手动启动

**1. 配置环境变量**

创建 `backend/.env` 文件：
```bash
cd backend
cp .env.demo .env
```

或手动创建包含以下内容的 `.env` 文件：
```env
NODE_ENV=development
PORT=5001
MONGODB_URI=mongodb://localhost:27017/cmax
JWT_SECRET=your-secret-key
FRONTEND_URL=http://localhost:5173
```

**2. 初始化数据**

```bash
cd backend
npm run seed:final
```

**3. 启动服务**

```bash
# 后端
cd backend
npm start

# 前端
cd frontend
npm run dev
```

---

## 🔍 验证数据库

### 检查当前数据库

```bash
# 连接到 MongoDB
mongosh

# 切换到 cmax 数据库
use cmax

# 查看所有集合
show collections

# 查看用户数量
db.users.countDocuments()

# 查看执行器数量
db.actuators.countDocuments()

# 查看项目数量
db.newprojects.countDocuments()
```

### 预期结果

演示数据初始化后，cmax 数据库应包含：

```
✅ 用户 (users): 10 个测试账号
✅ 供应商 (suppliers): 5 个
✅ 执行器型号 (actuators): 55 个
✅ 手动操作装置 (manualoverrides): 4 个
✅ 配件 (accessories): 8 个
✅ 示例项目 (newprojects): 4 个
```

---

## 🗄️ 数据库结构

### cmax 数据库包含的集合

| 集合名称 | 说明 | 数量 |
|---------|------|------|
| users | 用户账号 | 10 |
| suppliers | 供应商 | 5 |
| actuators | 执行器型号 | 55 |
| accessories | 配件 | 8 |
| manualoverrides | 手动操作装置 | 4 |
| newprojects | 新项目 | 4 |
| salesorders | 销售订单 | 0-N |
| productionorders | 生产订单 | 0-N |
| purchaseorders | 采购订单 | 0-N |
| servicetickets | 售后工单 | 0-N |
| qualitychecks | 质检记录 | 0-N |
| workorders | 工作单 | 0-N |

---

## 🔄 数据重置

### 重新初始化演示数据

如果需要重置数据库到初始状态：

```bash
cd backend
npm run seed:final
```

**注意**: 此操作会：
- ❌ 清空 cmax 数据库的所有现有数据
- ✅ 重新创建演示数据

---

## 🛡️ 数据安全

### 开发/演示环境
- 使用 `cmax` 数据库
- 包含测试数据
- 可以随时重置

### 生产环境建议
- 使用不同的数据库名称（如 `cmax_production`）
- 修改 `.env` 文件中的 `MONGODB_URI`
- 使用强密码和访问控制
- 定期备份数据

---

## 📝 环境变量优先级

系统按以下优先级读取数据库配置：

1. **环境变量** `MONGODB_URI` （最高优先级）
2. **环境变量** `MONGO_URI`
3. **默认值** `mongodb://localhost:27017/cmax`

**示例**:
```bash
# 临时使用其他数据库
MONGODB_URI=mongodb://localhost:27017/test npm start

# 永久配置（在 .env 文件中）
MONGODB_URI=mongodb://localhost:27017/cmax
```

---

## 🔧 故障排查

### 问题1: 连接失败

**错误信息**: `MongoDB Connection Error`

**解决方案**:
```bash
# 检查 MongoDB 是否运行
brew services list | grep mongodb

# 启动 MongoDB
brew services start mongodb-community

# 验证连接
mongosh --eval "db.adminCommand('ping')"
```

---

### 问题2: 数据为空

**症状**: 登录后看不到项目或数据

**解决方案**:
```bash
# 重新初始化数据
cd backend
npm run seed:final

# 刷新浏览器
```

---

### 问题3: 数据库名称不一致

**症状**: 数据保存到了其他数据库

**解决方案**:
```bash
# 检查环境变量
cat backend/.env | grep MONGODB_URI

# 确保设置为 cmax
echo "MONGODB_URI=mongodb://localhost:27017/cmax" > backend/.env

# 或使用演示启动脚本
bash 演示环境启动.sh
```

---

## 📖 相关命令

### MongoDB 常用命令

```bash
# 连接到 MongoDB
mongosh

# 查看所有数据库
show dbs

# 切换数据库
use cmax

# 查看当前数据库
db.getName()

# 查看所有集合
show collections

# 查看集合数据
db.users.find().pretty()

# 统计文档数量
db.users.countDocuments()

# 删除数据库（谨慎使用）
db.dropDatabase()
```

---

## 🎯 总结

✅ **所有演示数据统一保存在 `cmax` 数据库**

✅ **配置文件已全部更新**:
- backend/config/database.js
- backend/seed_final_acceptance.js
- 演示环境启动.sh
- backend/.env.demo

✅ **使用演示启动脚本自动配置**:
```bash
bash 演示环境启动.sh
```

✅ **数据可随时重置**:
```bash
npm run seed:final
```

---

**维护者**: Project Ark Team  
**更新日期**: 2025-10-30

---

© 2025 Project Ark Team. All Rights Reserved.

