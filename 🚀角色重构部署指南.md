# 🚀 角色重构部署指南

**修改日期：** 2025年10月31日  
**修改内容：** 合并After-sales Engineer到Technical Engineer  
**影响范围：** 前后端代码、数据库模型、API权限

---

## 📋 部署前准备

### 1. 备份当前数据库

```bash
# 备份整个数据库
mongodump --uri="mongodb://localhost:27017/cmax" --out=./backup_$(date +%Y%m%d_%H%M%S)

# 仅备份用户集合
mongodump --uri="mongodb://localhost:27017/cmax" --collection=users --out=./backup_users_$(date +%Y%m%d_%H%M%S)
```

### 2. 检查现有After-sales Engineer用户

```bash
cd backend
node -e "
require('dotenv').config();
const mongoose = require('mongoose');
const User = require('./models/User');

mongoose.connect(process.env.MONGO_URI || 'mongodb://localhost:27017/cmax')
  .then(async () => {
    const count = await User.countDocuments({role: 'After-sales Engineer'});
    console.log('现有After-sales Engineer用户数量:', count);
    
    const users = await User.find({role: 'After-sales Engineer'}, 'full_name phone department');
    users.forEach(u => console.log(' -', u.full_name, u.phone, u.department));
    
    process.exit(0);
  });
"
```

---

## 🔄 部署步骤

### 步骤1: 停止所有服务

```bash
# 停止后端服务
pm2 stop backend  # 或者 Ctrl+C 停止开发服务器

# 停止前端服务
pm2 stop frontend  # 或者 Ctrl+C 停止开发服务器
```

### 步骤2: 拉取最新代码

```bash
cd "/Users/hexiaoxiao/Desktop/Model Selection System"
git pull origin main  # 或者您的分支名
```

### 步骤3: 安装依赖（如有更新）

```bash
# 后端
cd backend
npm install

# 前端
cd ../frontend
npm install
```

### 步骤4: 运行数据库迁移脚本

```bash
cd backend
node migrations/migrate_aftersales_to_technical.js
```

**预期输出：**
```
╔═══════════════════════════════════════════════════════════════╗
║  开始迁移：After-sales Engineer → Technical Engineer      ║
╚═══════════════════════════════════════════════════════════════╝

📋 找到 X 个 After-sales Engineer 用户：

   • 吴售后 (13000000009) - 售后服务部

🔄 开始更新角色...

✅ 成功更新 X 个用户的角色

╔═══════════════════════════════════════════════════════════════╗
║  迁移完成统计                                                ║
╠═══════════════════════════════════════════════════════════════╣
║  剩余 After-sales Engineer 用户: 0                        ║
║  当前 Technical Engineer 用户总数: Y                      ║
╚═══════════════════════════════════════════════════════════════╝

🎉 所有 After-sales Engineer 用户已成功迁移为 Technical Engineer！
```

**如果输出显示失败：**
1. 检查数据库连接
2. 检查 `.env` 文件中的 `MONGO_URI`
3. 查看详细错误信息

### 步骤5: 验证数据库迁移结果

```bash
mongo
> use cmax  // 或您的数据库名
> db.users.find({role: "After-sales Engineer"}).count()
// 应该返回 0

> db.users.find({role: "Technical Engineer"})
// 查看所有技术工程师用户
```

### 步骤6: 清理旧的seed数据（可选）

如果是测试环境，建议重新初始化：

```bash
cd backend
node seed_final_acceptance.js
```

**注意：** 这会清空所有数据！生产环境**不要**运行此命令！

### 步骤7: 启动后端服务

```bash
cd backend
npm run dev  # 开发环境
# 或
pm2 start ecosystem.config.js  # 生产环境
```

**验证后端启动：**
```bash
curl http://localhost:5000/api/health
```

### 步骤8: 重新构建前端

```bash
cd frontend
npm run build
```

**检查构建输出：**
- ✅ 无编译错误
- ✅ 无类型警告
- ✅ 构建大小合理

### 步骤9: 启动前端服务

```bash
cd frontend
npm run dev  # 开发环境
# 或
pm2 start ecosystem.config.js  # 生产环境
```

---

## ✅ 部署后验证

### 1. 登录测试

#### 测试账号

| 用户 | 手机号 | 密码 | 角色 |
|-----|--------|------|-----|
| 张技术 | 13000000003 | password | Technical Engineer |
| 李销售 | 13000000002 | password | Sales Manager |
| 王管理 | 13000000001 | password | Administrator |

#### 验证步骤

**1. 技术工程师登录**
```
1. 访问 http://localhost:3000/login
2. 输入: 13000000003 / password
3. 检查菜单是否包含：
   ✅ 智慧选型
   ✅ 售后服务
4. 点击"售后服务"，验证可以访问
```

**2. 销售经理登录**
```
1. 输入: 13000000002 / password
2. 检查菜单是否包含：
   ✅ 项目管理
   ✅ 售后服务（可以查看，不能处理）
```

**3. 管理员登录**
```
1. 输入: 13000000001 / password
2. 访问"用户管理"
3. 创建新用户，检查角色下拉框：
   ✅ 应该包含9个角色（不含Administrator）
   ❌ 不应该包含"After-sales Engineer"
```

### 2. 功能测试

#### 测试1：创建售后工单
```
1. 以销售经理身份登录
2. 进入"售后服务" → "创建工单"
3. 填写工单信息
4. 在"指派工程师"下拉框中：
   ✅ 应该只显示Technical Engineer角色的用户
   ❌ 不应该有"After-sales Engineer"选项
5. 提交工单
```

#### 测试2：技术工程师接收工单
```
1. 以技术工程师身份登录（张技术 / 13000000003）
2. 进入"售后服务"
3. 检查：
   ✅ 能看到刚才创建的工单（如果指派给他）
   ✅ 可以点击"接受任务"
   ✅ 可以添加跟进记录
   ✅ 可以更新工单状态
```

#### 测试3：技术工程师使用智能选型
```
1. 仍以技术工程师身份
2. 进入"智慧选型"
3. 验证：
   ✅ 可以正常访问
   ✅ 可以创建新方案
   ✅ 功能完全正常
```

### 3. API测试

#### 使用Postman或curl测试

**获取JWT Token:**
```bash
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13000000003",
    "password": "password"
  }'
```

**测试创建工单（技术工程师权限）:**
```bash
curl -X POST http://localhost:5000/api/tickets \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "测试工单",
    "description": "API权限测试",
    "client_name": "测试客户",
    "service_type": "技术支持",
    "priority": "正常"
  }'
```

**预期结果：**
- ✅ 返回201 Created
- ✅ 工单创建成功

---

## 🔧 故障排除

### 问题1: 数据库迁移失败

**错误信息：**
```
❌ 数据库连接失败: connection refused
```

**解决方案：**
1. 检查MongoDB是否运行
   ```bash
   brew services list | grep mongodb  # macOS
   sudo systemctl status mongod       # Linux
   ```

2. 检查`.env`文件中的`MONGO_URI`
   ```bash
   cat backend/.env | grep MONGO_URI
   ```

3. 手动连接测试
   ```bash
   mongo mongodb://localhost:27017/cmax
   ```

### 问题2: 前端构建失败

**错误信息：**
```
Module not found: Can't resolve '@ant-design/icons'
```

**解决方案：**
```bash
cd frontend
rm -rf node_modules package-lock.json
npm install
npm run build
```

### 问题3: 登录后菜单不显示

**可能原因：**
- 浏览器缓存了旧的角色数据

**解决方案：**
1. 清除浏览器缓存
2. 打开开发者工具 → Application → Local Storage → 删除`auth-storage`
3. 重新登录

### 问题4: 技术工程师看不到售后菜单

**检查步骤：**

1. **验证数据库中的角色：**
   ```bash
   mongo
   > db.users.findOne({phone: "13000000003"}, {role: 1, full_name: 1})
   // 应该返回: { role: "Technical Engineer", full_name: "张技术" }
   ```

2. **检查前端菜单配置：**
   ```javascript
   // frontend/src/components/Layout/AttioLayout.jsx
   // 查找 '/service-center' 的配置
   // 应该包含: roles: ['Technical Engineer', 'Sales Manager']
   ```

3. **检查JWT Token：**
   - 打开浏览器开发者工具
   - Network → 找到任意API请求
   - Headers → Authorization
   - 复制Token到 https://jwt.io 解码
   - 检查 `role` 字段是否为 "Technical Engineer"

---

## 📊 数据迁移统计

### 修改的文件统计

| 类别 | 文件数 | 关键修改 |
|-----|--------|---------|
| 后端模型 | 1 | User模型枚举值 |
| 后端路由 | 3 | API权限配置 |
| 后端控制器 | 0 | 无需修改（逻辑通用） |
| 后端脚本 | 2 | seed + migration |
| 前端组件 | 4 | 菜单、权限、表单 |
| 前端页面 | 4 | Dashboard、工单相关 |
| **总计** | **14** | + 1个新建迁移脚本 |

### 代码变更统计

- **删除行数：** ~50行（移除After-sales引用）
- **新增行数：** ~120行（迁移脚本 + 角色补充）
- **修改行数：** ~80行（角色替换）

---

## 🎯 回滚方案

### 如果部署后发现严重问题：

#### 步骤1: 恢复数据库备份

```bash
# 停止所有服务
pm2 stop all

# 恢复数据库
mongorestore --uri="mongodb://localhost:27017" --drop ./backup_TIMESTAMP
```

#### 步骤2: 回退代码版本

```bash
git log --oneline -10  # 查看最近10次提交
git revert HEAD       # 回退最新的提交
# 或
git reset --hard COMMIT_HASH  # 回到指定提交（危险操作）
```

#### 步骤3: 重启服务

```bash
pm2 restart all
```

---

## 📝 给用户的通知模板

### 邮件标题
```
【系统升级通知】技术工程师职责扩展 - 现包含售后服务
```

### 邮件正文
```
尊敬的用户，

我们的系统将于 [日期时间] 进行升级，主要变更如下：

1. **角色合并**
   - 原"售后工程师"角色已合并到"技术工程师"
   - 所有原售后工程师的账号已自动升级为技术工程师
   - 您的登录凭证（手机号和密码）保持不变

2. **功能增强**
   - 技术工程师现在可以同时处理技术方案和售后工单
   - 菜单中将同时显示"智慧选型"和"售后服务"两个入口
   - 所有原有功能均保持不变

3. **影响范围**
   - 如果您是原售后工程师：请使用原手机号登录，角色已自动更新
   - 如果您是其他角色：无影响，系统使用方式不变

4. **技术支持**
   - 如有任何问题，请联系系统管理员
   - 技术支持热线：[您的热线电话]

感谢您的理解与支持！

系统管理员团队
[日期]
```

---

## ✅ 部署检查清单

### 部署前

- [ ] 已备份数据库
- [ ] 已通知相关用户
- [ ] 已停止所有服务
- [ ] 已拉取最新代码
- [ ] 已安装所有依赖

### 部署中

- [ ] 数据库迁移成功（0个After-sales Engineer残留）
- [ ] 后端启动成功
- [ ] 前端构建成功
- [ ] 前端启动成功

### 部署后

- [ ] 技术工程师可以登录
- [ ] 技术工程师可以访问智慧选型
- [ ] 技术工程师可以访问售后服务
- [ ] 销售经理可以创建售后工单
- [ ] 工单可以分配给技术工程师
- [ ] 技术工程师可以处理分配给他的工单
- [ ] 用户管理界面不显示After-sales Engineer选项
- [ ] API权限测试通过
- [ ] 所有角色菜单显示正确

---

## 🚀 性能优化建议

### 数据库索引

确保User集合有以下索引：

```javascript
db.users.createIndex({ phone: 1 }, { unique: true })
db.users.createIndex({ role: 1 })
db.users.createIndex({ createdAt: -1 })
```

### 缓存清理

```bash
# 清理Redis缓存（如果使用）
redis-cli FLUSHDB

# 清理应用缓存
rm -rf backend/.cache
rm -rf frontend/.cache
```

---

**文档版本：** v1.0  
**最后更新：** 2025-10-31  
**维护人员：** AI Architect

**紧急联系：** 如部署过程中遇到任何问题，请立即停止部署并联系系统管理员！

