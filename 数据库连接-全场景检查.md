# 🔍 数据库连接 - 全场景检查报告
## Database Connection - Full Scenario Audit

**检查日期**: 2025-10-30  
**目标**: 确保所有场景下都连接到正确的数据库

---

## 📊 场景分类

### 场景1: 演示环境 🎬
**预期数据库**: `cmax`  
**使用场景**: 客户演示、内部培训、系统验收

### 场景2: 开发环境 💻
**预期数据库**: `cmax`  
**使用场景**: 日常开发、功能测试

### 场景3: 生产环境 🚀
**预期数据库**: `cmax`（或通过环境变量指定）  
**使用场景**: 正式上线运行

### 场景4: 测试环境 🧪
**预期数据库**: `cmax_test`（自动添加 _test 后缀）  
**使用场景**: 自动化测试、单元测试

---

## ✅ 已修复的文件（正确）

### 1. ✓ backend/config/database.js
```javascript
// 开发/生产环境
dbUri = process.env.MONGODB_URI || 'mongodb://localhost:27017/cmax';
```
**状态**: ✅ 正确 - 默认使用 cmax

---

### 2. ✓ backend/seed_final_acceptance.js
```javascript
const mongoUri = process.env.MONGO_URI || 
                 process.env.MONGODB_URI || 
                 'mongodb://localhost:27017/cmax';
```
**状态**: ✅ 正确 - 演示数据初始化到 cmax

---

### 3. ✓ 演示环境启动.sh
```bash
MONGODB_URI=mongodb://localhost:27017/cmax NODE_ENV=development npm start
```
**状态**: ✅ 正确 - 明确指定 cmax

---

## ⚠️ 需要修复的文件（发现问题）

### 1. ❌ backend/drop-email-index.js
**当前配置**:
```javascript
const dbUri = process.env.MONGODB_URI || 'mongodb://localhost:27017/cmax-actuators';
```
**问题**: 默认使用 cmax-actuators（旧名称）  
**影响**: 如果不设置环境变量，会连接到错误的数据库  
**修复**: 改为 'mongodb://localhost:27017/cmax'

---

### 2. ❌ backend/clean-and-recreate-users.js
**当前配置**:
```javascript
const dbUri = process.env.MONGODB_URI || 'mongodb://localhost:27017/cmax-actuators';
```
**问题**: 默认使用 cmax-actuators（旧名称）  
**影响**: 清理用户时可能操作错误的数据库  
**修复**: 改为 'mongodb://localhost:27017/cmax'

---

### 3. ❌ backend/seed.js
**当前配置**:
```javascript
const mongoUri = process.env.MONGO_URI || 
                 process.env.MONGODB_URI || 
                 'mongodb://localhost:27017/project_ark';
```
**问题**: 默认使用 project_ark（旧名称）  
**影响**: 执行 npm run seed 会初始化到错误的数据库  
**修复**: 改为 'mongodb://localhost:27017/cmax'

---

### 4. ❌ backend/seed_comprehensive_test.js
**当前配置**:
```javascript
const mongoUri = process.env.MONGO_URI || 
                 process.env.MONGODB_URI || 
                 'mongodb://localhost:27017/project_ark';
```
**问题**: 默认使用 project_ark（旧名称）  
**影响**: 综合测试数据初始化到错误的数据库  
**修复**: 改为 'mongodb://localhost:27017/cmax'

---

### 5. ❌ backend/seed_final_test_data.js
**当前配置**:
```javascript
await mongoose.connect(process.env.MONGODB_URI || 
                      'mongodb://localhost:27017/valve_selection', {
```
**问题**: 默认使用 valve_selection（旧名称）  
**影响**: 测试数据初始化到错误的数据库  
**修复**: 改为 'mongodb://localhost:27017/cmax'

---

### 6. ❌ backend/seed_mock_suppliers.js
**当前配置**:
```javascript
await mongoose.connect(process.env.MONGODB_URI || 
                      'mongodb://localhost:27017/project_ark');
```
**问题**: 默认使用 project_ark（旧名称）  
**影响**: 模拟供应商数据初始化到错误的数据库  
**修复**: 改为 'mongodb://localhost:27017/cmax'

---

### 7. ❌ backend/scripts/createAdminUser.js
**当前配置**:
```javascript
const mongoURI = process.env.MONGODB_URI || 
                'mongodb://localhost:27017/project_ark';
```
**问题**: 默认使用 project_ark（旧名称）  
**影响**: 创建管理员用户到错误的数据库  
**修复**: 改为 'mongodb://localhost:27017/cmax'

---

### 8. ❌ backend/scripts/testPasswordReset.js
**当前配置**:
```javascript
const mongoURI = process.env.MONGODB_URI || 
                'mongodb://localhost:27017/project_ark';
```
**问题**: 默认使用 project_ark（旧名称）  
**影响**: 密码重置测试连接错误的数据库  
**修复**: 改为 'mongodb://localhost:27017/cmax'

---

## 📋 修复优先级

### 🔥 高优先级（必须立即修复）

这些文件可能在演示或生产中使用：

1. **backend/seed.js** - npm run seed 命令使用
2. **backend/seed_comprehensive_test.js** - 综合测试使用
3. **backend/scripts/createAdminUser.js** - 创建管理员

### ⚠️ 中优先级（建议修复）

这些文件在特定场景使用：

4. **backend/clean-and-recreate-users.js** - 用户管理
5. **backend/drop-email-index.js** - 索引管理
6. **backend/seed_final_test_data.js** - 测试数据

### 💡 低优先级（可选修复）

这些文件不常用：

7. **backend/seed_mock_suppliers.js** - 模拟数据
8. **backend/scripts/testPasswordReset.js** - 测试脚本

---

## 🎯 统一标准

### 标准配置模式

所有脚本应使用统一的配置模式：

```javascript
const mongoUri = process.env.MONGO_URI || 
                 process.env.MONGODB_URI || 
                 'mongodb://localhost:27017/cmax';
```

**优先级**:
1. MONGO_URI 环境变量（最高）
2. MONGODB_URI 环境变量
3. 默认值：mongodb://localhost:27017/cmax

---

## 🔄 各场景使用的数据库

### 场景1: npm start（正常启动）
```bash
npm start
```
**数据库**: cmax（通过 config/database.js）  
**状态**: ✅ 正确

---

### 场景2: 演示启动脚本
```bash
bash 演示环境启动.sh
```
**数据库**: cmax（明确指定 MONGODB_URI）  
**状态**: ✅ 正确

---

### 场景3: npm run seed:final
```bash
npm run seed:final
```
**数据库**: cmax（seed_final_acceptance.js）  
**状态**: ✅ 正确

---

### 场景4: npm run seed
```bash
npm run seed
```
**数据库**: project_ark（seed.js）  
**状态**: ❌ **错误** - 需要修复

---

### 场景5: NODE_ENV=test npm start
```bash
NODE_ENV=test npm start
```
**数据库**: cmax_test（自动添加后缀）  
**状态**: ✅ 正确

---

### 场景6: 手动启动（有 .env 文件）
```bash
# .env 文件包含 MONGODB_URI=mongodb://localhost:27017/cmax
npm start
```
**数据库**: cmax  
**状态**: ✅ 正确

---

### 场景7: 手动启动（无 .env 文件）
```bash
# 没有 .env 文件
npm start
```
**数据库**: cmax（使用 config/database.js 的默认值）  
**状态**: ✅ 正确

---

### 场景8: 生产环境
```bash
NODE_ENV=production MONGODB_URI=mongodb://production-server:27017/cmax npm start
```
**数据库**: 环境变量指定的数据库  
**状态**: ✅ 正确（需要正确配置环境变量）

---

## ⚡ 立即修复建议

### 方案1: 修复所有文件（推荐）

修复所有8个文件，确保100%一致性

**优点**:
- 完全消除隐患
- 未来不会出现数据库错误

**缺点**:
- 需要修改多个文件

---

### 方案2: 只修复高优先级文件

只修复最常用的3个文件

**优点**:
- 快速解决主要问题

**缺点**:
- 仍有潜在风险

---

## 📝 修复检查清单

- [ ] backend/seed.js
- [ ] backend/seed_comprehensive_test.js
- [ ] backend/scripts/createAdminUser.js
- [ ] backend/clean-and-recreate-users.js
- [ ] backend/drop-email-index.js
- [ ] backend/seed_final_test_data.js
- [ ] backend/seed_mock_suppliers.js
- [ ] backend/scripts/testPasswordReset.js

---

## 🎉 修复后的保证

修复所有文件后，可以保证：

✅ **演示环境**: 始终使用 cmax 数据库  
✅ **开发环境**: 始终使用 cmax 数据库  
✅ **生产环境**: 使用环境变量指定或默认 cmax  
✅ **测试环境**: 自动使用 cmax_test 数据库  
✅ **所有脚本**: 统一使用 cmax 数据库  

---

## 📞 验证方法

修复后，使用以下方法验证：

```bash
# 1. 启动系统
npm start

# 2. 查看日志，确认数据库
# 应该显示: 数据库连接成功: cmax

# 3. 连接 MongoDB 验证
mongosh
use cmax
show collections
```

---

**报告生成时间**: 2025-10-30  
**需要修复的文件**: 8 个  
**建议**: 立即修复所有文件，确保100%一致性

---

© 2025 Project Ark Team

