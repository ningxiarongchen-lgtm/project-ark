# 阶梯定价 - 快速参考卡片

> **快速查阅新的价格结构和使用方法**

---

## 📦 新的数据结构

### 执行器模型 (Actuator)

```javascript
{
  model_base: "AT-SR52K8",
  series: "AT",
  
  // ✅ 主要价格字段 - 阶梯定价
  price_tiers: [
    {
      min_quantity: 1,      // 起订量
      unit_price: 5280,     // 单价
      price_type: 'normal', // 价格类型
      notes: '单件价格'     // 备注
    },
    {
      min_quantity: 5,
      unit_price: 5016,     // 5% 折扣
      price_type: 'normal',
      notes: '5-9件'
    },
    {
      min_quantity: 10,
      unit_price: 4752,     // 10% 折扣
      price_type: 'normal',
      notes: '10件以上'
    }
  ],
  
  // ✅ 手动操作装置
  manual_override: {
    model: "SD-1",
    price: 860
  },
  
  // ✅ 配件价格
  accessories_pricing: {
    seal_kit_price: 12
  }
}
```

---

## 🎯 常用方法

### 1. 获取指定数量的价格

```javascript
const actuator = await Actuator.findById(id);

// 采购 8 件
const priceInfo = actuator.getPriceByQuantity(8);

// 返回:
{
  unit_price: 5016,       // 单价
  min_quantity: 5,        // 适用档位
  total_price: 40128,     // 总价 (5016 × 8)
  price_type: 'normal',
  notes: '5-9件'
}
```

### 2. 获取所有价格档位

```javascript
const tiers = actuator.getAllPriceTiers();

// 返回（按 min_quantity 升序）:
[
  { min_quantity: 1, unit_price: 5280, ... },
  { min_quantity: 5, unit_price: 5016, ... },
  { min_quantity: 10, unit_price: 4752, ... }
]
```

### 3. 支持不同价格类型

```javascript
// 获取高温型号的价格（10件）
const price = actuator.getPriceByQuantity(10, 'high_temp');
```

---

## 🔧 API 路由示例

### 获取执行器价格

```http
GET /api/actuators/:id/price?quantity=10&price_type=normal

Response:
{
  "success": true,
  "data": {
    "actuator_model": "AT-SR52K8",
    "quantity": 10,
    "unit_price": 4752,
    "total_price": 47520,
    "min_quantity": 10,
    "price_type": "normal"
  }
}
```

### 获取所有价格档位

```http
GET /api/actuators/:id/price-tiers

Response:
{
  "success": true,
  "data": {
    "actuator_model": "AT-SR52K8",
    "price_tiers": [
      { "min_quantity": 1, "unit_price": 5280, ... },
      { "min_quantity": 5, "unit_price": 5016, ... },
      { "min_quantity": 10, "unit_price": 4752, ... }
    ]
  }
}
```

---

## 📊 价格类型 (price_type)

| 类型 | 值 | 说明 | 价格示例 |
|------|---|------|----------|
| 标准型 | `'normal'` | 常规温度 -20~80°C | ¥5,280 |
| 低温型 | `'low_temp'` | 低温 -40~80°C | ¥6,336 (+20%) |
| 高温型 | `'high_temp'` | 高温 -20~150°C | ¥6,336 (+20%) |
| 通用 | `'standard'` | 默认价格 | ¥5,280 |

---

## 💡 典型配置示例

### 标准阶梯定价（推荐）

```javascript
price_tiers: [
  { min_quantity: 1,  unit_price: 5280 },  // 基础价
  { min_quantity: 5,  unit_price: 5016 },  // -5%
  { min_quantity: 10, unit_price: 4752 },  // -10%
  { min_quantity: 20, unit_price: 4488 }   // -15%
]
```

### 支持多温度等级

```javascript
price_tiers: [
  // 标准型
  { min_quantity: 1,  unit_price: 5280, price_type: 'normal' },
  { min_quantity: 10, unit_price: 4752, price_type: 'normal' },
  
  // 高温型（+20%）
  { min_quantity: 1,  unit_price: 6336, price_type: 'high_temp' },
  { min_quantity: 10, unit_price: 5702, price_type: 'high_temp' }
]
```

---

## 🔄 迁移命令

### 从旧数据迁移

```bash
cd backend
node scripts/migrate_pricing_to_tiers.js
```

### 导入新格式数据

```bash
cd backend
node scripts/import_actuators_with_tiers.js data/actuators.csv
```

---

## ⚙️ 前端使用示例

### React 组件

```jsx
import { useEffect, useState } from 'react';
import { actuatorsAPI } from '../services/api';

function PriceDisplay({ actuatorId, quantity }) {
  const [price, setPrice] = useState(null);
  
  useEffect(() => {
    const fetchPrice = async () => {
      const response = await actuatorsAPI.getPrice(actuatorId, quantity);
      setPrice(response.data);
    };
    fetchPrice();
  }, [actuatorId, quantity]);
  
  return (
    <div>
      <p>单价: ¥{price?.unit_price}</p>
      <p>总价: ¥{price?.total_price}</p>
      <small>适用档位: {price?.min_quantity}件起</small>
    </div>
  );
}
```

---

## 📋 检查清单

### 创建新执行器时

- [ ] 配置至少 3 个价格档位
- [ ] 设置合理的折扣幅度（通常 5%, 10%, 15%）
- [ ] 添加 notes 说明每个档位
- [ ] 配置 manual_override（如适用）
- [ ] 配置 accessories_pricing

### API 调用时

- [ ] 传递正确的 quantity 参数
- [ ] 指定 price_type（如需要）
- [ ] 处理可能的 null 返回值
- [ ] 显示适用的价格档位信息

---

## 🆘 常见问题

### Q: 如何快速计算批量折扣？

```javascript
const basePrice = 5280;
const discount = 0.10;  // 10% 折扣
const discountedPrice = basePrice * (1 - discount);  // 4752
```

### Q: 如果执行器没有配置 price_tiers 怎么办？

```javascript
const priceInfo = actuator.getPriceByQuantity(10);

if (!priceInfo) {
  console.log('此执行器未配置价格信息');
  // 降级处理：使用旧的 pricing 字段（如果存在）
}
```

### Q: 如何添加新的价格档位？

```javascript
const actuator = await Actuator.findById(id);

actuator.price_tiers.push({
  min_quantity: 50,
  unit_price: 4200,  // 20% 折扣
  price_type: 'normal',
  notes: '50件以上享受20%折扣'
});

await actuator.save();
```

---

## 📞 需要帮助？

- 📖 [完整升级文档](./阶梯定价升级说明.md)
- 📧 技术支持: tech@cmax.com
- 💬 开发团队: dev@cmax.com

---

**版本**: v2.1.0 | **更新**: 2025-10-27

