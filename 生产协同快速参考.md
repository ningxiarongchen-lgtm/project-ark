# 生产协同功能快速参考 🔧

## 📌 核心文件

### 后端
```
backend/
├── models/ProductionOrder.js           # 生产订单数据模型
├── controllers/productionController.js # 生产控制器
└── routes/productionRoutes.js          # 生产路由
```

### 前端
```
frontend/src/
├── pages/
│   ├── ProductionSchedule.jsx          # 生产排期页
│   └── OrderDetails.jsx                # 订单详情页(新增生产功能)
└── services/api.js                     # API服务(新增productionAPI)
```

---

## 🔗 API端点速查

| 功能 | 方法 | 端点 |
|------|------|------|
| 从订单创建生产任务 | POST | `/api/production/from-order/:salesOrderId` |
| 获取生产订单列表 | GET | `/api/production?status=&priority=&page=&limit=` |
| 获取生产订单详情 | GET | `/api/production/:id` |
| 更新生产订单 | PUT | `/api/production/:id` |
| 更新生产状态 | PATCH | `/api/production/:id/status` |
| 更新生产进度 | PATCH | `/api/production/:id/progress` |
| 分配资源 | POST | `/api/production/:id/assign-resources` |
| 删除生产订单 | DELETE | `/api/production/:id` |
| 获取统计 | GET | `/api/production/statistics` |

---

## 📋 生产状态

```
Pending → Scheduled → In Production → Completed
                            ↓
                         Paused
                            ↓
                        Delayed
                            ↓
                       Cancelled
```

**优先级**: Low | Normal | High | Urgent

**物料状态**: Pending | In Production | Completed | On Hold

---

## 🎯 使用流程

### 1. 从销售订单创建生产任务

```javascript
// 前端调用
import { productionAPI } from '../services/api'

const productionData = {
  plannedStartDate: "2025-10-28",
  plannedEndDate: "2025-11-27",
  priority: "High",
  productionLines: ["生产线A", "生产线B"],
  productionNotes: "注意质量控制",
  technicalRequirements: "按标准工艺",
  specialInstructions: "优先处理"
}

const response = await productionAPI.createFromOrder(salesOrderId, productionData)
```

### 2. 获取生产订单列表

```javascript
// 带筛选条件
const params = {
  status: 'In Production',
  priority: 'High',
  page: 1,
  limit: 20,
  startDate: '2025-10-01',
  endDate: '2025-12-31'
}

const response = await productionAPI.getAll(params)
```

### 3. 更新生产进度

```javascript
const progressData = {
  itemIndex: 0,  // 物料索引
  producedQuantity: 7,
  qualifiedQuantity: 7,
  defectiveQuantity: 0
}

await productionAPI.updateProgress(productionId, progressData)
```

### 4. 分配生产资源

```javascript
const resourceData = {
  supervisorId: "userId123",
  operatorIds: ["userId456", "userId789"],
  productionLines: ["生产线A", "生产线B"],
  equipment: [
    { name: "装配线1", id: "EQ001" }
  ]
}

await productionAPI.assignResources(productionId, resourceData)
```

---

## ⚠️ 重要限制

1. **只有已确认或生产中的销售订单才能创建生产任务**
2. **每个销售订单只能创建一个生产订单**(防止重复)
3. **只能删除 `Pending` 或 `Cancelled` 状态的生产订单**
4. **进度更新会自动计算合格率和完成状态**

---

## 🎨 UI组件速查

### OrderDetails.jsx 新增按钮
```jsx
{/* 创建生产任务按钮 - 橙色渐变 */}
<Button 
  icon={<ToolOutlined />}
  disabled={!['Confirmed', 'In Production'].includes(order.status)}
>
  创建生产任务
</Button>
```

### ProductionSchedule.jsx 核心组件

**统计卡片**:
- 生产订单总数
- 待生产/生产中/已完成数量
- 平均完成率
- 平均合格率

**关键列**:
- 生产订单号(PO-YYYYMM-XXXX)
- 进度条(Progress)
- 合格率徽章(Badge)
- 优先级标签(Tag)
- 状态标签(带图标)
- 逾期警告

---

## 📊 数据字段速查

### ProductionOrder 核心字段
```javascript
{
  productionOrderNumber: String,     // 自动生成 PO-YYYYMM-XXXX
  status: String,                    // 生产状态
  priority: String,                  // 优先级
  salesOrder: ObjectId,              // 关联销售订单
  orderSnapshot: Object,             // 订单快照
  
  schedule: {
    plannedStartDate: Date,
    plannedEndDate: Date,
    actualStartDate: Date,
    actualCompletedDate: Date
  },
  
  productionItems: [{
    model_name: String,
    ordered_quantity: Number,
    produced_quantity: Number,
    qualified_quantity: Number,
    defective_quantity: Number,
    production_status: String,
    production_line: String
  }],
  
  resources: {
    production_lines: [String],
    supervisor: ObjectId,
    operators: [ObjectId],
    equipment: [Object]
  },
  
  progress: {
    overall_percentage: Number,      // 0-100
    total_quantity: Number,
    completed_quantity: Number,
    in_progress_quantity: Number
  },
  
  quality: {
    pass_rate: Number,              // 0-100
    inspector: ObjectId
  }
}
```

---

## 🔧 常见问题

### Q1: 为什么无法创建生产任务？
**A**: 检查以下条件：
- 销售订单状态必须为 `Confirmed` 或 `In Production`
- 该销售订单还没有创建过生产任务

### Q2: 如何更新生产进度？
**A**: 
- 使用 PATCH `/api/production/:id/progress`
- 提供物料索引和数量数据
- 系统会自动计算进度百分比和合格率

### Q3: 生产进度如何自动计算？
**A**: 
```javascript
进度百分比 = (已完成数量 / 总订单数量) × 100
合格率 = (合格数量 / 已生产数量) × 100
```

### Q4: 什么时候生产订单自动完成？
**A**: 
- 当所有物料的 `qualified_quantity >= ordered_quantity` 时
- 系统自动将状态更新为 `Completed`
- 记录实际完成时间

---

## 🧪 快速测试

### 测试步骤
```bash
# 1. 启动后端
cd backend
npm start

# 2. 启动前端
cd frontend
npm run dev

# 3. 在浏览器中
# - 登录系统
# - 进入"订单管理"
# - 选择一个已确认的订单
# - 点击"创建生产任务"
# - 填写生产计划并提交
# - 在"生产排期"查看新任务
# - 测试状态更新和进度更新
```

---

## 📈 自动计算功能

### 1. 进度计算
```javascript
// 自动计算
productionOrder.calculateProgress()

// 计算内容:
// - overall_percentage: 总体完成百分比
// - total_quantity: 所有物料的总数量
// - completed_quantity: 已完成的总数量
// - in_progress_quantity: 在产数量
```

### 2. 质量计算
```javascript
// 自动计算
productionOrder.calculateQualityRate()

// 计算内容:
// - pass_rate: 合格率百分比
// - 基于所有物料的合格/生产数量
```

### 3. 日志记录
```javascript
// 自动添加日志
productionOrder.addLog(action, description, userId)

// 记录的操作:
// - Created: 创建
// - Status Changed: 状态变更
// - Progress Updated: 进度更新
// - Resources Assigned: 资源分配
// - Completed: 完成
```

---

## 🎯 最佳实践

### 1. 生产计划
- 合理设置计划开始/结束日期
- 根据订单紧急程度设置优先级
- 预先分配生产线和人员
- 记录详细的技术要求

### 2. 进度跟踪
- 及时更新生产进度
- 记录合格和不合格数量
- 关注合格率指标
- 处理质量问题

### 3. 资源管理
- 合理分配生产线
- 指定负责人和操作员
- 记录使用的设备
- 优化资源利用率

### 4. 状态管理
- 按实际情况更新状态
- 延期时记录原因
- 暂停时说明情况
- 完成后及时标记

---

## 🌟 核心特性

### 1. 智能自动化
- ✅ 进度自动计算
- ✅ 质量自动统计
- ✅ 状态自动判断
- ✅ 时间自动记录

### 2. 可视化展示
- 📊 进度条显示
- 🏷️ 彩色标签
- 📈 统计卡片
- ⚠️ 逾期警告

### 3. 完整追溯
- 📝 操作日志
- 👤 人员记录
- ⏰ 时间戳
- 🔍 审计追踪

---

## 💡 提示技巧

### 1. 优先级使用
- **Urgent**: 客户紧急订单、特殊要求
- **High**: 交期紧、重要客户
- **Normal**: 常规订单
- **Low**: 备货、试产

### 2. 状态管理
- 生产开始前先 **Scheduled** 排期
- 开始生产时更新为 **In Production**
- 遇到问题时使用 **Paused** 或 **Delayed**
- 所有物料完成后自动 **Completed**

### 3. 进度更新
- 每班次结束更新进度
- 及时记录不合格品
- 关注合格率趋势
- 异常情况立即处理

---

## 🚀 扩展方向

可扩展的功能：
- ✨ 生产详情页
- ✨ 甘特图排期
- ✨ 生产看板
- ✨ 工单打印
- ✨ 物料需求计划
- ✨ 设备管理
- ✨ IoT数据采集

---

**更新时间**: 2025-10-27  
**版本**: v1.0.0

💡 **提示**: 这是一个快速参考文档。详细信息请查看《生产协同功能完成报告.md》


