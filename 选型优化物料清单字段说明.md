# 选型优化物料清单字段说明 📝

**添加时间**: 2025-10-27  
**文件**: `backend/models/NewProject.js`  
**字段**: `optimized_bill_of_materials`  
**状态**: ✅ 已完成

---

## 📋 字段概述

在 `NewProject` 模型中新增了 `optimized_bill_of_materials` 字段，用于存储项目的**选型优化结果**和**精简的最终报价清单**。

---

## 🎯 字段结构

### Schema 定义

```javascript
optimized_bill_of_materials: [{
  // 最终选定的执行机构完整型号
  actuator_model: {
    type: String,
    trim: true,
    uppercase: true
    // 例如: 'SF10/C-150DA-T1', 'AT-DA63-T2'
  },
  
  // 该型号的总数量
  total_quantity: {
    type: Number,
    required: true,
    min: [1, '数量必须大于0']
  },
  
  // 单价
  unit_price: {
    type: Number,
    required: true,
    min: [0, '单价不能为负数']
  },
  
  // 总价 (total_quantity × unit_price)
  total_price: {
    type: Number,
    required: true,
    min: [0, '总价不能为负数']
  },
  
  // 该型号所覆盖的所有阀门位号列表（关键字段）
  covered_tags: [{
    type: String,
    trim: true,
    uppercase: true
    // 例如: ['V-101', 'V-102', 'V-105']
    // 用于跟踪哪些阀门使用了这个型号
  }],
  
  // 备注信息
  notes: {
    type: String,
    trim: true
  }
}]
```

### 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `actuator_model` | String | ❌ | 执行机构完整型号（自动转大写） |
| `total_quantity` | Number | ✅ | 该型号的总数量（≥1） |
| `unit_price` | Number | ✅ | 单价（≥0） |
| `total_price` | Number | ✅ | 总价（≥0） |
| `covered_tags` | Array[String] | ❌ | 覆盖的阀门位号列表 |
| `notes` | String | ❌ | 备注信息 |

---

## 💡 业务场景

### 场景说明

在一个大型项目中，可能有多个阀门位号需要选型。经过优化后，我们可能会发现：
- 多个阀门可以使用**同一型号**的执行器
- 可以通过**批量采购**降低成本
- 需要生成**精简的物料清单**用于采购和报价

### 优化前 vs 优化后

#### 优化前（selections 数组）

```javascript
selections: [
  {
    tag_number: "V-101",
    selected_actuator: {
      model_base: "SF10-150DA",
      final_model_name: "SF10/C-150DA-T1",
      price: 8925
    },
    total_price: 9225
  },
  {
    tag_number: "V-102",
    selected_actuator: {
      model_base: "SF10-150DA",
      final_model_name: "SF10/C-150DA-T1",
      price: 8925
    },
    total_price: 9225
  },
  {
    tag_number: "V-105",
    selected_actuator: {
      model_base: "SF10-150DA",
      final_model_name: "SF10/C-150DA-T1",
      price: 8925
    },
    total_price: 9225
  },
  {
    tag_number: "V-103",
    selected_actuator: {
      model_base: "AT-DA63",
      final_model_name: "AT-DA63-T2",
      price: 93
    },
    total_price: 220
  },
  {
    tag_number: "V-104",
    selected_actuator: {
      model_base: "AT-DA63",
      final_model_name: "AT-DA63-T2",
      price: 93
    },
    total_price: 220
  }
]

// 问题：
// - 数据冗余（同型号重复多次）
// - 不易统计（需要遍历所有选型）
// - 报价不清晰（没有汇总）
```

#### 优化后（optimized_bill_of_materials）

```javascript
optimized_bill_of_materials: [
  {
    actuator_model: "SF10/C-150DA-T1",
    total_quantity: 3,
    unit_price: 8925,
    total_price: 26775,  // 8925 × 3
    covered_tags: ["V-101", "V-102", "V-105"],
    notes: "球阀用，低温环境"
  },
  {
    actuator_model: "AT-DA63-T2",
    total_quantity: 2,
    unit_price: 93,
    total_price: 186,  // 93 × 2
    covered_tags: ["V-103", "V-104"],
    notes: "小型阀门用"
  }
]

// 优势：
// ✅ 数据精简（2条记录 vs 5条）
// ✅ 易于统计（一目了然）
// ✅ 批量采购（清晰的数量汇总）
// ✅ 专业报价（符合商业习惯）
```

---

## 📊 数据示例

### 示例 1: 单一项目的优化物料清单

```javascript
{
  project_name: "某化工厂阀门改造项目",
  project_number: "PROJ-2025-00123",
  
  // 原始选型记录（保留详细信息）
  selections: [
    { tag_number: "FV-101", selected_actuator: {...}, total_price: 9225 },
    { tag_number: "FV-102", selected_actuator: {...}, total_price: 9225 },
    { tag_number: "FV-103", selected_actuator: {...}, total_price: 220 },
    // ... 更多选型
  ],
  
  // 优化后的物料清单（用于采购和报价）
  optimized_bill_of_materials: [
    {
      actuator_model: "SF10/C-150DA-T1",
      total_quantity: 2,
      unit_price: 8925,
      total_price: 17850,
      covered_tags: ["FV-101", "FV-102"],
      notes: "主管道球阀，低温环境(-40°C)"
    },
    {
      actuator_model: "AT-DA63-T2",
      total_quantity: 1,
      unit_price: 93,
      total_price: 93,
      covered_tags: ["FV-103"],
      notes: "辅助管道小型阀门"
    }
  ],
  
  total_project_price: 18163  // 自动计算总价
}
```

---

### 示例 2: 大型项目

```javascript
{
  project_name: "炼油厂全厂阀门选型项目",
  project_number: "PROJ-2025-00456",
  
  optimized_bill_of_materials: [
    {
      actuator_model: "SF10/C-150DA",
      total_quantity: 15,
      unit_price: 8500,
      total_price: 127500,
      covered_tags: [
        "V-101", "V-102", "V-103", "V-104", "V-105",
        "V-106", "V-107", "V-108", "V-109", "V-110",
        "V-111", "V-112", "V-113", "V-114", "V-115"
      ],
      notes: "常温环境，主管道球阀"
    },
    {
      actuator_model: "SF10/C-150DA-T1",
      total_quantity: 8,
      unit_price: 8925,
      total_price: 71400,
      covered_tags: [
        "V-201", "V-202", "V-203", "V-204",
        "V-205", "V-206", "V-207", "V-208"
      ],
      notes: "低温环境(-40°C)，主管道球阀"
    },
    {
      actuator_model: "AT-DA63",
      total_quantity: 25,
      unit_price: 90,
      total_price: 2250,
      covered_tags: [
        "V-301", "V-302", "V-303", "V-304", "V-305",
        // ... 共25个位号
      ],
      notes: "常温环境，辅助管道小型阀门"
    },
    {
      actuator_model: "GY-75-M",
      total_quantity: 5,
      unit_price: 1400,
      total_price: 7000,
      covered_tags: ["V-401", "V-402", "V-403", "V-404", "V-405"],
      notes: "高温环境(120°C)，蒸汽管道"
    }
  ],
  
  total_project_price: 208150
}
```

---

## 🔧 使用方法

### 1. 创建优化物料清单

```javascript
const project = await NewProject.findById(projectId);

// 优化算法：合并相同型号
const optimizedBOM = [];
const modelMap = new Map();

// 遍历所有选型记录
project.selections.forEach(selection => {
  const model = selection.selected_actuator?.final_model_name || 
                selection.selected_actuator?.model_base;
  const price = selection.selected_actuator?.price || 0;
  const tag = selection.tag_number;
  
  if (modelMap.has(model)) {
    // 已存在该型号，累加数量
    const item = modelMap.get(model);
    item.total_quantity += 1;
    item.total_price = item.unit_price * item.total_quantity;
    item.covered_tags.push(tag);
  } else {
    // 新型号，创建记录
    modelMap.set(model, {
      actuator_model: model,
      total_quantity: 1,
      unit_price: price,
      total_price: price,
      covered_tags: [tag]
    });
  }
});

// 转换为数组
project.optimized_bill_of_materials = Array.from(modelMap.values());

await project.save();
console.log('✅ 优化物料清单已生成');
```

---

### 2. 查询优化物料清单

```javascript
// 获取项目的优化物料清单
const project = await NewProject.findById(projectId);

if (project.optimized_bill_of_materials && 
    project.optimized_bill_of_materials.length > 0) {
  console.log('📊 优化物料清单:');
  
  project.optimized_bill_of_materials.forEach((item, index) => {
    console.log(`${index + 1}. ${item.actuator_model}`);
    console.log(`   数量: ${item.total_quantity}`);
    console.log(`   单价: ¥${item.unit_price.toLocaleString()}`);
    console.log(`   总价: ¥${item.total_price.toLocaleString()}`);
    console.log(`   覆盖位号: ${item.covered_tags.join(', ')}`);
    console.log('');
  });
}
```

---

### 3. 更新优化物料清单

```javascript
// 添加新的物料项
project.optimized_bill_of_materials.push({
  actuator_model: "SF12-200DA-M",
  total_quantity: 3,
  unit_price: 12500,
  total_price: 37500,
  covered_tags: ["V-501", "V-502", "V-503"],
  notes: "高温高压环境"
});

await project.save();
```

---

### 4. 根据位号查找对应的型号

```javascript
// 查找某个位号对应的执行器型号
const findModelByTag = (project, tagNumber) => {
  for (const item of project.optimized_bill_of_materials) {
    if (item.covered_tags.includes(tagNumber)) {
      return {
        model: item.actuator_model,
        quantity: item.total_quantity,
        unit_price: item.unit_price,
        total_covered: item.covered_tags.length
      };
    }
  }
  return null;
};

const result = findModelByTag(project, "V-101");
console.log(result);
// {
//   model: "SF10/C-150DA-T1",
//   quantity: 3,
//   unit_price: 8925,
//   total_covered: 3
// }
```

---

### 5. 统计分析

```javascript
// 统计优化效果
const analyzeOptimization = (project) => {
  const originalCount = project.selections.length;
  const optimizedCount = project.optimized_bill_of_materials.length;
  
  // 计算总数量
  const totalQuantity = project.optimized_bill_of_materials.reduce(
    (sum, item) => sum + item.total_quantity, 0
  );
  
  // 计算总价
  const totalPrice = project.optimized_bill_of_materials.reduce(
    (sum, item) => sum + item.total_price, 0
  );
  
  // 计算平均单价
  const avgUnitPrice = totalPrice / totalQuantity;
  
  return {
    originalSelections: originalCount,
    uniqueModels: optimizedCount,
    totalQuantity,
    totalPrice,
    avgUnitPrice,
    consolidationRate: ((originalCount - optimizedCount) / originalCount * 100).toFixed(2) + '%'
  };
};

const stats = analyzeOptimization(project);
console.log('📈 优化分析:');
console.log(`原始选型数: ${stats.originalSelections}`);
console.log(`优化后型号数: ${stats.uniqueModels}`);
console.log(`总数量: ${stats.totalQuantity}`);
console.log(`总价: ¥${stats.totalPrice.toLocaleString()}`);
console.log(`平均单价: ¥${stats.avgUnitPrice.toLocaleString()}`);
console.log(`合并率: ${stats.consolidationRate}`);
```

---

## 📄 API 端点建议

### 1. 生成优化物料清单

```javascript
// POST /api/new-projects/:id/optimize-bom
router.post('/new-projects/:id/optimize-bom', async (req, res) => {
  try {
    const project = await NewProject.findById(req.params.id);
    
    if (!project) {
      return res.status(404).json({
        success: false,
        message: '项目不存在'
      });
    }
    
    // 优化算法
    const modelMap = new Map();
    
    project.selections.forEach(selection => {
      const model = selection.selected_actuator?.final_model_name || 
                    selection.selected_actuator?.model_base;
      const price = selection.selected_actuator?.price || 0;
      const tag = selection.tag_number;
      
      if (!model) return;
      
      if (modelMap.has(model)) {
        const item = modelMap.get(model);
        item.total_quantity += 1;
        item.total_price = item.unit_price * item.total_quantity;
        item.covered_tags.push(tag);
      } else {
        modelMap.set(model, {
          actuator_model: model,
          total_quantity: 1,
          unit_price: price,
          total_price: price,
          covered_tags: [tag]
        });
      }
    });
    
    project.optimized_bill_of_materials = Array.from(modelMap.values());
    await project.save();
    
    res.json({
      success: true,
      message: '优化物料清单已生成',
      data: {
        original_count: project.selections.length,
        optimized_count: project.optimized_bill_of_materials.length,
        bom: project.optimized_bill_of_materials
      }
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: '生成失败',
      error: error.message
    });
  }
});
```

---

### 2. 获取优化物料清单

```javascript
// GET /api/new-projects/:id/optimized-bom
router.get('/new-projects/:id/optimized-bom', async (req, res) => {
  try {
    const project = await NewProject.findById(req.params.id)
      .select('optimized_bill_of_materials project_name project_number');
    
    if (!project) {
      return res.status(404).json({
        success: false,
        message: '项目不存在'
      });
    }
    
    res.json({
      success: true,
      data: {
        project_name: project.project_name,
        project_number: project.project_number,
        bom: project.optimized_bill_of_materials || []
      }
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: '获取失败',
      error: error.message
    });
  }
});
```

---

### 3. 更新优化物料清单

```javascript
// PUT /api/new-projects/:id/optimized-bom
router.put('/new-projects/:id/optimized-bom', async (req, res) => {
  try {
    const project = await NewProject.findById(req.params.id);
    
    if (!project) {
      return res.status(404).json({
        success: false,
        message: '项目不存在'
      });
    }
    
    // 验证数据格式
    const { optimized_bill_of_materials } = req.body;
    
    if (!Array.isArray(optimized_bill_of_materials)) {
      return res.status(400).json({
        success: false,
        message: 'optimized_bill_of_materials 必须是数组'
      });
    }
    
    project.optimized_bill_of_materials = optimized_bill_of_materials;
    await project.save();
    
    res.json({
      success: true,
      message: '更新成功',
      data: project.optimized_bill_of_materials
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: '更新失败',
      error: error.message
    });
  }
});
```

---

## 📊 前端集成

### 优化物料清单展示组件

```jsx
import { Table, Tag, Tooltip } from 'antd';

const OptimizedBOMTable = ({ bom }) => {
  const columns = [
    {
      title: '序号',
      key: 'index',
      width: 60,
      render: (_, __, index) => index + 1
    },
    {
      title: '执行器型号',
      dataIndex: 'actuator_model',
      key: 'actuator_model',
      render: (model) => (
        <strong style={{ color: '#1890ff' }}>{model}</strong>
      )
    },
    {
      title: '数量',
      dataIndex: 'total_quantity',
      key: 'total_quantity',
      width: 80,
      align: 'center',
      render: (qty) => (
        <Tag color="blue">{qty}</Tag>
      )
    },
    {
      title: '单价',
      dataIndex: 'unit_price',
      key: 'unit_price',
      width: 120,
      align: 'right',
      render: (price) => `¥${price.toLocaleString()}`
    },
    {
      title: '总价',
      dataIndex: 'total_price',
      key: 'total_price',
      width: 120,
      align: 'right',
      render: (price) => (
        <strong style={{ color: '#52c41a' }}>
          ¥{price.toLocaleString()}
        </strong>
      )
    },
    {
      title: '覆盖位号',
      dataIndex: 'covered_tags',
      key: 'covered_tags',
      render: (tags) => (
        <Tooltip title={tags.join(', ')}>
          <div>
            {tags.slice(0, 3).map(tag => (
              <Tag key={tag} color="geekblue">{tag}</Tag>
            ))}
            {tags.length > 3 && (
              <Tag color="default">+{tags.length - 3}</Tag>
            )}
          </div>
        </Tooltip>
      )
    },
    {
      title: '备注',
      dataIndex: 'notes',
      key: 'notes',
      ellipsis: true
    }
  ];
  
  const totalPrice = bom.reduce((sum, item) => sum + item.total_price, 0);
  const totalQuantity = bom.reduce((sum, item) => sum + item.total_quantity, 0);
  
  return (
    <>
      <Table
        columns={columns}
        dataSource={bom}
        rowKey={(record) => record.actuator_model}
        pagination={false}
        summary={() => (
          <Table.Summary.Row>
            <Table.Summary.Cell index={0}>合计</Table.Summary.Cell>
            <Table.Summary.Cell index={1}></Table.Summary.Cell>
            <Table.Summary.Cell index={2} align="center">
              <Tag color="blue">{totalQuantity}</Tag>
            </Table.Summary.Cell>
            <Table.Summary.Cell index={3}></Table.Summary.Cell>
            <Table.Summary.Cell index={4} align="right">
              <strong style={{ color: '#52c41a', fontSize: 16 }}>
                ¥{totalPrice.toLocaleString()}
              </strong>
            </Table.Summary.Cell>
            <Table.Summary.Cell index={5}></Table.Summary.Cell>
            <Table.Summary.Cell index={6}></Table.Summary.Cell>
          </Table.Summary.Row>
        )}
      />
    </>
  );
};
```

---

## 🎯 业务价值

### 1. 采购优化 📦
- ✅ 清晰的物料汇总
- ✅ 批量采购降低成本
- ✅ 减少供应商沟通次数

### 2. 报价专业化 💰
- ✅ 符合商业习惯的清单
- ✅ 清晰的价格结构
- ✅ 易于客户理解

### 3. 项目管理 📊
- ✅ 快速统计项目规模
- ✅ 追踪位号对应关系
- ✅ 简化库存管理

### 4. 数据分析 📈
- ✅ 型号使用频率统计
- ✅ 成本分析
- ✅ 优化效果评估

---

## ✅ 验证清单

- [x] 字段已添加到 Schema
- [x] 所有字段类型正确
- [x] 必填字段标记
- [x] 数值验证规则（min）
- [x] 字符串自动处理（trim, uppercase）
- [x] 数组类型正确
- [x] 零 Linter 错误

---

## 🎉 总结

`optimized_bill_of_materials` 字段已成功添加！

**关键特性**:
- 📊 **结构化数据**: 完整的物料信息
- 🔍 **可追溯性**: covered_tags 追踪位号
- 💰 **价格透明**: 单价和总价分离
- 📈 **易于统计**: 数量、价格汇总
- 🎯 **专业性**: 符合商业报价习惯

**适用场景**:
- 大型项目物料汇总
- 批量采购清单生成
- 专业报价单制作
- 成本分析和优化

---

**完成时间**: 2025-10-27  
**状态**: ✅ Production Ready

