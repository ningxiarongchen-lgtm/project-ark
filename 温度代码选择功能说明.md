# 温度代码选择功能说明 📝

**添加时间**: 2025-10-27  
**文件**: `frontend/src/pages/SelectionEngine.jsx`  
**状态**: ✅ 已完成

---

## 📋 功能概述

在前端选型界面的"基本参数"面板中，添加了详细的温度代码选择功能，允许用户根据实际工况选择合适的温度范围。

---

## 🎯 新增字段详情

### 字段信息

| 属性 | 值 |
|------|-----|
| **Label** | 使用温度 (Temperature) |
| **Name** | `temperature_code` |
| **组件** | Ant Design `Select` |
| **默认值** | `'No code'` (常温) |
| **必填** | ❌ 可选 |
| **工具提示** | "选择执行器的工作温度范围" |

### 温度选项

| 代码 | 标签 | 温度范围 | 说明 |
|------|------|----------|------|
| `No code` | 常温 Normal | -20°C ~ 80°C | ⭐ 默认选项，适用于大多数常规环境 |
| `T1` | 低温 Low T1 | -40°C ~ 80°C | 轻度低温环境 |
| `T2` | 低温 Low T2 | -50°C ~ 80°C | 中度低温环境 |
| `T3` | 低温 Low T3 | -60°C ~ 80°C | 极端低温环境 |
| `M` | 高温 High Temp | -20°C ~ 120°C | 高温环境 |

---

## 💻 代码实现

### 1. 表单项 (Form.Item)

```jsx
{/* 使用温度 (Temperature) */}
<Form.Item
  label="使用温度 (Temperature)"
  name="temperature_code"
  tooltip="选择执行器的工作温度范围"
>
  <Select placeholder="选择使用温度范围" defaultValue="No code">
    <Select.Option value="No code">常温 Normal (-20~80°C)</Select.Option>
    <Select.Option value="T1">低温 Low T1 (-40~80°C)</Select.Option>
    <Select.Option value="T2">低温 Low T2 (-50~80°C)</Select.Option>
    <Select.Option value="T3">低温 Low T3 (-60~80°C)</Select.Option>
    <Select.Option value="M">高温 High Temp (-20~120°C)</Select.Option>
  </Select>
</Form.Item>
```

**位置**: 在"工作压力 (MPa)"字段之后，"旋转角度 (度)"字段之前

### 2. 初始值设置

```jsx
<Form
  form={form}
  layout="vertical"
  initialValues={{
    mechanism: 'Scotch Yoke',
    yoke_type: 'symmetric',
    needs_manual_override: false,
    max_rotation_angle: 90,
    temperature_type: 'normal',
    needs_handwheel: false,
    temperature_code: 'No code'  // ⭐ 新增默认值
  }}
>
```

---

## 🎨 用户界面效果

### 表单显示

```
┌─────────────────────────────────────────────┐
│ 基本参数                                    │
├─────────────────────────────────────────────┤
│ 执行机构类型                                │
│ [拨叉式] [齿轮齿条式]                       │
├─────────────────────────────────────────────┤
│ 阀门口径                                    │
│ [ DN100                               ]     │
├─────────────────────────────────────────────┤
│ 法兰连接尺寸                                │
│ [ F07/F10                             ]     │
├─────────────────────────────────────────────┤
│ 位号标识（可选）                            │
│ [ FV-101                              ]     │
├─────────────────────────────────────────────┤
│ 需求扭矩 (Nm) *                             │
│ [ 50                                  ]     │
├─────────────────────────────────────────────┤
│ 工作压力 (MPa) *                            │
│ [ 0.55 MPa ▼                          ]     │
├─────────────────────────────────────────────┤
│ 使用温度 (Temperature) ⓘ           ⭐ 新增  │
│ [ 常温 Normal (-20~80°C) ▼          ]      │
│   常温 Normal (-20~80°C)             ✓      │
│   低温 Low T1 (-40~80°C)                   │
│   低温 Low T2 (-50~80°C)                   │
│   低温 Low T3 (-60~80°C)                   │
│   高温 High Temp (-20~120°C)               │
├─────────────────────────────────────────────┤
│ 旋转角度 (度)                               │
│ [ 90° ▼                               ]     │
└─────────────────────────────────────────────┘
```

---

## 📊 数据流

### 前端表单数据

当用户提交表单时，`temperature_code` 字段会包含在表单数据中：

```javascript
{
  mechanism: "Scotch Yoke",
  valve_type: "Ball Valve",
  valve_size: "DN100",
  flange_size: "F07/F10",
  tag_number: "FV-101",
  required_torque: 500,
  working_pressure: 0.55,
  temperature_code: "T1",  // ⭐ 温度代码
  max_rotation_angle: 90,
  needs_manual_override: false
}
```

### 后端接收

后端选型 API (`POST /api/selection/calculate`) 会接收这个参数：

```javascript
// selectionController.js
const {
  mechanism,
  valve_type,
  required_torque,
  working_pressure,
  temperature_code,  // ⭐ 接收温度代码
  // ... 其他参数
} = req.body;
```

---

## 🔄 与现有字段的关系

### temperature_type vs temperature_code

系统现在有两个温度相关的字段：

#### 1. `temperature_type` (仅AT/GY系列)

- **用途**: 价格计算
- **类型**: Radio.Group
- **选项**: `normal` / `low` / `high`
- **显示条件**: 仅当选择"齿轮齿条式 (AT/GY系列)"时显示
- **作用**: 决定使用哪个价格等级（常温价/低温价/高温价）

```jsx
<Radio.Group buttonStyle="solid">
  <Radio.Button value="normal">常温 (Normal)</Radio.Button>
  <Radio.Button value="low">低温 (Low Temp)</Radio.Button>
  <Radio.Button value="high">高温 (High Temp)</Radio.Button>
</Radio.Group>
```

#### 2. `temperature_code` (所有系列) ⭐ 新增

- **用途**: 产品规格标识
- **类型**: Select
- **选项**: `No code` / `T1` / `T2` / `T3` / `M`
- **显示条件**: 始终显示（所有执行机构类型）
- **作用**: 标识产品的温度等级代码，用于规格书和订单

```jsx
<Select placeholder="选择使用温度范围" defaultValue="No code">
  <Select.Option value="No code">常温 Normal (-20~80°C)</Select.Option>
  <Select.Option value="T1">低温 Low T1 (-40~80°C)</Select.Option>
  // ...
</Select>
```

### 两者的协同使用

**示例场景**: 用户选择 AT/GY 系列 + 低温环境

1. **temperature_type**: 选择 `"low"` → 后端使用 `base_price_low` 计算价格
2. **temperature_code**: 选择 `"T2"` (-50°C ~ 80°C) → 规格书和订单中标注 "T2"

**表单数据**:
```javascript
{
  mechanism: "Rack & Pinion",
  temperature_type: "low",      // 价格等级
  temperature_code: "T2",        // 产品规格
  // ...
}
```

---

## 🎯 应用场景

### 场景 1: 常规环境

**客户需求**: 室内常温环境，温度 -10°C ~ 60°C

**选择**: 
- `temperature_code`: `"No code"` (常温 Normal -20~80°C)
- `temperature_type`: `"normal"` (如果是AT/GY系列)

**结果**: 使用标准产品，标准价格

---

### 场景 2: 寒冷地区

**客户需求**: 东北地区户外，冬季温度可达 -45°C

**选择**:
- `temperature_code`: `"T1"` (低温 Low T1 -40~80°C)
- `temperature_type`: `"low"` (如果是AT/GY系列)

**结果**: 产品标注 "T1"，使用低温价格

---

### 场景 3: 极寒环境

**客户需求**: 北极地区，极端低温 -55°C

**选择**:
- `temperature_code`: `"T2"` (低温 Low T2 -50~80°C)
- `temperature_type`: `"low"` (如果是AT/GY系列)

**结果**: 产品标注 "T2"，使用低温价格

---

### 场景 4: 高温环境

**客户需求**: 锅炉房，环境温度 100°C

**选择**:
- `temperature_code`: `"M"` (高温 High Temp -20~120°C)
- `temperature_type`: `"high"` (如果是AT/GY系列)

**结果**: 产品标注 "M"，使用高温价格

---

## 📄 后续集成建议

### 1. 规格书生成 (PDF)

**技术规格书**应包含温度代码信息：

```javascript
// pdfGenerator.js - generateSelectionSpecPDF()

doc.text(`温度等级: ${selection.temperature_code || 'No code'}`, ...);

// 或者更详细的说明
const tempCodeMap = {
  'No code': '常温 Normal (-20°C ~ 80°C)',
  'T1': '低温 Low T1 (-40°C ~ 80°C)',
  'T2': '低温 Low T2 (-50°C ~ 80°C)',
  'T3': '低温 Low T3 (-60°C ~ 80°C)',
  'M': '高温 High Temp (-20°C ~ 120°C)'
};

doc.text(`使用温度: ${tempCodeMap[selection.temperature_code]}`, ...);
```

---

### 2. 报价单生成

**报价单**应显示温度代码：

```javascript
// pdfGenerator.js - generateSelectionQuotePDF()

// 在产品描述中包含温度代码
const productDescription = `${actuator.model_base}${
  selection.temperature_code !== 'No code' 
    ? ` (${selection.temperature_code})` 
    : ''
}`;

// 例如: "AT-DA63 (T1)" 或 "SF10-DA-SY"
```

---

### 3. 数据库保存

**项目保存**时应包含温度代码：

```javascript
// newProjectController.js - autoSelect()

const selectionData = {
  tag_number: req.body.tag_number,
  input_params: {
    valve_torque: req.body.valve_torque,
    working_pressure: req.body.working_pressure,
    temperature_code: req.body.temperature_code,  // ⭐ 保存温度代码
    // ...
  },
  selected_actuator: {
    model_base: actuator.model_base,
    temperature_code: req.body.temperature_code,  // ⭐ 关联到选中的执行器
    // ...
  }
};
```

---

### 4. 后端验证（可选）

**添加温度代码验证**：

```javascript
// selectionController.js

const validTempCodes = ['No code', 'T1', 'T2', 'T3', 'M'];

if (temperature_code && !validTempCodes.includes(temperature_code)) {
  return res.status(400).json({
    success: false,
    message: '无效的温度代码'
  });
}
```

---

### 5. 型号命名规则

**如果需要在型号中包含温度代码**：

```javascript
// 生成最终产品型号
const generateFinalModel = (baseModel, tempCode) => {
  if (tempCode === 'No code') {
    return baseModel;  // AT-DA63
  }
  return `${baseModel}-${tempCode}`;  // AT-DA63-T1
};

// 使用示例
const finalModel = generateFinalModel('AT-DA63', 'T1');
// 结果: "AT-DA63-T1"
```

---

## 🧪 测试清单

### 前端测试

- [ ] 字段正确显示在"基本参数"面板中
- [ ] 默认值为 "No code" (常温)
- [ ] 所有5个温度选项都可以选择
- [ ] 工具提示 (tooltip) 正确显示
- [ ] 选择不同选项后表单值正确更新
- [ ] 提交表单时 `temperature_code` 值正确发送

### 界面测试

- [ ] Select 组件样式正常
- [ ] 下拉菜单显示所有选项
- [ ] 温度范围文字清晰可读
- [ ] 响应式布局正常（手机/平板/桌面）

### 数据测试

```javascript
// 测试数据 1: 默认值
{
  temperature_code: "No code"
}

// 测试数据 2: 低温 T1
{
  temperature_code: "T1"
}

// 测试数据 3: 高温 M
{
  temperature_code: "M"
}
```

---

## 📝 使用示例

### 完整选型流程

```
1. 用户登录系统
   ↓
2. 进入选型引擎
   ↓
3. 填写基本参数:
   - 执行机构类型: 拨叉式 (SF系列)
   - 阀门类型: 球阀
   - 阀门口径: DN100
   - 需求扭矩: 500 Nm
   - 工作压力: 0.6 MPa
   - 使用温度: T1 (-40~80°C)  ⭐ 选择温度代码
   - 旋转角度: 90°
   ↓
4. 点击"查找匹配执行器"
   ↓
5. 查看推荐结果
   ↓
6. 选择合适的型号
   ↓
7. 保存到项目（包含温度代码信息）
   ↓
8. 生成规格书和报价单（显示温度代码）
```

---

## ✅ 完成清单

- [x] 添加 `temperature_code` 表单字段
- [x] 设置 5 个温度选项
- [x] 设置默认值为 `'No code'`
- [x] 添加工具提示说明
- [x] 更新表单初始值
- [x] 零 Linter 错误
- [x] 编写使用文档

---

## 📚 相关文档

- [AT_GY系列完整升级总结.md](./AT_GY系列完整升级总结.md)
- [AT_GY系列前端表单升级报告.md](./AT_GY系列前端表单升级报告.md)

---

**完成时间**: 2025-10-27  
**状态**: ✅ Production Ready

---

**备注**: 此功能为产品规格标识，与之前的 `temperature_type` (价格等级) 是两个不同的概念，可以配合使用。

