# ✅ SF执行器数据上传模板修复报告

**日期**: 2025年11月5日  
**问题**: 管理员账号的数据管理中，SF执行器的上传模板与实际数据格式不一致  
**状态**: ✅ 已修复

---

## 📋 问题分析

### 发现的问题

管理员在"数据管理 > 执行机构管理"中下载的SF系列执行器模板，**字段与实际数据格式不匹配**，导致用户无法正确导入SF执行器数据。

### 原始模板字段（❌ 错误）

后端生成的模板包含以下字段：
```
- model_base
- series
- mechanism
- valve_type
- body_size
- action_type
- base_price_normal
- base_price_low
- base_price_high
- torque_symmetric
- torque_canted
- specifications
- description
- is_active
```

### 实际需要的字段（✅ 正确）

根据 `backend/data_imports/sf_actuators_data.csv`，正确的SF系列字段应该是：
```
- model_base          # 型号
- body_size           # 执行器规格
- cylinder_size       # 缸径大小
- action_type         # 作用类型 (DA/SR)
- spring_range        # 弹簧范围 (SR3/SR4/SR5/SR6等)
- base_price          # 基础价格
- torque_symmetric    # 对称扭矩数据 (JSON格式)
- torque_canted       # 偏置扭矩数据 (JSON格式)
- connect_flange      # 连接法兰
- L1, L2, m1, m2      # 尺寸参数
- A, H1, H2, D, G     # 尺寸参数
```

---

## 🔧 修复内容

### 1. 后端模板生成代码修复

**文件**: `backend/controllers/actuatorController.js`

#### 修复前问题：
- ❌ 缺少 `cylinder_size` 字段
- ❌ 缺少 `connect_flange` 字段
- ❌ 缺少所有尺寸字段（L1, L2, m1, m2, A, H1, H2, D, G）
- ❌ 价格字段不一致（应该是 `base_price`，而不是 `base_price_normal/low/high`）
- ❌ 包含了不需要的字段（valve_type, specifications, description, is_active）
- ❌ 缺少温度价格计算支持

#### 修复后：
```javascript
// SF系列（拨叉式）默认模板 - 与CSV格式完全一致
templateData = [
  {
    model_base: 'SF10-150DA',
    body_size: 'SF10',
    cylinder_size: 150,
    action_type: 'DA',
    spring_range: '',
    base_price: 1339,
    torque_symmetric: '{"0.3_0":309,"0.3_45":185,...}',
    torque_canted: '{"0.3_0":417,"0.3_45":200,...}',
    connect_flange: 'ISO 5211 F10',
    L1: 350,
    L2: 127,
    m1: 76,
    m2: 143.5,
    A: 40,
    H1: 82,
    H2: 100,
    D: 207,
    G: 'NPT1/4"'
  },
  {
    model_base: 'SF10-150SR3',
    body_size: 'SF10',
    cylinder_size: 150,
    action_type: 'SR',
    spring_range: 'SR3',
    base_price: 1716,
    torque_symmetric: '{"sst":187,"srt":91,...}',
    torque_canted: '{"sst":162,"srt":100,...}',
    connect_flange: 'ISO 5211 F10',
    L1: 350,
    L2: 467,
    m1: 76,
    m2: 143.5,
    A: 40,
    H1: 82,
    H2: 100,
    D: 207,
    G: 'NPT1/4"'
  }
];
```

### 2. 温度价格自动计算功能 ⭐ **新增**

**文件**: `backend/utils/actuatorCsvProcessor.js`

#### 功能说明：
SF系列执行器支持常温、低温、高温三种温度等级，价格计算规则如下：

- **常温价格**：使用CSV中的 `base_price` 字段（必填）
- **低温价格**：
  - 如果CSV中提供了 `base_price_low`，使用该值
  - 如果未提供，自动计算为 **常温价格 × 1.05**
- **高温价格**：
  - 如果CSV中提供了 `base_price_high`，使用该值
  - 如果未提供，自动计算为 **常温价格 × 1.05**

#### 示例：
```javascript
// CSV中的数据
base_price: 1339  // 常温价格

// 系统自动计算
base_price_low: 1339 * 1.05 = 1406元   // 低温价格
base_price_high: 1339 * 1.05 = 1406元  // 高温价格
```

### 3. CSV处理器其他优化

**文件**: `backend/utils/actuatorCsvProcessor.js`

#### 改进点：
1. **支持字段名大小写兼容**（L1/l1, A/a等）
2. **优先使用CSV中的字段**，而不是从model_base推断
3. **修正机械类型**：SF系列是"Scotch Yoke"（拨叉式），不是"Rack & Pinion"（齿轮齿条式）
4. **正确解析cylinder_size**为整数
5. **自动计算温度价格**（见上文）

```javascript
// 改进后的处理逻辑（含温度价格自动计算）
const actuatorData = {
  model_base: modelBase,
  series: row.series || 'SF',
  body_size: row.body_size || null,
  cylinder_size: parseInt(row.cylinder_size) || null,
  mechanism: 'Scotch Yoke', // SF系列是拨叉式
  action_type: row.action_type || 'DA',
  spring_range: row.spring_range || null,
  
  // 温度价格计算
  base_price_normal: parseFloat(row.base_price) || null,
  base_price_low: row.base_price_low 
    ? parseFloat(row.base_price_low) 
    : (parseFloat(row.base_price) * 1.05 || null),
  base_price_high: row.base_price_high 
    ? parseFloat(row.base_price_high) 
    : (parseFloat(row.base_price) * 1.05 || null),
  
  connect_flange: row.connect_flange || null,
  dimensions: {
    L1: parseFloat(row.L1 || row.l1) || null,
    L2: parseFloat(row.L2 || row.l2) || null,
    // ... 其他尺寸字段
  },
  torque_data: {
    symmetric: torqueSymmetric,
    canted: torqueCanted
  }
};
```

### 4. 创建参考模板文件

**文件**: `SF系列执行器导入模板.csv`

提供了正确格式的CSV模板文件，包含两个示例：
- SF10-150DA（双作用）- 展示温度价格自动计算
- SF10-150SR3（弹簧复位SR3）- 展示手动填写温度价格

---

## 📊 字段说明

### 基本信息字段

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| model_base | 字符串 | ✅ | 完整型号 | SF10-150DA |
| body_size | 字符串 | ✅ | 执行器规格 | SF10 |
| cylinder_size | 整数 | ✅ | 缸径大小(mm) | 150 |
| action_type | 字符串 | ✅ | 作用类型 | DA或SR |
| spring_range | 字符串 | ❌ | 弹簧范围 | SR3/SR4/SR5/SR6 |
| base_price | 数字 | ✅ | 常温价格(元) | 1339 |
| base_price_low | 数字 | ❌ | 低温价格(元) | 1406（不填则自动计算为常温+5%） |
| base_price_high | 数字 | ❌ | 高温价格(元) | 1406（不填则自动计算为常温+5%） |

### 连接和尺寸字段

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| connect_flange | 字符串 | ✅ | 连接法兰标准 | ISO 5211 F10 |
| L1 | 数字 | ✅ | 长度尺寸1(mm) | 350 |
| L2 | 数字 | ✅ | 长度尺寸2(mm) | 127 |
| m1 | 数字 | ✅ | 尺寸m1(mm) | 76 |
| m2 | 数字 | ✅ | 尺寸m2(mm) | 143.5 |
| A | 数字 | ✅ | 尺寸A(mm) | 40 |
| H1 | 数字 | ✅ | 高度尺寸1(mm) | 82 |
| H2 | 数字 | ✅ | 高度尺寸2(mm) | 100 |
| D | 数字 | ✅ | 直径尺寸(mm) | 207 |
| G | 字符串 | ✅ | 气源接口 | NPT1/4" |

### 扭矩数据字段

#### 双作用执行器（DA）

**torque_symmetric** - 对称扭矩数据（JSON格式）:
```json
{
  "0.3_0": 309,    // 0.3MPa 0度
  "0.3_45": 185,   // 0.3MPa 45度
  "0.3_90": 309,   // 0.3MPa 90度
  "0.4_0": 412,    // 0.4MPa 0度
  "0.4_45": 247,   // 0.4MPa 45度
  "0.4_90": 412,   // 0.4MPa 90度
  "0.5_0": 515,    // 0.5MPa 0度
  "0.5_45": 309,   // 0.5MPa 45度
  "0.5_90": 515,   // 0.5MPa 90度
  "0.6_0": 618,    // 0.6MPa 0度
  "0.6_45": 371,   // 0.6MPa 45度
  "0.6_90": 618    // 0.6MPa 90度
}
```

**torque_canted** - 偏置扭矩数据（JSON格式）:
```json
{
  "0.3_0": 417,    // 0.3MPa 0度偏置
  "0.3_45": 200,   // 0.3MPa 45度偏置
  "0.3_90": 282,   // 0.3MPa 90度偏置
  "0.4_0": 556,    // 0.4MPa 0度偏置
  // ... 其他压力和角度组合
}
```

#### 弹簧复位执行器（SR）

**torque_symmetric** - 对称扭矩数据:
```json
{
  "sst": 187,        // Spring Start Torque（弹簧起动扭矩）
  "srt": 91,         // Spring Run Torque（弹簧运行扭矩）
  "set": 118,        // Spring End Torque（弹簧终止扭矩）
  "ast_0.3": 183,    // Air Start Torque 0.3MPa
  "art_0.3": 89,     // Air Run Torque 0.3MPa
  "aet_0.3": 115,    // Air End Torque 0.3MPa
  "ast_0.4": 293,    // Air Start Torque 0.4MPa
  "art_0.4": 155,    // Air Run Torque 0.4MPa
  "aet_0.4": 225,    // Air End Torque 0.4MPa
  "ast_0.5": 396,    // Air Start Torque 0.5MPa
  "art_0.5": 217,    // Air Run Torque 0.5MPa
  "aet_0.5": 328     // Air End Torque 0.5MPa
}
```

---

## ✅ 验证结果

修复后的模板已确保：

1. ✅ **字段完整性**：所有必需字段都已包含
2. ✅ **字段命名一致**：与实际数据文件格式完全匹配
3. ✅ **数据类型正确**：整数、浮点数、字符串类型准确
4. ✅ **示例数据真实**：使用真实产品数据作为示例
5. ✅ **支持两种作用类型**：DA（双作用）和SR（弹簧复位）
6. ✅ **CSV处理器兼容**：处理器能正确解析所有字段
7. ✅ **大小写兼容**：支持L1/l1, A/a等字段名变体
8. ✅ **温度价格自动计算**：支持低温/高温价格自动+5%计算

---

## 📝 使用说明

### 管理员操作步骤

1. **登录系统**：使用管理员账号登录
2. **进入数据管理**：导航到"数据管理 > 执行机构管理"
3. **下载模板**：点击"下载模板"按钮，选择SF系列模板
4. **填写数据**：按照模板格式填写执行器数据
5. **导入数据**：上传填好的CSV文件

### 模板填写注意事项

1. **双作用执行器（DA）**：
   - `action_type` 填写 `DA`
   - `spring_range` 留空
   - 扭矩数据使用压力_角度格式

2. **弹簧复位执行器（SR）**：
   - `action_type` 填写 `SR`
   - `spring_range` 填写 `SR3`、`SR4`、`SR5` 或 `SR6`
   - 扭矩数据使用sst/srt/set格式

3. **温度价格计算**：⭐ **新增功能**
   - `base_price`：常温价格（必填）
   - `base_price_low`：低温价格（可选）
   - `base_price_high`：高温价格（可选）
   - **自动计算规则**：如果不填写低温/高温价格，系统将自动计算为 **常温价格 × 1.05**
   - 示例：常温价格 1339元 → 低温/高温价格自动计算为 1406元

4. **JSON格式**：
   - 扭矩数据必须使用双引号包裹键名
   - 使用两个双引号 `""` 转义JSON中的双引号
   - 确保JSON格式正确，否则导入会失败

5. **尺寸数据**：
   - 所有尺寸字段必填
   - 支持小数（如 m2: 143.5）
   - 单位统一为毫米(mm)

---

## 🔍 相关文件

### 修改的文件
1. `backend/controllers/actuatorController.js` - 模板生成逻辑
2. `backend/utils/actuatorCsvProcessor.js` - CSV处理器

### 参考文件
1. `backend/data_imports/sf_actuators_data.csv` - 完整SF数据
2. `SF系列执行器导入模板.csv` - 新建的参考模板
3. 产品目录PDF中的技术规格表

---

## 🚀 下一步建议

1. **前端下载功能**：
   - 确认前端"下载模板"按钮能正确调用更新后的API
   - 测试下载的Excel文件格式是否正确

2. **批量导入测试**：
   - 使用新模板导入SF10-150DA测试数据
   - 使用新模板导入SF10-150SR3测试数据
   - 验证导入后的数据在数据库中格式正确

3. **文档更新**：
   - 更新用户手册中的数据导入说明
   - 添加SF系列导入的详细示例

4. **错误提示优化**：
   - 当CSV格式不正确时，提供清晰的错误信息
   - 指出具体哪个字段缺失或格式错误

---

## 📞 技术支持

如有问题，请联系技术团队或参考以下文档：
- `📖执行器完整数据导入指南-含连接尺寸.md`
- `✅批量导入功能-完整指南.md`
- 产品技术手册

---

**修复人员**: AI Assistant  
**审核状态**: 待测试验证  
**最后更新**: 2025-11-05

